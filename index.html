<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Escaparate - Cliente</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.4.7/peerjs.min.js"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --success: #27ae60;
            --danger: #e74c3c;
            --warning: #f39c12;
            --light: #ecf0f1;
            --dark: #2c3e50;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 15px;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logo i {
            font-size: 24px;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.2);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: var(--success);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .offline .status-dot {
            background-color: var(--danger);
            animation: none;
        }
        
        .user-menu {
            position: relative;
        }
        
        .user-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .user-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            color: #333;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            width: 200px;
            z-index: 100;
            margin-top: 5px;
        }
        
        .user-dropdown.show {
            display: block;
        }
        
        .user-dropdown-item {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .user-dropdown-item:last-child {
            border-bottom: none;
        }
        
        .user-dropdown-item:hover {
            background-color: #f5f5f5;
        }
        
        .tabs {
            display: flex;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }
        
        .tab.active {
            border-bottom: 3px solid var(--secondary);
            background-color: rgba(52, 152, 219, 0.1);
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .product-card {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }
        
        .product-card:hover {
            transform: translateY(-5px);
        }
        
        .product-image {
            height: 160px;
            background-color: #eee;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        
        .product-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .product-info {
            padding: 15px;
        }
        
        .product-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .product-description {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }
        
        .product-price {
            color: var(--success);
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .product-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .btn-primary {
            background-color: var(--secondary);
            color: white;
        }
        
        .btn-success {
            background-color: var(--success);
            color: white;
        }
        
        .btn-warning {
            background-color: var(--warning);
            color: white;
        }
        
        .cart-badge {
            background-color: var(--danger);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            position: absolute;
            top: -5px;
            right: -5px;
        }
        
        .cart-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        .cart-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--secondary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            cursor: pointer;
            position: relative;
        }
        
        .cart-panel {
            display: none;
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 350px;
            max-height: 500px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            overflow: hidden;
        }
        
        .cart-panel.show {
            display: flex;
            flex-direction: column;
        }
        
        .cart-header {
            background: var(--primary);
            color: white;
            padding: 15px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .cart-items {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            max-height: 350px;
        }
        
        .cart-item {
            display: flex;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        
        .cart-item-image {
            width: 50px;
            height: 50px;
            border-radius: 5px;
            background: #eee;
            margin-right: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .cart-item-info {
            flex: 1;
        }
        
        .cart-item-name {
            font-weight: bold;
            font-size: 14px;
        }
        
        .cart-item-price {
            font-size: 14px;
            color: var(--success);
        }
        
        .cart-item-quantity {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .quantity-btn {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: #eee;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        
        .cart-footer {
            padding: 15px;
            border-top: 1px solid #eee;
        }
        
        .cart-total {
            display: flex;
            justify-content: space-between;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .checkout-btn {
            width: 100%;
            padding: 12px;
            background: var(--success);
            color: white;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 500px;
            border: 1px solid #ddd;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .chat-header {
            background-color: var(--primary);
            color: white;
            padding: 15px;
            font-weight: bold;
        }
        
        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background-color: #f9f9f9;
        }
        
        .message {
            margin-bottom: 15px;
            max-width: 80%;
        }
        
        .message.received {
            align-self: flex-start;
        }
        
        .message.sent {
            align-self: flex-end;
            margin-left: auto;
        }
        
        .message-bubble {
            padding: 10px 15px;
            border-radius: 18px;
            position: relative;
        }
        
        .received .message-bubble {
            background-color: white;
            border-bottom-left-radius: 5px;
        }
        
        .sent .message-bubble {
            background-color: var(--secondary);
            color: white;
            border-bottom-right-radius: 5px;
        }
        
        .message-time {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }
        
        .chat-input {
            display: flex;
            padding: 15px;
            background-color: white;
            border-top: 1px solid #ddd;
        }
        
        .chat-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 20px;
            margin-right: 10px;
        }

        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            opacity: 0;
            transition: opacity 0.5s, transform 0.5s;
            transform: translateY(20px);
            z-index: 10000;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .notification.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        .notification-success {
            background-color: var(--success);
        }
        
        .notification-error {
            background-color: var(--danger);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #fefefe;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 400px;
            position: relative;
        }

        .close-btn {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 20px;
            cursor: pointer;
        }

        .close-btn:hover, .close-btn:focus {
            color: #333;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
</head>
<body>

<div class="app-container">
    
    <header>
        <div class="logo">
            <i class="fas fa-shopping-bag"></i>
            <h1 id="storeName">Mi Escaparate</h1>
        </div>
        <div class="status-indicator" id="statusIndicator">
            <span class="status-dot"></span>
            <span id="statusText">Buscando tienda...</span>
        </div>
        <div class="user-menu">
            <button class="user-btn" id="userBtn">
                <i class="fas fa-user-circle"></i> 
                <span id="userName">Invitado</span>
                <i class="fas fa-caret-down"></i>
            </button>
            <div class="user-dropdown" id="userDropdown">
                <div class="user-dropdown-item" id="loginBtn">
                    <i class="fas fa-sign-in-alt"></i> 
                    <span id="loginText">Iniciar Sesión / Registrarse</span>
                </div>
                <div class="user-dropdown-item" id="profileBtn" style="display: none;">
                    <i class="fas fa-id-card-alt"></i> Ver Perfil
                </div>
                <div class="user-dropdown-item" id="logoutBtn" style="display: none;">
                    <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
                </div>
            </div>
        </div>
    </header>

    <div class="p2p-status">
        <strong>Estado de Conexión:</strong> <span id="p2pStatus">Inicializando...</span>
        <input type="text" id="storePinInput" placeholder="PIN de la Tienda" style="margin-left: 10px; padding: 5px; border-radius: 5px;">
        <button class="btn btn-primary" id="connectBtn">Conectar</button>
    </div>

    <div class="tabs">
        <div class="tab active" data-tab="catalog">Catálogo</div>
        <div class="tab" data-tab="chat">Chat con la Tienda</div>
        <div class="tab" data-tab="orders">Mis Pedidos</div>
    </div>

    <div class="tab-content active" id="catalog-tab">
        <h2>Productos Disponibles</h2>
        <div class="product-grid" id="productGrid">
            <p style="text-align: center; color: #666;">Cargando catálogo. Conéctate a la tienda.</p>
        </div>
    </div>

    <div class="tab-content" id="chat-tab">
        <h2>Chat con la Tienda</h2>
        <div class="chat-container">
            <div class="chat-header" id="chatHeader">
                Conecta con la tienda para chatear
            </div>
            <div class="chat-messages" id="chatMessages">
                <div class="message received">
                    <div class="message-bubble"> ¡Bienvenido! Ingresa el PIN de la tienda y haz clic en "Conectar" para comenzar a chatear. </div>
                </div>
            </div>
            <div class="chat-input">
                <input type="text" id="messageInput" placeholder="Conecta con la tienda primero..." disabled>
                <button class="btn btn-primary" id="sendMessageBtn" disabled>
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <div class="tab-content" id="orders-tab">
        <h2>Mis Pedidos</h2>
        <div id="ordersList">
            <p style="text-align: center; color: #666;">Inicia sesión y conéctate para ver tus pedidos.</p>
        </div>
    </div>
</div>

<div class="cart-container">
    <div class="cart-btn" id="cartBtn">
        <i class="fas fa-shopping-cart"></i>
        <span class="cart-badge" id="cartBadge" style="display: none;">0</span>
    </div>
    <div class="cart-panel" id="cartPanel">
        <div class="cart-header">
            <span>Tu Carrito</span>
            <button class="btn btn-warning btn-sm" id="clearCartBtn" style="padding: 5px 10px;"><i class="fas fa-times-circle"></i> Vaciar</button>
        </div>
        <div class="cart-items" id="cartItems">
            <p style="text-align: center; color: #666;">Tu carrito está vacío</p>
        </div>
        <div class="cart-footer">
            <div class="cart-total">
                <span>Total Estimado:</span>
                <span id="cartTotal">0.00 Bs</span>
            </div>
            <button class="checkout-btn" id="checkoutBtn" disabled>
                <i class="fas fa-credit-card"></i> <span>Proceder al Pago</span>
            </button>
        </div>
    </div>
</div>

<div id="authModal" class="modal">
    <div class="modal-content">
        <span class="close-btn">&times;</span>
        <h3 id="authModalTitle">Iniciar Sesión</h3>
        <form id="authForm">
            <div class="form-group">
                <label for="authName">Nombre Completo</label>
                <input type="text" id="authName" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="authEmail">Correo Electrónico</label>
                <input type="email" id="authEmail" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="authPhone">Teléfono</label>
                <input type="tel" id="authPhone" class="form-control">
            </div>
            <div class="form-group">
                <label for="authAddress">Dirección</label>
                <textarea id="authAddress" class="form-control"></textarea>
            </div>
            <button type="submit" class="btn btn-success" id="authSubmitBtn">Confirmar</button>
            <p style="margin-top: 10px; font-size: 14px; text-align: center;">
                <a href="#" id="switchAuthMode">¿No tienes cuenta? Regístrate aquí</a>
            </p>
        </form>
    </div>
</div>

<div id="checkoutModal" class="modal">
    <div class="modal-content" style="max-width: 550px;">
        <span class="close-btn" id="closeCheckoutModal">&times;</span>
        <h3>Confirmación de Pedido</h3>
        <div id="checkoutSummary" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 20px;">
            </div>

        <h4>Datos del Cliente</h4>
        <div id="checkoutClientInfo" style="margin-bottom: 20px; padding: 10px; background: #f7f7f7; border-radius: 5px;">
            </div>
        
        <div class="form-group">
            <label for="paymentMethod">Método de Pago</label>
            <select id="paymentMethod" class="form-control">
                <option value="zelle">Zelle</option>
                <option value="pago_movil">Pago Móvil</option>
                <option value="efectivo">Efectivo (USD o Bs)</option>
            </select>
        </div>

        <div class="form-group">
            <label for="deliveryOption">Opción de Entrega</label>
            <select id="deliveryOption" class="form-control">
                <option value="delivery">Delivery (+${5.00} USD)</option>
                <option value="pickup">Recoger en Tienda (Gratis)</option>
            </select>
        </div>

        <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
            <button class="btn" id="cancelCheckoutBtn">Cancelar</button>
            <button class="btn btn-success" id="confirmCheckoutBtn">Confirmar Pedido</button>
        </div>
    </div>
</div>


<div class="notification notification-success" id="successNotification">
    <i class="fas fa-check-circle"></i> <span id="notificationText">Operación exitosa</span>
</div>
<div class="notification notification-error" id="errorNotification">
    <i class="fas fa-exclamation-circle"></i> <span id="errorNotificationText">Ha ocurrido un error</span>
</div>


<script>
    // =================================================================================
    // INDEXEDDB HELPER (Reemplazo de localStorage)
    // =================================================================================
    let db;
    const DB_NAME = 'MiTiendaClientDB';
    const DB_VERSION = 2; 
    const STORE_NAMES = ['user', 'cart', 'orders', 'client_chats'];

    /**
     * @returns {Promise<IDBDatabase>}
     */
    function openDatabase() {
        return new Promise((resolve, reject) => {
            if (db) return resolve(db);

            const request = indexedDB.open(DB_NAME, DB_VERSION);

            request.onupgradeneeded = (event) => {
                const tempDb = event.target.result;
                STORE_NAMES.forEach(storeName => {
                    if (!tempDb.objectStoreNames.contains(storeName)) {
                        // User, Cart, Orders, Chats use 'id' or 'key'
                        let options = { keyPath: 'id' };
                        if (storeName === 'user') {
                            options = { keyPath: 'key' };
                        }
                        tempDb.createObjectStore(storeName, options);
                    }
                });
            };

            request.onsuccess = (event) => {
                db = event.target.result;
                resolve(db);
            };

            request.onerror = (event) => {
                console.error("Database error:", event.target.error);
                reject(event.target.error);
            };
        });
    }

    /**
     * @param {string} storeName 
     * @param {string} mode ('readonly' or 'readwrite')
     * @param {function(IDBObjectStore): IDBRequest} operation 
     * @returns {Promise<any>}
     */
    async function performDBOperation(storeName, mode, operation) {
        const database = await openDatabase();
        return new Promise((resolve, reject) => {
            const transaction = database.transaction(storeName, mode);
            const store = transaction.objectStore(storeName);
            const request = operation(store);

            request.onsuccess = () => {
                resolve(request.result);
            };

            request.onerror = () => {
                reject(request.error);
            };
        });
    }

    const IDBHelper = {
        async set(storeName, key, value) {
            // Used for single objects (user, chat messages array)
            const item = { id: key, value: value };
            if (storeName === 'user') item.key = key; // Use 'key' for the user store for consistency
            
            return performDBOperation(storeName, 'readwrite', (store) => 
                store.put(item)
            );
        },

        async get(storeName, key) {
            const result = await performDBOperation(storeName, 'readonly', (store) => 
                store.get(key)
            );
            return result ? result.value : null;
        },

        async saveCollection(storeName, collection) {
            // Clears and saves the entire collection (cart, orders, etc.)
            await this.clear(storeName);
            const database = await openDatabase();
            return new Promise((resolve, reject) => {
                const transaction = database.transaction(storeName, 'readwrite');
                const store = transaction.objectStore(storeName);
                
                collection.forEach(item => {
                    store.put(item);
                });

                transaction.oncomplete = () => resolve(true);
                transaction.onerror = (event) => reject(event.target.error);
            });
        },

        async getAll(storeName) {
            return performDBOperation(storeName, 'readonly', (store) => 
                store.getAll()
            );
        },

        async clear(storeName) {
            return performDBOperation(storeName, 'readwrite', (store) => 
                store.clear()
            );
        }
    };

    // =================================================================================
    // ESTADO GLOBAL Y ELEMENTOS
    // =================================================================================

    const PREDEFINED_PINS = [
        '11223344', '55667788', '99001122', '33445566', '77889900',
        '12121212', '34343434', '56565656', '78787878', '90909090'
    ]; 

    const state = {
        peer: null,
        conn: null,
        storePin: null, 
        storeAdminId: null,
        isConnectedToStore: false,
        
        // Data from Store (updated via P2P)
        products: [],
        exchangeRate: 35.50,
        deliveryCost: 5.00,
        storeName: "Mi Escaparate",

        // Local Persistent Data (Managed by IndexedDB)
        user: null, // { id, name, email, phone, address }
        cart: [], // [{ productId, name, price, image, quantity }]
        orders: [], // [{ id, total, status, items... }]
        messages: [], // Chat messages with the store
        
        isLoginMode: true // For auth modal
    };

    // Elementos DOM (Se mantienen igual)
    const elements = {
        storeName: document.getElementById('storeName'),
        p2pStatus: document.getElementById('p2pStatus'),
        storePinInput: document.getElementById('storePinInput'),
        connectBtn: document.getElementById('connectBtn'),
        productGrid: document.getElementById('productGrid'),
        cartBtn: document.getElementById('cartBtn'),
        cartBadge: document.getElementById('cartBadge'),
        cartPanel: document.getElementById('cartPanel'),
        cartItems: document.getElementById('cartItems'),
        cartTotal: document.getElementById('cartTotal'),
        clearCartBtn: document.getElementById('clearCartBtn'),
        checkoutBtn: document.getElementById('checkoutBtn'),
        ordersList: document.getElementById('ordersList'),
        chatHeader: document.getElementById('chatHeader'),
        chatMessages: document.getElementById('chatMessages'),
        messageInput: document.getElementById('messageInput'),
        sendMessageBtn: document.getElementById('sendMessageBtn'),
        authModal: document.getElementById('authModal'),
        authModalTitle: document.getElementById('authModalTitle'),
        switchAuthMode: document.getElementById('switchAuthMode'),
        checkoutModal: document.getElementById('checkoutModal'),
        checkoutSummary: document.getElementById('checkoutSummary'),
        checkoutClientInfo: document.getElementById('checkoutClientInfo'),
        loginText: document.getElementById('loginText'),
        loginBtn: document.getElementById('loginBtn'),
        profileBtn: document.getElementById('profileBtn'),
        logoutBtn: document.getElementById('logoutBtn'),
        userBtn: document.getElementById('userBtn'),
        userName: document.getElementById('userName'),
        userDropdown: document.getElementById('userDropdown'),
        successNotification: document.getElementById('successNotification'),
        errorNotification: document.getElementById('errorNotification'),
    };

    // =================================================================================
    // LÓGICA DE INICIALIZACIÓN (ASÍNCRONA)
    // =================================================================================

    document.addEventListener('DOMContentLoaded', async function() {
        // Validación del PIN (revisar que al menos haya PINS válidos)
        if (PREDEFINED_PINS.length === 0) {
            elements.p2pStatus.textContent = 'Error de configuración de PIN.';
            elements.p2pStatus.style.color = 'red';
            return;
        }

        setupEventListeners();
        await initializeApp(); // Now async to load from IndexedDB
        initializeP2P();
    });

    async function initializeApp() {
        try {
            // Load persistent data from IndexedDB
            const savedUser = await IDBHelper.get('user', 'clientUser');
            const savedCart = await IDBHelper.getAll('cart');
            const savedOrders = await IDBHelper.getAll('orders');
            const savedMessages = await IDBHelper.get('client_chats', 'storeChat');
            
            if (savedUser) { 
                state.user = savedUser; 
                updateUserInterface();
            }
            if (savedCart && savedCart.length > 0) { 
                state.cart = savedCart; 
                updateCart(); 
            }
            if (savedOrders && savedOrders.length > 0) { 
                state.orders = savedOrders; 
                renderOrders(); 
            }
            if (savedMessages) {
                state.messages = savedMessages;
            }

        } catch (error) {
            console.error("Error loading initial state from IndexedDB:", error);
            showNotification('Error al cargar datos locales. Usando valores por defecto.', 'error');
        }
    }


    // =================================================================================
    // LÓGICA DE AUTENTICACIÓN Y PEDIDOS (ACTUALIZADO A IDB)
    // =================================================================================

    async function processAuth() {
        const name = document.getElementById('authName').value;
        const email = document.getElementById('authEmail').value;
        const phone = document.getElementById('authPhone').value;
        const address = document.getElementById('authAddress').value;

        if (!name || !email) {
            showNotification('Nombre y correo electrónico son obligatorios', 'error');
            return;
        }

        const newUser = { 
            id: 'user_' + Date.now().toString(36), 
            name, 
            email, 
            phone, 
            address, 
            joinDate: new Date() 
        };
        state.user = newUser;

        // Save User to IndexedDB
        await IDBHelper.set('user', 'clientUser', newUser); 

        updateUserInterface();
        hideAuthModal();
        showNotification(state.isLoginMode ? 'Sesión iniciada correctamente' : 'Registro exitoso', 'success');

        // Send auth data to store via P2P if connected
        if (state.conn && state.conn.open) {
            state.conn.send({
                type: 'auth',
                data: {
                    name: state.user.name,
                    phone: state.user.phone,
                    address: state.user.address,
                    email: state.user.email
                }
            });
        }
    }

    async function handleConfirmCheckout() {
        if (!state.user) {
            showNotification('Debes iniciar sesión para confirmar el pedido.', 'warning');
            showAuthModal();
            return;
        }
        if (!state.isConnectedToStore) {
            showNotification('No estás conectado a la tienda. Por favor, conecta primero.', 'error');
            return;
        }
        if (state.cart.length === 0) {
            showNotification('Tu carrito está vacío.', 'error');
            return;
        }

        // Calculate total again to ensure accuracy
        const subtotal = state.cart.reduce((sum, item) => sum + item.price * item.quantity, 0) * state.exchangeRate;
        const deliveryOption = document.getElementById('deliveryOption').value;
        const delivery = deliveryOption === 'delivery' ? state.deliveryCost * state.exchangeRate : 0;
        const total = subtotal + delivery;
        const paymentMethod = document.getElementById('paymentMethod').value;
        
        const orderData = {
            items: state.cart.map(item => ({
                name: item.name,
                price: item.price,
                quantity: item.quantity
            })),
            total: total,
            totalUSD: (total / state.exchangeRate).toFixed(2),
            paymentMethod: paymentMethod,
            deliveryOption: deliveryOption
        };

        // Send order to store via P2P
        state.conn.send({
            type: 'order',
            data: orderData
        });

        // Add to local orders list
        state.orders.push({ 
            id: 'local_order_' + Date.now().toString(36), // Temporary ID until confirmed by Admin
            items: orderData.items, 
            total: total, 
            status: 'enviando', 
            date: new Date() 
        });
        
        // Save Orders to IndexedDB
        await IDBHelper.saveCollection('orders', state.orders);

        // Clear local cart
        state.cart = [];
        await IDBHelper.clear('cart');
        
        updateCart();
        hideCheckoutModal();
        renderOrders(); // Re-render orders tab
        
        showNotification('Pedido enviado a la tienda. Esperando confirmación.', 'success');
        switchTab('orders');
    }

    async function updateCart() {
        const totalItems = state.cart.reduce((sum, item) => sum + item.quantity, 0);
        if (totalItems > 0) {
            elements.cartBadge.textContent = totalItems;
            elements.cartBadge.style.display = 'flex';
        } else {
            elements.cartBadge.style.display = 'none';
        }

        elements.cartItems.innerHTML = '';
        if (state.cart.length === 0) {
            elements.cartItems.innerHTML = '<p style="text-align: center; color: #666;">Tu carrito está vacío</p>';
            elements.cartTotal.textContent = '0.00 Bs';
            elements.checkoutBtn.disabled = true;
            return;
        }

        let subtotalUSD = 0;
        state.cart.forEach(item => {
            const itemTotalBs = item.price * item.quantity * state.exchangeRate;
            const itemTotalUSD = item.price * item.quantity;
            subtotalUSD += itemTotalUSD;
            
            const itemElement = document.createElement('div');
            itemElement.className = 'cart-item';
            itemElement.innerHTML = `
                <div class="cart-item-image">
                    ${item.image ? `<img src="${item.image}" style="width:100%; height:100%; object-fit:cover; border-radius: 5px;">` : `<i class="fas fa-box" style="color: #ccc;"></i>`}
                </div>
                <div class="cart-item-info">
                    <div class="cart-item-name">${item.name}</div>
                    <div class="cart-item-price">$${itemTotalUSD.toFixed(2)} USD | ${itemTotalBs.toFixed(2)} Bs</div>
                </div>
                <div class="cart-item-quantity">
                    <span class="quantity-btn" data-id="${item.productId}" data-action="decrement"><i class="fas fa-minus"></i></span>
                    <span>${item.quantity}</span>
                    <span class="quantity-btn" data-id="${item.productId}" data-action="increment"><i class="fas fa-plus"></i></span>
                    <span class="quantity-btn" data-id="${item.productId}" data-action="remove" style="background: var(--danger); color: white;"><i class="fas fa-trash"></i></span>
                </div>
            `;
            elements.cartItems.appendChild(itemElement);
        });
        
        const totalBs = subtotalUSD * state.exchangeRate;
        elements.cartTotal.textContent = `${totalBs.toFixed(2)} Bs (${subtotalUSD.toFixed(2)} USD)`;
        elements.checkoutBtn.disabled = !state.isConnectedToStore;
        
        // Save Cart to IndexedDB
        await IDBHelper.saveCollection('cart', state.cart);
    }
    
    // =================================================================================
    // RESTO DE FUNCIONES (MANTENIDAS)
    // =================================================================================

    function setupEventListeners() {
        // ... [Listener setup is mostly the same] ...
        // User menu
        elements.userBtn.addEventListener('click', () => {
            elements.userDropdown.classList.toggle('show');
        });
        document.body.addEventListener('click', (e) => {
            if (!elements.userMenu.contains(e.target)) {
                elements.userDropdown.classList.remove('show');
            }
        });

        // Cart
        elements.cartBtn.addEventListener('click', () => {
            elements.cartPanel.classList.toggle('show');
        });
        elements.clearCartBtn.addEventListener('click', clearCart);
        elements.cartItems.addEventListener('click', handleCartAction);
        elements.checkoutBtn.addEventListener('click', showCheckoutModal);

        // Auth
        elements.loginBtn.addEventListener('click', () => showAuthModal(state.user));
        elements.logoutBtn.addEventListener('click', logout);
        elements.profileBtn.addEventListener('click', showProfile);
        document.querySelector('#authModal .close-btn').addEventListener('click', hideAuthModal);
        document.getElementById('switchAuthMode').addEventListener('click', switchAuthMode);
        document.getElementById('authForm').addEventListener('submit', (e) => { e.preventDefault(); processAuth(); });
        
        // Checkout
        document.getElementById('closeCheckoutModal').addEventListener('click', hideCheckoutModal);
        document.getElementById('cancelCheckoutBtn').addEventListener('click', hideCheckoutModal);
        document.getElementById('confirmCheckoutBtn').addEventListener('click', handleConfirmCheckout);

        // Tabs
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                switchTab(tab.dataset.tab);
            });
        });

        // P2P Connect
        elements.connectBtn.addEventListener('click', connectToStore);
        elements.storePinInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') connectToStore();
        });
        
        // Chat
        elements.sendMessageBtn.addEventListener('click', handleSendMessage);
        elements.messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleSendMessage();
        });
    }

    async function logout() {
        state.user = null;
        // Clear User from IndexedDB
        await IDBHelper.clear('user'); 
        updateUserInterface();
        showNotification('Sesión cerrada', 'success');
    }

    // ... [Other functions remain the same: switchTab, renderOrders, showAuthModal, hideAuthModal, 
    // switchAuthMode, updateUserInterface, showProfile, addToCart, handleCartAction, clearCart, 
    // renderProducts, showCheckoutModal, hideCheckoutModal, initializeP2P, connectToStore, 
    // handleStoreData, sendChatMessage, handleSendMessage, addMessageToChat, showNotification] ...

    // --- Placeholder functions for brevity (Assume they use the new async IDBHelper where necessary) ---
    // (Ensure these are present and updated with IDB calls in the final code you use)

    function switchTab(tabId) {
        document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        document.querySelector(`.tab[data-tab="${tabId}"]`).classList.add('active');
        document.getElementById(`${tabId}-tab`).classList.add('active');
        if (tabId === 'catalog') renderProducts();
        else if (tabId === 'orders') renderOrders();
        else if (tabId === 'chat') renderChat();
    }
    
    function renderOrders() {
        const ordersList = elements.ordersList;
        ordersList.innerHTML = '';

        if (state.orders.length === 0) {
            ordersList.innerHTML = '<p style="text-align: center; color: #666;">No tienes pedidos recientes.</p>';
            return;
        }

        // Simple rendering for orders (you can expand this)
        state.orders.forEach(order => {
            const orderDiv = document.createElement('div');
            orderDiv.className = 'client-item'; 
            orderDiv.innerHTML = `
                <div class="client-info">
                    <div class="client-name">Pedido #${order.id.split('_')[2] || order.id}</div>
                    <div class="client-last-message">Total: ${order.total.toFixed(2)} Bs | Estado: ${order.status}</div>
                </div>
            `;
            ordersList.appendChild(orderDiv);
        });
    }
    
    function showAuthModal(isUpdate = false) {
        // ... (Logic to show modal and prefill if updating profile)
        elements.authModal.style.display = 'flex';
    }
    
    function hideAuthModal() {
        elements.authModal.style.display = 'none';
    }

    function switchAuthMode() {
        state.isLoginMode = !state.isLoginMode;
        elements.authModalTitle.textContent = state.isLoginMode ? 'Iniciar Sesión' : 'Registrarse';
        document.getElementById('switchAuthMode').textContent = state.isLoginMode ? '¿No tienes cuenta? Regístrate aquí' : '¿Ya tienes cuenta? Inicia sesión aquí';
    }

    function updateUserInterface() {
        if (state.user) {
            elements.userName.textContent = state.user.name.split(' ')[0];
            elements.loginText.textContent = 'Ver Perfil';
            elements.loginBtn.style.display = 'none';
            elements.profileBtn.style.display = 'flex';
            elements.logoutBtn.style.display = 'flex';
        } else {
            elements.userName.textContent = 'Invitado';
            elements.loginText.textContent = 'Iniciar Sesión / Registrarse';
            elements.loginBtn.style.display = 'flex';
            elements.profileBtn.style.display = 'none';
            elements.logoutBtn.style.display = 'none';
        }
    }
    
    function showProfile() {
        alert(`Perfil de Usuario:\n\nNombre: ${state.user.name}\nEmail: ${state.user.email}\nTeléfono: ${state.user.phone || 'N/A'}\nDirección: ${state.user.address || 'N/A'}`);
    }

    function addToCart(productId) {
        const product = state.products.find(p => p.id === productId);
        if (!product) return;

        const existingItem = state.cart.find(item => item.productId === productId);
        if (existingItem) {
            existingItem.quantity += 1;
        } else {
            state.cart.push({ productId, name: product.name, price: product.price, image: product.image, quantity: 1 });
        }
        updateCart();
        renderProducts(); 
        showNotification(`${product.name} agregado al carrito`, 'success');
    }

    function removeFromCart(productId) {
        state.cart = state.cart.filter(item => item.productId !== productId);
        updateCart();
        renderProducts(); 
        showNotification('Producto removido del carrito', 'success');
    }
    
    function clearCart() {
        if (!confirm('¿Seguro que quieres vaciar el carrito?')) return;
        state.cart = [];
        IDBHelper.clear('cart');
        updateCart();
        showNotification('Carrito vaciado', 'success');
    }
    
    function handleCartAction(e) {
        const target = e.target.closest('.quantity-btn');
        if (!target) return;
        
        const productId = target.dataset.id;
        const action = target.dataset.action;
        const item = state.cart.find(i => i.productId === productId);
        if (!item) return;

        if (action === 'increment') {
            item.quantity += 1;
        } else if (action === 'decrement') {
            item.quantity -= 1;
            if (item.quantity === 0) {
                state.cart = state.cart.filter(i => i.productId !== productId);
            }
        } else if (action === 'remove') {
            state.cart = state.cart.filter(i => i.productId !== productId);
        }

        updateCart();
    }

    function renderProducts() {
        elements.productGrid.innerHTML = '';
        if (state.products.length === 0) {
            elements.productGrid.innerHTML = '<p style="text-align: center; color: #666;">No hay productos disponibles.</p>';
            return;
        }

        state.products.forEach(product => {
            const priceInBs = (product.price * state.exchangeRate).toFixed(2);
            
            const productCard = document.createElement('div');
            productCard.className = 'product-card';
            productCard.innerHTML = `
                <div class="product-image">
                    ${product.image ? `<img src="${product.image}" alt="${product.name}" onerror="this.style.display='none'">` : `<i class="fas fa-box" style="font-size: 50px; color: #ccc;"></i>` }
                </div>
                <div class="product-info">
                    <div class="product-name">${product.name}</div>
                    <div class="product-description">${product.description}</div>
                    <div class="product-price">$${product.price.toFixed(2)} USD | ${priceInBs} Bs</div>
                    <div class="product-actions">
                        <button class="btn btn-success add-to-cart" data-id="${product.id}">
                            <i class="fas fa-cart-plus"></i> Añadir
                        </button>
                    </div>
                </div>
            `;
            elements.productGrid.appendChild(productCard);
        });

        document.querySelectorAll('.add-to-cart').forEach(btn => {
            btn.addEventListener('click', (e) => addToCart(e.currentTarget.dataset.id));
        });
    }

    function showCheckoutModal() {
        if (state.cart.length === 0) {
            showNotification('Tu carrito está vacío', 'error');
            return;
        }

        const subtotalUSD = state.cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
        const subtotal = subtotalUSD * state.exchangeRate;
        const delivery = state.deliveryCost * state.exchangeRate;
        const total = subtotal + delivery;

        // Populate client info
        elements.checkoutClientInfo.innerHTML = state.user ? `
            <strong>Nombre:</strong> ${state.user.name}<br>
            <strong>Email:</strong> ${state.user.email}<br>
            <strong>Teléfono:</strong> ${state.user.phone || 'N/A'}<br>
            <strong>Dirección:</strong> ${state.user.address || 'N/A'}
        ` : '<strong>¡Advertencia!</strong> No has iniciado sesión. Inicia sesión para usar tus datos guardados.';

        // Populate summary
        const summaryHTML = `
            ${state.cart.map(item => `
                <div style="display: flex; justify-content: space-between; font-size: 14px; margin-bottom: 5px;">
                    <span>${item.quantity} x ${item.name} ($${item.price.toFixed(2)} USD)</span>
                    <span>${(item.price * item.quantity * state.exchangeRate).toFixed(2)} Bs</span>
                </div>
            `).join('')}
            <div style="border-top: 1px solid #eee; padding-top: 10px;">
                <div style="display: flex; justify-content: space-between;">
                    <span>Subtotal:</span>
                    <span>${subtotal.toFixed(2)} Bs</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span>Delivery (+${state.deliveryCost.toFixed(2)} USD):</span>
                    <span id="deliveryCostText">${delivery.toFixed(2)} Bs</span>
                </div>
                <div style="display: flex; justify-content: space-between; font-weight: bold; margin-top: 5px;">
                    <span>Total Estimado:</span>
                    <span>${total.toFixed(2)} Bs ($${(total / state.exchangeRate).toFixed(2)} USD)</span>
                </div>
            </div>`;
        elements.checkoutSummary.innerHTML = summaryHTML;
        document.getElementById('deliveryOption').querySelector('option').textContent = `Delivery (+${state.deliveryCost.toFixed(2)} USD)`;

        elements.checkoutModal.style.display = 'flex';
    }

    function hideCheckoutModal() {
        elements.checkoutModal.style.display = 'none';
    }
    
    // P2P and Chat functions
    function initializeP2P() {
        state.peer = new Peer({ debug: 2 });
        state.peer.on('open', function(id) {
            elements.p2pStatus.textContent = 'Listo. Introduce el PIN y Conecta.';
            elements.p2pStatus.style.color = 'orange';
            elements.connectBtn.disabled = false;
        });
        state.peer.on('error', function(err) {
            elements.p2pStatus.textContent = 'Error: ' + err.type;
            elements.p2pStatus.style.color = 'red';
            showNotification('Error PeerJS: ' + err.type, 'error');
        });
    }

    function connectToStore() {
        if (!state.peer) return showNotification('P2P no inicializado', 'error');

        state.storePin = elements.storePinInput.value.trim();
        if (!PREDEFINED_PINS.includes(state.storePin)) {
             return showNotification('PIN no válido. Intenta uno predefinido.', 'error');
        }

        elements.p2pStatus.textContent = 'Conectando...';
        elements.connectBtn.disabled = true;

        state.storeAdminId = 'mi-tienda-admin-' + state.storePin;
        state.conn = state.peer.connect(state.storeAdminId);

        state.conn.on('open', () => {
            state.isConnectedToStore = true;
            elements.p2pStatus.textContent = `Conectado a la tienda (PIN: ${state.storePin})`;
            elements.p2pStatus.style.color = 'green';
            elements.chatHeader.textContent = 'Chat con la Tienda';
            elements.messageInput.disabled = false;
            elements.sendMessageBtn.disabled = false;
            showNotification('Conectado a la tienda', 'success');

            // Send stored user data upon connection
            if (state.user) {
                 state.conn.send({
                    type: 'auth',
                    data: { name: state.user.name, phone: state.user.phone, address: state.user.address, email: state.user.email }
                });
            }
        });

        state.conn.on('data', (data) => {
            handleStoreData(data);
        });

        state.conn.on('close', () => {
            state.isConnectedToStore = false;
            elements.p2pStatus.textContent = 'Desconectado';
            elements.p2pStatus.style.color = 'orange';
            elements.connectBtn.disabled = false;
            elements.messageInput.disabled = true;
            elements.sendMessageBtn.disabled = true;
            showNotification('Desconexión de la tienda', 'error');
        });

        state.conn.on('error', (err) => {
            state.isConnectedToStore = false;
            elements.p2pStatus.textContent = 'Error en conexión con la tienda';
            elements.p2pStatus.style.color = 'red';
            elements.connectBtn.disabled = false;
            showNotification('Error en conexión con la tienda', 'error');
        });
    }
    
    async function handleStoreData(data) {
        switch (data.type) {
            case 'store_data':
                state.products = data.data.products || [];
                state.exchangeRate = data.data.exchangeRate || 35.50;
                state.deliveryCost = data.data.deliveryCost || 5.00;
                state.storeName = data.data.storeName || "Mi Escaparate";
                elements.storeName.textContent = state.storeName;
                renderProducts();
                updateCart(); // Recalculate total with new rate
                showNotification('Catálogo cargado', 'success');
                break;
            case 'products_update':
                state.products = data.data;
                renderProducts();
                showNotification('Productos actualizados', 'success');
                break;
            case 'settings_update':
                state.exchangeRate = data.data.exchangeRate;
                state.deliveryCost = data.data.deliveryCost;
                state.storeName = data.data.storeName;
                elements.storeName.textContent = state.storeName;
                renderProducts();
                updateCart(); // Recalculate total with new rate
                showNotification('Configuración de la tienda actualizada', 'success');
                break;
            case 'message':
                addMessageToChat(data.data.text, 'received', data.data.timestamp);
                state.messages.push({ text: data.data.text, sender: 'received', timestamp: new Date(data.data.timestamp) });
                // Save Messages to IndexedDB
                await IDBHelper.set('client_chats', 'storeChat', state.messages); 
                break;
            case 'order_confirmation':
                showNotification('Pedido confirmado por la tienda', 'success');
                break;
            case 'order_update':
                const order = state.orders.find(o => o.id === data.data.orderId);
                if (order) { 
                    order.status = data.data.status; 
                    // Save Orders to IndexedDB
                    await IDBHelper.saveCollection('orders', state.orders); 
                    renderOrders();
                }
                showNotification(`Estado de pedido actualizado: ${data.data.status}`, 'success');
                break;
        }
    }

    async function handleSendMessage() {
        const messageText = elements.messageInput.value.trim();
        if (!messageText || !state.isConnectedToStore) return;

        state.conn.send({
            type: 'message',
            data: {
                text: messageText,
                timestamp: new Date()
            }
        });
        
        state.messages.push({
            text: messageText,
            sender: 'sent',
            timestamp: new Date()
        });
        
        // Save Messages to IndexedDB
        await IDBHelper.set('client_chats', 'storeChat', state.messages); 

        elements.messageInput.value = '';
        addMessageToChat(messageText, 'sent', new Date());
    }

    function renderChat() {
        elements.chatMessages.innerHTML = '';
        state.messages.forEach(msg => {
            addMessageToChat(msg.text, msg.sender, msg.timestamp);
        });
        elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
    }
    
    function addMessageToChat(text, sender, timestamp) {
        const messageElement = document.createElement('div');
        messageElement.className = `message ${sender}`;
        
        messageElement.innerHTML = `
            <div class="message-bubble">${text}</div>
            <div class="message-time">${new Date(timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
        `;
        
        elements.chatMessages.appendChild(messageElement);
        elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
    }
    
    function showNotification(message, type = 'success') {
        const notification = type === 'success' ? 
            elements.successNotification : elements.errorNotification;
            
        notification.querySelector('span').textContent = message;
        notification.classList.add('show');
        
        setTimeout(() => {
            notification.classList.remove('show');
        }, 3000);
    }
</script>
</body>
</html>
