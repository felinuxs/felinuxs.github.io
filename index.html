<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <title>Gestor Empresarial M√≥vil</title>
    <link rel="manifest" href="manifest.json">
    <meta name="them<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#3498db">
    <title>Gestor Empresarial M√≥vil Completo</title>
    
    <link rel="manifest" href="manifest.json">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Gestor M√≥vil">

    <style>
        :root {
            --primary: #3498db;
            --secondary: #3498db;
            --success: #27ae60;
            --danger: #e74c3c;
            --warning: #f39c12;
            --light: #f8f9fa;
            --dark: #343a40;
            --background: #f8f9fa;
            --text: #343a40;
            --card-bg: white;
            --border: #ddd;
        }

        .tema-oscuro {
            --primary: #2980b9;
            --secondary: #2980b9;
            --background: #1a1a1a;
            --text: #f8f9fa;
            --card-bg: #2d2d2d;
            --border: #444;
        }

        /* Additional Themes */
        .tema-negro {
            --primary: #343a40;
            --secondary: #343a40;
        }

        .tema-verde {
            --primary: #27ae60;
            --secondary: #27ae60;
        }

        .tema-amarillo {
            --primary: #f39c12;
            --secondary: #f39c12;
        }
        /* Fix text contrast for light color themes */
        .tema-amarillo .btn-primary, .tema-amarillo .btn-movil, .tema-amarillo table th,
        .tema-amarillo .btn-sell, .tema-amarillo .btn-view, .tema-amarillo .btn-success,
        .tema-naranja .btn-primary, .tema-naranja .btn-movil, .tema-naranja table th,
        .tema-naranja .btn-sell, .tema-naranja .btn-view, .tema-naranja .btn-success {
            color: var(--dark);
            font-weight: bold;
        }

        .tema-naranja {
            --primary: #e67e22;
            --secondary: #e67e22;
        }

        .tema-rosado {
            --primary: #e84393;
            --secondary: #e84393;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', system-ui;
            background: var(--background);
            color: var(--text);
            font-size: 15px; /* Reduced font size */
            transition: background 0.3s, color 0.3s;
            padding-bottom: 30px;
        }

        .barra-buscadora {
            background: var(--primary);
            color: white;
            padding: 10px;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .search-container {
            display: flex;
            align-items: center;
            position: relative;
        }

        .search-container input {
            flex: 1;
            padding: 10px 15px;
            border: none;
            border-radius: 20px;
            font-size: 1em;
            background: white;
            color: #333;
            text-transform: capitalize;
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--card-bg);
            color: var(--text);
            border-radius: 0 0 5px 5px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            max-height: 300px;
            overflow-y: auto;
            display: none;
            z-index: 1001;
            border: 1px solid var(--border);
        }

        .search-result-item {
            padding: 10px 15px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .search-result-item:hover {
            background-color: rgba(0,0,0,0.05);
        }

        .result-actions {
            display: flex;
            gap: 5px;
        }

        .result-btn {
            padding: 3px 8px;
            border: none;
            border-radius: 3px;
            font-size: 0.8em;
            cursor: pointer;
        }

        .btn-view {
            background: var(--secondary);
            color: white;
        }

        .btn-edit {
            background: var(--warning);
            color: white;
        }

        .btn-add {
            background: var(--success);
            color: white;
        }

        .btn-sell {
            background: var(--primary);
            color: white;
        }

        .container {
            width: 100%;
            padding: 10px;
            margin-top: 60px;
        }

        .menu-movil {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .btn-movil {
            padding: 12px 8px;
            background: var(--secondary);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 0.95em;
            cursor: pointer;
            transition: transform 0.2s, background 0.2s;
            width: 100%;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            flex-direction: column;
            height: 80px;
        }

        .btn-movil:hover {
            opacity: 0.9;
        }

        .btn-movil:active {
            transform: scale(0.98);
        }

        .tipo-cambio-btn {
            font-size: 0.85em;
            line-height: 1.2;
            text-align: center;
        }

        .tipo-cambio-btn .tasa {
            font-size: 0.75em;
            font-weight: bold;
        }

        .tipo-cambio-btn .label {
            font-size: 0.85em;
            margin-top: 3px;
        }

        .nueva-pagina {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--background);
            color: var(--text);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }

        .nueva-pagina .close-btn {
            background: none;
            border: none;
            font-size: 1.5em;
            color: var(--primary);
            padding: 5px;
            position: absolute;
            right: 15px;
            top: 15px;
            cursor: pointer;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        table th, table td {
            padding: 10px;
            border: 1px solid var(--border);
            text-align: left;
        }

        table th {
            background-color: var(--primary);
            color: white;
        }

        table tr:nth-child(even) {
            background-color: rgba(0,0,0,0.03);
        }

        table tr:hover {
            background-color: rgba(0,0,0,0.05);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 5px;
            font-size: 1em;
            background: var(--card-bg);
            color: var(--text);
            text-transform: capitalize;
        }

        .btn {
            padding: 10px 15px;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            margin: 5px;
        }

        .btn-primary {
            background-color: var(--secondary);
        }

        .btn-danger {
            background-color: var(--danger);
        }

        .btn-success {
            background-color: var(--success);
        }

        .btn-warning {
            background-color: var(--warning);
        }

        .btn:hover {
            opacity: 0.9;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--card-bg);
            color: var(--text);
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid var(--border);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: var(--text);
        }

        .producto-venta {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid var(--border);
            align-items: center;
        }

        .producto-info {
            flex: 1;
        }

        .producto-acciones {
            display: flex;
            gap: 5px;
        }

        .tipo-cambio-info {
            background: rgba(0,0,0,0.05);
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
            font-size: 0.9em;
        }

        .card {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border: 1px solid var(--border);
        }

        .error {
            color: var(--danger);
            font-size: 0.9em;
            margin-top: 5px;
        }

        .config-option {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }

        .config-option:last-child {
            border-bottom: none;
        }

        .watermark {
            position: fixed;
            bottom: 10px;
            left: 0;
            width: 100%;
            text-align: center;
            font-size: 0.8em;
            color: #777;
            z-index: 999;
        }

        #modal-salida {
            display: none;
        }

        #modal-salida .modal-content {
            text-align: center;
        }

        #modal-salida .botones-confirmacion {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        .factura-termica {
            width: 80mm;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            background: white;
            color: black;
            line-height: 1.2;
        }

        .factura-header {
            text-align: center;
            margin-bottom: 10px;
            border-bottom: 1px dashed #000;
            padding-bottom: 10px;
        }

        .factura-items {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }

        .factura-items th, .factura-items td {
            padding: 4px 0;
            border-bottom: 1px dashed #ccc;
        }

        .factura-total {
            margin-top: 10px;
            border-top: 2px solid #000;
            padding-top: 10px;
            text-align: right;
            font-weight: bold;
        }

        .capitalize {
            text-transform: capitalize;
        }

        .gasto-item, .empleado-item, .proveedor-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid var(--border);
            align-items: center;
        }

        .reporte-item {
            padding: 10px;
            border-bottom: 1px solid var(--border);
        }

        .mensaje-item {
            padding: 10px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
        }

        .mensaje-item.unread {
            background-color: rgba(52, 152, 219, 0.1);
        }

        .btn-tema {
            background-color: var(--card-bg);
            color: var(--text);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            font-weight: bold;
            border: 1px solid var(--border);
        }

        .botones-accion {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-top: 10px;
        }

        .botones-accion .btn {
            flex: 1;
            text-align: center;
            padding: 12px 5px;
            font-size: 0.9em;
        }

        .botones-data {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .botones-data .btn {
            flex: 1;
            min-width: 100px;
            text-align: center;
        }

        .acciones-tabla {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .acciones-tabla .btn {
            padding: 6px 10px;
            font-size: 0.85em;
            margin: 2px;
        }

        .exportar-factura {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .exportar-factura .btn {
            flex: 1;
        }
        
        .calendario-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .calendario-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            text-align: center;
        }
        .calendario-grid div {
            padding: 8px 4px;
            border-radius: 5px;
        }
        .calendario-dia-nombre {
            font-weight: bold;
            font-size: 0.8em;
        }
        .calendario-dia {
            cursor: pointer;
            border: 1px solid var(--border);
        }
        .calendario-dia:hover {
            background: var(--primary);
            color: white;
        }
        .dia-actual {
            background: var(--success);
            color: white;
            font-weight: bold;
        }
        .dia-seleccionado {
            background: var(--warning);
            color: white;
        }

        .modal-exportacion {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal-exportacion .modal-content {
            background: var(--card-bg);
            color: var(--text);
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid var(--border);
        }

        .opcion-exportacion {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
        }

        .opcion-exportacion:last-child {
            border-bottom: none;
        }

        .opcion-exportacion:hover {
            background-color: rgba(0,0,0,0.05);
        }

        .icono-exportacion {
            font-size: 24px;
            margin-right: 15px;
            width: 30px;
            text-align: center;
        }

        .texto-exportacion {
            flex: 1;
        }

        .texto-exportacion h4 {
            margin-bottom: 5px;
        }

        .texto-exportacion p {
            font-size: 0.9em;
            color: #777;
        }

        .formulario-envio {
            margin-top: 15px;
        }

        .formulario-envio .form-group {
            margin-bottom: 10px;
        }

        .formulario-envio label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 0.9em;
        }

        .formulario-envio input {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: 5px;
            font-size: 0.9em;
        }

        .botones-envio {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <div class="barra-buscadora">
        <div class="search-container">
            <input type="text" id="buscador-global" placeholder="Buscar productos, clientes, proveedores..." autocomplete="off">
            <div class="search-results" id="resultados-busqueda"></div>
        </div>
    </div>

    <div class="container">
        <div class="menu-movil">
            <button class="btn-movil" onclick="abrirPagina('ventas')">üõí Ventas</button>
            <button class="btn-movil" onclick="abrirPagina('inventario')">üì¶ Inventario</button>
            <button class="btn-movil" onclick="abrirPagina('clientes')">üë• Clientes</button>
            <button class="btn-movil" onclick="abrirPagina('proveedores')">üöö Proveedores</button>
            <button class="btn-movil" onclick="abrirPagina('gastos')">üí∏ Gastos</button>
            <button class="btn-movil" onclick="abrirPagina('empleados')">üë®‚Äçüíº Empleados</button>
            <button class="btn-movil tipo-cambio-btn" onclick="abrirPagina('tipo-cambio')">
                <div>üíµ</div>
                <div class="tasa" id="tipo-cambio-btn">1$ = 168,00 Bs</div>
                <div class="label">D√≥lar</div>
            </button>
            <button class="btn-movil" onclick="abrirPagina('mensajes')">üì® Mensajes</button>
            <button class="btn-movil" onclick="abrirPagina('reportes')">üìä Reportes</button>
            <button class="btn-movil" onclick="abrirPagina('config')">‚öôÔ∏è Configuraci√≥n</button>
        </div>
    </div>

    <div class="watermark">@felinuxs</div>

    <div id="pagina-ventas" class="nueva-pagina">
        <button class="close-btn" onclick="cerrarPagina('ventas')">&times;</button>
        <h2>üõí Ventas</h2>
        
        <div class="tipo-cambio-info">
            Tipo de cambio: <span id="tipo-cambio-venta">1$ = 168,00 Bs</span>
        </div>
        
        <div class="form-group">
            <label for="cliente-venta">Cliente:</label>
            <div class="search-container">
                <input type="text" id="buscador-cliente-venta" placeholder="Buscar cliente..." autocomplete="off">
                <div class="search-results" id="resultados-cliente-venta"></div>
            </div>
            <button class="btn btn-success" style="margin-top: 5px; width: 100%;" onclick="mostrarModal('modal-nuevo-cliente')">+ Nuevo Cliente</button>
        </div>
        
        <div class="form-group">
            <label for="producto-venta">Producto:</label>
            <div class="search-container">
                <input type="text" id="buscador-producto-venta" placeholder="Buscar producto..." autocomplete="off">
                <div class="search-results" id="resultados-producto-venta"></div>
            </div>
        </div>
        
        <div id="productos-seleccionados"></div>
        
        <div style="margin-top: 20px; padding: 10px; background: rgba(0,0,0,0.05); border-radius: 5px;">
            <h3>Resumen de Venta</h3>
            <p>Total: <span id="total-bs">0,00 Bs</span></p>
            <div class="form-group" style="margin-top: 10px;">
                <label for="metodo-pago">M√©todo de Pago:</label>
                <select id="metodo-pago">
                    <option value="Pagom√≥vil">Pagom√≥vil</option>
                    <option value="Efectivo USD">Efectivo USD</option>
                    <option value="Efectivo Bs">Efectivo Bs</option>
                    <option value="Tarjeta">Tarjeta</option>
                    <option value="Otro">Otro</option>
                </select>
            </div>
        </div>
        
        <div class="botones-accion">
            <button class="btn btn-success" onclick="finalizarVenta()">Finalizar Venta</button>
            <button class="btn btn-primary" onclick="mostrarFactura()">Ver Factura</button>
        </div>
    </div>

    <div id="pagina-inventario" class="nueva-pagina">
        <button class="close-btn" onclick="cerrarPagina('inventario')">&times;</button>
        <h2>üì¶ Inventario</h2>
        
        <div class="search-container" style="margin-bottom: 15px;">
            <input type="text" id="buscador-inventario" placeholder="Buscar en inventario..." autocomplete="off">
            <div class="search-results" id="resultados-inventario"></div>
        </div>
        
        <button class="btn btn-success" onclick="mostrarModal('modal-agregar-producto')">+ Agregar Producto</button>
        
        <table id="tabla-inventario">
            <thead>
                <tr>
                    <th>Nombre</th>
                    <th>Precio USD</th>
                    <th>Precio Bs</th>
                    <th>Stock</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="pagina-clientes" class="nueva-pagina">
        <button class="close-btn" onclick="cerrarPagina('clientes')">&times;</button>
        <h2>üë• Clientes</h2>
        
        <div class="search-container" style="margin-bottom: 15px;">
            <input type="text" id="buscador-clientes" placeholder="Buscar clientes..." autocomplete="off">
            <div class="search-results" id="resultados-clientes"></div>
        </div>
        
        <button class="btn btn-success" onclick="mostrarModal('modal-nuevo-cliente')">+ Agregar Cliente</button>
        
        <table id="tabla-clientes">
            <thead>
                <tr>
                    <th>Nombre</th>
                    <th>Tel√©fono</th>
                    <th>Email</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="pagina-proveedores" class="nueva-pagina">
        <button class="close-btn" onclick="cerrarPagina('proveedores')">&times;</button>
        <h2>üöö Proveedores</h2>
        
        <div class="search-container" style="margin-bottom: 15px;">
            <input type="text" id="buscador-proveedores" placeholder="Buscar proveedores..." autocomplete="off">
            <div class="search-results" id="resultados-proveedores"></div>
        </div>
        
        <button class="btn btn-success" onclick="mostrarModal('modal-agregar-proveedor')">+ Agregar Proveedor</button>
        
        <table id="tabla-proveedores">
            <thead>
                <tr>
                    <th>Nombre</th>
                    <th>Contacto</th>
                    <th>Tel√©fono</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="pagina-gastos" class="nueva-pagina">
        <button class="close-btn" onclick="cerrarPagina('gastos')">&times;</button>
        <h2>üí∏ Gastos</h2>
        
        <div class="form-group">
            <label for="filtro-fecha-gastos">Filtrar por fecha:</label>
            <input type="month" id="filtro-fecha-gastos" onchange="filtrarGastos()">
        </div>
        
        <button class="btn btn-success" onclick="mostrarModal('modal-agregar-gasto')">+ Registrar Gasto</button>
        
        <div id="resumen-gastos" class="card">
            <h3>Resumen del Mes</h3>
            <p>Total Gastos: <span id="total-gastos">0,00 Bs</span></p>
            <p>Por Categor√≠a:</p>
            <ul id="categorias-gastos"></ul>
        </div>
        
        <div id="lista-gastos">
            </div>
    </div>

    <div id="pagina-empleados" class="nueva-pagina">
        <button class="close-btn" onclick="cerrarPagina('empleados')">&times;</button>
        <h2>üë®‚Äçüíº Empleados</h2>
        
        <div class="search-container" style="margin-bottom: 15px;">
            <input type="text" id="buscador-empleados" placeholder="Buscar empleados..." autocomplete="off">
            <div class="search-results" id="resultados-empleados"></div>
        </div>
        
        <button class="btn btn-success" onclick="mostrarModal('modal-agregar-empleado')">+ Agregar Empleado</button>
        
        <div id="lista-empleados">
            </div>
    </div>

    <div id="pagina-tipo-cambio" class="nueva-pagina">
        <button class="close-btn" onclick="cerrarPagina('tipo-cambio')">&times;</button>
        <h2>üíµ Tipo de Cambio</h2>
        
        <div class="card">
            <h3>Tipo de Cambio Actual</h3>
            <p>1 USD = <span id="tipo-cambio-actual">168,00</span> Bs</p>
            <p>√öltima actualizaci√≥n: <span id="fecha-actualizacion">01/01/2023</span></p>
        </div>
        
        <div class="form-group">
            <label for="nuevo-tipo-cambio">Nuevo Tipo de Cambio (Bs por USD):</label>
            <input type="number" id="nuevo-tipo-cambio" step="0.01" min="1" value="168">
        </div>
        
        <button class="btn btn-primary" onclick="actualizarTipoCambio()">Actualizar Tipo de Cambio</button>
        
        <div class="card" style="margin-top: 20px;">
            <h3>Historial de Cambios</h3>
            <div id="historial-tipo-cambio">
                </div>
        </div>
    </div>

    <div id="pagina-mensajes" class="nueva-pagina">
        <button class="close-btn" onclick="cerrarPagina('mensajes')">&times;</button>
        <h2>üì® Mensajes</h2>
        
        <div class="search-container" style="margin-bottom: 15px;">
            <input type="text" id="buscador-mensajes" placeholder="Buscar mensajes..." autocomplete="off">
        </div>
        
        <div id="filtros-mensajes" style="margin-bottom: 15px;">
            <button class="btn btn-primary" onclick="filtrarMensajes('todos')">Todos</button>
            <button class="btn btn-primary" onclick="filtrarMensajes('no-leidos')">No Le√≠dos</button>
            <button class="btn btn-primary" onclick="filtrarMensajes('importantes')">Importantes</button>
        </div>
        
        <div id="lista-mensajes">
            </div>
    </div>

    <div id="pagina-reportes" class="nueva-pagina">
        <button class="close-btn" onclick="cerrarPagina('reportes')">&times;</button>
        <h2>üìä Reportes</h2>
        
        <div class="card">
            <h3>Ventas Diarias</h3>
            <div id="calendario-container">
                <div class="calendario-header">
                    <button class="btn btn-primary" id="mes-anterior-btn">&lt;</button>
                    <h4 id="mes-actual-titulo"></h4>
                    <button class="btn btn-primary" id="mes-siguiente-btn">&gt;</button>
                </div>
                <div class="calendario-grid" id="calendario-grid"></div>
            </div>
            <div id="reporte-diario-container" style="margin-top: 15px;">
                </div>
        </div>

        <div class="card">
            <h3>Generar Reporte General</h3>
            <div class="form-group">
                <label for="tipo-reporte">Tipo de Reporte:</label>
                <select id="tipo-reporte">
                    <option value="ventas">Ventas</option>
                    <option value="inventario">Inventario</option>
                    <option value="gastos">Gastos</option>
                    <option value="clientes">Clientes</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="fecha-inicio">Fecha Inicio:</label>
                <input type="date" id="fecha-inicio">
            </div>
            
            <div class="form-group">
                <label for="fecha-fin">Fecha Fin:</label>
                <input type="date" id="fecha-fin">
            </div>
            
            <button class="btn btn-primary" onclick="generarReporte()">Generar Reporte</button>
        </div>
        
        <div id="contenedor-reporte" style="margin-top: 20px;">
            </div>
    </div>

    <div id="pagina-config" class="nueva-pagina">
        <button class="close-btn" onclick="cerrarPagina('config')">&times;</button>
        <h2>‚öôÔ∏è Configuraci√≥n</h2>
        
        <div class="config-option">
            <h3>Apariencia</h3>
            <div class="form-group">
                <label for="tema-select">Tema:</label>
                <select id="tema-select" onchange="cambiarTema(this.value)">
                    <option value="claro">Claro</option>
                    <option value="oscuro">Oscuro</option>
                    <option value="negro">Negro</option>
                    <option value="verde">Verde</option>
                    <option value="amarillo">Amarillo</option>
                    <option value="naranja">Naranja</option>
                    <option value="rosado">Rosado</option>
                </select>
            </div>
        </div>
        
        <div class="config-option">
            <h3>Prevenci√≥n de Cierre</h3>
            <button class="btn btn-primary" onclick="activarPrevencionCierre()">Activar Prevenci√≥n de Cierre</button>
            <button class="btn btn-danger" onclick="desactivarPrevencionCierre()">Desactivar Prevenci√≥n de Cierre</button>
            <p id="estado-prevencion" style="margin-top: 10px; font-size: 0.9em;">Estado: Inactivo</p>
        </div>
        
        <div class="config-option">
            <h3>Datos</h3>
            <div class="botones-data">
                <button class="btn btn-primary" onclick="respaldarDatos()">Respaldar (JSON)</button>
                <button class="btn btn-warning" onclick="restaurarDatos()">Restaurar (JSON)</button>
                <button class="btn btn-primary" onclick="exportarDatosExcel()">Respaldar (Excel)</button>
                <button class="btn btn-warning" onclick="importarDatosExcel()">Restaurar (Excel)</button>
                <button class="btn btn-danger" onclick="mostrarModal('modal-salida')">Eliminar Datos</button>
            </div>
        </div>
        
        <div class="config-option">
            <h3>Empresa</h3>
            <div class="form-group">
                <label for="nombre-empresa">Nombre de la Empresa:</label>
                <input type="text" id="nombre-empresa" value="MI EMPRESA">
            </div>
            <div class="form-group">
                <label for="rif-empresa">RIF:</label>
                <input type="text" id="rif-empresa" value="J-123456789">
            </div>
            <div class="form-group">
                <label for="telefono-empresa">Tel√©fono:</label>
                <input type="text" id="telefono-empresa" value="(123) 456-7890">
            </div>
            <div class="form-group">
                <label for="direccion-empresa">Direcci√≥n:</label>
                <textarea id="direccion-empresa">Av. Principal, Local #123</textarea>
            </div>
            <button class="btn btn-success" onclick="guardarConfiguracionEmpresa()">Guardar Configuraci√≥n</button>
        </div>
        
        <div class="config-option">
            <h3>Acerca de</h3>
            <p>Gestor Empresarial M√≥vil v1.1</p>
            <p>Desarrollado por @felinuxs</p>
        </div>
    </div>

    <div class="modal" id="modal-nuevo-cliente">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Nuevo Cliente</h3>
                <button class="modal-close" onclick="cerrarModal('modal-nuevo-cliente')">&times;</button>
            </div>
            <form id="form-nuevo-cliente">
                <div class="form-group">
                    <label for="nombre-cliente-modal">Nombre:</label>
                    <input type="text" id="nombre-cliente-modal" class="capitalize" required>
                </div>
                <div class="form-group">
                    <label for="telefono-cliente-modal">Tel√©fono:</label>
                    <input type="text" id="telefono-cliente-modal">
                </div>
                <div class="form-group">
                    <label for="email-cliente-modal">Email:</label>
                    <input type="email" id="email-cliente-modal">
                </div>
                <div class="form-group">
                    <label for="direccion-cliente-modal">Direcci√≥n:</label>
                    <textarea id="direccion-cliente-modal" class="capitalize"></textarea>
                </div>
                <button type="submit" class="btn btn-success">Guardar Cliente</button>
            </form>
        </div>
    </div>

    <div class="modal" id="modal-agregar-producto">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="titulo-modal-producto">Agregar Producto</h3>
                <button class="modal-close" onclick="cerrarModal('modal-agregar-producto')">&times;</button>
            </div>
            <form id="form-agregar-producto">
                <div class="form-group">
                    <label for="nombre-producto">Nombre:</label>
                    <input type="text" id="nombre-producto" class="capitalize">
                </div>
                <div class="form-group">
                    <label for="precio-usd-producto">Precio USD:</label>
                    <input type="number" id="precio-usd-producto" step="0.01" min="0" oninput="calcularPrecioBs()">
                </div>
                <div class="form-group">
                    <label for="precio-bs-producto">Precio Bs:</label>
                    <input type="number" id="precio-bs-producto" step="0.01" min="0" readonly>
                </div>
                <div class="form-group">
                    <label for="stock-producto">Stock:</label>
                    <input type="number" id="stock-producto" min="0">
                </div>
                <button type="submit" class="btn btn-success">Guardar Producto</button>
            </form>
        </div>
    </div>

    <div class="modal" id="modal-agregar-proveedor">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Agregar Proveedor</h3>
                <button class="modal-close" onclick="cerrarModal('modal-agregar-proveedor')">&times;</button>
            </div>
            <form id="form-agregar-proveedor">
                <div class="form-group">
                    <label for="nombre-proveedor">Nombre:</label>
                    <input type="text" id="nombre-proveedor" class="capitalize" required>
                </div>
                <div class="form-group">
                    <label for="contacto-proveedor">Persona de Contacto:</label>
                    <input type="text" id="contacto-proveedor" class="capitalize">
                </div>
                <div class="form-group">
                    <label for="telefono-proveedor">Tel√©fono:</label>
                    <input type="text" id="telefono-proveedor">
                </div>
                <div class="form-group">
                    <label for="email-proveedor">Email:</label>
                    <input type="email" id="email-proveedor">
                </div>
                <div class="form-group">
                    <label for="productos-proveedor">Productos que suministra:</label>
                    <textarea id="productos-proveedor" class="capitalize"></textarea>
                </div>
                <button type="submit" class="btn btn-success">Guardar Proveedor</button>
            </form>
        </div>
    </div>

    <div class="modal" id="modal-agregar-gasto">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Registrar Gasto</h3>
                <button class="modal-close" onclick="cerrarModal('modal-agregar-gasto')">&times;</button>
            </div>
            <form id="form-agregar-gasto">
                <div class="form-group">
                    <label for="descripcion-gasto">Descripci√≥n:</label>
                    <input type="text" id="descripcion-gasto" class="capitalize" required>
                </div>
                <div class="form-group">
                    <label for="categoria-gasto">Categor√≠a:</label>
                    <select id="categoria-gasto">
                        <option value="oficina">Oficina</option>
                        <option value="servicios">Servicios</option>
                        <option value="impuestos">Impuestos</option>
                        <option value="n√≥mina">N√≥mina</option>
                        <option value="otros">Otros</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="monto-gasto">Monto (Bs):</label>
                    <input type="number" id="monto-gasto" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label for="fecha-gasto">Fecha:</label>
                    <input type="date" id="fecha-gasto" required>
                </div>
                <button type="submit" class="btn btn-success">Registrar Gasto</button>
            </form>
        </div>
    </div>

    <div class="modal" id="modal-agregar-empleado">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Agregar Empleado</h3>
                <button class="modal-close" onclick="cerrarModal('modal-agregar-empleado')">&times;</button>
            </div>
            <form id="form-agregar-empleado">
                <div class="form-group">
                    <label for="nombre-empleado">Nombre:</label>
                    <input type="text" id="nombre-empleado" class="capitalize" required>
                </div>
                <div class="form-group">
                    <label for="cargo-empleado">Cargo:</label>
                    <input type="text" id="cargo-empleado" class="capitalize">
                </div>
                <div class="form-group">
                    <label for="salario-empleado">Salario (Bs):</label>
                    <input type="number" id="salario-empleado" step="0.01" min="0">
                </div>
                <div class="form-group">
                    <label for="telefono-empleado">Tel√©fono:</label>
                    <input type="text" id="telefono-empleado">
                </div>
                <div class="form-group">
                    <label for="fecha-contracto">Fecha de Contrato:</label>
                    <input type="date" id="fecha-contracto">
                </div>
                <button type="submit" class="btn btn-success">Guardar Empleado</button>
            </form>
        </div>
    </div>

    <div class="modal" id="modal-factura">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Factura</h3>
                <button class="modal-close" onclick="cerrarModal('modal-factura')">&times;</button>
            </div>
            <div class="factura-termica" id="area-factura">
                <div class="factura-header">
                    <h3 id="nombre-empresa-factura">MI EMPRESA</h3>
                    <p>RIF: <span id="rif-empresa-factura">J-123456789</span></p>
                    <p>Tel√©fono: <span id="telefono-empresa-factura">(123) 456-7890</span></p>
                    <p>Fecha: <span id="factura-fecha"></span></p>
                </div>
                
                <div class="factura-cliente">
                    <p><strong>Cliente:</strong> <span id="factura-cliente-nombre"></span></p>
                </div>
                
                <table class="factura-items">
                    <thead>
                        <tr>
                            <th>Producto</th>
                            <th>Cant</th>
                            <th>Precio</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody id="factura-items-body">
                    </tbody>
                </table>
                
                <div class="factura-total">
                    <p>Total: <span id="factura-total"></span></p>
                </div>
                
                <div class="factura-footer">
                    <p>¬°Gracias por su compra!</p>
                </div>
            </div>
            <div class="exportar-factura">
                <button class="btn btn-primary" onclick="mostrarOpcionesExportacion()">Exportar/Imprimir Factura</button>
            </div>
        </div>
    </div>

    <div class="modal" id="modal-salida">
        <div class="modal-content">
            <div class="modal-header">
                <h3>¬øEliminar todos los datos?</h3>
            </div>
            <p>¬øEst√° seguro que desea eliminar todos los datos? Esta acci√≥n no se puede deshacer.</p>
            <div class="botones-confirmacion">
                <button class="btn btn-danger" onclick="eliminarTodosDatos()">S√≠, eliminar</button>
                <button class="btn btn-primary" onclick="cerrarModal('modal-salida')">Cancelar</button>
            </div>
        </div>
    </div>

    <div class="modal-exportacion" id="modal-exportar">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Exportar Factura</h3>
                <button class="modal-close" onclick="cerrarModal('modal-exportar')">&times;</button>
            </div>
            
            <div class="opcion-exportacion" onclick="imprimirFactura()">
                <div class="icono-exportacion">üñ®Ô∏è</div>
                <div class="texto-exportacion">
                    <h4>Imprimir (T√©rmica 80mm)</h4>
                    <p>Imprimir factura directamente</p>
                </div>
            </div>
            
            <div class="opcion-exportacion" onclick="exportarFacturaComo('PDF')">
                <div class="icono-exportacion">üìÑ</div>
                <div class="texto-exportacion">
                    <h4>Exportar a PDF</h4>
                    <p>Guardar como documento PDF</p>
                </div>
            </div>
            
            <div class="opcion-exportacion" onclick="exportarFacturaComo('JPEG')">
                <div class="icono-exportacion">üñºÔ∏è</div>
                <div class="texto-exportacion">
                    <h4>Exportar a JPEG</h4>
                    <p>Guardar como imagen JPEG</p>
                </div>
            </div>
            
            <div class="opcion-exportacion" onclick="exportarFacturaComo('TXT')">
                <div class="icono-exportacion">üìù</div>
                <div class="texto-exportacion">
                    <h4>Exportar a TXT</h4>
                    <p>Guardar como archivo de texto</p>
                </div>
            </div>

            <div class="opcion-exportacion" onclick="exportarFacturaComo('Excel')">
                <div class="icono-exportacion">üìä</div>
                <div class="texto-exportacion">
                    <h4>Exportar a Excel</h4>
                    <p>Guardar como hoja de c√°lculo</p>
                </div>
            </div>
            
            <div class="opcion-exportacion" onclick="mostrarFormularioEmail()">
                <div class="icono-exportacion">üìß</div>
                <div class="texto-exportacion">
                    <h4>Enviar por Email</h4>
                    <p>Enviar factura por correo electr√≥nico</p>
                </div>
            </div>
            
            <div class="opcion-exportacion" onclick="mostrarFormularioSMS()">
                <div class="icono-exportacion">üí¨</div>
                <div class="texto-exportacion">
                    <h4>Enviar por SMS</h4>
                    <p>Enviar factura por mensaje de texto</p>
                </div>
            </div>
            
            <div id="formulario-email" class="formulario-envio" style="display: none;">
                <div class="form-group">
                    <label for="email-destino">Email destino:</label>
                    <input type="email" id="email-destino" placeholder="correo@ejemplo.com">
                </div>
                <div class="botones-envio">
                    <button class="btn btn-primary" onclick="enviarFacturaEmail()">Enviar</button>
                    <button class="btn btn-danger" onclick="ocultarFormularios()">Cancelar</button>
                </div>
            </div>
            
            <div id="formulario-sms" class="formulario-envio" style="display: none;">
                <div class="form-group">
                    <label for="telefono-destino">Tel√©fono destino:</label>
                    <input type="tel" id="telefono-destino" placeholder="+1234567890">
                </div>
                <div class="botones-envio">
                    <button class="btn btn-primary" onclick="enviarFacturaSMS()">Enviar</button>
                    <button class="btn btn-danger" onclick="ocultarFormularios()">Cancelar</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== FUNCIONES DE UTILIDAD (NUEVAS) =====
        function redondearPrecioBs(precio) {
            // Redondea al 0.50 m√°s cercano
            return Math.round(precio * 2) / 2;
        }

        function formatearBs(numero) {
            if (typeof numero !== 'number') {
                numero = parseFloat(numero) || 0;
            }
            // Crea el formato 1.250,00 Bs
            const formato = new Intl.NumberFormat('es-VE', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(numero);
            return formato + ' Bs';
        }

        // ===== DATOS DE EJEMPLO =====
        let inventario = JSON.parse(localStorage.getItem('inventario')) || [
            {
                id: 1,
                nombre: "Maxicaucho",
                precioUSD: 9.00,
                precioBs: 80.64,
                stock: 10
            }
        ];

        let clientes = JSON.parse(localStorage.getItem('clientes')) || [
            {
                id: 1,
                nombre: "Juan P√©rez",
                telefono: "12345678",
                email: "juan@email.com",
                direccion: "Av. Siempre Viva 123"
            }
        ];

        let proveedores = JSON.parse(localStorage.getItem('proveedores')) || [
            {
                id: 1,
                nombre: "Distribuidora ABC",
                contacto: "Mar√≠a Gonz√°lez",
                telefono: "98765432",
                email: "contacto@distribuidoraabc.com",
                productos: "Materiales de oficina"
            }
        ];

        let gastos = JSON.parse(localStorage.getItem('gastos')) || [
            {
                id: 1,
                descripcion: "Papeler√≠a",
                categoria: "oficina",
                monto: 150.50,
                fecha: "2023-05-15"
            }
        ];

        let empleados = JSON.parse(localStorage.getItem('empleados')) || [
            {
                id: 1,
                nombre: "Carlos Rodr√≠guez",
                cargo: "Vendedor",
                salario: 1200.00,
                telefono: "5551234",
                fechaContrato: "2023-01-10"
            }
        ];

        let mensajes = JSON.parse(localStorage.getItem('mensajes')) || [
            {
                id: 1,
                remitente: "Sistema",
                asunto: "Bienvenido al Gestor Empresarial",
                contenido: "Su sistema ha sido configurado correctamente.",
                fecha: "2023-05-01",
                leido: false,
                importante: true
            }
        ];

        let tipoCambio = parseFloat(localStorage.getItem('tipoCambio')) || 168;
        let historialTipoCambio = JSON.parse(localStorage.getItem('historialTipoCambio')) || [
            { fecha: "2023-05-01", tasa: 168 }
        ];

        let configuracion = JSON.parse(localStorage.getItem('configuracion')) || {
            tema: "claro",
            empresa: {
                nombre: "MI EMPRESA",
                rif: "J-123456789",
                telefono: "(123) 456-7890",
                direccion: "Av. Principal, Local #123"
            }
        };

        const TEMA_COLORS = {
            claro: '#3498db',
            oscuro: '#2980b9',
            negro: '#343a40',
            verde: '#27ae60',
            amarillo: '#f39c12',
            naranja: '#e67e22',
            rosado: '#e84393'
        };

        let ventaActual = {
            cliente: null,
            productos: [],
            totalUSD: 0,
            totalBs: 0,
            metodoPago: 'Pagom√≥vil',
            timestamp: null
        };

        let prevencionCierreActiva = false;
        let fechaCalendario = new Date();


        // ===== INICIALIZACI√ìN =====
        document.addEventListener('DOMContentLoaded', function() {
            aplicarTema(); // Aplicar tema al cargar la p√°gina
            
            cargarInventario();
            cargarClientes();
            cargarProveedores();
            cargarGastos();
            cargarEmpleados();
            cargarMensajes();
            configurarBuscadorGlobal();
            configurarBuscadoresModulos();
            actualizarTipoCambioVisual();
            
            document.getElementById('form-nuevo-cliente').addEventListener('submit', function(e) {
                e.preventDefault();
                guardarNuevoClienteDesdeModal();
            });
            
            document.getElementById('form-agregar-producto').addEventListener('submit', function(e) {
                e.preventDefault();
                guardarNuevoProducto();
            });
            
            document.getElementById('form-agregar-proveedor').addEventListener('submit', function(e) {
                e.preventDefault();
                guardarNuevoProveedor();
            });
            
            document.getElementById('form-agregar-gasto').addEventListener('submit', function(e) {
                e.preventDefault();
                guardarNuevoGasto();
            });
            
            document.getElementById('form-agregar-empleado').addEventListener('submit', function(e) {
                e.preventDefault();
                guardarNuevoEmpleado();
            });
            
            document.querySelectorAll('input[type="text"], textarea').forEach(input => {
                input.addEventListener('input', function() {
                    if (this.value.length === 1) {
                        this.value = this.value.charAt(0).toUpperCase() + this.value.slice(1);
                    }
                });
            });
            
            const hoy = new Date().toISOString().split('T')[0];
            document.getElementById('fecha-gasto').value = hoy;
            document.getElementById('fecha-contracto').value = hoy;
            document.getElementById('fecha-inicio').value = hoy;
            document.getElementById('fecha-fin').value = hoy;

            document.getElementById('mes-anterior-btn').addEventListener('click', () => {
                fechaCalendario.setMonth(fechaCalendario.getMonth() - 1);
                generarCalendario(fechaCalendario.getFullYear(), fechaCalendario.getMonth());
            });
            document.getElementById('mes-siguiente-btn').addEventListener('click', () => {
                fechaCalendario.setMonth(fechaCalendario.getMonth() + 1);
                generarCalendario(fechaCalendario.getFullYear(), fechaCalendario.getMonth());
            });

            obtenerTipoCambioReal();
        });

        // ===== PWA Service Worker Registration =====
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => console.log('ServiceWorker registrado con √©xito: ', registration.scope))
                    .catch(err => console.log('Fallo en el registro de ServiceWorker: ', err));
            });
        }

        async function obtenerTipoCambioReal() {
            try {
                const response = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
                if (!response.ok) {
                    throw new Error('No se pudo obtener la tasa de cambio');
                }
                const data = await response.json();
                const tasaVES = data.rates.VES;
                
                if (tasaVES) {
                    tipoCambio = parseFloat(tasaVES);
                    historialTipoCambio.push({ fecha: new Date().toISOString(), tasa: tipoCambio });
                    localStorage.setItem('tipoCambio', tipoCambio);
                    localStorage.setItem('historialTipoCambio', JSON.stringify(historialTipoCambio));
                    inventario.forEach(p => { p.precioBs = redondearPrecioBs(p.precioUSD * tipoCambio); });
                    localStorage.setItem('inventario', JSON.stringify(inventario));
                    actualizarTipoCambioVisual();
                    cargarHistorialTipoCambio();
                    console.log(`Tipo de cambio actualizado a: ${tipoCambio}`);
                }
            } catch (error) {
                console.error("Error al obtener el tipo de cambio:", error);
                alert("No se pudo conectar al servicio de tipo de cambio. Se usar√° la √∫ltima tasa guardada.");
            }
        }

        // ===== FUNCIONES DE EXPORTACI√ìN =====
        function mostrarOpcionesExportacion() {
            if (ventaActual.productos.length === 0) {
                alert('No hay productos en la venta para generar una factura.');
                return;
            }
            mostrarFactura();
            mostrarModal('modal-exportar');
        }

        function ocultarFormularios() {
            document.getElementById('formulario-email').style.display = 'none';
            document.getElementById('formulario-sms').style.display = 'none';
        }

        function mostrarFormularioEmail() {
            ocultarFormularios();
            document.getElementById('formulario-email').style.display = 'block';
        }

        function mostrarFormularioSMS() {
            ocultarFormularios();
            document.getElementById('formulario-sms').style.display = 'block';
        }

        function imprimirFactura() {
            const contenido = document.getElementById('area-factura').innerHTML;
            const ventana = window.open('', '_blank');
            
            ventana.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Factura - ${configuracion.empresa.nombre}</title>
                    <style>
                        body { 
                            font-family: 'Courier New', monospace; 
                            font-size: 12px; 
                            line-height: 1.2;
                            margin: 0;
                            padding: 0;
                            width: 80mm;
                        }
                        .factura-termica { width: 100%; padding: 10px; }
                        .factura-header { text-align: center; margin-bottom: 10px; border-bottom: 1px dashed #000; padding-bottom: 10px; }
                        .factura-items { width: 100%; border-collapse: collapse; margin: 10px 0; }
                        .factura-items th, .factura-items td { padding: 4px 0; border-bottom: 1px dashed #ccc; text-align: left; }
                        .factura-total { margin-top: 10px; border-top: 2px solid #000; padding-top: 10px; text-align: right; font-weight: bold; }
                        @media print {
                            body { -webkit-print-color-adjust: exact; }
                        }
                    </style>
                </head>
                <body onload="window.print(); setTimeout(() => window.close(), 500);">
                    <div class="factura-termica">${contenido}</div>
                </body>
                </html>
            `);
            ventana.document.close();
        }

        function exportarFacturaComo(formato) {
            const facturaElement = document.getElementById('area-factura');
            const nombreArchivo = `Factura_${configuracion.empresa.nombre}_${new Date().toISOString().split('T')[0]}`;

            switch(formato) {
                case 'PDF':
                    html2canvas(facturaElement).then(canvas => {
                        const imgData = canvas.toDataURL('image/jpeg', 1.0);
                        const { jsPDF } = window.jspdf;
                        const pdf = new jsPDF('p', 'mm', [80, facturaElement.scrollHeight / 3.5]);
                        pdf.addImage(imgData, 'JPEG', 0, 0, 80, facturaElement.scrollHeight / 3.5);
                        pdf.save(`${nombreArchivo}.pdf`);
                    });
                    break;
                case 'JPEG':
                    html2canvas(facturaElement).then(canvas => {
                        const link = document.createElement('a');
                        link.download = `${nombreArchivo}.jpg`;
                        link.href = canvas.toDataURL('image/jpeg', 0.9);
                        link.click();
                    });
                    break;
                case 'TXT':
                    let txtContent = "";
                    txtContent += `${document.getElementById('nombre-empresa-factura').textContent}\n`;
                    txtContent += `RIF: ${document.getElementById('rif-empresa-factura').textContent}\n`;
                    txtContent += `Tel√©fono: ${document.getElementById('telefono-empresa-factura').textContent}\n`;
                    txtContent += `Fecha: ${document.getElementById('factura-fecha').textContent}\n\n`;
                    txtContent += `Cliente: ${document.getElementById('factura-cliente-nombre').textContent}\n\n`;
                    txtContent += "Producto\tCant\tPrecio\tTotal\n";
                    txtContent += "----------------------------------------\n";
                    ventaActual.productos.forEach(p => {
                        txtContent += `${p.nombre}\t${p.cantidad}\t${p.precioBs.toFixed(2)}\t${(p.precioBs * p.cantidad).toFixed(2)}\n`;
                    });
                    txtContent += "----------------------------------------\n";
                    txtContent += `Total: ${document.getElementById('factura-total').textContent}\n\n`;
                    txtContent += "¬°Gracias por su compra!\n";
                    
                    const blobTxt = new Blob([txtContent], { type: 'text/plain' });
                    const linkTxt = document.createElement('a');
                    linkTxt.href = URL.createObjectURL(blobTxt);
                    linkTxt.download = `${nombreArchivo}.txt`;
                    linkTxt.click();
                    break;
                case 'Excel':
                    const data = ventaActual.productos.map(p => ({
                        Producto: p.nombre,
                        Cantidad: p.cantidad,
                        'Precio Unit. (Bs)': p.precioBs.toFixed(2),
                        'Total (Bs)': (p.precioBs * p.cantidad).toFixed(2)
                    }));
                    data.push({});
                    data.push({ 'Total (Bs)': ventaActual.totalBs.toFixed(2) });

                    const worksheet = XLSX.utils.json_to_sheet(data);
                    const workbook = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(workbook, worksheet, 'Factura');
                    XLSX.writeFile(workbook, `${nombreArchivo}.xlsx`);
                    break;
            }
            alert(`Factura exportada como ${formato} correctamente`);
        }
        
        function enviarFacturaEmail() {
            const email = document.getElementById('email-destino').value;
            if (!email || !email.includes('@')) {
                alert('Por favor ingrese un email v√°lido');
                return;
            }
            html2canvas(document.querySelector('.factura-termica')).then(canvas => {
                alert(`Factura enviada por email a: ${email}\n\n(Simulaci√≥n: En una app real, la imagen de la factura se adjuntar√≠a y enviar√≠a).`);
                cerrarModal('modal-exportar');
            });
        }

        function enviarFacturaSMS() {
            const telefono = document.getElementById('telefono-destino').value;
            if (!telefono) {
                alert('Por favor ingrese un n√∫mero de tel√©fono');
                return;
            }
            alert(`Factura enviada por SMS al n√∫mero: ${telefono}\n\n(Simulaci√≥n: En una app real, se enviar√≠a un enlace a la factura).`);
            cerrarModal('modal-exportar');
        }

        // ===== FUNCIONES DE P√ÅGINAS =====
        function abrirPagina(paginaId) {
            document.querySelectorAll('.nueva-pagina').forEach(pagina => {
                pagina.style.display = 'none';
            });
            document.getElementById(`pagina-${paginaId}`).style.display = 'block';
            
            switch(paginaId) {
                case 'inventario': cargarInventario(); break;
                case 'ventas': reiniciarVenta(); break;
                case 'clientes': cargarClientes(); break;
                case 'proveedores': cargarProveedores(); break;
                case 'gastos': cargarGastos(); break;
                case 'empleados': cargarEmpleados(); break;
                case 'tipo-cambio': cargarHistorialTipoCambio(); break;
                case 'mensajes': cargarMensajes(); break;
                case 'reportes':
                    fechaCalendario = new Date();
                    generarCalendario(fechaCalendario.getFullYear(), fechaCalendario.getMonth());
                    break;
                case 'config': cargarConfiguracion(); break;
            }
        }

        function cerrarPagina(paginaId) {
            document.getElementById(`pagina-${paginaId}`).style.display = 'none';
        }

        // ===== PREVENCI√ìN DE CIERRE =====
        function activarPrevencionCierre() {
            prevencionCierreActiva = true;
            document.getElementById('estado-prevencion').textContent = 'Estado: Activo';
            window.history.pushState(null, null, window.location.href);
            window.addEventListener('popstate', function() {
                window.history.pushState(null, null, window.location.href);
                alert('La prevenci√≥n de cierre est√° activada. Use el bot√≥n de cerrar en la aplicaci√≥n.');
            });
            window.addEventListener('beforeunload', function(e) {
                if (prevencionCierreActiva) {
                    e.preventDefault();
                    e.returnValue = '';
                    return '';
                }
            });
            alert('Prevenci√≥n de cierre activada. La aplicaci√≥n no se cerrar√° accidentalmente.');
        }

        function desactivarPrevencionCierre() {
            prevencionCierreActiva = false;
            document.getElementById('estado-prevencion').textContent = 'Estado: Inactivo';
            alert('Prevenci√≥n de cierre desactivada.');
        }

        // ===== FUNCIONES PARA MODALES =====
        function mostrarModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }

        function cerrarModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // ===== B√öSQUEDA GLOBAL =====
        function configurarBuscadorGlobal() {
            const buscador = document.getElementById('buscador-global');
            const resultados = document.getElementById('resultados-busqueda');
            
            buscador.addEventListener('input', function() {
                const query = this.value.toLowerCase().trim();
                if (query.length < 2) {
                    resultados.style.display = 'none';
                    return;
                }
                const resultadosInventario = buscarEnInventario(query);
                const resultadosClientes = buscarEnClientes(query);
                const resultadosProveedores = buscarEnProveedores(query);
                
                const todosResultados = [
                    ...resultadosInventario.map(item => ({...item, tipo: 'producto'})),
                    ...resultadosClientes.map(item => ({...item, tipo: 'cliente'})),
                    ...resultadosProveedores.map(item => ({...item, tipo: 'proveedor'}))
                ];
                mostrarResultadosBusquedaGlobal(todosResultados, resultados);
            });
        }

        function configurarBuscadoresModulos() {
            document.getElementById('buscador-clientes').addEventListener('input', function() {
                const query = this.value.toLowerCase().trim();
                buscarYMostrarResultados(query, buscarEnClientes, document.getElementById('resultados-clientes'), 'clientes');
            });
            document.getElementById('buscador-cliente-venta').addEventListener('input', function() {
                const query = this.value.toLowerCase().trim();
                buscarYMostrarResultados(query, buscarEnClientes, document.getElementById('resultados-cliente-venta'), 'cliente-venta');
            });
            document.getElementById('buscador-producto-venta').addEventListener('input', function() {
                const query = this.value.toLowerCase().trim();
                buscarYMostrarResultados(query, buscarEnInventario, document.getElementById('resultados-producto-venta'), 'producto-venta');
            });
            document.getElementById('buscador-inventario').addEventListener('input', function() {
                const query = this.value.toLowerCase().trim();
                buscarYMostrarResultados(query, buscarEnInventario, document.getElementById('resultados-inventario'), 'inventario');
            });
            document.getElementById('buscador-proveedores').addEventListener('input', function() {
                const query = this.value.toLowerCase().trim();
                buscarYMostrarResultados(query, buscarEnProveedores, document.getElementById('resultados-proveedores'), 'proveedores');
            });
            document.getElementById('buscador-empleados').addEventListener('input', function() {
                const query = this.value.toLowerCase().trim();
                buscarYMostrarResultados(query, buscarEnEmpleados, document.getElementById('resultados-empleados'), 'empleados');
            });
        }

        function buscarYMostrarResultados(query, funcionBusqueda, contenedorResultados, contexto) {
            if (query.length < 2) {
                contenedorResultados.style.display = 'none';
                return;
            }
            const resultados = funcionBusqueda(query);
            mostrarResultadosBusqueda(resultados, contenedorResultados, contexto);
        }

        // ===== FUNCIONES DE B√öSQUEDA =====
        function buscarEnInventario(query) {
            return inventario.filter(item => item.nombre.toLowerCase().includes(query));
        }
        function buscarEnClientes(query) {
            return clientes.filter(item => 
                item.nombre.toLowerCase().includes(query) || 
                (item.email && item.email.toLowerCase().includes(query)) ||
                (item.telefono && item.telefono.includes(query))
            );
        }
        function buscarEnProveedores(query) {
            return proveedores.filter(item => 
                item.nombre.toLowerCase().includes(query) || 
                (item.contacto && item.contacto.toLowerCase().includes(query)) ||
                (item.productos && item.productos.toLowerCase().includes(query))
            );
        }
        function buscarEnEmpleados(query) {
            return empleados.filter(item => 
                item.nombre.toLowerCase().includes(query) || 
                (item.cargo && item.cargo.toLowerCase().includes(query))
            );
        }

        // ===== MOSTRAR RESULTADOS DE B√öSQUEDA =====
        function mostrarResultadosBusquedaGlobal(resultados, contenedor) {
            contenedor.innerHTML = '';
            if (resultados.length === 0) {
                contenedor.innerHTML = '<div class="search-result-item">No se encontraron resultados</div>';
                contenedor.style.display = 'block';
                return;
            }
            resultados.forEach(item => {
                const elemento = document.createElement('div');
                elemento.className = 'search-result-item';
                elemento.innerHTML = `
                    <div>${item.nombre} (${item.tipo})</div>
                    <div class="result-actions">
                        <button class="result-btn btn-add" onclick="venderDesdeBusqueda('${item.tipo}', ${item.id})">Vender</button>
                        <button class="result-btn btn-edit" onclick="editarDesdeBusqueda('${item.tipo}', ${item.id})">Editar</button>
                    </div>
                `;
                contenedor.appendChild(elemento);
            });
            contenedor.style.display = 'block';
        }

        function mostrarResultadosBusqueda(resultados, contenedor, contexto = 'global') {
            contenedor.innerHTML = '';
            if (resultados.length === 0) {
                contenedor.innerHTML = '<div class="search-result-item">No se encontraron resultados</div>';
                contenedor.style.display = 'block';
                return;
            }
            resultados.forEach(item => {
                const elemento = document.createElement('div');
                elemento.className = 'search-result-item';
                let acciones = '';
                
                if (contexto === 'cliente-venta') {
                    elemento.onclick = () => seleccionarCliente(item.id);
                    acciones = `<div class="result-actions"><button class="result-btn btn-add">Seleccionar</button></div>`;
                } else if (contexto === 'producto-venta') {
                    elemento.onclick = () => agregarProductoVenta(item.id);
                    acciones = `<div class="result-actions"><button class="result-btn btn-add">Agregar</button></div>`;
                }
                
                elemento.innerHTML = `<div>${item.nombre}</div>${acciones}`;
                contenedor.appendChild(elemento);
            });
            contenedor.style.display = 'block';
        }

        // ===== FUNCIONES DESDE B√öSQUEDA =====
        function venderDesdeBusqueda(tipo, id) {
            abrirPagina('ventas');
            setTimeout(() => {
                if (tipo === 'producto') agregarProductoVenta(id);
                else if (tipo === 'cliente') seleccionarCliente(id);
            }, 100);
            document.getElementById('resultados-busqueda').style.display = 'none';
            document.getElementById('buscador-global').value = '';
        }

        function editarDesdeBusqueda(tipo, id) {
            if (tipo === 'producto') {
                abrirPagina('inventario');
                setTimeout(() => editarProducto(id), 100);
            } else if (tipo === 'cliente') {
                abrirPagina('clientes');
                setTimeout(() => editarCliente(id), 100);
            } else if (tipo === 'proveedor') {
                abrirPagina('proveedores');
                setTimeout(() => editarProveedor(id), 100);
            }
            document.getElementById('resultados-busqueda').style.display = 'none';
            document.getElementById('buscador-global').value = '';
        }

        // ===== FUNCIONES PARA VENTAS =====
        function seleccionarCliente(id) {
            const cliente = clientes.find(c => c.id === id);
            if (cliente) {
                ventaActual.cliente = cliente;
                document.getElementById('buscador-cliente-venta').value = cliente.nombre;
                document.getElementById('resultados-cliente-venta').style.display = 'none';
            }
        }

        function agregarProductoVenta(id) {
            const producto = inventario.find(p => p.id === id);
            if (producto) {
                const existente = ventaActual.productos.find(p => p.id === id);
                if (existente) {
                    existente.cantidad += 1;
                } else {
                    ventaActual.productos.push({ ...producto, cantidad: 1 });
                }
                actualizarProductosVenta();
                document.getElementById('buscador-producto-venta').value = '';
                document.getElementById('resultados-producto-venta').style.display = 'none';
            }
        }

        function actualizarProductosVenta() {
            const contenedor = document.getElementById('productos-seleccionados');
            contenedor.innerHTML = '';
            ventaActual.productos.forEach(producto => {
                const elemento = document.createElement('div');
                elemento.className = 'producto-venta';
                const subtotalBs = producto.precioBs * producto.cantidad;
                elemento.innerHTML = `
                    <div class="producto-info">
                        <strong>${producto.nombre}</strong>
                        <div>Cantidad: ${producto.cantidad}</div>
                        <div>Precio: ${formatearBs(producto.precioBs)}</div>
                        <div>Subtotal: ${formatearBs(subtotalBs)}</div>
                    </div>
                    <div class="producto-acciones">
                        <button class="btn btn-primary" onclick="modificarCantidad(${producto.id}, 1)">+</button>
                        <button class="btn btn-warning" onclick="modificarCantidad(${producto.id}, -1)">-</button>
                        <button class="btn btn-danger" onclick="eliminarProductoVenta(${producto.id})">X</button>
                    </div>
                `;
                contenedor.appendChild(elemento);
            });
            calcularTotalVenta();
        }

        function modificarCantidad(id, cambio) {
            const producto = ventaActual.productos.find(p => p.id === id);
            if (producto) {
                producto.cantidad += cambio;
                if (producto.cantidad <= 0) {
                    eliminarProductoVenta(id);
                } else {
                    actualizarProductosVenta();
                }
            }
        }

        function eliminarProductoVenta(id) {
            ventaActual.productos = ventaActual.productos.filter(p => p.id !== id);
            actualizarProductosVenta();
        }

        function calcularTotalVenta() {
            let subtotalBs = 0;
            ventaActual.productos.forEach(producto => {
                subtotalBs += producto.precioBs * producto.cantidad;
            });
            ventaActual.totalBs = subtotalBs;
            document.getElementById('total-bs').textContent = formatearBs(subtotalBs);
        }

        function finalizarVenta() {
            if (ventaActual.productos.length === 0) {
                alert('Debe agregar al menos un producto a la venta');
                return;
            }
            
            for (const productoVenta of ventaActual.productos) {
                const productoInventario = inventario.find(p => p.id === productoVenta.id);
                if (productoInventario && productoInventario.stock < productoVenta.cantidad) {
                    alert(`No hay suficiente stock de ${productoInventario.nombre}. Stock disponible: ${productoInventario.stock}`);
                    return;
                }
            }
            
            ventaActual.productos.forEach(productoVenta => {
                const productoInventario = inventario.find(p => p.id === productoVenta.id);
                if (productoInventario) {
                    productoInventario.stock -= productoVenta.cantidad;
                }
            });
            
            localStorage.setItem('inventario', JSON.stringify(inventario));
            
            const ventas = JSON.parse(localStorage.getItem('ventas')) || [];
            ventas.push({
                id: Date.now(),
                timestamp: Date.now(),
                cliente: ventaActual.cliente,
                productos: ventaActual.productos,
                totalBs: ventaActual.totalBs,
                metodoPago: document.getElementById('metodo-pago').value
            });
            localStorage.setItem('ventas', JSON.stringify(ventas));
            
            alert('Venta registrada con √©xito');
            mostrarFactura();
            reiniciarVenta();
        }

        function reiniciarVenta() {
            ventaActual = {
                cliente: null,
                productos: [],
                totalBs: 0,
                metodoPago: 'Pagom√≥vil',
                timestamp: null
            };
            document.getElementById('buscador-cliente-venta').value = '';
            document.getElementById('buscador-producto-venta').value = '';
            document.getElementById('productos-seleccionados').innerHTML = '';
            calcularTotalVenta();
        }

        function mostrarFactura() {
            if (ventaActual.productos.length === 0) {
                alert('No hay productos en la venta actual');
                return;
            }
            
            document.getElementById('factura-fecha').textContent = new Date().toLocaleString();
            document.getElementById('factura-cliente-nombre').textContent = ventaActual.cliente ? ventaActual.cliente.nombre : 'Cliente General';
            document.getElementById('nombre-empresa-factura').textContent = configuracion.empresa.nombre;
            document.getElementById('rif-empresa-factura').textContent = configuracion.empresa.rif;
            document.getElementById('telefono-empresa-factura').textContent = configuracion.empresa.telefono;
            
            const facturaItemsBody = document.getElementById('factura-items-body');
            facturaItemsBody.innerHTML = '';
            
            ventaActual.productos.forEach(producto => {
                const row = document.createElement('tr');
                const precioUnitario = formatearBs(producto.precioBs).replace(' Bs', '');
                const totalProducto = formatearBs(producto.precioBs * producto.cantidad).replace(' Bs', '');
                row.innerHTML = `
                    <td>${producto.nombre}</td>
                    <td>${producto.cantidad}</td>
                    <td>${precioUnitario}</td>
                    <td>${totalProducto}</td>
                `;
                facturaItemsBody.appendChild(row);
            });
            
            document.getElementById('factura-total').textContent = formatearBs(ventaActual.totalBs);
            
            mostrarModal('modal-factura');
        }

        // ===== FUNCIONES PARA INVENTARIO =====
        function cargarInventario() {
            const tbody = document.querySelector("#tabla-inventario tbody");
            if (!tbody) return;
            tbody.innerHTML = "";
            inventario.forEach((producto) => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${producto.nombre}</td>
                    <td>$${producto.precioUSD.toFixed(2)}</td>
                    <td>${formatearBs(producto.precioBs)}</td>
                    <td>${producto.stock}</td>
                    <td>
                        <div class="acciones-tabla">
                            <button class="btn btn-sell" onclick="venderProducto(${producto.id})">Vender</button>
                            <button class="btn btn-primary" onclick="editarProducto(${producto.id})">Editar</button>
                            <button class="btn btn-danger" onclick="eliminarProducto(${producto.id})">Eliminar</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function venderProducto(id) {
            abrirPagina('ventas');
            setTimeout(() => agregarProductoVenta(id), 100);
        }

        function calcularPrecioBs() {
            const precioUSD = parseFloat(document.getElementById('precio-usd-producto').value) || 0;
            document.getElementById('precio-bs-producto').value = redondearPrecioBs(precioUSD * tipoCambio).toFixed(2);
        }

        function guardarNuevoProducto() {
            const nombre = document.getElementById('nombre-producto').value;
            if (!nombre || nombre.trim() === '') {
                alert('Por favor ingrese un nombre para el producto');
                return;
            }
            const precioUSD = parseFloat(document.getElementById('precio-usd-producto').value) || 0;
            const stock = parseInt(document.getElementById('stock-producto').value) || 0;
            
            inventario.push({
                id: Date.now(),
                nombre: nombre.trim(),
                precioUSD: precioUSD,
                precioBs: redondearPrecioBs(precioUSD * tipoCambio),
                stock: stock
            });
            
            localStorage.setItem('inventario', JSON.stringify(inventario));
            cargarInventario();
            cerrarModal('modal-agregar-producto');
            document.getElementById('form-agregar-producto').reset();
        }

        function editarProducto(id) {
            const producto = inventario.find(p => p.id === id);
            if (!producto) return;
            
            document.getElementById('nombre-producto').value = producto.nombre;
            document.getElementById('precio-usd-producto').value = producto.precioUSD;
            document.getElementById('precio-bs-producto').value = producto.precioBs.toFixed(2);
            document.getElementById('stock-producto').value = producto.stock;
            document.getElementById('titulo-modal-producto').textContent = 'Editar Producto';
            
            mostrarModal('modal-agregar-producto');
            
            const form = document.getElementById('form-agregar-producto');
            form.onsubmit = e => { e.preventDefault(); actualizarProducto(id); };
        }

        function actualizarProducto(id) {
            const index = inventario.findIndex(p => p.id === id);
            if (index === -1) return;
            
            const nombre = document.getElementById('nombre-producto').value;
            const precioUSD = parseFloat(document.getElementById('precio-usd-producto').value) || 0;
            const stock = parseInt(document.getElementById('stock-producto').value) || 0;
            
            inventario[index] = {
                id: id,
                nombre: nombre || 'Producto sin nombre',
                precioUSD: precioUSD,
                precioBs: redondearPrecioBs(precioUSD * tipoCambio),
                stock: stock
            };
            
            localStorage.setItem('inventario', JSON.stringify(inventario));
            cargarInventario();
            cerrarModal('modal-agregar-producto');
            
            const form = document.getElementById('form-agregar-producto');
            form.onsubmit = e => { e.preventDefault(); guardarNuevoProducto(); };
            document.getElementById('titulo-modal-producto').textContent = 'Agregar Producto';
            form.reset();
        }

        function eliminarProducto(id) {
            if (confirm("¬øEst√° seguro de eliminar este producto?")) {
                inventario = inventario.filter(p => p.id !== id);
                localStorage.setItem('inventario', JSON.stringify(inventario));
                cargarInventario();
            }
        }

        // ===== FUNCIONES PARA CLIENTES =====
        function cargarClientes() {
            const tbody = document.querySelector("#tabla-clientes tbody");
            if (!tbody) return;
            tbody.innerHTML = "";
            clientes.forEach((cliente) => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${cliente.nombre}</td>
                    <td>${cliente.telefono || '-'}</td>
                    <td>${cliente.email || '-'}</td>
                    <td>
                        <div class="acciones-tabla">
                            <button class="btn btn-primary" onclick="editarCliente(${cliente.id})">Editar</button>
                            <button class="btn btn-danger" onclick="eliminarCliente(${cliente.id})">Eliminar</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function guardarNuevoClienteDesdeModal() {
            const nombre = document.getElementById('nombre-cliente-modal').value;
            const telefono = document.getElementById('telefono-cliente-modal').value;
            const email = document.getElementById('email-cliente-modal').value;
            const direccion = document.getElementById('direccion-cliente-modal').value;
            
            const nuevoCliente = {
                id: Date.now(),
                nombre: nombre || 'Cliente sin nombre',
                telefono, email, direccion
            };
            
            clientes.push(nuevoCliente);
            localStorage.setItem('clientes', JSON.stringify(clientes));
            
            if (document.getElementById('pagina-ventas').style.display === 'block') {
                seleccionarCliente(nuevoCliente.id);
            }
            
            cerrarModal('modal-nuevo-cliente');
            document.getElementById('form-nuevo-cliente').reset();
        }

        function editarCliente(id) {
            const cliente = clientes.find(c => c.id === id);
            if (!cliente) return;
            
            document.getElementById('nombre-cliente-modal').value = cliente.nombre;
            document.getElementById('telefono-cliente-modal').value = cliente.telefono || '';
            document.getElementById('email-cliente-modal').value = cliente.email || '';
            document.getElementById('direccion-cliente-modal').value = cliente.direccion || '';
            
            mostrarModal('modal-nuevo-cliente');
            
            const form = document.getElementById('form-nuevo-cliente');
            form.onsubmit = e => { e.preventDefault(); actualizarCliente(id); };
        }

        function actualizarCliente(id) {
            const index = clientes.findIndex(c => c.id === id);
            if (index === -1) return;
            
            clientes[index] = {
                id: id,
                nombre: document.getElementById('nombre-cliente-modal').value || 'Cliente sin nombre',
                telefono: document.getElementById('telefono-cliente-modal').value,
                email: document.getElementById('email-cliente-modal').value,
                direccion: document.getElementById('direccion-cliente-modal').value
            };
            
            localStorage.setItem('clientes', JSON.stringify(clientes));
            cargarClientes();
            cerrarModal('modal-nuevo-cliente');
            
            const form = document.getElementById('form-nuevo-cliente');
            form.onsubmit = e => { e.preventDefault(); guardarNuevoClienteDesdeModal(); };
            form.reset();
        }

        function eliminarCliente(id) {
            if (confirm("¬øEst√° seguro de eliminar este cliente?")) {
                clientes = clientes.filter(c => c.id !== id);
                localStorage.setItem('clientes', JSON.stringify(clientes));
                cargarClientes();
            }
        }

        // ===== FUNCIONES PARA PROVEEDORES (ACTUALIZADO) =====
        function cargarProveedores() {
            const tbody = document.querySelector("#tabla-proveedores tbody");
            if (!tbody) return;
            tbody.innerHTML = "";
            proveedores.forEach((proveedor) => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${proveedor.nombre}</td>
                    <td>${proveedor.contacto || '-'}</td>
                    <td>${proveedor.telefono || '-'}</td>
                    <td>
                        <div class="acciones-tabla">
                            <button class="btn btn-primary" onclick="editarProveedor(${proveedor.id})">Editar</button>
                            <button class="btn btn-danger" onclick="eliminarProveedor(${proveedor.id})">Eliminar</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function guardarNuevoProveedor() {
            const nuevoProveedor = {
                id: Date.now(),
                nombre: document.getElementById('nombre-proveedor').value || 'Proveedor sin nombre',
                contacto: document.getElementById('contacto-proveedor').value,
                telefono: document.getElementById('telefono-proveedor').value,
                email: document.getElementById('email-proveedor').value,
                productos: document.getElementById('productos-proveedor').value
            };
            proveedores.push(nuevoProveedor);
            localStorage.setItem('proveedores', JSON.stringify(proveedores));
            cargarProveedores();
            cerrarModal('modal-agregar-proveedor');
            document.getElementById('form-agregar-proveedor').reset();
        }

        function editarProveedor(id) {
            const proveedor = proveedores.find(p => p.id === id);
            if (!proveedor) return;
            
            document.getElementById('nombre-proveedor').value = proveedor.nombre;
            document.getElementById('contacto-proveedor').value = proveedor.contacto || '';
            document.getElementById('telefono-proveedor').value = proveedor.telefono || '';
            document.getElementById('email-proveedor').value = proveedor.email || '';
            document.getElementById('productos-proveedor').value = proveedor.productos || '';
            
            mostrarModal('modal-agregar-proveedor');
            
            const form = document.getElementById('form-agregar-proveedor');
            form.onsubmit = e => { e.preventDefault(); actualizarProveedor(id); };
        }

        function actualizarProveedor(id) {
            const index = proveedores.findIndex(p => p.id === id);
            if (index === -1) return;
            
            proveedores[index] = {
                id: id,
                nombre: document.getElementById('nombre-proveedor').value || 'Proveedor sin nombre',
                contacto: document.getElementById('contacto-proveedor').value,
                telefono: document.getElementById('telefono-proveedor').value,
                email: document.getElementById('email-proveedor').value,
                productos: document.getElementById('productos-proveedor').value
            };
            
            localStorage.setItem('proveedores', JSON.stringify(proveedores));
            cargarProveedores();
            cerrarModal('modal-agregar-proveedor');
            
            const form = document.getElementById('form-agregar-proveedor');
            form.onsubmit = e => { e.preventDefault(); guardarNuevoProveedor(); };
            form.reset();
        }

        function eliminarProveedor(id) {
            if (confirm("¬øEst√° seguro de eliminar este proveedor?")) {
                proveedores = proveedores.filter(p => p.id !== id);
                localStorage.setItem('proveedores', JSON.stringify(proveedores));
                cargarProveedores();
            }
        }
        
        // ===== FUNCIONES PARA GASTOS, EMPLEADOS, MENSAJES... =====
        function cargarGastos() {
            const contenedor = document.getElementById('lista-gastos');
            if (!contenedor) return;
            
            const filtroMes = document.getElementById('filtro-fecha-gastos').value || new Date().toISOString().slice(0, 7);
            document.getElementById('filtro-fecha-gastos').value = filtroMes;
            const gastosFiltrados = gastos.filter(g => g.fecha.startsWith(filtroMes));
            
            contenedor.innerHTML = '';
            gastosFiltrados.forEach(gasto => {
                const elemento = document.createElement('div');
                elemento.className = 'gasto-item card';
                elemento.innerHTML = `
                    <h3>${gasto.descripcion}</h3>
                    <p><strong>Categor√≠a:</strong> ${gasto.categoria}</p>
                    <p><strong>Monto:</strong> ${formatearBs(gasto.monto)}</p>
                    <p><strong>Fecha:</strong> ${new Date(gasto.fecha).toLocaleDateString()}</p>
                `;
                contenedor.appendChild(elemento);
            });
            actualizarResumenGastos(gastosFiltrados);
        }

        function filtrarGastos() { cargarGastos(); }

        function actualizarResumenGastos(gastosFiltrados) {
            const total = gastosFiltrados.reduce((sum, gasto) => sum + gasto.monto, 0);
            document.getElementById('total-gastos').textContent = formatearBs(total);
            const categorias = {};
            gastosFiltrados.forEach(gasto => {
                if (!categorias[gasto.categoria]) categorias[gasto.categoria] = 0;
                categorias[gasto.categoria] += gasto.monto;
            });
            const listaCategorias = document.getElementById('categorias-gastos');
            listaCategorias.innerHTML = '';
            for (const categoria in categorias) {
                const item = document.createElement('li');
                item.textContent = `${categoria}: ${formatearBs(categorias[categoria])}`;
                listaCategorias.appendChild(item);
            }
        }
        function guardarNuevoGasto() {
            const nuevoGasto = {
                id: Date.now(),
                descripcion: document.getElementById('descripcion-gasto').value || 'Gasto sin descripci√≥n',
                categoria: document.getElementById('categoria-gasto').value,
                monto: parseFloat(document.getElementById('monto-gasto').value) || 0,
                fecha: document.getElementById('fecha-gasto').value
            };
            gastos.push(nuevoGasto);
            localStorage.setItem('gastos', JSON.stringify(gastos));
            cargarGastos();
            cerrarModal('modal-agregar-gasto');
            document.getElementById('form-agregar-gasto').reset();
            document.getElementById('fecha-gasto').value = new Date().toISOString().split('T')[0];
        }
        function cargarEmpleados() {
            const contenedor = document.getElementById('lista-empleados');
            if(!contenedor) return;
            contenedor.innerHTML = '';
            empleados.forEach(e => {
                const el = document.createElement('div');
                el.className = 'empleado-item card';
                el.innerHTML = `<h3>${e.nombre}</h3><p><strong>Cargo:</strong> ${e.cargo || 'N/A'}</p>`;
                contenedor.appendChild(el);
            });
        }
        function guardarNuevoEmpleado(){}
        function cargarMensajes() {
            const contenedor = document.getElementById('lista-mensajes');
            if (!contenedor) return;
            contenedor.innerHTML = '';
            mensajes.forEach(m => {
                const el = document.createElement('div');
                el.className = `mensaje-item card ${m.leido ? '' : 'unread'}`;
                el.innerHTML = `<h3>${m.asunto} ${m.importante ? '‚≠ê' : ''}</h3><p><strong>De:</strong> ${m.remitente}</p>`;
                contenedor.appendChild(el);
            });
        }
        function filtrarMensajes(filtro) { alert(`Filtro: ${filtro}`); }

        // ===== FUNCIONES PARA TIPO DE CAMBIO =====
        function actualizarTipoCambioVisual() {
            const tasaFormateada = `1$ = ${formatearBs(tipoCambio)}`;
            document.getElementById('tipo-cambio-btn').textContent = tasaFormateada;
            document.getElementById('tipo-cambio-venta').textContent = tasaFormateada;
            document.getElementById('tipo-cambio-actual').textContent = new Intl.NumberFormat('es-VE', {minimumFractionDigits: 2}).format(tipoCambio);
        }

        function cargarHistorialTipoCambio() {
            const contenedor = document.getElementById('historial-tipo-cambio');
            if (!contenedor) return;
            const ultimaActualizacion = historialTipoCambio[historialTipoCambio.length - 1];
            if (ultimaActualizacion) {
                document.getElementById('fecha-actualizacion').textContent = new Date(ultimaActualizacion.fecha).toLocaleDateString();
            }
            contenedor.innerHTML = '';
            historialTipoCambio.slice().reverse().forEach(item => {
                const el = document.createElement('div');
                el.innerHTML = `<p>${new Date(item.fecha).toLocaleDateString()}: ${formatearBs(item.tasa)}</p>`;
                contenedor.appendChild(el);
            });
        }

        function actualizarTipoCambio() {
            const nuevoTipoCambio = parseFloat(document.getElementById('nuevo-tipo-cambio').value);
            if (isNaN(nuevoTipoCambio) || nuevoTipoCambio <= 0) {
                alert('Por favor ingrese un valor v√°lido para el tipo de cambio');
                return;
            }
            tipoCambio = nuevoTipoCambio;
            historialTipoCambio.push({ fecha: new Date().toISOString(), tasa: tipoCambio });
            localStorage.setItem('tipoCambio', tipoCambio);
            localStorage.setItem('historialTipoCambio', JSON.stringify(historialTipoCambio));
            
            inventario.forEach(p => { p.precioBs = redondearPrecioBs(p.precioUSD * tipoCambio); });
            localStorage.setItem('inventario', JSON.stringify(inventario));
            
            actualizarTipoCambioVisual();
            cargarHistorialTipoCambio();
            alert('Tipo de cambio actualizado correctamente');
        }

        // ===== FUNCIONES PARA REPORTES =====
        function generarCalendario(year, month) {
            const grid = document.getElementById('calendario-grid');
            const titulo = document.getElementById('mes-actual-titulo');
            grid.innerHTML = '';
            
            const primerDia = new Date(year, month, 1);
            const ultimoDia = new Date(year, month + 1, 0);
            
            const nombresMeses = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            titulo.textContent = `${nombresMeses[month]} ${year}`;
            
            const diasSemana = ['Do', 'Lu', 'Ma', 'Mi', 'Ju', 'Vi', 'Sa'];
            diasSemana.forEach(dia => {
                const diaEl = document.createElement('div');
                diaEl.className = 'calendario-dia-nombre';
                diaEl.textContent = dia;
                grid.appendChild(diaEl);
            });

            for (let i = 0; i < primerDia.getDay(); i++) {
                grid.appendChild(document.createElement('div'));
            }
            
            for (let dia = 1; dia <= ultimoDia.getDate(); dia++) {
                const diaEl = document.createElement('div');
                diaEl.className = 'calendario-dia';
                diaEl.textContent = dia;
                const fechaActual = new Date(year, month, dia);

                const hoy = new Date();
                if (fechaActual.toDateString() === hoy.toDateString()) {
                    diaEl.classList.add('dia-actual');
                }

                diaEl.addEventListener('click', () => {
                    document.querySelectorAll('.calendario-dia').forEach(d => d.classList.remove('dia-seleccionado'));
                    diaEl.classList.add('dia-seleccionado');
                    mostrarVentasDelDia(fechaActual);
                });
                grid.appendChild(diaEl);
            }
        }
        
        function formatoFechaDetallado(timestamp) {
            const fecha = new Date(timestamp);
            const opciones = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const hora = fecha.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true }).toLowerCase();
            return `${hora} / ${fecha.toLocaleDateString('es-ES', opciones)}`;
        }

        function mostrarVentasDelDia(fecha) {
            const contenedor = document.getElementById('reporte-diario-container');
            const ventas = JSON.parse(localStorage.getItem('ventas')) || [];
            
            const ventasDelDia = ventas.filter(venta => {
                const fechaVenta = new Date(venta.timestamp);
                return fechaVenta.toDateString() === fecha.toDateString();
            });

            if (ventasDelDia.length === 0) {
                contenedor.innerHTML = `<p>No se encontraron ventas para el ${fecha.toLocaleDateString('es-ES')}.</p>`;
                return;
            }

            let reporteHtml = `<h4>Ventas de ${fecha.toLocaleDateString('es-ES')}</h4>`;
            ventasDelDia.forEach(venta => {
                const productosDesc = venta.productos.map(p => `${p.cantidad} x ${p.nombre}`).join(', ');
                const totalUSD = venta.productos.reduce((acc, p) => acc + p.precioUSD * p.cantidad, 0);

                reporteHtml += `
                    <div class="reporte-item card">
                        <strong>${formatoFechaDetallado(venta.timestamp)}</strong>
                        <p>Venta de ${productosDesc}. Por ${venta.metodoPago} en ${totalUSD.toFixed(2)}$ / ${formatearBs(venta.totalBs)}</p>
                        <p>Cliente: ${venta.cliente ? venta.cliente.nombre : 'General'}</p>
                    </div>
                `;
            });
            contenedor.innerHTML = reporteHtml;
        }

        function generarReporte() {
            alert('Generando reporte general...');
        }

        // ===== FUNCIONES PARA CONFIGURACI√ìN Y TEMAS (ACTUALIZADO) =====
        function aplicarTema() {
            const tema = configuracion.tema || 'claro';
            document.body.className = ''; // Limpiar clases de tema
            if (tema !== 'claro') {
                document.body.classList.add('tema-' + tema);
            }
            document.querySelector('meta[name="theme-color"]').setAttribute('content', TEMA_COLORS[tema]);
        }

        function cambiarTema(nuevoTema) {
            configuracion.tema = nuevoTema;
            localStorage.setItem('configuracion', JSON.stringify(configuracion));
            aplicarTema();
        }

        function cargarConfiguracion() {
            document.getElementById('nombre-empresa').value = configuracion.empresa.nombre;
            document.getElementById('rif-empresa').value = configuracion.empresa.rif;
            document.getElementById('telefono-empresa').value = configuracion.empresa.telefono;
            document.getElementById('direccion-empresa').value = configuracion.empresa.direccion;
            
            document.getElementById('tema-select').value = configuracion.tema || 'claro';
            aplicarTema();
        }

        function guardarConfiguracionEmpresa() {
            configuracion.empresa = {
                nombre: document.getElementById('nombre-empresa').value,
                rif: document.getElementById('rif-empresa').value,
                telefono: document.getElementById('telefono-empresa').value,
                direccion: document.getElementById('direccion-empresa').value
            };
            localStorage.setItem('configuracion', JSON.stringify(configuracion));
            alert('Configuraci√≥n de empresa guardada correctamente');
        }

        function respaldarDatos() {
            const datos = { inventario, clientes, proveedores, gastos, empleados, mensajes, tipoCambio, configuracion, ventas: JSON.parse(localStorage.getItem('ventas')) || [] };
            const datosStr = JSON.stringify(datos, null, 2);
            const blob = new Blob([datosStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `respaldo_gestor_empresarial_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            alert('Respaldo de datos (JSON) generado correctamente');
        }

        function restaurarDatos() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = e => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = e => {
                    try {
                        const datos = JSON.parse(e.target.result);
                        if (confirm("¬øRestaurar desde JSON? Se sobrescribir√°n los datos actuales.")) {
                            inventario = datos.inventario || [];
                            clientes = datos.clientes || [];
                            proveedores = datos.proveedores || [];
                            gastos = datos.gastos || [];
                            empleados = datos.empleados || [];
                            mensajes = datos.mensajes || [];
                            tipoCambio = datos.tipoCambio || 1;
                            configuracion = datos.configuracion || {};

                            localStorage.setItem('inventario', JSON.stringify(inventario));
                            localStorage.setItem('clientes', JSON.stringify(clientes));
                            localStorage.setItem('proveedores', JSON.stringify(proveedores));
                            localStorage.setItem('gastos', JSON.stringify(gastos));
                            localStorage.setItem('empleados', JSON.stringify(empleados));
                            localStorage.setItem('mensajes', JSON.stringify(mensajes));
                            localStorage.setItem('tipoCambio', tipoCambio);
                            localStorage.setItem('configuracion', JSON.stringify(configuracion));
                            localStorage.setItem('ventas', JSON.stringify(datos.ventas || []));

                            alert('Datos restaurados desde JSON correctamente. Recargando...');
                            location.reload();
                        }
                    } catch (error) { alert('Error: El archivo JSON no es v√°lido'); }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function exportarDatosExcel() {
            const wb = XLSX.utils.book_new();
            const ventas = JSON.parse(localStorage.getItem('ventas')) || [];

            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(inventario), "Inventario");
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(clientes), "Clientes");
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(proveedores), "Proveedores");
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(gastos), "Gastos");
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(empleados), "Empleados");
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(ventas), "Ventas");

            XLSX.writeFile(wb, `Respaldo_Gestor_${new Date().toISOString().split('T')[0]}.xlsx`);
            alert('Respaldo de datos (Excel) generado correctamente.');
        }

        function importarDatosExcel() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.xlsx, .xls';
            input.onchange = e => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = e => {
                    try {
                        if (confirm("¬øRestaurar desde Excel? Se sobrescribir√°n los datos actuales.")) {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });

                            const leerHoja = (nombreHoja) => XLSX.utils.sheet_to_json(workbook.Sheets[nombreHoja]);

                            localStorage.setItem('inventario', JSON.stringify(leerHoja("Inventario")));
                            localStorage.setItem('clientes', JSON.stringify(leerHoja("Clientes")));
                            localStorage.setItem('proveedores', JSON.stringify(leerHoja("Proveedores")));
                            localStorage.setItem('gastos', JSON.stringify(leerHoja("Gastos")));
                            localStorage.setItem('empleados', JSON.stringify(leerHoja("Empleados")));
                            localStorage.setItem('ventas', JSON.stringify(leerHoja("Ventas")));

                            alert('Datos restaurados desde Excel correctamente. Recargando...');
                            location.reload();
                        }
                    } catch (error) { alert('Error al procesar el archivo Excel.'); }
                };
                reader.readAsArrayBuffer(file);
            };
            input.click();
        }


        function eliminarTodosDatos() {
            if (confirm("¬øEST√Å ABSOLUTAMENTE SEGURO? Esta acci√≥n eliminar√° TODOS los datos y no se puede deshacer.")) {
                localStorage.clear();
                alert('Todos los datos han sido eliminados. La p√°gina se recargar√°.');
                location.reload();
            }
        }
    </script>
</body>
</html>e-color" content="#3498db">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Gestor">
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/3498db/ffffff?text=GE">

    <style>
        :root {
            --primary: #3498db;
            --secondary: #3498db;
            --success: #27ae60;
            --danger: #e74c3c;
            --warning: #f39c12;
            --light: #f8f9fa;
            --dark: #343a40;
            --background: #f8f9fa;
            --text: #343a40;
            --card-bg: white;
            --border: #ddd;
        }

        .tema-oscuro {
            --primary: #2980b9;
            --secondary: #2980b9;
            --background: #1a1a1a;
            --text: #f8f9fa;
            --card-bg: #2d2d2d;
            --border: #444;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body {
            height: 100%;
            overflow: hidden; /* Evita el scroll del body principal */
        }

        body {
            font-family: 'Segoe UI', system-ui;
            background: var(--background);
            color: var(--text);
            font-size: 16px;
            transition: background 0.3s, color 0.3s;
        }

        .barra-buscadora {
            background: var(--primary);
            color: white;
            padding: 10px;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .search-container {
            display: flex;
            align-items: center;
            position: relative;
        }

        .search-container input {
            flex: 1;
            padding: 10px 15px;
            border: none;
            border-radius: 20px;
            font-size: 1em;
            background: white;
            color: #333;
            text-transform: capitalize;
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--card-bg);
            color: var(--text);
            border-radius: 0 0 5px 5px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            max-height: 300px;
            overflow-y: auto;
            display: none;
            z-index: 1001;
            border: 1px solid var(--border);
        }

        .search-result-item {
            padding: 10px 15px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .search-result-item:hover {
            background-color: rgba(0,0,0,0.05);
        }

        .result-actions {
            display: flex;
            gap: 5px;
        }

        .result-btn {
            padding: 3px 8px;
            border: none;
            border-radius: 3px;
            font-size: 0.8em;
            cursor: pointer;
        }

        .btn-view {
            background: var(--secondary);
            color: white;
        }

        .btn-edit {
            background: var(--warning);
            color: white;
        }

        .btn-add {
            background: var(--success);
            color: white;
        }

        .btn-sell {
            background: var(--primary);
            color: white;
        }

        .container {
            width: 100%;
            padding: 10px;
            margin-top: 60px; /* Ajustado para la barra superior */
            height: calc(100% - 60px); /* Ocupa el resto de la altura */
            overflow-y: auto;
        }

        .menu-movil {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .btn-movil {
            padding: 12px 8px;
            background: var(--secondary);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 0.95em;
            cursor: pointer;
            transition: transform 0.2s, background 0.2s;
            width: 100%;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            flex-direction: column;
            height: 80px;
        }

        .btn-movil:hover {
            background: #2980b9;
        }

        .btn-movil:active {
            transform: scale(0.98);
        }

        .tipo-cambio-btn {
            font-size: 0.85em;
            line-height: 1.2;
            text-align: center;
        }

        .tipo-cambio-btn .tasa {
            font-size: 0.75em;
            font-weight: bold;
        }

        .tipo-cambio-btn .label {
            font-size: 0.85em;
            margin-top: 3px;
        }

        .nueva-pagina {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--background);
            color: var(--text);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
            padding-top: 70px; /* Espacio para el bot√≥n de cerrar */
        }

        .nueva-pagina .close-btn {
            background: none;
            border: none;
            font-size: 2em;
            color: var(--primary);
            padding: 10px;
            position: absolute;
            right: 15px;
            top: 15px;
            cursor: pointer;
            z-index: 1001;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        table th, table td {
            padding: 10px;
            border: 1px solid var(--border);
            text-align: left;
        }

        table th {
            background-color: var(--primary);
            color: white;
        }

        table tr:nth-child(even) {
            background-color: rgba(0,0,0,0.03);
        }

        table tr:hover {
            background-color: rgba(0,0,0,0.05);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 5px;
            font-size: 1em;
            background: var(--card-bg);
            color: var(--text);
            text-transform: capitalize;
        }

        .btn {
            padding: 10px 15px;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            margin: 5px 0; /* Ajustado */
        }

        .btn-primary {
            background-color: var(--secondary);
        }

        .btn-danger {
            background-color: var(--danger);
        }

        .btn-success {
            background-color: var(--success);
        }

        .btn-warning {
            background-color: var(--warning);
        }

        .btn:hover {
            opacity: 0.9;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--card-bg);
            color: var(--text);
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid var(--border);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: var(--text);
        }

        .producto-venta {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid var(--border);
            align-items: center;
        }

        .producto-info {
            flex: 1;
        }

        .producto-acciones {
            display: flex;
            gap: 5px;
        }

        .tipo-cambio-info {
            background: rgba(0,0,0,0.05);
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
            font-size: 0.9em;
        }

        .card {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border: 1px solid var(--border);
        }

        .error {
            color: var(--danger);
            font-size: 0.9em;
            margin-top: 5px;
        }

        .config-option {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }

        .config-option:last-child {
            border-bottom: none;
        }

        .watermark {
            position: fixed;
            bottom: 10px;
            left: 0;
            width: 100%;
            text-align: center;
            font-size: 0.8em;
            color: #777;
            z-index: 999;
        }

        #modal-salida {
            display: none;
        }

        #modal-salida .modal-content {
            text-align: center;
        }

        #modal-salida .botones-confirmacion {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        .factura-termica {
            width: 80mm;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            background: white;
            color: black;
            line-height: 1.2;
        }

        .factura-header {
            text-align: center;
            margin-bottom: 10px;
            border-bottom: 1px dashed #000;
            padding-bottom: 10px;
        }

        .factura-items {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }

        .factura-items th, .factura-items td {
            padding: 4px 0;
            border-bottom: 1px dashed #ccc;
        }

        .factura-total {
            margin-top: 10px;
            border-top: 2px solid #000;
            padding-top: 10px;
            text-align: right;
            font-weight: bold;
        }

        .capitalize {
            text-transform: capitalize;
        }

        .gasto-item, .empleado-item, .proveedor-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid var(--border);
            align-items: center;
        }

        .reporte-item {
            padding: 10px;
            border-bottom: 1px solid var(--border);
        }

        .mensaje-item {
            padding: 10px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
        }

        .mensaje-item.unread {
            background-color: rgba(52, 152, 219, 0.1);
        }

        .btn-tema {
            background-color: var(--card-bg);
            color: var(--text);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            font-weight: bold;
            border: 1px solid var(--border);
        }

        .botones-accion {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-top: 10px;
        }

        .botones-accion .btn {
            flex: 1;
            text-align: center;
            padding: 12px 5px;
            font-size: 0.9em;
        }

        .botones-data {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .botones-data .btn {
            flex: 1;
            min-width: 100px;
            text-align: center;
        }

        .acciones-tabla {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .acciones-tabla .btn {
            padding: 6px 10px;
            font-size: 0.85em;
            margin: 2px;
        }

        .exportar-factura {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .exportar-factura .btn {
            flex: 1;
        }
        
        .calendario-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .calendario-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            text-align: center;
        }
        .calendario-grid div {
            padding: 8px 4px;
            border-radius: 5px;
        }
        .calendario-dia-nombre {
            font-weight: bold;
            font-size: 0.8em;
        }
        .calendario-dia {
            cursor: pointer;
            border: 1px solid var(--border);
        }
        .calendario-dia:hover {
            background: var(--primary);
            color: white;
        }
        .dia-actual {
            background: var(--success);
            color: white;
            font-weight: bold;
        }
        .dia-seleccionado {
            background: var(--warning);
            color: white;
        }

        .modal-exportacion {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal-exportacion .modal-content {
            background: var(--card-bg);
            color: var(--text);
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid var(--border);
        }

        .opcion-exportacion {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
        }

        .opcion-exportacion:last-child {
            border-bottom: none;
        }

        .opcion-exportacion:hover {
            background-color: rgba(0,0,0,0.05);
        }

        .icono-exportacion {
            font-size: 24px;
            margin-right: 15px;
            width: 30px;
            text-align: center;
        }

        .texto-exportacion {
            flex: 1;
        }

        .texto-exportacion h4 {
            margin-bottom: 5px;
        }

        .texto-exportacion p {
            font-size: 0.9em;
            color: #777;
        }

        .formulario-envio {
            margin-top: 15px;
        }

        .formulario-envio .form-group {
            margin-bottom: 10px;
        }

        .formulario-envio label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 0.9em;
        }

        .formulario-envio input {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: 5px;
            font-size: 0.9em;
        }

        .botones-envio {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <div class="barra-buscadora">
        <div class="search-container">
            <input type="text" id="buscador-global" placeholder="Buscar productos, clientes, proveedores..." autocomplete="off">
            <div class="search-results" id="resultados-busqueda"></div>
        </div>
    </div>

    <div class="container">
        <div class="menu-movil">
            <button class="btn-movil" onclick="abrirPagina('ventas')">üõí Ventas</button>
            <button class="btn-movil" onclick="abrirPagina('inventario')">üì¶ Inventario</button>
            <button class="btn-movil" onclick="abrirPagina('clientes')">üë• Clientes</button>
            <button class="btn-movil" onclick="abrirPagina('proveedores')">üöö Proveedores</button>
            <button class="btn-movil" onclick="abrirPagina('gastos')">üí∏ Gastos</button>
            <button class="btn-movil" onclick="abrirPagina('empleados')">üë®‚Äçüíº Empleados</button>
            <button class="btn-movil tipo-cambio-btn" onclick="abrirPagina('tipo-cambio')">
                <div>üíµ</div>
                <div class="tasa" id="tipo-cambio-btn">1$ = 180 Bs</div>
                <div class="label">D√≥lar</div>
            </button>
            <button class="btn-movil" onclick="abrirPagina('mensajes')">üì® Mensajes</button>
            <button class="btn-movil" onclick="abrirPagina('reportes')">üìä Reportes</button>
            <button class="btn-movil" onclick="abrirPagina('config')">‚öôÔ∏è Configuraci√≥n</button>
        </div>
        <div class="watermark">@felinuxs</div>
    </div>

    <div id="pagina-ventas" class="nueva-pagina">
        <button class="close-btn" onclick="cerrarPagina('ventas')">&times;</button>
        <h2>üõí Ventas</h2>
        
        <div class="tipo-cambio-info">
            Tipo de cambio: <span id="tipo-cambio-venta">1$ = 180 Bs</span>
        </div>
        
        <div class="form-group">
            <label for="cliente-venta">Cliente:</label>
            <div class="search-container">
                <input type="text" id="buscador-cliente-venta" placeholder="Buscar cliente..." autocomplete="off">
                <div class="search-results" id="resultados-cliente-venta"></div>
            </div>
            <button class="btn btn-success" style="margin-top: 5px; width: 100%;" onclick="mostrarModal('modal-nuevo-cliente')">+ Nuevo Cliente</button>
        </div>
        
        <div class="form-group">
            <label for="producto-venta">Producto:</label>
            <div class="search-container">
                <input type="text" id="buscador-producto-venta" placeholder="Buscar producto..." autocomplete="off">
                <div class="search-results" id="resultados-producto-venta"></div>
            </div>
        </div>
        
        <div id="productos-seleccionados"></div>
        
        <div style="margin-top: 20px; padding: 10px; background: rgba(0,0,0,0.05); border-radius: 5px;">
            <h3>Resumen de Venta</h3>
            <p>Total: <span id="total-bs">0.00</span> Bs</p>
            <div class="form-group" style="margin-top: 10px;">
                <label for="metodo-pago">M√©todo de Pago:</label>
                <select id="metodo-pago">
                    <option value="Pagom√≥vil">Pagom√≥vil</option>
                    <option value="Efectivo USD">Efectivo USD</option>
                    <option value="Efectivo Bs">Efectivo Bs</option>
                    <option value="Tarjeta">Tarjeta</option>
                    <option value="Otro">Otro</option>
                </select>
            </div>
        </div>
        
        <div class="botones-accion">
            <button class="btn btn-success" onclick="finalizarVenta()">Finalizar Venta</button>
            <button class="btn btn-primary" onclick="mostrarFactura()">Ver Factura</button>
        </div>
    </div>

    <div id="pagina-inventario" class="nueva-pagina">
        <button class="close-btn" onclick="cerrarPagina('inventario')">&times;</button>
        <h2>üì¶ Inventario</h2>
        
        <div class="search-container" style="margin-bottom: 15px;">
            <input type="text" id="buscador-inventario" placeholder="Buscar en inventario..." autocomplete="off">
            <div class="search-results" id="resultados-inventario"></div>
        </div>
        
        <button class="btn btn-success" onclick="mostrarModal('modal-agregar-producto')">+ Agregar Producto</button>
        
        <table id="tabla-inventario">
            <thead>
                <tr>
                    <th>Nombre</th>
                    <th>Precio USD</th>
                    <th>Precio Bs</th>
                    <th>Stock</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="pagina-clientes" class="nueva-pagina">
        <button class="close-btn" onclick="cerrarPagina('clientes')">&times;</button>
        <h2>üë• Clientes</h2>
        
        <div class="search-container" style="margin-bottom: 15px;">
            <input type="text" id="buscador-clientes" placeholder="Buscar clientes..." autocomplete="off">
            <div class="search-results" id="resultados-clientes"></div>
        </div>
        
        <button class="btn btn-success" onclick="mostrarModal('modal-nuevo-cliente')">+ Agregar Cliente</button>
        
        <table id="tabla-clientes">
            <thead>
                <tr>
                    <th>Nombre</th>
                    <th>Tel√©fono</th>
                    <th>Email</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="pagina-proveedores" class="nueva-pagina">
        <button class="close-btn" onclick="cerrarPagina('proveedores')">&times;</button>
        <h2>üöö Proveedores</h2>
        
        <div class="search-container" style="margin-bottom: 15px;">
            <input type="text" id="buscador-proveedores" placeholder="Buscar proveedores..." autocomplete="off">
            <div class="search-results" id="resultados-proveedores"></div>
        </div>
        
        <button class="btn btn-success" onclick="mostrarModal('modal-agregar-proveedor')">+ Agregar Proveedor</button>
        
        <div id="lista-proveedores">
            </div>
    </div>

    <div id="pagina-gastos" class="nueva-pagina">
        <button class="close-btn" onclick="cerrarPagina('gastos')">&times;</button>
        <h2>üí∏ Gastos</h2>
        
        <div class="form-group">
            <label for="filtro-fecha-gastos">Filtrar por fecha:</label>
            <input type="month" id="filtro-fecha-gastos" onchange="filtrarGastos()">
        </div>
        
        <button class="btn btn-success" onclick="mostrarModal('modal-agregar-gasto')">+ Registrar Gasto</button>
        
        <div id="resumen-gastos" class="card">
            <h3>Resumen del Mes</h3>
            <p>Total Gastos: <span id="total-gastos">0.00</span> Bs</p>
            <p>Por Categor√≠a:</p>
            <ul id="categorias-gastos"></ul>
        </div>
        
        <div id="lista-gastos">
            </div>
    </div>

    <div id="pagina-empleados" class="nueva-pagina">
        <button class="close-btn" onclick="cerrarPagina('empleados')">&times;</button>
        <h2>üë®‚Äçüíº Empleados</h2>
        
        <div class="search-container" style="margin-bottom: 15px;">
            <input type="text" id="buscador-empleados" placeholder="Buscar empleados..." autocomplete="off">
            <div class="search-results" id="resultados-empleados"></div>
        </div>
        
        <button class="btn btn-success" onclick="mostrarModal('modal-agregar-empleado')">+ Agregar Empleado</button>
        
        <div id="lista-empleados">
            </div>
    </div>

    <div id="pagina-tipo-cambio" class="nueva-pagina">
        <button class="close-btn" onclick="cerrarPagina('tipo-cambio')">&times;</button>
        <h2>üíµ Tipo de Cambio</h2>
        
        <div class="card">
            <h3>Tipo de Cambio Actual</h3>
            <p>1 USD = <span id="tipo-cambio-actual">168</span> Bs</p>
            <p>√öltima actualizaci√≥n: <span id="fecha-actualizacion">01/01/2023</span></p>
        </div>
        
        <div class="form-group">
            <label for="nuevo-tipo-cambio">Nuevo Tipo de Cambio (Bs por USD):</label>
            <input type="number" id="nuevo-tipo-cambio" step="0.01" min="1" value="168">
        </div>
        
        <button class="btn btn-primary" onclick="actualizarTipoCambio()">Actualizar Tipo de Cambio</button>
        
        <div class="card" style="margin-top: 20px;">
            <h3>Historial de Cambios</h3>
            <div id="historial-tipo-cambio">
                </div>
        </div>
    </div>

    <div id="pagina-mensajes" class="nueva-pagina">
        <button class="close-btn" onclick="cerrarPagina('mensajes')">&times;</button>
        <h2>üì® Mensajes</h2>
        
        <div class="search-container" style="margin-bottom: 15px;">
            <input type="text" id="buscador-mensajes" placeholder="Buscar mensajes..." autocomplete="off">
        </div>
        
        <div id="filtros-mensajes" style="margin-bottom: 15px;">
            <button class="btn btn-primary" onclick="filtrarMensajes('todos')">Todos</button>
            <button class="btn btn-primary" onclick="filtrarMensajes('no-leidos')">No Le√≠dos</button>
            <button class="btn btn-primary" onclick="filtrarMensajes('importantes')">Importantes</button>
        </div>
        
        <div id="lista-mensajes">
            </div>
    </div>

    <div id="pagina-reportes" class="nueva-pagina">
        <button class="close-btn" onclick="cerrarPagina('reportes')">&times;</button>
        <h2>üìä Reportes</h2>
        
        <div class="card">
            <h3>Ventas Diarias</h3>
            <div id="calendario-container">
                <div class="calendario-header">
                    <button class="btn btn-primary" id="mes-anterior-btn">&lt;</button>
                    <h4 id="mes-actual-titulo"></h4>
                    <button class="btn btn-primary" id="mes-siguiente-btn">&gt;</button>
                </div>
                <div class="calendario-grid" id="calendario-grid"></div>
            </div>
            <div id="reporte-diario-container" style="margin-top: 15px;">
                </div>
        </div>

        <div class="card">
            <h3>Generar Reporte General</h3>
            <div class="form-group">
                <label for="tipo-reporte">Tipo de Reporte:</label>
                <select id="tipo-reporte">
                    <option value="ventas">Ventas</option>
                    <option value="inventario">Inventario</option>
                    <option value="gastos">Gastos</option>
                    <option value="clientes">Clientes</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="fecha-inicio">Fecha Inicio:</label>
                <input type="date" id="fecha-inicio">
            </div>
            
            <div class="form-group">
                <label for="fecha-fin">Fecha Fin:</label>
                <input type="date" id="fecha-fin">
            </div>
            
            <button class="btn btn-primary" onclick="generarReporte()">Generar Reporte</button>
        </div>
        
        <div id="contenedor-reporte" style="margin-top: 20px;">
            </div>
    </div>

    <div id="pagina-config" class="nueva-pagina">
        <button class="close-btn" onclick="cerrarPagina('config')">&times;</button>
        <h2>‚öôÔ∏è Configuraci√≥n</h2>
        
        <div class="config-option">
            <h3>Apariencia</h3>
            <button class="btn btn-tema" id="btn-cambiar-tema" onclick="cambiarTema()">Cambiar a Modo Oscuro</button>
        </div>
        
        <div class="config-option">
            <h3>Instalaci√≥n y Pantalla Completa</h3>
            <p style="font-size: 0.9em; margin-bottom: 10px;">Instala la aplicaci√≥n en tu dispositivo para una experiencia nativa y sin distracciones.</p>
            <div class="botones-data">
                <button class="btn btn-success" id="btn-instalar-app" style="display: none;">Instalar Aplicaci√≥n</button>
                <button class="btn btn-primary" onclick="toggleFullScreen()">Pantalla Completa</button>
            </div>
        </div>

        <div class="config-option" id="seccion-prevencion-cierre">
            <h3>Prevenci√≥n de Cierre Accidental</h3>
            <button class="btn btn-primary" onclick="activarPrevencionCierre()">Activar Prevenci√≥n</button>
            <button class="btn btn-danger" onclick="desactivarPrevencionCierre()">Desactivar Prevenci√≥n</button>
            <p id="estado-prevencion" style="margin-top: 10px; font-size: 0.9em;">Estado: Inactivo</p>
        </div>
        
        <div class="config-option">
            <h3>Datos</h3>
            <div class="botones-data">
                <button class="btn btn-primary" onclick="respaldarDatos()">Respaldar (JSON)</button>
                <button class="btn btn-warning" onclick="restaurarDatos()">Restaurar (JSON)</button>
                <button class="btn btn-primary" onclick="exportarDatosExcel()">Respaldar (Excel)</button>
                <button class="btn btn-warning" onclick="importarDatosExcel()">Restaurar (Excel)</button>
                <button class="btn btn-danger" onclick="mostrarModal('modal-salida')">Eliminar Datos</button>
            </div>
        </div>
        
        <div class="config-option">
            <h3>Empresa</h3>
            <div class="form-group">
                <label for="nombre-empresa">Nombre de la Empresa:</label>
                <input type="text" id="nombre-empresa" value="MI EMPRESA">
            </div>
            <div class="form-group">
                <label for="rif-empresa">RIF:</label>
                <input type="text" id="rif-empresa" value="J-123456789">
            </div>
            <div class="form-group">
                <label for="telefono-empresa">Tel√©fono:</label>
                <input type="text" id="telefono-empresa" value="(123) 456-7890">
            </div>
            <div class="form-group">
                <label for="direccion-empresa">Direcci√≥n:</label>
                <textarea id="direccion-empresa">Av. Principal, Local #123</textarea>
            </div>
            <button class="btn btn-success" onclick="guardarConfiguracionEmpresa()">Guardar Configuraci√≥n</button>
        </div>
        
        <div class="config-option">
            <h3>Acerca de</h3>
            <p>Gestor Empresarial M√≥vil v1.2 PWA</p>
            <p>Desarrollado por @felinuxs</p>
        </div>
    </div>
    
    <div class="modal" id="modal-nuevo-cliente">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Nuevo Cliente</h3>
                <button class="modal-close" onclick="cerrarModal('modal-nuevo-cliente')">&times;</button>
            </div>
            <form id="form-nuevo-cliente">
                <div class="form-group">
                    <label for="nombre-cliente-modal">Nombre:</label>
                    <input type="text" id="nombre-cliente-modal" class="capitalize" required>
                </div>
                <div class="form-group">
                    <label for="telefono-cliente-modal">Tel√©fono:</label>
                    <input type="text" id="telefono-cliente-modal">
                </div>
                <div class="form-group">
                    <label for="email-cliente-modal">Email:</label>
                    <input type="email" id="email-cliente-modal">
                </div>
                <div class="form-group">
                    <label for="direccion-cliente-modal">Direcci√≥n:</label>
                    <textarea id="direccion-cliente-modal" class="capitalize"></textarea>
                </div>
                <button type="submit" class="btn btn-success">Guardar Cliente</button>
            </form>
        </div>
    </div>

    <div class="modal" id="modal-agregar-producto">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="titulo-modal-producto">Agregar Producto</h3>
                <button class="modal-close" onclick="cerrarModal('modal-agregar-producto')">&times;</button>
            </div>
            <form id="form-agregar-producto">
                <div class="form-group">
                    <label for="nombre-producto">Nombre:</label>
                    <input type="text" id="nombre-producto" class="capitalize">
                </div>
                <div class="form-group">
                    <label for="precio-usd-producto">Precio USD:</label>
                    <input type="number" id="precio-usd-producto" step="0.01" min="0" oninput="calcularPrecioBs()">
                </div>
                <div class="form-group">
                    <label for="precio-bs-producto">Precio Bs:</label>
                    <input type="number" id="precio-bs-producto" step="0.01" min="0" readonly>
                </div>
                <div class="form-group">
                    <label for="stock-producto">Stock:</label>
                    <input type="number" id="stock-producto" min="0">
                </div>
                <button type="submit" class="btn btn-success">Guardar Producto</button>
            </form>
        </div>
    </div>

    <div class="modal" id="modal-agregar-proveedor">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Agregar Proveedor</h3>
                <button class="modal-close" onclick="cerrarModal('modal-agregar-proveedor')">&times;</button>
            </div>
            <form id="form-agregar-proveedor">
                <div class="form-group">
                    <label for="nombre-proveedor">Nombre:</label>
                    <input type="text" id="nombre-proveedor" class="capitalize" required>
                </div>
                <div class="form-group">
                    <label for="contacto-proveedor">Persona de Contacto:</label>
                    <input type="text" id="contacto-proveedor" class="capitalize">
                </div>
                <div class="form-group">
                    <label for="telefono-proveedor">Tel√©fono:</label>
                    <input type="text" id="telefono-proveedor">
                </div>
                <div class="form-group">
                    <label for="email-proveedor">Email:</label>
                    <input type="email" id="email-proveedor">
                </div>
                <div class="form-group">
                    <label for="productos-proveedor">Productos que suministra:</label>
                    <textarea id="productos-proveedor" class="capitalize"></textarea>
                </div>
                <button type="submit" class="btn btn-success">Guardar Proveedor</button>
            </form>
        </div>
    </div>

    <div class="modal" id="modal-agregar-gasto">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Registrar Gasto</h3>
                <button class="modal-close" onclick="cerrarModal('modal-agregar-gasto')">&times;</button>
            </div>
            <form id="form-agregar-gasto">
                <div class="form-group">
                    <label for="descripcion-gasto">Descripci√≥n:</label>
                    <input type="text" id="descripcion-gasto" class="capitalize" required>
                </div>
                <div class="form-group">
                    <label for="categoria-gasto">Categor√≠a:</label>
                    <select id="categoria-gasto">
                        <option value="oficina">Oficina</option>
                        <option value="servicios">Servicios</option>
                        <option value="impuestos">Impuestos</option>
                        <option value="n√≥mina">N√≥mina</option>
                        <option value="otros">Otros</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="monto-gasto">Monto (Bs):</label>
                    <input type="number" id="monto-gasto" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label for="fecha-gasto">Fecha:</label>
                    <input type="date" id="fecha-gasto" required>
                </div>
                <button type="submit" class="btn btn-success">Registrar Gasto</button>
            </form>
        </div>
    </div>

    <div class="modal" id="modal-agregar-empleado">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Agregar Empleado</h3>
                <button class="modal-close" onclick="cerrarModal('modal-agregar-empleado')">&times;</button>
            </div>
            <form id="form-agregar-empleado">
                <div class="form-group">
                    <label for="nombre-empleado">Nombre:</label>
                    <input type="text" id="nombre-empleado" class="capitalize" required>
                </div>
                <div class="form-group">
                    <label for="cargo-empleado">Cargo:</label>
                    <input type="text" id="cargo-empleado" class="capitalize">
                </div>
                <div class="form-group">
                    <label for="salario-empleado">Salario (Bs):</label>
                    <input type="number" id="salario-empleado" step="0.01" min="0">
                </div>
                <div class="form-group">
                    <label for="telefono-empleado">Tel√©fono:</label>
                    <input type="text" id="telefono-empleado">
                </div>
                <div class="form-group">
                    <label for="fecha-contracto">Fecha de Contrato:</label>
                    <input type="date" id="fecha-contracto">
                </div>
                <button type="submit" class="btn btn-success">Guardar Empleado</button>
            </form>
        </div>
    </div>

    <div class="modal" id="modal-factura">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Factura</h3>
                <button class="modal-close" onclick="cerrarModal('modal-factura')">&times;</button>
            </div>
            <div class="factura-termica" id="area-factura">
                <div class="factura-header">
                    <h3 id="nombre-empresa-factura">MI EMPRESA</h3>
                    <p>RIF: <span id="rif-empresa-factura">J-123456789</span></p>
                    <p>Tel√©fono: <span id="telefono-empresa-factura">(123) 456-7890</span></p>
                    <p>Fecha: <span id="factura-fecha"></span></p>
                </div>
                
                <div class="factura-cliente">
                    <p><strong>Cliente:</strong> <span id="factura-cliente-nombre"></span></p>
                </div>
                
                <table class="factura-items">
                    <thead>
                        <tr>
                            <th>Producto</th>
                            <th>Cant</th>
                            <th>Precio</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody id="factura-items-body">
                    </tbody>
                </table>
                
                <div class="factura-total">
                    <p>Total: <span id="factura-total"></span> Bs</p>
                </div>
                
                <div class="factura-footer">
                    <p>¬°Gracias por su compra!</p>
                </div>
            </div>
            <div class="exportar-factura">
                <button class="btn btn-primary" onclick="mostrarOpcionesExportacion()">Exportar/Imprimir Factura</button>
            </div>
        </div>
    </div>

    <div class="modal" id="modal-salida">
        <div class="modal-content">
            <div class="modal-header">
                <h3>¬øEliminar todos los datos?</h3>
            </div>
            <p>¬øEst√° seguro que desea eliminar todos los datos? Esta acci√≥n no se puede deshacer.</p>
            <div class="botones-confirmacion">
                <button class="btn btn-danger" onclick="eliminarTodosDatos()">S√≠, eliminar</button>
                <button class="btn btn-primary" onclick="cerrarModal('modal-salida')">Cancelar</button>
            </div>
        </div>
    </div>

    <div class="modal-exportacion" id="modal-exportar">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Exportar Factura</h3>
                <button class="modal-close" onclick="cerrarModal('modal-exportar')">&times;</button>
            </div>
            
            <div class="opcion-exportacion" onclick="imprimirFactura()">
                <div class="icono-exportacion">üñ®Ô∏è</div>
                <div class="texto-exportacion">
                    <h4>Imprimir (T√©rmica 80mm)</h4>
                    <p>Imprimir factura directamente</p>
                </div>
            </div>
            
            <div class="opcion-exportacion" onclick="exportarFacturaComo('PDF')">
                <div class="icono-exportacion">üìÑ</div>
                <div class="texto-exportacion">
                    <h4>Exportar a PDF</h4>
                    <p>Guardar como documento PDF</p>
                </div>
            </div>
            
            <div class="opcion-exportacion" onclick="exportarFacturaComo('JPEG')">
                <div class="icono-exportacion">üñºÔ∏è</div>
                <div class="texto-exportacion">
                    <h4>Exportar a JPEG</h4>
                    <p>Guardar como imagen JPEG</p>
                </div>
            </div>
            
            <div class="opcion-exportacion" onclick="exportarFacturaComo('TXT')">
                <div class="icono-exportacion">üìù</div>
                <div class="texto-exportacion">
                    <h4>Exportar a TXT</h4>
                    <p>Guardar como archivo de texto</p>
                </div>
            </div>

            <div class="opcion-exportacion" onclick="exportarFacturaComo('Excel')">
                <div class="icono-exportacion">üìä</div>
                <div class="texto-exportacion">
                    <h4>Exportar a Excel</h4>
                    <p>Guardar como hoja de c√°lculo</p>
                </div>
            </div>
            
            <div class="opcion-exportacion" onclick="mostrarFormularioEmail()">
                <div class="icono-exportacion">üìß</div>
                <div class="texto-exportacion">
                    <h4>Enviar por Email</h4>
                    <p>Enviar factura por correo electr√≥nico</p>
                </div>
            </div>
            
            <div class="opcion-exportacion" onclick="mostrarFormularioSMS()">
                <div class="icono-exportacion">üí¨</div>
                <div class="texto-exportacion">
                    <h4>Enviar por SMS</h4>
                    <p>Enviar factura por mensaje de texto</p>
                </div>
            </div>
            
            <div id="formulario-email" class="formulario-envio" style="display: none;">
                <div class="form-group">
                    <label for="email-destino">Email destino:</label>
                    <input type="email" id="email-destino" placeholder="correo@ejemplo.com">
                </div>
                <div class="botones-envio">
                    <button class="btn btn-primary" onclick="enviarFacturaEmail()">Enviar</button>
                    <button class="btn btn-danger" onclick="ocultarFormularios()">Cancelar</button>
                </div>
            </div>
            
            <div id="formulario-sms" class="formulario-envio" style="display: none;">
                <div class="form-group">
                    <label for="telefono-destino">Tel√©fono destino:</label>
                    <input type="tel" id="telefono-destino" placeholder="+1234567890">
                </div>
                <div class="botones-envio">
                    <button class="btn btn-primary" onclick="enviarFacturaSMS()">Enviar</button>
                    <button class="btn btn-danger" onclick="ocultarFormularios()">Cancelar</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Registro del Service Worker para PWA ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registrado con √©xito:', registration.scope);
                    })
                    .catch(registrationError => {
                        console.log('Fallo en el registro del ServiceWorker:', registrationError);
                    });
            });
        }
    
        // --- L√≥gica para el bot√≥n de instalaci√≥n de PWA ---
        let deferredPrompt;
        const installButton = document.getElementById('btn-instalar-app');

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault(); // Previene que el navegador muestre su propio mini-infobar
            deferredPrompt = e; // Guarda el evento para usarlo despu√©s
            if (installButton) {
                installButton.style.display = 'block'; // Muestra nuestro bot√≥n de instalar
            }
        });

        if (installButton) {
            installButton.addEventListener('click', async () => {
                if (!deferredPrompt) return;
                installButton.style.display = 'none'; // Oculta el bot√≥n despu√©s de click
                deferredPrompt.prompt(); // Muestra el di√°logo de instalaci√≥n
                const { outcome } = await deferredPrompt.userChoice;
                console.log(`Respuesta del usuario al prompt de instalaci√≥n: ${outcome}`);
                deferredPrompt = null;
            });
        }

        window.addEventListener('appinstalled', () => {
            if (installButton) installButton.style.display = 'none';
            deferredPrompt = null;
            console.log('PWA instalada');
            alert('¬°Aplicaci√≥n instalada con √©xito!');
        });

        // --- L√≥gica para Pantalla Completa ---
        function toggleFullScreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    alert(`Error al activar pantalla completa: ${err.message}`);
                });
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }
        
        // ===== DATOS DE EJEMPLO =====
        let inventario = JSON.parse(localStorage.getItem('inventario')) || [
            {
                id: 1,
                nombre: "Cu√±ete Blanco Maxi Caucho C",
                precioUSD: 33.00,
                precioBs: 5940.00,
                stock: 5
            }
        ];

        let clientes = JSON.parse(localStorage.getItem('clientes')) || [
            {
                id: 1,
                nombre: "Juan P√©rez",
                telefono: "12345678",
                email: "juan@email.com",
                direccion: "Av. Siempre Viva 123"
            }
        ];

        let proveedores = JSON.parse(localStorage.getItem('proveedores')) || [
            {
                id: 1,
                nombre: "Distribuidora ABC",
                contacto: "Mar√≠a Gonz√°lez",
                telefono: "98765432",
                email: "contacto@distribuidoraabc.com",
                productos: "Materiales de oficina"
            }
        ];

        let gastos = JSON.parse(localStorage.getItem('gastos')) || [
            {
                id: 1,
                descripcion: "Papeler√≠a",
                categoria: "oficina",
                monto: 150.50,
                fecha: "2023-05-15"
            }
        ];

        let empleados = JSON.parse(localStorage.getItem('empleados')) || [
            {
                id: 1,
                nombre: "Carlos Rodr√≠guez",
                cargo: "Vendedor",
                salario: 1200.00,
                telefono: "5551234",
                fechaContrato: "2023-01-10"
            }
        ];

        let mensajes = JSON.parse(localStorage.getItem('mensajes')) || [
            {
                id: 1,
                remitente: "Sistema",
                asunto: "Bienvenido al Gestor Empresarial",
                contenido: "Su sistema ha sido configurado correctamente.",
                fecha: "2023-05-01",
                leido: false,
                importante: true
            }
        ];

        let tipoCambio = parseFloat(localStorage.getItem('tipoCambio')) || 168;
        let historialTipoCambio = JSON.parse(localStorage.getItem('historialTipoCambio')) || [
            { fecha: "2023-05-01", tasa: 168 }
        ];

        let configuracion = JSON.parse(localStorage.getItem('configuracion')) || {
            tema: "claro",
            empresa: {
                nombre: "MI EMPRESA",
                rif: "J-123456789",
                telefono: "(123) 456-7890",
                direccion: "Av. Principal, Local #123"
            }
        };

        // Variables para la venta actual
        let ventaActual = {
            cliente: null,
            productos: [],
            totalUSD: 0,
            totalBs: 0,
            metodoPago: 'Pagom√≥vil',
            timestamp: null
        };

        // Variable para controlar la prevenci√≥n de cierre
        let prevencionCierreActiva = false;
        
        // Variables para el calendario
        let fechaCalendario = new Date();


        // ===== INICIALIZACI√ìN =====
        document.addEventListener('DOMContentLoaded', function() {
            cargarInventario();
            cargarClientes();
            cargarProveedores();
            cargarGastos();
            cargarEmpleados();
            cargarMensajes();
            cargarConfiguracion();
            configurarBuscadorGlobal();
            configurarBuscadoresModulos();
            actualizarTipoCambioVisual();
            
            document.getElementById('form-nuevo-cliente').addEventListener('submit', function(e) { e.preventDefault(); guardarNuevoClienteDesdeModal(); });
            document.getElementById('form-agregar-producto').addEventListener('submit', function(e) { e.preventDefault(); guardarNuevoProducto(); });
            document.getElementById('form-agregar-proveedor').addEventListener('submit', function(e) { e.preventDefault(); guardarNuevoProveedor(); });
            document.getElementById('form-agregar-gasto').addEventListener('submit', function(e) { e.preventDefault(); guardarNuevoGasto(); });
            document.getElementById('form-agregar-empleado').addEventListener('submit', function(e) { e.preventDefault(); guardarNuevoEmpleado(); });
            
            document.querySelectorAll('input[type="text"], textarea').forEach(input => {
                input.addEventListener('input', function() {
                    if (this.value.length === 1) this.value = this.value.charAt(0).toUpperCase() + this.value.slice(1);
                });
            });
            
            const hoy = new Date().toISOString().split('T')[0];
            document.getElementById('fecha-gasto').value = hoy;
            document.getElementById('fecha-contracto').value = hoy;
            document.getElementById('fecha-inicio').value = hoy;
            document.getElementById('fecha-fin').value = hoy;

            document.getElementById('mes-anterior-btn').addEventListener('click', () => {
                fechaCalendario.setMonth(fechaCalendario.getMonth() - 1);
                generarCalendario(fechaCalendario.getFullYear(), fechaCalendario.getMonth());
            });
            document.getElementById('mes-siguiente-btn').addEventListener('click', () => {
                fechaCalendario.setMonth(fechaCalendario.getMonth() + 1);
                generarCalendario(fechaCalendario.getFullYear(), fechaCalendario.getMonth());
            });

            // ===== MEJORA: L√≥gica de Prevenci√≥n de Cierre Autom√°tica =====
            const seccionPrevencion = document.getElementById('seccion-prevencion-cierre');
            // Activar prevenci√≥n de cierre por defecto si es una PWA instalada
            if (window.matchMedia('(display-mode: standalone)').matches) {
                activarPrevencionCierre(false); // Activar sin mostrar alerta
                if (seccionPrevencion) {
                    seccionPrevencion.innerHTML = `
                        <h3>Prevenci√≥n de Cierre Accidental</h3>
                        <p style="font-size: 0.9em; margin-top: 10px;">Para una mejor experiencia, la prevenci√≥n contra el bot√≥n "Atr√°s" del dispositivo se activa autom√°ticamente en la aplicaci√≥n instalada.</p>
                    `;
                }
            }
        });

        // ===== FUNCIONES DE EXPORTACI√ìN =====
        function mostrarOpcionesExportacion() {
            if (ventaActual.productos.length === 0) {
                alert('No hay productos en la venta para generar una factura.');
                return;
            }
            mostrarFactura();
            mostrarModal('modal-exportar');
        }

        function ocultarFormularios() {
            document.getElementById('formulario-email').style.display = 'none';
            document.getElementById('formulario-sms').style.display = 'none';
        }

        function mostrarFormularioEmail() {
            ocultarFormularios();
            document.getElementById('formulario-email').style.display = 'block';
        }

        function mostrarFormularioSMS() {
            ocultarFormularios();
            document.getElementById('formulario-sms').style.display = 'block';
        }

        function imprimirFactura() {
            const contenido = document.getElementById('area-factura').innerHTML;
            const ventana = window.open('', '_blank');
            
            ventana.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Factura - ${configuracion.empresa.nombre}</title>
                    <style>
                        body { font-family: 'Courier New', monospace; font-size: 12px; line-height: 1.2; margin: 0; padding: 0; width: 80mm; }
                        .factura-termica { width: 100%; padding: 10px; }
                        .factura-header { text-align: center; margin-bottom: 10px; border-bottom: 1px dashed #000; padding-bottom: 10px; }
                        .factura-items { width: 100%; border-collapse: collapse; margin: 10px 0; }
                        .factura-items th, .factura-items td { padding: 4px 0; border-bottom: 1px dashed #ccc; text-align: left; }
                        .factura-total { margin-top: 10px; border-top: 2px solid #000; padding-top: 10px; text-align: right; font-weight: bold; }
                        @media print { body { -webkit-print-color-adjust: exact; } }
                    </style>
                </head>
                <body onload="window.print(); setTimeout(() => window.close(), 500);">
                    <div class="factura-termica">${contenido}</div>
                </body>
                </html>
            `);
            ventana.document.close();
        }

        function exportarFacturaComo(formato) {
            const facturaElement = document.getElementById('area-factura');
            const nombreArchivo = `Factura_${configuracion.empresa.nombre}_${new Date().toISOString().split('T')[0]}`;

            switch(formato) {
                case 'PDF':
                    html2canvas(facturaElement).then(canvas => {
                        const imgData = canvas.toDataURL('image/jpeg', 1.0);
                        const { jsPDF } = window.jspdf;
                        const pdf = new jsPDF('p', 'mm', [80, facturaElement.scrollHeight / 3.5]);
                        pdf.addImage(imgData, 'JPEG', 0, 0, 80, facturaElement.scrollHeight / 3.5);
                        pdf.save(`${nombreArchivo}.pdf`);
                    });
                    break;
                case 'JPEG':
                    html2canvas(facturaElement).then(canvas => {
                        const link = document.createElement('a');
                        link.download = `${nombreArchivo}.jpg`;
                        link.href = canvas.toDataURL('image/jpeg', 0.9);
                        link.click();
                    });
                    break;
                case 'TXT':
                    let txtContent = "";
                    txtContent += `${document.getElementById('nombre-empresa-factura').textContent}\n`;
                    txtContent += `RIF: ${document.getElementById('rif-empresa-factura').textContent}\n`;
                    txtContent += `Tel√©fono: ${document.getElementById('telefono-empresa-factura').textContent}\n`;
                    txtContent += `Fecha: ${document.getElementById('factura-fecha').textContent}\n\n`;
                    txtContent += `Cliente: ${document.getElementById('factura-cliente-nombre').textContent}\n\n`;
                    txtContent += "Producto\tCant\tPrecio\tTotal\n";
                    txtContent += "----------------------------------------\n";
                    ventaActual.productos.forEach(p => {
                        txtContent += `${p.nombre}\t${p.cantidad}\t${p.precioBs.toFixed(2)}\t${(p.precioBs * p.cantidad).toFixed(2)}\n`;
                    });
                    txtContent += "----------------------------------------\n";
                    txtContent += `Total: ${document.getElementById('factura-total').textContent} Bs\n\n`;
                    txtContent += "¬°Gracias por su compra!\n";
                    
                    const blobTxt = new Blob([txtContent], { type: 'text/plain' });
                    const linkTxt = document.createElement('a');
                    linkTxt.href = URL.createObjectURL(blobTxt);
                    linkTxt.download = `${nombreArchivo}.txt`;
                    linkTxt.click();
                    break;
                case 'Excel':
                    const data = ventaActual.productos.map(p => ({
                        Producto: p.nombre,
                        Cantidad: p.cantidad,
                        'Precio Unit. (Bs)': p.precioBs.toFixed(2),
                        'Total (Bs)': (p.precioBs * p.cantidad).toFixed(2)
                    }));
                    data.push({}); // empty row
                    data.push({ 'Total (Bs)': ventaActual.totalBs.toFixed(2) });

                    const worksheet = XLSX.utils.json_to_sheet(data);
                    const workbook = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(workbook, worksheet, 'Factura');
                    XLSX.writeFile(workbook, `${nombreArchivo}.xlsx`);
                    break;
            }
            alert(`Factura exportada como ${formato} correctamente`);
        }
        
        function enviarFacturaEmail() {
            const email = document.getElementById('email-destino').value;
            if (!email || !email.includes('@')) {
                alert('Por favor ingrese un email v√°lido');
                return;
            }
            html2canvas(document.querySelector('.factura-termica')).then(canvas => {
                alert(`Factura enviada por email a: ${email}\n\n(Simulaci√≥n: En una app real, la imagen de la factura se adjuntar√≠a y enviar√≠a).`);
                cerrarModal('modal-exportar');
            });
        }

        function enviarFacturaSMS() {
            const telefono = document.getElementById('telefono-destino').value;
            if (!telefono) {
                alert('Por favor ingrese un n√∫mero de tel√©fono');
                return;
            }
            alert(`Factura enviada por SMS al n√∫mero: ${telefono}\n\n(Simulaci√≥n: En una app real, se enviar√≠a un enlace a la factura).`);
            cerrarModal('modal-exportar');
        }

        // ===== FUNCIONES DE P√ÅGINAS =====
        function abrirPagina(paginaId) {
            document.querySelectorAll('.nueva-pagina').forEach(pagina => {
                pagina.style.display = 'none';
            });
            document.getElementById(`pagina-${paginaId}`).style.display = 'block';
            
            switch(paginaId) {
                case 'inventario': cargarInventario(); break;
                case 'ventas': reiniciarVenta(); break;
                case 'clientes': cargarClientes(); break;
                case 'proveedores': cargarProveedores(); break;
                case 'gastos': cargarGastos(); break;
                case 'empleados': cargarEmpleados(); break;
                case 'tipo-cambio': cargarHistorialTipoCambio(); break;
                case 'mensajes': cargarMensajes(); break;
                case 'reportes':
                    fechaCalendario = new Date();
                    generarCalendario(fechaCalendario.getFullYear(), fechaCalendario.getMonth());
                    break;
                case 'config': cargarConfiguracion(); break;
            }
        }

        function cerrarPagina(paginaId) {
            document.getElementById(`pagina-${paginaId}`).style.display = 'none';
        }

        // ===== PREVENCI√ìN DE CIERRE (BOT√ìN ATR√ÅS) =====
        function onPopState(event) {
            if (prevencionCierreActiva) {
                window.history.pushState(null, null, window.location.href);
                // Mensaje mejorado para el usuario
                alert('Para cerrar una secci√≥n, utiliza el bot√≥n "√ó" dentro de la aplicaci√≥n.');
            }
        }
        
        function activarPrevencionCierre(showAlert = true) { // Par√°metro para controlar la alerta
            if (!prevencionCierreActiva) {
                window.history.pushState(null, null, window.location.href);
                window.addEventListener('popstate', onPopState);
                prevencionCierreActiva = true;
                const estadoPrevencion = document.getElementById('estado-prevencion');
                if (estadoPrevencion) estadoPrevencion.textContent = 'Estado: Activo';
                if (showAlert) {
                    alert('Prevenci√≥n de cierre activada. El bot√≥n "Atr√°s" del navegador no cerrar√° la aplicaci√≥n.');
                }
            }
        }

        function desactivarPrevencionCierre() {
            if (prevencionCierreActiva) {
                window.removeEventListener('popstate', onPopState);
                prevencionCierreActiva = false;
                const estadoPrevencion = document.getElementById('estado-prevencion');
                if (estadoPrevencion) estadoPrevencion.textContent = 'Estado: Inactivo';
                alert('Prevenci√≥n de cierre desactivada.');
            }
        }


        // ===== FUNCIONES PARA MODALES =====
        function mostrarModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }

        function cerrarModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // ===== B√öSQUEDA GLOBAL =====
        function configurarBuscadorGlobal() {
            const buscador = document.getElementById('buscador-global');
            const resultados = document.getElementById('resultados-busqueda');
            
            buscador.addEventListener('input', function() {
                const query = this.value.toLowerCase().trim();
                if (query.length < 2) {
                    resultados.style.display = 'none';
                    return;
                }
                const resultadosInventario = buscarEnInventario(query);
                const resultadosClientes = buscarEnClientes(query);
                const resultadosProveedores = buscarEnProveedores(query);
                
                const todosResultados = [
                    ...resultadosInventario.map(item => ({...item, tipo: 'producto'})),
                    ...resultadosClientes.map(item => ({...item, tipo: 'cliente'})),
                    ...resultadosProveedores.map(item => ({...item, tipo: 'proveedor'}))
                ];
                mostrarResultadosBusquedaGlobal(todosResultados, resultados);
            });
        }

        function configurarBuscadoresModulos() {
            document.getElementById('buscador-clientes').addEventListener('input', function() { buscarYMostrarResultados(this.value, buscarEnClientes, document.getElementById('resultados-clientes'), 'clientes'); });
            document.getElementById('buscador-cliente-venta').addEventListener('input', function() { buscarYMostrarResultados(this.value, buscarEnClientes, document.getElementById('resultados-cliente-venta'), 'cliente-venta'); });
            document.getElementById('buscador-producto-venta').addEventListener('input', function() { buscarYMostrarResultados(this.value, buscarEnInventario, document.getElementById('resultados-producto-venta'), 'producto-venta'); });
            document.getElementById('buscador-inventario').addEventListener('input', function() { buscarYMostrarResultados(this.value, buscarEnInventario, document.getElementById('resultados-inventario'), 'inventario'); });
            document.getElementById('buscador-proveedores').addEventListener('input', function() { buscarYMostrarResultados(this.value, buscarEnProveedores, document.getElementById('resultados-proveedores'), 'proveedores'); });
            document.getElementById('buscador-empleados').addEventListener('input', function() { buscarYMostrarResultados(this.value, buscarEnEmpleados, document.getElementById('resultados-empleados'), 'empleados'); });
        }

        function buscarYMostrarResultados(query, funcionBusqueda, contenedorResultados, contexto) {
            const q = query.toLowerCase().trim();
            if (q.length < 2) {
                contenedorResultados.style.display = 'none';
                return;
            }
            const resultados = funcionBusqueda(q);
            mostrarResultadosBusqueda(resultados, contenedorResultados, contexto);
        }

        function buscarEnInventario(query) { return inventario.filter(item => item.nombre.toLowerCase().includes(query)); }
        function buscarEnClientes(query) { return clientes.filter(item => item.nombre.toLowerCase().includes(query) || (item.email && item.email.toLowerCase().includes(query)) || (item.telefono && item.telefono.includes(query))); }
        function buscarEnProveedores(query) { return proveedores.filter(item => item.nombre.toLowerCase().includes(query) || (item.contacto && item.contacto.toLowerCase().includes(query)) || (item.productos && item.productos.toLowerCase().includes(query))); }
        function buscarEnEmpleados(query) { return empleados.filter(item => item.nombre.toLowerCase().includes(query) || (item.cargo && item.cargo.toLowerCase().includes(query))); }

        function mostrarResultadosBusquedaGlobal(resultados, contenedor) {
            contenedor.innerHTML = '';
            if (resultados.length === 0) {
                contenedor.innerHTML = '<div class="search-result-item">No se encontraron resultados</div>';
                contenedor.style.display = 'block';
                return;
            }
            resultados.forEach(item => {
                const elemento = document.createElement('div');
                elemento.className = 'search-result-item';
                elemento.innerHTML = `
                    <div>${item.nombre} (${item.tipo})</div>
                    <div class="result-actions">
                        <button class="result-btn btn-add" onclick="venderDesdeBusqueda('${item.tipo}', ${item.id})">Vender</button>
                        <button class="result-btn btn-edit" onclick="editarDesdeBusqueda('${item.tipo}', ${item.id})">Editar</button>
                    </div>
                `;
                contenedor.appendChild(elemento);
            });
            contenedor.style.display = 'block';
        }

        function mostrarResultadosBusqueda(resultados, contenedor, contexto = 'global') {
            contenedor.innerHTML = '';
            if (resultados.length === 0) {
                contenedor.innerHTML = '<div class="search-result-item">No se encontraron resultados</div>';
                contenedor.style.display = 'block';
                return;
            }
            resultados.forEach(item => {
                const elemento = document.createElement('div');
                elemento.className = 'search-result-item';
                let acciones = '';
                
                if (contexto === 'cliente-venta') {
                    elemento.onclick = () => seleccionarCliente(item.id);
                    acciones = `<div class="result-actions"><button class="result-btn btn-add">Seleccionar</button></div>`;
                } else if (contexto === 'producto-venta') {
                    elemento.onclick = () => agregarProductoVenta(item.id);
                    acciones = `<div class="result-actions"><button class="result-btn btn-add">Agregar</button></div>`;
                }
                
                elemento.innerHTML = `<div>${item.nombre}</div>${acciones}`;
                contenedor.appendChild(elemento);
            });
            contenedor.style.display = 'block';
        }


        // ===== FUNCIONES DESDE B√öSQUEDA =====
        function venderDesdeBusqueda(tipo, id) {
            abrirPagina('ventas');
            setTimeout(() => {
                if (tipo === 'producto') agregarProductoVenta(id);
                else if (tipo === 'cliente') seleccionarCliente(id);
            }, 100);
            document.getElementById('resultados-busqueda').style.display = 'none';
            document.getElementById('buscador-global').value = '';
        }

        function editarDesdeBusqueda(tipo, id) {
            if (tipo === 'producto') {
                abrirPagina('inventario');
                setTimeout(() => editarProducto(id), 100);
            } else if (tipo === 'cliente') {
                abrirPagina('clientes');
                setTimeout(() => editarCliente(id), 100);
            } else if (tipo === 'proveedor') {
                abrirPagina('proveedores');
                setTimeout(() => editarProveedor(id), 100);
            }
            document.getElementById('resultados-busqueda').style.display = 'none';
            document.getElementById('buscador-global').value = '';
        }

        // ===== FUNCIONES PARA VENTAS =====
        function seleccionarCliente(id) {
            const cliente = clientes.find(c => c.id === id);
            if (cliente) {
                ventaActual.cliente = cliente;
                document.getElementById('buscador-cliente-venta').value = cliente.nombre;
                document.getElementById('resultados-cliente-venta').style.display = 'none';
            }
        }

        function agregarProductoVenta(id) {
            const producto = inventario.find(p => p.id === id);
            if (producto) {
                const existente = ventaActual.productos.find(p => p.id === id);
                if (existente) {
                    existente.cantidad += 1;
                } else {
                    ventaActual.productos.push({ ...producto, cantidad: 1 });
                }
                actualizarProductosVenta();
                document.getElementById('buscador-producto-venta').value = '';
                document.getElementById('resultados-producto-venta').style.display = 'none';
            }
        }

        function actualizarProductosVenta() {
            const contenedor = document.getElementById('productos-seleccionados');
            contenedor.innerHTML = '';
            ventaActual.productos.forEach(producto => {
                const elemento = document.createElement('div');
                elemento.className = 'producto-venta';
                const subtotalBs = producto.precioBs * producto.cantidad;
                elemento.innerHTML = `
                    <div class="producto-info">
                        <strong>${producto.nombre}</strong>
                        <div>Cantidad: ${producto.cantidad}</div>
                        <div>Precio: ${producto.precioBs.toFixed(2)} Bs</div>
                        <div>Subtotal: ${subtotalBs.toFixed(2)} Bs</div>
                    </div>
                    <div class="producto-acciones">
                        <button class="btn btn-primary" onclick="modificarCantidad(${producto.id}, 1)">+</button>
                        <button class="btn btn-warning" onclick="modificarCantidad(${producto.id}, -1)">-</button>
                        <button class="btn btn-danger" onclick="eliminarProductoVenta(${producto.id})">X</button>
                    </div>
                `;
                contenedor.appendChild(elemento);
            });
            calcularTotalVenta();
        }

        function modificarCantidad(id, cambio) {
            const producto = ventaActual.productos.find(p => p.id === id);
            if (producto) {
                producto.cantidad += cambio;
                if (producto.cantidad <= 0) {
                    eliminarProductoVenta(id);
                } else {
                    actualizarProductosVenta();
                }
            }
        }

        function eliminarProductoVenta(id) {
            ventaActual.productos = ventaActual.productos.filter(p => p.id !== id);
            actualizarProductosVenta();
        }

        function calcularTotalVenta() {
            let subtotalBs = 0;
            ventaActual.productos.forEach(producto => {
                subtotalBs += producto.precioBs * producto.cantidad;
            });
            ventaActual.totalBs = subtotalBs;
            document.getElementById('total-bs').textContent = subtotalBs.toFixed(2);
        }

        function finalizarVenta() {
            if (ventaActual.productos.length === 0) {
                alert('Debe agregar al menos un producto a la venta');
                return;
            }
            
            for (const productoVenta of ventaActual.productos) {
                const productoInventario = inventario.find(p => p.id === productoVenta.id);
                if (productoInventario && productoInventario.stock < productoVenta.cantidad) {
                    alert(`No hay suficiente stock de ${productoInventario.nombre}. Stock disponible: ${productoInventario.stock}`);
                    return;
                }
            }
            
            ventaActual.productos.forEach(productoVenta => {
                const productoInventario = inventario.find(p => p.id === productoVenta.id);
                if (productoInventario) {
                    productoInventario.stock -= productoVenta.cantidad;
                }
            });
            
            localStorage.setItem('inventario', JSON.stringify(inventario));
            
            const ventas = JSON.parse(localStorage.getItem('ventas')) || [];
            ventas.push({
                id: Date.now(),
                timestamp: Date.now(),
                cliente: ventaActual.cliente,
                productos: ventaActual.productos,
                totalBs: ventaActual.totalBs,
                metodoPago: document.getElementById('metodo-pago').value
            });
            localStorage.setItem('ventas', JSON.stringify(ventas));
            
            alert('Venta registrada con √©xito');
            mostrarFactura();
            reiniciarVenta();
        }

        function reiniciarVenta() {
            ventaActual = {
                cliente: null,
                productos: [],
                totalBs: 0,
                metodoPago: 'Pagom√≥vil',
                timestamp: null
            };
            document.getElementById('buscador-cliente-venta').value = '';
            document.getElementById('buscador-producto-venta').value = '';
            document.getElementById('productos-seleccionados').innerHTML = '';
            calcularTotalVenta();
        }

        function mostrarFactura() {
            if (ventaActual.productos.length === 0) {
                alert('No hay productos en la venta actual');
                return;
            }
            
            document.getElementById('factura-fecha').textContent = new Date().toLocaleString();
            document.getElementById('factura-cliente-nombre').textContent = ventaActual.cliente ? ventaActual.cliente.nombre : 'Cliente General';
            document.getElementById('nombre-empresa-factura').textContent = configuracion.empresa.nombre;
            document.getElementById('rif-empresa-factura').textContent = configuracion.empresa.rif;
            document.getElementById('telefono-empresa-factura').textContent = configuracion.empresa.telefono;
            
            const facturaItemsBody = document.getElementById('factura-items-body');
            facturaItemsBody.innerHTML = '';
            
            ventaActual.productos.forEach(producto => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${producto.nombre}</td>
                    <td>${producto.cantidad}</td>
                    <td>${producto.precioBs.toFixed(2)}</td>
                    <td>${(producto.precioBs * producto.cantidad).toFixed(2)}</td>
                `;
                facturaItemsBody.appendChild(row);
            });
            
            document.getElementById('factura-total').textContent = ventaActual.totalBs.toFixed(2);
            
            mostrarModal('modal-factura');
        }

        // ===== FUNCIONES PARA INVENTARIO =====
        function cargarInventario() {
            const tbody = document.querySelector("#tabla-inventario tbody");
            if (!tbody) return;
            tbody.innerHTML = "";
            inventario.forEach((producto) => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${producto.nombre}</td>
                    <td>$${producto.precioUSD.toFixed(2)}</td>
                    <td>${producto.precioBs.toFixed(2)} Bs</td>
                    <td>${producto.stock}</td>
                    <td>
                        <div class="acciones-tabla">
                            <button class="btn btn-sell" onclick="venderProducto(${producto.id})">Vender</button>
                            <button class="btn btn-primary" onclick="editarProducto(${producto.id})">Editar</button>
                            <button class="btn btn-danger" onclick="eliminarProducto(${producto.id})">Eliminar</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function venderProducto(id) {
            abrirPagina('ventas');
            setTimeout(() => agregarProductoVenta(id), 100);
        }

        function calcularPrecioBs() {
            const precioUSD = parseFloat(document.getElementById('precio-usd-producto').value) || 0;
            document.getElementById('precio-bs-producto').value = (precioUSD * tipoCambio).toFixed(2);
        }

        function guardarNuevoProducto() {
            const nombre = document.getElementById('nombre-producto').value;
            if (!nombre || nombre.trim() === '') {
                alert('Por favor ingrese un nombre para el producto');
                return;
            }
            const precioUSD = parseFloat(document.getElementById('precio-usd-producto').value) || 0;
            const stock = parseInt(document.getElementById('stock-producto').value) || 0;
            
            inventario.push({
                id: Date.now(),
                nombre: nombre.trim(),
                precioUSD: precioUSD,
                precioBs: precioUSD * tipoCambio,
                stock: stock
            });
            
            localStorage.setItem('inventario', JSON.stringify(inventario));
            cargarInventario();
            cerrarModal('modal-agregar-producto');
            document.getElementById('form-agregar-producto').reset();
        }

        function editarProducto(id) {
            const producto = inventario.find(p => p.id === id);
            if (!producto) return;
            
            document.getElementById('nombre-producto').value = producto.nombre;
            document.getElementById('precio-usd-producto').value = producto.precioUSD;
            document.getElementById('precio-bs-producto').value = producto.precioBs;
            document.getElementById('stock-producto').value = producto.stock;
            document.getElementById('titulo-modal-producto').textContent = 'Editar Producto';
            
            mostrarModal('modal-agregar-producto');
            
            const form = document.getElementById('form-agregar-producto');
            form.onsubmit = e => { e.preventDefault(); actualizarProducto(id); };
        }

        function actualizarProducto(id) {
            const index = inventario.findIndex(p => p.id === id);
            if (index === -1) return;
            
            const nombre = document.getElementById('nombre-producto').value;
            const precioUSD = parseFloat(document.getElementById('precio-usd-producto').value) || 0;
            const stock = parseInt(document.getElementById('stock-producto').value) || 0;
            
            inventario[index] = {
                id: id,
                nombre: nombre || 'Producto sin nombre',
                precioUSD: precioUSD,
                precioBs: precioUSD * tipoCambio,
                stock: stock
            };
            
            localStorage.setItem('inventario', JSON.stringify(inventario));
            cargarInventario();
            cerrarModal('modal-agregar-producto');
            
            const form = document.getElementById('form-agregar-producto');
            form.onsubmit = e => { e.preventDefault(); guardarNuevoProducto(); };
            document.getElementById('titulo-modal-producto').textContent = 'Agregar Producto';
            form.reset();
        }

        function eliminarProducto(id) {
            if (confirm("¬øEst√° seguro de eliminar este producto?")) {
                inventario = inventario.filter(p => p.id !== id);
                localStorage.setItem('inventario', JSON.stringify(inventario));
                cargarInventario();
            }
        }

        // ===== FUNCIONES PARA CLIENTES =====
        function cargarClientes() {
            const tbody = document.querySelector("#tabla-clientes tbody");
            if (!tbody) return;
            tbody.innerHTML = "";
            clientes.forEach((cliente) => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${cliente.nombre}</td>
                    <td>${cliente.telefono || '-'}</td>
                    <td>${cliente.email || '-'}</td>
                    <td>
                        <div class="acciones-tabla">
                            <button class="btn btn-primary" onclick="editarCliente(${cliente.id})">Editar</button>
                            <button class="btn btn-danger" onclick="eliminarCliente(${cliente.id})">Eliminar</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function guardarNuevoClienteDesdeModal() {
            const nombre = document.getElementById('nombre-cliente-modal').value;
            const telefono = document.getElementById('telefono-cliente-modal').value;
            const email = document.getElementById('email-cliente-modal').value;
            const direccion = document.getElementById('direccion-cliente-modal').value;
            
            const nuevoCliente = {
                id: Date.now(),
                nombre: nombre || 'Cliente sin nombre',
                telefono, email, direccion
            };
            
            clientes.push(nuevoCliente);
            localStorage.setItem('clientes', JSON.stringify(clientes));
            
            if (document.getElementById('pagina-ventas').style.display === 'block') {
                seleccionarCliente(nuevoCliente.id);
            }
            
            cerrarModal('modal-nuevo-cliente');
            document.getElementById('form-nuevo-cliente').reset();
        }

        function editarCliente(id) {
            const cliente = clientes.find(c => c.id === id);
            if (!cliente) return;
            
            document.getElementById('nombre-cliente-modal').value = cliente.nombre;
            document.getElementById('telefono-cliente-modal').value = cliente.telefono || '';
            document.getElementById('email-cliente-modal').value = cliente.email || '';
            document.getElementById('direccion-cliente-modal').value = cliente.direccion || '';
            
            mostrarModal('modal-nuevo-cliente');
            
            const form = document.getElementById('form-nuevo-cliente');
            form.onsubmit = e => { e.preventDefault(); actualizarCliente(id); };
        }

        function actualizarCliente(id) {
            const index = clientes.findIndex(c => c.id === id);
            if (index === -1) return;
            
            clientes[index] = {
                id: id,
                nombre: document.getElementById('nombre-cliente-modal').value || 'Cliente sin nombre',
                telefono: document.getElementById('telefono-cliente-modal').value,
                email: document.getElementById('email-cliente-modal').value,
                direccion: document.getElementById('direccion-cliente-modal').value
            };
            
            localStorage.setItem('clientes', JSON.stringify(clientes));
            cargarClientes();
            cerrarModal('modal-nuevo-cliente');
            
            const form = document.getElementById('form-nuevo-cliente');
            form.onsubmit = e => { e.preventDefault(); guardarNuevoClienteDesdeModal(); };
            form.reset();
        }

        function eliminarCliente(id) {
            if (confirm("¬øEst√° seguro de eliminar este cliente?")) {
                clientes = clientes.filter(c => c.id !== id);
                localStorage.setItem('clientes', JSON.stringify(clientes));
                cargarClientes();
            }
        }

        // ===== FUNCIONES PARA PROVEEDORES =====
        function cargarProveedores() {
            const contenedor = document.getElementById('lista-proveedores');
            if (!contenedor) return;
            contenedor.innerHTML = '';
            proveedores.forEach(proveedor => {
                const elemento = document.createElement('div');
                elemento.className = 'proveedor-item card';
                elemento.innerHTML = `
                    <h3>${proveedor.nombre}</h3>
                    <p><strong>Contacto:</strong> ${proveedor.contacto || 'N/A'}</p>
                    <p><strong>Tel√©fono:</strong> ${proveedor.telefono || 'N/A'}</p>
                    <p><strong>Email:</strong> ${proveedor.email || 'N/A'}</p>
                    <p><strong>Productos:</strong> ${proveedor.productos || 'N/A'}</p>
                    <div style="margin-top: 10px;">
                        <button class="btn btn-primary" onclick="editarProveedor(${proveedor.id})">Editar</button>
                        <button class="btn btn-danger" onclick="eliminarProveedor(${proveedor.id})">Eliminar</button>
                    </div>
                `;
                contenedor.appendChild(elemento);
            });
        }

        function guardarNuevoProveedor() {
            const nuevoProveedor = {
                id: Date.now(),
                nombre: document.getElementById('nombre-proveedor').value || 'Proveedor sin nombre',
                contacto: document.getElementById('contacto-proveedor').value,
                telefono: document.getElementById('telefono-proveedor').value,
                email: document.getElementById('email-proveedor').value,
                productos: document.getElementById('productos-proveedor').value
            };
            proveedores.push(nuevoProveedor);
            localStorage.setItem('proveedores', JSON.stringify(proveedores));
            cargarProveedores();
            cerrarModal('modal-agregar-proveedor');
            document.getElementById('form-agregar-proveedor').reset();
        }

        function editarProveedor(id) {
            const proveedor = proveedores.find(p => p.id === id);
            if (!proveedor) return;
            
            document.getElementById('nombre-proveedor').value = proveedor.nombre;
            document.getElementById('contacto-proveedor').value = proveedor.contacto || '';
            document.getElementById('telefono-proveedor').value = proveedor.telefono || '';
            document.getElementById('email-proveedor').value = proveedor.email || '';
            document.getElementById('productos-proveedor').value = proveedor.productos || '';
            
            mostrarModal('modal-agregar-proveedor');
            
            const form = document.getElementById('form-agregar-proveedor');
            form.onsubmit = e => { e.preventDefault(); actualizarProveedor(id); };
        }

        function actualizarProveedor(id) {
            const index = proveedores.findIndex(p => p.id === id);
            if (index === -1) return;
            
            proveedores[index] = {
                id: id,
                nombre: document.getElementById('nombre-proveedor').value || 'Proveedor sin nombre',
                contacto: document.getElementById('contacto-proveedor').value,
                telefono: document.getElementById('telefono-proveedor').value,
                email: document.getElementById('email-proveedor').value,
                productos: document.getElementById('productos-proveedor').value
            };
            
            localStorage.setItem('proveedores', JSON.stringify(proveedores));
            cargarProveedores();
            cerrarModal('modal-agregar-proveedor');
            
            const form = document.getElementById('form-agregar-proveedor');
            form.onsubmit = e => { e.preventDefault(); guardarNuevoProveedor(); };
            form.reset();
        }

        function eliminarProveedor(id) {
            if (confirm("¬øEst√° seguro de eliminar este proveedor?")) {
                proveedores = proveedores.filter(p => p.id !== id);
                localStorage.setItem('proveedores', JSON.stringify(proveedores));
                cargarProveedores();
            }
        }
        
        function cargarGastos() {
            const contenedor = document.getElementById('lista-gastos');
            if (!contenedor) return;
            
            const filtroMes = document.getElementById('filtro-fecha-gastos').value || new Date().toISOString().slice(0, 7);
            document.getElementById('filtro-fecha-gastos').value = filtroMes;
            const gastosFiltrados = gastos.filter(g => g.fecha.startsWith(filtroMes));
            
            contenedor.innerHTML = '';
            gastosFiltrados.forEach(gasto => {
                const elemento = document.createElement('div');
                elemento.className = 'gasto-item card';
                elemento.innerHTML = `
                    <h3>${gasto.descripcion}</h3>
                    <p><strong>Categor√≠a:</strong> ${gasto.categoria}</p>
                    <p><strong>Monto:</strong> ${gasto.monto.toFixed(2)} Bs</p>
                    <p><strong>Fecha:</strong> ${new Date(gasto.fecha).toLocaleDateString()}</p>
                `;
                contenedor.appendChild(elemento);
            });
            actualizarResumenGastos(gastosFiltrados);
        }

        function filtrarGastos() { cargarGastos(); }

        function actualizarResumenGastos(gastosFiltrados) {
            const total = gastosFiltrados.reduce((sum, gasto) => sum + gasto.monto, 0);
            document.getElementById('total-gastos').textContent = total.toFixed(2);
            const categorias = {};
            gastosFiltrados.forEach(gasto => {
                if (!categorias[gasto.categoria]) categorias[gasto.categoria] = 0;
                categorias[gasto.categoria] += gasto.monto;
            });
            const listaCategorias = document.getElementById('categorias-gastos');
            listaCategorias.innerHTML = '';
            for (const categoria in categorias) {
                const item = document.createElement('li');
                item.textContent = `${categoria}: ${categorias[categoria].toFixed(2)} Bs`;
                listaCategorias.appendChild(item);
            }
        }
        function guardarNuevoGasto() {
            const nuevoGasto = {
                id: Date.now(),
                descripcion: document.getElementById('descripcion-gasto').value || 'Gasto sin descripci√≥n',
                categoria: document.getElementById('categoria-gasto').value,
                monto: parseFloat(document.getElementById('monto-gasto').value) || 0,
                fecha: document.getElementById('fecha-gasto').value
            };
            gastos.push(nuevoGasto);
            localStorage.setItem('gastos', JSON.stringify(gastos));
            cargarGastos();
            cerrarModal('modal-agregar-gasto');
            document.getElementById('form-agregar-gasto').reset();
            document.getElementById('fecha-gasto').value = new Date().toISOString().split('T')[0];
        }
        function cargarEmpleados() {
            const contenedor = document.getElementById('lista-empleados');
            if(!contenedor) return;
            contenedor.innerHTML = '';
            empleados.forEach(e => {
                const el = document.createElement('div');
                el.className = 'empleado-item card';
                el.innerHTML = `<h3>${e.nombre}</h3><p><strong>Cargo:</strong> ${e.cargo || 'N/A'}</p>`;
                contenedor.appendChild(el);
            });
        }
        function guardarNuevoEmpleado(){}
        function cargarMensajes() {
            const contenedor = document.getElementById('lista-mensajes');
            if (!contenedor) return;
            contenedor.innerHTML = '';
            mensajes.forEach(m => {
                const el = document.createElement('div');
                el.className = `mensaje-item card ${m.leido ? '' : 'unread'}`;
                el.innerHTML = `<h3>${m.asunto} ${m.importante ? '‚≠ê' : ''}</h3><p><strong>De:</strong> ${m.remitente}</p>`;
                contenedor.appendChild(el);
            });
        }
        function filtrarMensajes(filtro) { alert(`Filtro: ${filtro}`); }

        // ===== FUNCIONES PARA TIPO DE CAMBIO =====
        function actualizarTipoCambioVisual() {
            document.getElementById('tipo-cambio-btn').textContent = `1$ = ${tipoCambio.toFixed(2)} Bs`;
            document.getElementById('tipo-cambio-venta').textContent = `1$ = ${tipoCambio.toFixed(2)} Bs`;
            document.getElementById('tipo-cambio-actual').textContent = tipoCambio.toFixed(2);
        }

        function cargarHistorialTipoCambio() {
            const contenedor = document.getElementById('historial-tipo-cambio');
            if (!contenedor) return;
            const ultimaActualizacion = historialTipoCambio[historialTipoCambio.length - 1];
            if (ultimaActualizacion) {
                document.getElementById('fecha-actualizacion').textContent = new Date(ultimaActualizacion.fecha).toLocaleDateString();
            }
            contenedor.innerHTML = '';
            historialTipoCambio.slice().reverse().forEach(item => {
                const el = document.createElement('div');
                el.innerHTML = `<p>${new Date(item.fecha).toLocaleDateString()}: 1$ = ${item.tasa.toFixed(2)} Bs</p>`;
                contenedor.appendChild(el);
            });
        }

        function actualizarTipoCambio() {
            const nuevoTipoCambio = parseFloat(document.getElementById('nuevo-tipo-cambio').value);
            if (isNaN(nuevoTipoCambio) || nuevoTipoCambio <= 0) {
                alert('Por favor ingrese un valor v√°lido para el tipo de cambio');
                return;
            }
            tipoCambio = nuevoTipoCambio;
            historialTipoCambio.push({ fecha: new Date().toISOString(), tasa: tipoCambio });
            localStorage.setItem('tipoCambio', tipoCambio);
            localStorage.setItem('historialTipoCambio', JSON.stringify(historialTipoCambio));
            
            inventario.forEach(p => { p.precioBs = p.precioUSD * tipoCambio; });
            localStorage.setItem('inventario', JSON.stringify(inventario));
            
            actualizarTipoCambioVisual();
            cargarHistorialTipoCambio();
            alert('Tipo de cambio actualizado correctamente');
        }

        // ===== FUNCIONES PARA REPORTES =====
        function generarCalendario(year, month) {
            const grid = document.getElementById('calendario-grid');
            const titulo = document.getElementById('mes-actual-titulo');
            grid.innerHTML = '';
            
            const primerDia = new Date(year, month, 1);
            const ultimoDia = new Date(year, month + 1, 0);
            
            const nombresMeses = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            titulo.textContent = `${nombresMeses[month]} ${year}`;
            
            const diasSemana = ['Do', 'Lu', 'Ma', 'Mi', 'Ju', 'Vi', 'Sa'];
            diasSemana.forEach(dia => {
                const diaEl = document.createElement('div');
                diaEl.className = 'calendario-dia-nombre';
                diaEl.textContent = dia;
                grid.appendChild(diaEl);
            });

            for (let i = 0; i < primerDia.getDay(); i++) {
                grid.appendChild(document.createElement('div'));
            }
            
            for (let dia = 1; dia <= ultimoDia.getDate(); dia++) {
                const diaEl = document.createElement('div');
                diaEl.className = 'calendario-dia';
                diaEl.textContent = dia;
                const fechaActual = new Date(year, month, dia);

                const hoy = new Date();
                if (fechaActual.toDateString() === hoy.toDateString()) {
                    diaEl.classList.add('dia-actual');
                }

                diaEl.addEventListener('click', () => {
                    document.querySelectorAll('.calendario-dia').forEach(d => d.classList.remove('dia-seleccionado'));
                    diaEl.classList.add('dia-seleccionado');
                    mostrarVentasDelDia(fechaActual);
                });
                grid.appendChild(diaEl);
            }
        }
        
        function formatoFechaDetallado(timestamp) {
            const fecha = new Date(timestamp);
            const opciones = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const hora = fecha.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true }).toLowerCase();
            return `${hora} / ${fecha.toLocaleDateString('es-ES', opciones)}`;
        }

        function mostrarVentasDelDia(fecha) {
            const contenedor = document.getElementById('reporte-diario-container');
            const ventas = JSON.parse(localStorage.getItem('ventas')) || [];
            
            const ventasDelDia = ventas.filter(venta => {
                const fechaVenta = new Date(venta.timestamp);
                return fechaVenta.toDateString() === fecha.toDateString();
            });

            if (ventasDelDia.length === 0) {
                contenedor.innerHTML = `<p>No se encontraron ventas para el ${fecha.toLocaleDateString('es-ES')}.</p>`;
                return;
            }

            let reporteHtml = `<h4>Ventas de ${fecha.toLocaleDateString('es-ES')}</h4>`;
            ventasDelDia.forEach(venta => {
                const productosDesc = venta.productos.map(p => `${p.cantidad} x ${p.nombre}`).join(', ');
                const totalUSD = venta.productos.reduce((acc, p) => acc + p.precioUSD * p.cantidad, 0);

                reporteHtml += `
                    <div class="reporte-item card">
                        <strong>${formatoFechaDetallado(venta.timestamp)}</strong>
                        <p>Venta de ${productosDesc}. Por ${venta.metodoPago} en ${totalUSD.toFixed(2)}$ / Bs ${venta.totalBs.toFixed(2)}</p>
                        <p>Cliente: ${venta.cliente ? venta.cliente.nombre : 'General'}</p>
                    </div>
                `;
            });
            contenedor.innerHTML = reporteHtml;
        }

        function generarReporte() {
            alert('Generando reporte general...');
        }

        // ===== FUNCIONES PARA CONFIGURACI√ìN =====
        function cargarConfiguracion() {
            document.getElementById('nombre-empresa').value = configuracion.empresa.nombre;
            document.getElementById('rif-empresa').value = configuracion.empresa.rif;
            document.getElementById('telefono-empresa').value = configuracion.empresa.telefono;
            document.getElementById('direccion-empresa').value = configuracion.empresa.direccion;
            
            const btnTema = document.getElementById('btn-cambiar-tema');
            btnTema.textContent = configuracion.tema === 'claro' ? 'Cambiar a Modo Oscuro' : 'Cambiar a Modo Claro';
            
            if (configuracion.tema === 'oscuro') document.body.classList.add('tema-oscuro');
            else document.body.classList.remove('tema-oscuro');
        }

        function cambiarTema() {
            configuracion.tema = (configuracion.tema === 'claro' ? 'oscuro' : 'claro');
            localStorage.setItem('configuracion', JSON.stringify(configuracion));
            cargarConfiguracion();
        }

        function guardarConfiguracionEmpresa() {
            configuracion.empresa = {
                nombre: document.getElementById('nombre-empresa').value,
                rif: document.getElementById('rif-empresa').value,
                telefono: document.getElementById('telefono-empresa').value,
                direccion: document.getElementById('direccion-empresa').value
            };
            localStorage.setItem('configuracion', JSON.stringify(configuracion));
            alert('Configuraci√≥n de empresa guardada correctamente');
        }

        function respaldarDatos() {
            const datos = { inventario, clientes, proveedores, gastos, empleados, mensajes, tipoCambio, configuracion, ventas: JSON.parse(localStorage.getItem('ventas')) || [] };
            const datosStr = JSON.stringify(datos, null, 2);
            const blob = new Blob([datosStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `respaldo_gestor_empresarial_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            alert('Respaldo de datos (JSON) generado correctamente');
        }

        function restaurarDatos() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = e => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = e => {
                    try {
                        const datos = JSON.parse(e.target.result);
                        if (confirm("¬øRestaurar desde JSON? Se sobrescribir√°n los datos actuales.")) {
                            inventario = datos.inventario || [];
                            localStorage.setItem('inventario', JSON.stringify(inventario));
                            localStorage.setItem('ventas', JSON.stringify(datos.ventas || []));
                            alert('Datos restaurados desde JSON correctamente. Recargando...');
                            location.reload();
                        }
                    } catch (error) { alert('Error: El archivo JSON no es v√°lido'); }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function exportarDatosExcel() {
            const wb = XLSX.utils.book_new();
            const ventas = JSON.parse(localStorage.getItem('ventas')) || [];
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(inventario), "Inventario");
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(clientes), "Clientes");
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(proveedores), "Proveedores");
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(gastos), "Gastos");
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(empleados), "Empleados");
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(ventas), "Ventas");
            XLSX.writeFile(wb, `Respaldo_Gestor_${new Date().toISOString().split('T')[0]}.xlsx`);
            alert('Respaldo de datos (Excel) generado correctamente.');
        }

        function importarDatosExcel() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.xlsx, .xls';
            input.onchange = e => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = e => {
                    try {
                        if (confirm("¬øRestaurar desde Excel? Se sobrescribir√°n los datos actuales.")) {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });
                            const leerHoja = (nombreHoja) => XLSX.utils.sheet_to_json(workbook.Sheets[nombreHoja]);
                            localStorage.setItem('inventario', JSON.stringify(leerHoja("Inventario")));
                            localStorage.setItem('clientes', JSON.stringify(leerHoja("Clientes")));
                            localStorage.setItem('proveedores', JSON.stringify(leerHoja("Proveedores")));
                            localStorage.setItem('gastos', JSON.stringify(leerHoja("Gastos")));
                            localStorage.setItem('empleados', JSON.stringify(leerHoja("Empleados")));
                            localStorage.setItem('ventas', JSON.stringify(leerHoja("Ventas")));
                            alert('Datos restaurados desde Excel correctamente. Recargando...');
                            location.reload();
                        }
                    } catch (error) { alert('Error al procesar el archivo Excel.'); }
                };
                reader.readAsArrayBuffer(file);
            };
            input.click();
        }


        function eliminarTodosDatos() {
            if (confirm("¬øEST√Å ABSOLUTAMENTE SEGURO? Esta acci√≥n eliminar√° TODOS los datos y no se puede deshacer.")) {
                localStorage.clear();
                alert('Todos los datos han sido eliminados. La p√°gina se recargar√°.');
                location.reload();
            }
        }
    </script>
</body>
</html>
