<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Escaparate - Cliente</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --success: #27ae60;
            --danger: #e74c3c;
            --warning: #f39c12;
            --light: #ecf0f1;
            --dark: #2c3e50;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 15px;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logo i {
            font-size: 24px;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.2);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: var(--success);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .offline .status-dot {
            background-color: var(--danger);
            animation: none;
        }
        
        .user-menu {
            position: relative;
        }
        
        .user-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .user-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            color: #333;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            width: 200px;
            z-index: 100;
            margin-top: 5px;
        }
        
        .user-dropdown.show {
            display: block;
        }
        
        .user-dropdown-item {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .user-dropdown-item:last-child {
            border-bottom: none;
        }
        
        .user-dropdown-item:hover {
            background-color: #f5f5f5;
        }
        
        .tabs {
            display: flex;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }
        
        .tab.active {
            border-bottom: 3px solid var(--secondary);
            background-color: rgba(52, 152, 219, 0.1);
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .product-card {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }
        
        .product-card:hover {
            transform: translateY(-5px);
        }
        
        .product-image {
            height: 160px;
            background-color: #eee;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        
        .product-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .product-info {
            padding: 15px;
        }
        
        .product-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .product-description {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }
        
        .product-price {
            color: var(--success);
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .product-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .btn-primary {
            background-color: var(--secondary);
            color: white;
        }
        
        .btn-success {
            background-color: var(--success);
            color: white;
        }
        
        .btn-warning {
            background-color: var(--warning);
            color: white;
        }
        
        .cart-badge {
            background-color: var(--danger);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            position: absolute;
            top: -5px;
            right: -5px;
        }
        
        .cart-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        .cart-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--secondary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            cursor: pointer;
            position: relative;
        }
        
        .cart-panel {
            display: none;
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 350px;
            max-height: 500px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            overflow: hidden;
        }
        
        .cart-panel.show {
            display: flex;
            flex-direction: column;
        }
        
        .cart-header {
            background: var(--primary);
            color: white;
            padding: 15px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .cart-items {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            max-height: 350px;
        }
        
        .cart-item {
            display: flex;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        
        .cart-item-image {
            width: 50px;
            height: 50px;
            border-radius: 5px;
            background: #eee;
            margin-right: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .cart-item-info {
            flex: 1;
        }
        
        .cart-item-name {
            font-weight: bold;
            font-size: 14px;
        }
        
        .cart-item-price {
            font-size: 14px;
            color: var(--success);
        }
        
        .cart-item-quantity {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .quantity-btn {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: #eee;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        
        .cart-footer {
            padding: 15px;
            border-top: 1px solid #eee;
        }
        
        .cart-total {
            display: flex;
            justify-content: space-between;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .checkout-btn {
            width: 100%;
            padding: 12px;
            background: var(--success);
            color: white;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 500px;
            border: 1px solid #ddd;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .chat-header {
            background-color: var(--primary);
            color: white;
            padding: 15px;
            font-weight: bold;
        }
        
        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background-color: #f9f9f9;
        }
        
        .message {
            margin-bottom: 15px;
            max-width: 80%;
        }
        
        .message.received {
            align-self: flex-start;
        }
        
        .message.sent {
            align-self: flex-end;
            margin-left: auto;
        }
        
        .message-bubble {
            padding: 10px 15px;
            border-radius: 18px;
            position: relative;
        }
        
        .received .message-bubble {
            background-color: white;
            border-bottom-left-radius: 5px;
        }
        
        .sent .message-bubble {
            background-color: var(--secondary);
            color: white;
            border-bottom-right-radius: 5px;
        }
        
        .message-time {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }
        
        .chat-input {
            display: flex;
            padding: 15px;
            background-color: white;
            border-top: 1px solid #ddd;
        }
        
        .chat-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 20px;
            margin-right: 10px;
        }
        
        .login-form {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 1000;
            transform: translateX(150%);
            transition: transform 0.3s;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification-success {
            border-left: 4px solid var(--success);
        }
        
        .notification-error {
            border-left: 4px solid var(--danger);
        }
        
        .p2p-status {
            background: #f8f9fa;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid var(--secondary);
        }
        
        @media (max-width: 768px) {
            .product-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }
            
            header {
                flex-direction: column;
                gap: 10px;
            }
            
            .cart-panel {
                width: 90%;
                right: 5%;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header>
            <div class="logo">
                <i class="fas fa-store"></i>
                <h1 id="storeName">Mi Pequeña Bodeguita</h1>
            </div>
            <div class="status-indicator" id="statusIndicator">
                <div class="status-dot"></div>
                <span id="statusText">Conectando...</span>
            </div>
            <div class="user-menu">
                <button class="user-btn" id="userMenuBtn">
                    <i class="fas fa-user"></i>
                    <span id="userName">Iniciar Sesión</span>
                    <i class="fas fa-chevron-down"></i>
                </button>
                <div class="user-dropdown" id="userDropdown">
                    <div class="user-dropdown-item" id="loginBtn">
                        <i class="fas fa-sign-in-alt"></i>
                        <span>Iniciar Sesión</span>
                    </div>
                    <div class="user-dropdown-item" id="registerBtn">
                        <i class="fas fa-user-plus"></i>
                        <span>Registrarse</span>
                    </div>
                    <div class="user-dropdown-item" id="profileBtn" style="display: none;">
                        <i class="fas fa-user-circle"></i>
                        <span>Mi Perfil</span>
                    </div>
                    <div class="user-dropdown-item" id="logoutBtn" style="display: none;">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Cerrar Sesión</span>
                    </div>
                </div>
            </div>
        </header>
        
        <div class="p2p-status">
            <strong>Estado de Conexión:</strong> 
            <span id="p2pStatus">Inicializando...</span>
        </div>
        
        <div class="tabs">
            <div class="tab active" data-tab="catalog">Catálogo</div>
            <div class="tab" data-tab="chat">Chat con la Tienda</div>
            <div class="tab" data-tab="orders">Mis Pedidos</div>
        </div>
        
        <div class="tab-content active" id="catalog-tab">
            <h2>Productos Disponibles</h2>
            <div class="product-grid" id="productGrid">
                <p>Buscando conexión con la tienda...</p>
            </div>
        </div>
        
        <div class="tab-content" id="chat-tab">
            <h2>Chat con la Tienda</h2>
            
            <div class="chat-container">
                <div class="chat-header" id="chatHeader">
                    Conecta con la tienda para chatear
                </div>
                <div class="chat-messages" id="chatMessages">
                    <div class="message received">
                        <div class="message-bubble">
                            Bienvenido! Conéctate a la tienda para comenzar a chatear.
                        </div>
                    </div>
                </div>
                <div class="chat-input">
                    <input type="text" id="messageInput" placeholder="Conecta con la tienda primero..." disabled>
                    <button class="btn btn-primary" id="sendMessageBtn" disabled>
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <div class="tab-content" id="orders-tab">
            <h2>Mis Pedidos</h2>
            <div id="ordersList">
                <p>No has realizado ningún pedido.</p>
            </div>
        </div>
        
        <div class="cart-container">
            <div class="cart-btn" id="cartBtn">
                <i class="fas fa-shopping-cart"></i>
                <div class="cart-badge" id="cartBadge" style="display: none;">0</div>
            </div>
            <div class="cart-panel" id="cartPanel">
                <div class="cart-header">
                    <span>Mi Carrito</span>
                    <i class="fas fa-times" id="closeCart"></i>
                </div>
                <div class="cart-items" id="cartItems">
                    <p style="text-align: center; color: #666;">Tu carrito está vacío</p>
                </div>
                <div class="cart-footer">
                    <div class="cart-total">
                        <span>Total:</span>
                        <span id="cartTotal">0.00 Bs</span>
                    </div>
                    <button class="checkout-btn" id="checkoutBtn">
                        <i class="fas fa-credit-card"></i> Realizar Pedido
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="authModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center;">
        <div class="login-form">
            <h3 id="authModalTitle">Iniciar Sesión</h3>
            
            <div class="form-group">
                <label for="authName">Nombre Completo</label>
                <input type="text" id="authName" class="form-control">
            </div>
            
            <div class="form-group">
                <label for="authEmail">Correo Electrónico</label>
                <input type="email" id="authEmail" class="form-control">
            </div>
            
            <div class="form-group">
                <label for="authPhone">Teléfono</label>
                <input type="tel" id="authPhone" class="form-control">
            </div>
            
            <div class="form-group">
                <label for="authAddress">Dirección</label>
                <textarea id="authAddress" class="form-control" rows="3"></textarea>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button class="btn" id="cancelAuthBtn">Cancelar</button>
                <button class="btn btn-success" id="confirmAuthBtn">Continuar</button>
            </div>
            
            <div style="text-align: center; margin-top: 15px;">
                <a href="#" id="switchAuthMode">¿No tienes cuenta? Regístrate aquí</a>
            </div>
        </div>
    </div>
    
    <div id="checkoutModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center;">
        <div style="background: white; padding: 20px; border-radius: 10px; width: 90%; max-width: 500px;">
            <h3>Confirmar Pedido</h3>
            
            <div id="checkoutSummary">
                </div>
            
            <div class="form-group">
                <label for="paymentMethod">Método de Pago</label>
                <select id="paymentMethod" class="form-control">
                    <option value="pago-movil">Pago Móvil</option>
                    <option value="transferencia">Transferencia Bancaria</option>
                    <option value="efectivo">Efectivo en Tienda</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="deliveryOption">Opción de Entrega</label>
                <select id="deliveryOption" class="form-control">
                    <option value="pickup">Recoger en Tienda</option>
                    <option value="delivery">Delivery a Domicilio</option>
                </select>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button class="btn" id="cancelCheckoutBtn">Cancelar</button>
                <button class="btn btn-success" id="confirmCheckoutBtn">Confirmar Pedido</button>
            </div>
        </div>
    </div>
    
    <div class="notification notification-success" id="successNotification">
        <i class="fas fa-check-circle"></i>
        <span id="notificationText">Operación exitosa</span>
    </div>
    
    <div class="notification notification-error" id="errorNotification">
        <i class="fas fa-exclamation-circle"></i>
        <span id="errorNotificationText">Ha ocurrido un error</span>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.4.7/peerjs.min.js"></script>
    <script>
        // =================================================================================
        // INSTRUCCIÓN PARA EL DESARROLLADOR:
        // 1. Aquí abajo está la lista de los 100 PINES predefinidos.
        //    Puedes generar y reemplazar estos pines por tus propios códigos únicos.
        const PREDEFINED_PINS = [
            '11223344', '55667788', '99001122', '33445566', '77889900', '12121212', '34343434', '56565656', '78787878', '90909090',
            '21212121', '43434343', '65656565', '87878787', '09090909', '11112222', '33334444', '55556666', '77778888', '99990000',
            '10203040', '50607080', '90807060', '50403020', '12345678', '87654321', '11224488', '13243546', '98761234', '43216789',
            '22332233', '44554455', '66776677', '88998899', '00110011', '88881111', '22228888', '33337777', '44446666', '55551111',
            '91827364', '55588811', '29384756', '10002000', '30004000', '50006000', '70008000', '90001000', '19912992', '39934994',
            '58856886', '78878878', '15253545', '55443322', '10102020', '30304040', '50506060', '70708080', '90900000', '11111111',
            '22222222', '33333333', '44444444', '55555555', '66666666', '77777777', '88888888', '99999999', '00000000', '12131415',
            '16171819', '21232425', '26272829', '31323435', '36373839', '41424345', '46474849', '51525354', '56575859', '61626364',
            '65676869', '71727374', '75767879', '81828384', '85868789', '91929394', '95969798', '10011002', '10031004', '10051006',
            '10071008', '10091010', '20012002', '20032004', '20052006', '20072008', '20092010', '30013002', '30033004', '30053006'
        ];
        
        // 2. Selecciona qué PIN de la lista de arriba usará este archivo.
        const CLIENT_PIN_INDEX = 0;
        const CLIENT_PIN = PREDEFINED_PINS[CLIENT_PIN_INDEX];

        // =================================================================================
        // MEJORAS PARA CONEXIÓN ENTRE REDES
        // =================================================================================

        // Servidores TURN adicionales para mejor conectividad
        const ICE_SERVERS = [
            { urls: 'stun:stun.l.google.com:19302' },
            { urls: 'stun:stun1.l.google.com:19302' },
            { urls: 'stun:stun2.l.google.com:19302' },
            { urls: 'stun:stun3.l.google.com:19302' },
            { urls: 'stun:stun4.l.google.com:19302' },
            { urls: 'stun:global.stun.twilio.com:3478' },
            { urls: 'turn:numb.viagenie.ca:3478', username: 'webrtc@live.com', credential: 'muazkh' },
            { urls: 'turn:openrelay.metered.ca:80', username: 'openrelayproject', credential: 'openrelayproject' },
            { urls: 'turn:openrelay.metered.ca:443', username: 'openrelayproject', credential: 'openrelayproject' },
            { urls: 'turn:openrelay.metered.ca:443?transport=tcp', username: 'openrelayproject', credential: 'openrelayproject' }
        ];

        // Configuración mejorada de PeerJS
        const PEER_CONFIG = {
            debug: 2,
            config: { iceServers: ICE_SERVERS },
            iceTransportPolicy: 'all',
            sdpSemantics: 'unified-plan'
        };

        // Variables para reintentos
        let connectionRetries = 0;
        const MAX_RETRIES = 5;
        const RETRY_DELAY = 3000;

        // =================================================================================

        // Estado de la aplicación
        const state = {
            user: null,
            products: [],
            cart: [],
            orders: [],
            exchangeRate: 35.50,
            deliveryCost: 5.00,
            storeName: "Mi Pequeña Bodeguita",
            peer: null,
            storeConnection: null,
            isConnected: false,
            messages: []
        };
        
        // Elementos DOM
        const elements = {
            statusIndicator: document.getElementById('statusIndicator'),
            statusText: document.getElementById('statusText'),
            p2pStatus: document.getElementById('p2pStatus'),
            storeName: document.getElementById('storeName'),
            userName: document.getElementById('userName'),
            userMenuBtn: document.getElementById('userMenuBtn'),
            userDropdown: document.getElementById('userDropdown'),
            productGrid: document.getElementById('productGrid'),
            cartBtn: document.getElementById('cartBtn'),
            cartBadge: document.getElementById('cartBadge'),
            cartPanel: document.getElementById('cartPanel'),
            cartItems: document.getElementById('cartItems'),
            cartTotal: document.getElementById('cartTotal'),
            chatHeader: document.getElementById('chatHeader'),
            chatMessages: document.getElementById('chatMessages'),
            messageInput: document.getElementById('messageInput'),
            sendMessageBtn: document.getElementById('sendMessageBtn'),
            ordersList: document.getElementById('ordersList'),
            authModal: document.getElementById('authModal'),
            authModalTitle: document.getElementById('authModalTitle'),
            checkoutModal: document.getElementById('checkoutModal'),
            checkoutSummary: document.getElementById('checkoutSummary'),
            successNotification: document.getElementById('successNotification'),
            errorNotification: document.getElementById('errorNotification'),
        };
        
        // Inicialización
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof CLIENT_PIN === 'undefined' || CLIENT_PIN.length !== 8) {
                alert('ERROR: El PIN de cliente no está configurado correctamente en el código fuente.');
                 elements.p2pStatus.textContent = 'Error de configuración de PIN.';
                 elements.p2pStatus.style.color = 'red';
                return;
            }
            initializeApp();
            setupEventListeners();
            initializeP2P();
        });
        
        function initializeApp() {
            // Cargar datos guardados
            const savedUser = localStorage.getItem('tiendaUser');
            const savedCart = localStorage.getItem('tiendaCart');
            const savedOrders = localStorage.getItem('tiendaOrders');
            
            if (savedUser) {
                state.user = JSON.parse(savedUser);
                updateUserInterface();
            }
            
            if (savedCart) {
                state.cart = JSON.parse(savedCart);
                updateCart();
            }
            
            if (savedOrders) {
                state.orders = JSON.parse(savedOrders);
            }
        }
        
        function initializeP2P() {
            try {
                // El cliente usa un ID de Peer anónimo
                state.peer = new Peer(PEER_CONFIG);
                
                state.peer.on('open', function(id) {
                    console.log('Peer Cliente conectado con ID:', id);
                    elements.p2pStatus.textContent = 'Listo. Intentando conectar con la tienda...';
                    elements.p2pStatus.style.color = 'orange';
                    connectionRetries = 0;
                    connectToStore();
                });
                
                state.peer.on('error', function(err) {
                    console.error('Error PeerJS:', err);
                    
                    if (err.type === 'unavailable-id' || err.type === 'server-error') {
                        elements.p2pStatus.textContent = 'Error de servidor. Reconectando...';
                        setTimeout(initializeP2P, RETRY_DELAY);
                    } else if (err.type === 'network' || err.type === 'disconnected') {
                        elements.p2pStatus.textContent = 'Error de red. Intentando reconexión...';
                        setTimeout(initializeP2P, RETRY_DELAY);
                    } else {
                        elements.p2pStatus.textContent = 'Error: ' + err.type;
                        elements.p2pStatus.style.color = 'red';
                    }
                    
                    showNotification('Error en conexión P2P: ' + err.type, 'error');
                });
                
            } catch (error) {
                console.error('Error inicializando P2P:', error);
                elements.p2pStatus.textContent = 'Error fatal al inicializar P2P.';
                elements.p2pStatus.style.color = 'red';
                
                if (connectionRetries < MAX_RETRIES) {
                    connectionRetries++;
                    setTimeout(initializeP2P, RETRY_DELAY);
                }
            }
        }
        
        function connectToStore() {
            const storePeerId = 'mi-tienda-admin-' + CLIENT_PIN;
            
            try {
                console.log('Intentando conectar con:', storePeerId);
                
                if (!state.peer || state.peer.disconnected) {
                    console.log('Peer desconectado, reintentando...');
                    if (connectionRetries < MAX_RETRIES) {
                        connectionRetries++;
                        setTimeout(connectToStore, RETRY_DELAY);
                    }
                    return;
                }
                
                const conn = state.peer.connect(storePeerId, {
                    reliable: true,
                    serialization: 'json',
                    metadata: {
                        clientType: 'customer',
                        pin: CLIENT_PIN,
                        timestamp: new Date().toISOString()
                    }
                });
                
                if (!conn) {
                    throw new Error('No se pudo crear la conexión');
                }
                
                setupStoreConnection(conn);
                
            } catch (error) {
                console.error('Error conectando a la tienda:', error);
                
                if (connectionRetries < MAX_RETRIES) {
                    connectionRetries++;
                    elements.p2pStatus.textContent = `Reintentando conexión... (${connectionRetries}/${MAX_RETRIES})`;
                    elements.p2pStatus.style.color = 'orange';
                    setTimeout(connectToStore, RETRY_DELAY);
                } else {
                    showNotification('No se pudo conectar a la tienda después de ' + MAX_RETRIES + ' intentos', 'error');
                    elements.p2pStatus.textContent = 'Conexión fallida. Recarga la página para reintentar.';
                    elements.p2pStatus.style.color = 'red';
                }
            }
        }

        function checkConnectionHealth() {
            if (state.storeConnection && state.storeConnection.open) {
                sendToStore({
                    type: 'ping',
                    data: { timestamp: Date.now() }
                });
                
                setTimeout(checkConnectionHealth, 15000);
            }
        }
        
        function setupStoreConnection(conn) {
            state.storeConnection = conn;
            
            conn.on('open', function() {
                console.log('Conectado a la tienda:', conn.peer);
                state.isConnected = true;
                connectionRetries = 0;
                elements.p2pStatus.textContent = 'Conectado a la tienda.';
                elements.p2pStatus.style.color = 'green';
                elements.statusText.textContent = 'Tienda Conectada';
                elements.statusIndicator.classList.remove('offline');
                elements.chatHeader.textContent = 'Chat con la Tienda';
                elements.messageInput.disabled = false;
                elements.messageInput.placeholder = 'Escribe un mensaje...';
                elements.sendMessageBtn.disabled = false;
                
                setTimeout(checkConnectionHealth, 15000);
                
                if (state.user) {
                    sendToStore({
                        type: 'user_info',
                        data: state.user
                    });
                }
                
                showNotification('Conectado a la tienda exitosamente', 'success');
            });
            
            conn.on('data', function(data) {
                console.log('Datos recibidos de la tienda:', data);
                handleStoreData(data);
            });
            
            conn.on('close', function() {
                console.log('Conexión con la tienda cerrada');
                state.isConnected = false;
                elements.p2pStatus.textContent = 'Desconectado de la tienda. Intenta recargar la página.';
                elements.p2pStatus.style.color = 'red';
                elements.statusText.textContent = 'Tienda Desconectada';
                elements.statusIndicator.classList.add('offline');
                elements.messageInput.disabled = true;
                elements.messageInput.placeholder = 'Conexión perdida...';
                elements.sendMessageBtn.disabled = true;
                
                showNotification('Desconectado de la tienda', 'error');
            });
            
            conn.on('error', function(err) {
                console.error('Error en conexión con tienda:', err);
                showNotification('Error en conexión con la tienda', 'error');
            });
        }
        
        function handleStoreData(data) {
            switch (data.type) {
                case 'store_data':
                    state.products = data.data.products || [];
                    state.exchangeRate = data.data.exchangeRate || 35.50;
                    state.deliveryCost = data.data.deliveryCost || 5.00;
                    state.storeName = data.data.storeName || "Mi Pequeña Bodeguita";
                    
                    elements.storeName.textContent = state.storeName;
                    renderProducts();
                    showNotification('Catálogo cargado', 'success');
                    break;
                    
                case 'products_update':
                    state.products = data.data;
                    renderProducts();
                    showNotification('Productos actualizados', 'success');
                    break;
                    
                case 'settings_update':
                    state.exchangeRate = data.data.exchangeRate;
                    state.deliveryCost = data.data.deliveryCost;
                    state.storeName = data.data.storeName;
                    
                    elements.storeName.textContent = state.storeName;
                    renderProducts();
                    updateCart();
                    showNotification('Configuración de la tienda actualizada', 'success');
                    break;
                    
                case 'message':
                    addMessageToChat(data.data.text, 'received', data.data.timestamp);
                    state.messages.push({
                        text: data.data.text,
                        sender: 'received',
                        timestamp: new Date(data.data.timestamp)
                    });
                    break;
                    
                case 'order_confirmation':
                    showNotification('Pedido confirmado por la tienda', 'success');
                    break;
                    
                case 'order_update':
                    const order = state.orders.find(o => o.id === data.data.orderId);
                    if (order) {
                        order.status = data.data.status;
                        localStorage.setItem('tiendaOrders', JSON.stringify(state.orders));
                        if (document.getElementById('orders-tab').classList.contains('active')) {
                            renderUserOrders();
                        }
                        showNotification(`Pedido ${data.data.orderId} ${data.data.status}`, 'success');
                    }
                    break;

                case 'pong':
                    console.log('Conexión saludable con tienda');
                    break;
            }
        }
        
        function sendToStore(data) {
            if (state.storeConnection && state.storeConnection.open) {
                state.storeConnection.send(data);
            } else {
                showNotification('No hay conexión con la tienda', 'error');
            }
        }
        
        function setupEventListeners() {
            // Tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });
            
            // Menú de usuario
            elements.userMenuBtn.addEventListener('click', function() {
                elements.userDropdown.classList.toggle('show');
            });
            
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.user-menu')) {
                    elements.userDropdown.classList.remove('show');
                }
            });
            
            // Botones de autenticación
            document.getElementById('loginBtn').addEventListener('click', showAuthModal);
            document.getElementById('registerBtn').addEventListener('click', showAuthModal);
            document.getElementById('profileBtn').addEventListener('click', showProfile);
            document.getElementById('logoutBtn').addEventListener('click', logout);
            
            // Modal de autenticación
            document.getElementById('cancelAuthBtn').addEventListener('click', hideAuthModal);
            document.getElementById('confirmAuthBtn').addEventListener('click', processAuth);
            document.getElementById('switchAuthMode').addEventListener('click', switchAuthMode);
            
            // Carrito
            elements.cartBtn.addEventListener('click', toggleCart);
            document.getElementById('closeCart').addEventListener('click', toggleCart);
            document.getElementById('checkoutBtn').addEventListener('click', showCheckoutModal);
            
            // Checkout
            document.getElementById('cancelCheckoutBtn').addEventListener('click', hideCheckoutModal);
            document.getElementById('confirmCheckoutBtn').addEventListener('click', confirmOrder);
            
            // Chat
            elements.sendMessageBtn.addEventListener('click', sendMessage);
            elements.messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') sendMessage();
            });
        }
        
        function switchTab(tabId) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            document.querySelector(`.tab[data-tab="${tabId}"]`).classList.add('active');
            document.getElementById(`${tabId}-tab`).classList.add('active');
            
            if (tabId === 'catalog') {
                renderProducts();
            } else if (tabId === 'orders') {
                renderUserOrders();
            } else if (tabId === 'chat') {
                loadChatHistory();
            }
        }
        
        function updateUserInterface() {
            if (state.user) {
                elements.userName.textContent = state.user.name;
                document.getElementById('loginBtn').style.display = 'none';
                document.getElementById('registerBtn').style.display = 'none';
                document.getElementById('profileBtn').style.display = 'flex';
                document.getElementById('logoutBtn').style.display = 'flex';
                
                if (state.isConnected) {
                    sendToStore({
                        type: 'user_info',
                        data: state.user
                    });
                }
            } else {
                elements.userName.textContent = 'Iniciar Sesión';
                document.getElementById('loginBtn').style.display = 'flex';
                document.getElementById('registerBtn').style.display = 'flex';
                document.getElementById('profileBtn').style.display = 'none';
                document.getElementById('logoutBtn').style.display = 'none';
            }
        }
        
        function showAuthModal() {
            state.isLoginMode = this.id === 'loginBtn';
            elements.authModalTitle.textContent = state.isLoginMode ? 'Iniciar Sesión' : 'Registrarse';
            elements.authModal.style.display = 'flex';
            
            document.getElementById('authName').value = '';
            document.getElementById('authEmail').value = '';
            document.getElementById('authPhone').value = '';
            document.getElementById('authAddress').value = '';
        }
        
        function hideAuthModal() {
            elements.authModal.style.display = 'none';
        }
        
        function switchAuthMode() {
            state.isLoginMode = !state.isLoginMode;
            elements.authModalTitle.textContent = state.isLoginMode ? 'Iniciar Sesión' : 'Registrarse';
            document.getElementById('switchAuthMode').textContent = state.isLoginMode ? 
                '¿No tienes cuenta? Regístrate aquí' : '¿Ya tienes cuenta? Inicia sesión aquí';
        }
        
        function processAuth() {
            const name = document.getElementById('authName').value;
            const email = document.getElementById('authEmail').value;
            const phone = document.getElementById('authPhone').value;
            const address = document.getElementById('authAddress').value;
            
            if (!name || !email) {
                showNotification('Nombre y correo electrónico son obligatorios', 'error');
                return;
            }
            
            state.user = {
                id: 'user_' + Date.now(),
                name,
                email,
                phone,
                address,
                joinDate: new Date()
            };
            
            localStorage.setItem('tiendaUser', JSON.stringify(state.user));
            
            updateUserInterface();
            hideAuthModal();
            showNotification(state.isLoginMode ? 'Sesión iniciada correctamente' : 'Registro exitoso', 'success');
        }
        
        function showProfile() {
            alert(`Perfil de Usuario:\n\nNombre: ${state.user.name}\nEmail: ${state.user.email}\nTeléfono: ${state.user.phone}\nDirección: ${state.user.address}`);
        }
        
        function logout() {
            state.user = null;
            localStorage.removeItem('tiendaUser');
            updateUserInterface();
            showNotification('Sesión cerrada', 'success');
        }
        
        function renderProducts() {
            elements.productGrid.innerHTML = '';
            
            if (state.products.length === 0) {
                elements.productGrid.innerHTML = '<p>No hay productos disponibles. Esperando conexión con la tienda...</p>';
                return;
            }
            
            state.products.forEach(product => {
                const priceInBs = (product.price * state.exchangeRate).toFixed(2);
                const inCart = state.cart.find(item => item.productId === product.id);
                
                const productCard = document.createElement('div');
                productCard.className = 'product-card';
                productCard.innerHTML = `
                    <div class="product-image">
                        ${product.image ? 
                            `<img src="${product.image}" alt="${product.name}" onerror="this.style.display='none'">` : 
                            `<i class="fas fa-box" style="font-size: 50px; color: #ccc;"></i>`
                        }
                    </div>
                    <div class="product-info">
                        <div class="product-name">${product.name}</div>
                        <div class="product-description">${product.description}</div>
                        <div class="product-price">$${product.price} USD | ${priceInBs} Bs</div>
                        <div class="product-actions">
                            ${inCart ? 
                                `<button class="btn btn-warning remove-from-cart" data-id="${product.id}">
                                    <i class="fas fa-minus"></i> Quitar
                                </button>` :
                                `<button class="btn btn-primary add-to-cart" data-id="${product.id}">
                                    <i class="fas fa-cart-plus"></i> Agregar
                                </button>`
                            }
                            <button class="btn btn-success ask-about-product" data-id="${product.id}">
                                <i class="fas fa-comment"></i> Consultar
                            </button>
                        </div>
                    </div>
                `;
                
                elements.productGrid.appendChild(productCard);
            });
            
            document.querySelectorAll('.add-to-cart').forEach(btn => {
                btn.addEventListener('click', function() {
                    const productId = this.getAttribute('data-id');
                    addToCart(productId);
                });
            });
            
            document.querySelectorAll('.remove-from-cart').forEach(btn => {
                btn.addEventListener('click', function() {
                    const productId = this.getAttribute('data-id');
                    removeFromCart(productId);
                });
            });
            
            document.querySelectorAll('.ask-about-product').forEach(btn => {
                btn.addEventListener('click', function() {
                    const productId = this.getAttribute('data-id');
                    const product = state.products.find(p => p.id === productId);
                    if (product && state.isConnected) {
                        const message = `Hola, me interesa el producto: ${product.name}. ¿Podrían darme más información?`;
                        elements.messageInput.value = message;
                        sendMessage();
                        switchTab('chat');
                    } else if (!state.isConnected) {
                        showNotification('Conéctate a la tienda para consultar', 'error');
                    }
                });
            });
        }
        
        function addToCart(productId) {
            if (!state.user) {
                showNotification('Debes iniciar sesión para agregar productos al carrito', 'error');
                showAuthModal();
                return;
            }
            
            const product = state.products.find(p => p.id === productId);
            if (!product) return;
            
            const existingItem = state.cart.find(item => item.productId === productId);
            
            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                state.cart.push({
                    productId,
                    name: product.name,
                    price: product.price,
                    image: product.image,
                    quantity: 1
                });
            }
            
            updateCart();
            renderProducts();
            showNotification(`${product.name} agregado al carrito`, 'success');
        }
        
        function removeFromCart(productId) {
            state.cart = state.cart.filter(item => item.productId !== productId);
            updateCart();
            renderProducts();
            showNotification('Producto removido del carrito', 'success');
        }
        
        function updateCart() {
            const totalItems = state.cart.reduce((sum, item) => sum + item.quantity, 0);
            if (totalItems > 0) {
                elements.cartBadge.textContent = totalItems;
                elements.cartBadge.style.display = 'flex';
            } else {
                elements.cartBadge.style.display = 'none';
            }
            
            elements.cartItems.innerHTML = '';
            
            if (state.cart.length === 0) {
                elements.cartItems.innerHTML = '<p style="text-align: center; color: #666;">Tu carrito está vacío</p>';
                elements.cartTotal.textContent = '0.00 Bs';
                return;
            }
            
            let total = 0;
            
            state.cart.forEach(item => {
                const itemTotal = item.price * item.quantity * state.exchangeRate;
                total += itemTotal;
                
                const cartItem = document.createElement('div');
                cartItem.className = 'cart-item';
                cartItem.innerHTML = `
                    <div class="cart-item-image">
                        ${item.image ? 
                            `<img src="${item.image}" alt="${item.name}" style="width: 100%; height: 100%; object-fit: cover;">` : 
                            `<i class="fas fa-box" style="color: #ccc;"></i>`
                        }
                    </div>
                    <div class="cart-item-info">
                        <div class="cart-item-name">${item.name}</div>
                        <div class="cart-item-price">${(item.price * state.exchangeRate).toFixed(2)} Bs</div>
                    </div>
                    <div class="cart-item-quantity">
                        <div class="quantity-btn decrease-quantity" data-id="${item.productId}">-</div>
                        <span>${item.quantity}</span>
                        <div class="quantity-btn increase-quantity" data-id="${item.productId}">+</div>
                    </div>
                `;
                
                elements.cartItems.appendChild(cartItem);
            });
            
            elements.cartTotal.textContent = total.toFixed(2) + ' Bs';
            
            document.querySelectorAll('.decrease-quantity').forEach(btn => {
                btn.addEventListener('click', function() {
                    const productId = this.getAttribute('data-id');
                    updateCartItemQuantity(productId, -1);
                });
            });
            
            document.querySelectorAll('.increase-quantity').forEach(btn => {
                btn.addEventListener('click', function() {
                    const productId = this.getAttribute('data-id');
                    updateCartItemQuantity(productId, 1);
                });
            });
            
            localStorage.setItem('tiendaCart', JSON.stringify(state.cart));
        }
        
        function updateCartItemQuantity(productId, change) {
            const item = state.cart.find(item => item.productId === productId);
            if (!item) return;
            
            item.quantity += change;
            
            if (item.quantity <= 0) {
                state.cart = state.cart.filter(i => i.productId !== productId);
            }
            
            updateCart();
            renderProducts();
        }
        
        function toggleCart() {
            elements.cartPanel.classList.toggle('show');
        }
        
        function showCheckoutModal() {
            if (!state.user) {
                showNotification('Debes iniciar sesión para realizar un pedido', 'error');
                showAuthModal();
                return;
            }
            
            if (state.cart.length === 0) {
                showNotification('Tu carrito está vacío', 'error');
                return;
            }
            
            if (!state.isConnected) {
                showNotification('Debes estar conectado a la tienda para realizar pedidos', 'error');
                return;
            }
            
            let summaryHTML = '<div style="margin-bottom: 15px;">';
            let subtotal = 0;
            
            state.cart.forEach(item => {
                const itemTotal = item.price * item.quantity * state.exchangeRate;
                subtotal += itemTotal;
                summaryHTML += `<div>${item.name} x ${item.quantity} - ${itemTotal.toFixed(2)} Bs</div>`;
            });
            
            const delivery = document.getElementById('deliveryOption').value === 'delivery' ? state.deliveryCost : 0;
            const total = subtotal + delivery;
            
            summaryHTML += `</div>
                <div style="border-top: 1px solid #eee; padding-top: 10px;">
                    <div style="display: flex; justify-content: space-between;">
                        <span>Subtotal:</span>
                        <span>${subtotal.toFixed(2)} Bs</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>Delivery:</span>
                        <span>${delivery.toFixed(2)} Bs</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-weight: bold; margin-top: 5px;">
                        <span>Total:</span>
                        <span>${total.toFixed(2)} Bs</span>
                    </div>
                </div>`;
            
            elements.checkoutSummary.innerHTML = summaryHTML;
            elements.checkoutModal.style.display = 'flex';
        }
        
        function hideCheckoutModal() {
            elements.checkoutModal.style.display = 'none';
        }
        
        function confirmOrder() {
            if (!state.user || state.cart.length === 0 || !state.isConnected) return;
            
            const paymentMethod = document.getElementById('paymentMethod').value;
            const deliveryOption = document.getElementById('deliveryOption').value;
            const total = calculateCartTotal();
            
            const newOrder = {
                id: 'order_' + Date.now(),
                items: [...state.cart],
                paymentMethod,
                deliveryOption,
                total: total,
                status: 'pending',
                date: new Date()
            };
            
            sendToStore({
                type: 'order',
                data: newOrder
            });
            
            state.orders.push(newOrder);
            localStorage.setItem('tiendaOrders', JSON.stringify(state.orders));
            
            state.cart = [];
            localStorage.setItem('tiendaCart', JSON.stringify(state.cart));
            
            updateCart();
            hideCheckoutModal();
            toggleCart();
            
            showNotification('Pedido enviado a la tienda', 'success');
        }
        
        function calculateCartTotal() {
            const subtotal = state.cart.reduce((sum, item) => {
                return sum + (item.price * item.quantity * state.exchangeRate);
            }, 0);
            
            const delivery = document.getElementById('deliveryOption').value === 'delivery' ? state.deliveryCost : 0;
            return subtotal + delivery;
        }
        
        function renderUserOrders() {
            elements.ordersList.innerHTML = '';
            
            const userOrders = state.orders.filter(order => order.status);
            
            if (userOrders.length === 0) {
                elements.ordersList.innerHTML = '<p>No has realizado ningún pedido.</p>';
                return;
            }
            
            userOrders.forEach(order => {
                const orderElement = document.createElement('div');
                orderElement.className = 'product-card';
                orderElement.style.marginBottom = '15px';
                
                let itemsHTML = '';
                order.items.forEach(item => {
                    itemsHTML += `<div>${item.name} x ${item.quantity}</div>`;
                });
                
                orderElement.innerHTML = `
                    <div class="product-info">
                        <div class="product-name">Pedido #${order.id.substring(order.id.length-6)}</div>
                        <div style="font-size: 14px; color: #666; margin-bottom: 10px;">
                            ${new Date(order.date).toLocaleString()}
                        </div>
                        <div style="margin-bottom: 10px;">
                            ${itemsHTML}
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>Total: ${order.total.toFixed(2)} Bs</span>
                            <span style="font-weight: bold; color: ${order.status === 'pending' ? 'var(--warning)' : 'var(--success)'}">
                                ${order.status === 'pending' ? 'Pendiente' : 'Completado'}
                            </span>
                        </div>
                    </div>
                `;
                
                elements.ordersList.appendChild(orderElement);
            });
        }
        
        function loadChatHistory() {
            elements.chatMessages.innerHTML = '';
            
            if (state.messages.length === 0) {
                addMessageToChat('¡Hola! Conéctate a la tienda para comenzar a chatear.', 'received', new Date());
            } else {
                state.messages.forEach(msg => {
                    addMessageToChat(msg.text, msg.sender, msg.timestamp);
                });
            }
            
            elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
        }
        
        function sendMessage() {
            const messageText = elements.messageInput.value.trim();
            if (!messageText || !state.isConnected) return;
            
            addMessageToChat(messageText, 'sent', new Date());
            
            sendToStore({
                type: 'message',
                data: {
                    text: messageText,
                    timestamp: new Date()
                }
            });
            
            state.messages.push({
                text: messageText,
                sender: 'sent',
                timestamp: new Date()
            });
            
            elements.messageInput.value = '';
        }
        
        function addMessageToChat(text, sender, timestamp) {
            const messageElement = document.createElement('div');
            messageElement.className = `message ${sender}`;
            
            messageElement.innerHTML = `
                <div class="message-bubble">${text}</div>
                <div class="message-time">${new Date(timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
            `;
            
            elements.chatMessages.appendChild(messageElement);
            elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
        }
        
        function showNotification(message, type = 'success') {
            const notification = type === 'success' ? 
                elements.successNotification : elements.errorNotification;
                
            notification.querySelector('span').textContent = message;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
    </script>
</body>
</html>
