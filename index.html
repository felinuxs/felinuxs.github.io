<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>PUNTO - Chat P2P Descentralizado</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        /* Estilos generales */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #fafafa;
            height: 100vh;
            display: flex;
            flex-direction: column;
            touch-action: manipulation;
            font-size: 16px;
            overflow: hidden;
            color: #333;
            /* Ocultar barras de desplazamiento */
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE/Edge */
        }
        
        body::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }

        /* Variables de color - Tema Gemini Blanco */
        :root {
            --primary-color: #4285F4; /* Azul Google */
            --secondary-color: #4285F4; 
            --light-bg: #ffffff;
            --medium-bg: #f8f9fa;
            --dark-text: #202124;
            --secondary-text: #5f6368;
            --accent-blue: #4285F4;
            --accent-red: #EA4335;
            --accent-yellow: #FBBC05;
            --sent-bubble: #d2e3fc; /* Azul muy claro */
            --received-bubble: #f1f3f4; /* Gris claro */
            --chat-bg: #ffffff;
            --header-bg: #ffffff;
            --header-border: #e0e0e0;
            --input-area-bg: #ffffff;
            --menu-bg: #ffffff;
            --menu-header-bg: #f1f3f4;
            --notification-bg: #f1f3f4;
            --modal-bg: #ffffff;
            --modal-shadow: rgba(60, 64, 67, 0.3);
        }

        /* Estilos de notificaciones emergentes (Toast) */
        .notification-popup {
            position: fixed;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            border-radius: 24px;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--dark-text);
            opacity: 0;
            transition: opacity 0.6s ease-out, transform 0.3s ease-out;
            z-index: 2000;
            pointer-events: none;
            white-space: nowrap;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            background: var(--notification-bg);
            border: 1px solid #e0e0e0;
        }

        .notification-success { border-left: 4px solid #34A853; }
        .notification-error { border-left: 4px solid #EA4335; }
        .notification-info { border-left: 4px solid #4285F4; }
        .notification-warning { border-left: 4px solid #FBBC05; }
        .notification-popup.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        .notification-popup.hide { opacity: 0; transform: translateX(-50%) translateY(-10px); }

        /* Contenedor Principal */
        .main-container {
            display: flex; flex-direction: column; flex: 1;
            padding-top: 60px;
            padding-bottom: 65px;
            overflow-y: hidden;
            -webkit-overflow-scrolling: touch;
            /* Ocultar barras de desplazamiento */
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE/Edge */
        }
        
        .main-container::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }

        /* Encabezado del Chat */
        .chat-header {
            background: var(--header-bg); 
            color: var(--dark-text);
            padding: 10px 15px; 
            position: fixed; 
            width: 100%; 
            top: 0; 
            z-index: 100;
            display: flex; 
            align-items: center; 
            justify-content: flex-start; 
            height: 60px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            border-bottom: 1px solid var(--header-border);
        }
        .chat-header .menu-button, .chat-header .back-button {
            background: none; 
            border: none; 
            color: var(--dark-text);
            font-size: 24px; 
            padding: 5px; 
            cursor: pointer; 
            outline: none;
            display: flex; 
            align-items: center;
        }
        .chat-header .back-button { margin-right: 15px; }
        .chat-header .profile-pic {
            width: 40px; 
            height: 40px; 
            border-radius: 50%;
            background: var(--received-bubble); 
            margin-right: 10px;
            display: flex; 
            align-items: center; 
            justify-content: center;
            font-size: 20px; 
            color: var(--secondary-text); 
            overflow: hidden; 
            flex-shrink: 0;
            border: 1px solid #e0e0e0;
        }
        .chat-header .profile-pic img { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
        }
        .chat-header .profile-info { 
            flex-grow: 1; 
            display: flex; 
            flex-direction: column; 
            align-items: flex-start; 
        }
        .chat-header h1 { 
            font-size: 18px; 
            margin: 0; 
            line-height: 1.2; 
            font-weight: 500; 
            color: var(--dark-text);
        }
        .online-status {
            font-size: 12px; 
            color: var(--secondary-text); 
            opacity: 0;
            height: 14px; 
            transition: opacity 0.3s ease-in-out; 
            margin-top: 2px;
        }
        .online-status.active { opacity: 1; color: #34A853; }
        .chat-header .header-icons { 
            display: flex; 
            gap: 20px; 
            margin-left: auto; 
            align-items: center; 
        }
        .chat-header .header-icons i { 
            font-size: 22px; 
            cursor: pointer; 
            color: var(--dark-text); 
        }

        /* Menú Lateral */
        .side-menu {
            position: fixed; 
            top: 0; 
            right: 0; 
            width: 280px; 
            height: 100%;
            background: var(--menu-bg); 
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            z-index: 150; 
            transform: translateX(100%); 
            transition: transform 0.3s ease-in-out;
            display: flex; 
            flex-direction: column;
        }
        .side-menu.active { transform: translateX(0%); }
        @media (max-width: 480px) { .side-menu { width: 80%; max-width: 280px; } }
        .side-menu .menu-header {
            background: var(--menu-header-bg); 
            padding: 20px; 
            display: flex;
            align-items: center; 
            color: var(--dark-text); 
            min-height: 120px;
            border-bottom: 1px solid #e0e0e0;
        }
        .side-menu .menu-header .avatar {
            width: 60px; 
            height: 60px; 
            border-radius: 50%;
            background: var(--received-bubble); 
            display: flex;
            align-items: center; 
            justify-content: center;
            font-size: 30px; 
            margin-right: 15px; 
            overflow: hidden;
            border: 1px solid #e0e0e0;
        }
        .side-menu .menu-header .avatar img { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
        }
        .side-menu .menu-header .user-info h2 { 
            font-size: 18px; 
            font-weight: 500; 
            margin: 0; 
            color: var(--dark-text);
        }
        .side-menu .menu-header .user-info p { 
            font-size: 14px; 
            color: var(--secondary-text); 
            margin-top: 5px; 
        }
        .side-menu .menu-options { 
            list-style: none; 
            padding: 0; 
            margin: 0; 
            flex-grow: 1; 
            overflow-y: auto; 
        }
        .side-menu .menu-options li {
            padding: 15px 20px; 
            border-bottom: 1px solid #eee; 
            font-size: 16px;
            color: var(--dark-text); 
            cursor: pointer; 
            transition: background 0.2s ease;
            display: flex; 
            align-items: center;
        }
        .side-menu .menu-options li i { 
            margin-right: 15px; 
            color: var(--accent-blue); 
            font-size: 20px; 
            width: 24px;
            text-align: center;
        }
        .side-menu .menu-options li:hover { background: #f8f9fa; }
        .side-menu-backdrop {
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%;
            background: rgba(0,0,0,0.3); 
            z-index: 149; 
            opacity: 0;
            pointer-events: none; 
            transition: opacity 0.3s ease;
        }
        .side-menu-backdrop.active { opacity: 1; pointer-events: all; }

        /* Lista de Pares Conectados */
        .connected-peers-list {
            background: var(--light-bg); 
            padding: 0; 
            width: 100%;
            position: fixed; 
            top: 60px; 
            height: calc(100vh - 60px);
            overflow-y: auto; 
            -webkit-overflow-scrolling: touch; 
            z-index: 99;
            transition: transform 0.3s ease-in-out; 
            transform: translateX(0%);
            /* Ocultar barras de desplazamiento */
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE/Edge */
        }
        .connected-peers-list::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }
        .connected-peers-list.hidden-left { 
            transform: translateX(-100%); 
            pointer-events: none; 
        }
        .connected-peers-list h4 {
            font-size: 14px; 
            margin: 15px 15px 10px 15px; 
            color: var(--secondary-text);
            text-transform: uppercase; 
            font-weight: 500;
            border-bottom: 1px solid #EAEAEA; 
            padding-bottom: 10px;
        }
        .connected-peers-list ul { 
            list-style: none; 
            padding: 0; 
            margin: 0; 
        }
        .connected-peers-list li {
            display: flex; 
            align-items: center; 
            padding: 12px 15px;
            border-bottom: 1px solid #EAEAEA; 
            cursor: pointer; 
            font-size: 16px;
            color: var(--dark-text); 
            transition: background 0.2s ease;
            position: relative;
        }
        .connected-peers-list li:hover { background: #f8f9fa; }
        .connected-peers-list li.active { background: var(--sent-bubble); font-weight: bold; }
        .connected-peers-list li.unread .peer-name { font-weight: bold; color: var(--accent-blue); }
        .connected-peers-list li .avatar {
            width: 50px; 
            height: 50px; 
            border-radius: 50%;
            background: var(--received-bubble); 
            margin-right: 15px; 
            display: flex;
            align-items: center; 
            justify-content: center; 
            font-size: 24px;
            color: #999; 
            flex-shrink: 0; 
            overflow: hidden;
            border: 1px solid #e0e0e0;
        }
        .connected-peers-list li .avatar img { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
        }
        .connected-peers-list .peer-info { 
            flex-grow: 1; 
            display: flex; 
            flex-direction: column; 
        }
        .connected-peers-list .peer-name { 
            font-weight: 500; 
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .connected-peers-list .peer-status-text { 
            font-size: 13px; 
            color: var(--secondary-text); 
            margin-top: 2px; 
        }
        .connected-peers-list .peer-status-text.online { color: #34A853; }
        .connected-peers-list .peer-status-text.tracker { color: #FBBC05; font-weight: bold; }
        
        .unread-count {
            background: var(--accent-blue);
            color: white;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
        }

        /* Área del Chat */
        #chat {
            flex: 1; 
            padding: 10px; 
            overflow-y: auto; 
            -webkit-overflow-scrolling: touch;
            display: flex; 
            flex-direction: column;
            background-color: var(--chat-bg);
            /* Ocultar barras de desplazamiento */
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE/Edge */
        }
        
        #chat::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }

        /* Burbujas de Mensajes */
        .message {
            margin: 6px 0; 
            padding: 8px 12px 6px 12px; 
            border-radius: 18px;
            max-width: 85%; 
            word-wrap: break-word; 
            position: relative;
            font-size: 15px; 
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            animation: slideIn 0.2s ease-out forwards;
            display: flex; 
            flex-direction: column; 
            line-height: 1.4;
        }
        @keyframes slideIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        .message.self { 
            background: var(--sent-bubble); 
            align-self: flex-end; 
            color: var(--dark-text); 
            border-bottom-right-radius: 4px;
        }
        .message.remote { 
            background: var(--received-bubble); 
            align-self: flex-start; 
            color: var(--dark-text); 
            border-bottom-left-radius: 4px;
        }
        .message.system-message {
            background: #e8f0fe; 
            color: #5a666d; 
            text-align: center;
            max-width: 90%; 
            margin: 10px auto; 
            font-size: 13px; 
            align-self: center;
            padding: 8px 16px; 
            border-radius: 12px; 
            box-shadow: none;
        }
        .message .sender-name { 
            font-weight: 500; 
            color: var(--accent-blue); 
            font-size: 14px; 
            margin-bottom: 3px; 
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .message .sender-name img {
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }
        .message.self .sender-name { display: none; }
        .message-footer { 
            align-self: flex-end; 
            margin-top: 4px; 
            font-size: 11px; 
            color: rgba(0, 0, 0, 0.45); 
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .message-content {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            align-items: center;
        }
        
        .emoji {
            font-size: 24px;
            line-height: 1;
        }

        /* Área de Entrada */
        .input-area {
            position: fixed; 
            bottom: 0; 
            width: 100%; 
            background: var(--input-area-bg);
            padding: 8px; 
            box-shadow: 0 -1px 5px rgba(0,0,0,0.05); 
            z-index: 100;
            display: flex; 
            gap: 8px; 
            align-items: flex-end;
            border-top: 1px solid #e0e0e0;
        }
        .message-input-group {
            flex: 1; 
            display: flex; 
            align-items: flex-end; 
            background: var(--received-bubble);
            border-radius: 25px; 
            padding: 5px 10px;
            border: 1px solid #e0e0e0;
        }
        .input-area textarea {
            flex: 1; 
            min-height: 20px; 
            max-height: 100px; 
            padding: 8px 5px;
            border: none; 
            resize: none; 
            font-size: 16px; 
            outline: none; 
            background: transparent;
            color: var(--dark-text);
        }
        .input-area button {
            background: transparent; 
            color: var(--secondary-text); 
            border: none; 
            border-radius: 50%;
            width: 48px; 
            height: 48px; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            font-size: 22px; 
            cursor: pointer; 
            flex-shrink: 0;
            transition: all 0.2s ease;
        }
        .input-area button:hover {
            background: #f1f3f4;
        }
        #sendButton {
            background: var(--accent-blue); 
            color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            width: 48px; 
            height: 48px;
        }
        #sendButton:hover {
            background: #3367d6;
        }

        /* Contenedor del Selector de Emojis */
        #emojiPickerContainer {
            position: absolute;
            bottom: 75px;
            right: 10px;
            z-index: 110;
            display: none;
        }
        emoji-picker {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-radius: 15px;
            border: 1px solid #e0e0e0;
            max-width: 100%;
        }
        
        /* Modal de Perfil */
        .profile-modal {
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%;
            background: rgba(0, 0, 0, 0.5); 
            display: flex;
            justify-content: center; 
            align-items: center; 
            z-index: 1000;
        }
        .profile-content {
            background: var(--modal-bg); 
            padding: 30px; 
            border-radius: 15px;
            width: 90%; 
            max-width: 380px; 
            text-align: center;
            box-shadow: 0 10px 30px var(--modal-shadow);
            animation: fadeInScale 0.3s ease-out forwards;
        }
        @keyframes fadeInScale { 
            from { opacity: 0; transform: scale(0.9); } 
            to { opacity: 1; transform: scale(1); } 
        }
        .profile-content h3 { 
            color: var(--accent-blue); 
            margin-bottom: 20px; 
            font-size: 22px; 
        }
        .profile-pic-upload {
            margin-top: 15px; 
            display: flex; 
            flex-direction: column; 
            align-items: center;
        }
        .profile-pic-upload .avatar-preview {
            width: 120px; 
            height: 120px; 
            border-radius: 50%; 
            background: #eee;
            display: flex; 
            align-items: center; 
            justify-content: center;
            font-size: 40px; 
            color: #ccc; 
            overflow: hidden;
            border: 3px solid var(--accent-blue); 
            margin-bottom: 10px;
        }
        .profile-pic-upload .avatar-preview img { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
        }
        .profile-pic-upload label {
            background: var(--accent-blue); 
            color: white; 
            border: none;
            padding: 10px 20px; 
            border-radius: 20px; 
            cursor: pointer;
            font-size: 14px; 
            transition: background 0.2s ease;
            margin-top: 10px;
        }
        .profile-pic-upload label:hover { 
            background: #3367d6; 
        }
        .profile-input {
            width: 100%; 
            padding: 12px; 
            margin: 15px 0;
            border: 1px solid #e0e0e0; 
            border-radius: 8px; 
            font-size: 16px;
            outline: none; 
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            background: var(--light-bg);
        }
        .profile-input:focus { 
            border-color: var(--accent-blue); 
            box-shadow: 0 0 0 2px rgba(66, 133, 244, 0.2); 
        }
        .profile-stats {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            text-align: center;
        }
        .profile-stat {
            padding: 10px;
        }
        .profile-stat-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--accent-blue);
        }
        .profile-stat-label {
            font-size: 14px;
            color: var(--secondary-text);
        }
        .profile-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        .profile-button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        .profile-button.save {
            background: var(--accent-blue);
            color: white;
        }
        .profile-button.cancel {
            background: #f1f3f4;
            color: var(--dark-text);
        }
        .profile-button:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        
        /* Instrucciones para modo pantalla completa */
        #fullscreen-instructions {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            text-align: center;
            padding: 20px;
            display: none;
        }
        
        #fullscreen-instructions h2 {
            font-size: 24px;
            margin-bottom: 20px;
        }
        
        #fullscreen-instructions p {
            font-size: 18px;
            margin-bottom: 30px;
            max-width: 500px;
            line-height: 1.6;
        }
        
        #fullscreen-instructions .device-icon {
            font-size: 60px;
            margin-bottom: 20px;
        }
        
        #fullscreen-instructions button {
            background: var(--accent-blue);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 30px;
            font-size: 18px;
            cursor: pointer;
            margin-top: 20px;
        }
        
        /* Animación de carga */
        .loader {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(66, 133, 244, 0.3);
            border-radius: 50%;
            border-top-color: var(--accent-blue);
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Mejora de scroll para iOS */
        .ios-scroll {
            -webkit-overflow-scrolling: touch;
        }
    </style>
</head>
<body>
    <div id="notification-container"></div>
    
    <!-- Instrucciones para modo pantalla completa -->
    <div id="fullscreen-instructions">
        <div class="device-icon"><i class="fas fa-mobile-alt"></i></div>
        <h2>Para una mejor experiencia</h2>
        <p>Agrega esta aplicación a tu pantalla de inicio para usar en modo pantalla completa sin la barra del navegador.</p>
        <p>En tu navegador, toca el menú (⋮) y selecciona "Agregar a la pantalla de inicio".</p>
        <button onclick="document.getElementById('fullscreen-instructions').style.display = 'none'">Entendido</button>
    </div>

    <!-- Encabezado del Chat -->
    <div id="chatHeader" class="chat-header">
        <button class="back-button" id="backToPeersList" style="display: none;"><i class="fa fa-arrow-left"></i></button>
        <div class="profile-pic" id="activePeerProfilePic"><i class="fa fa-user"></i></div>
        <div class="profile-info">
            <h1 id="activePeerName">Usuarios en Línea</h1>
            <div id="statusIndicator" class="online-status"></div>
        </div>
        <div class="header-icons">
            <i class="fa fa-trash" id="deleteChatButton" style="display: none;"></i>
            <button class="menu-button" id="menuButton"><i class="fa fa-bars"></i></button>
        </div>
    </div>

    <!-- Menú Lateral -->
    <div id="sideMenu" class="side-menu">
        <div class="menu-header">
            <div class="avatar" id="myProfileAvatar">
                <i class="fa fa-user"></i>
            </div>
            <div class="user-info">
                <h2 id="myAliasDisplay">Mi Alias</h2>
                <p id="myStatusText">En línea</p>
            </div>
        </div>
        <ul class="menu-options">
            <li id="userInfoOption"><i class="fa fa-user-edit"></i> Editar perfil</li>
            <li id="messageStatsOption"><i class="fa fa-chart-bar"></i> Estadísticas</li>
            <li id="settingsOption"><i class="fa fa-cog"></i> Ajustes</li>
            <li id="logoutOption"><i class="fa fa-sign-out-alt"></i> Cerrar sesión</li>
        </ul>
    </div>
    <div id="sideMenuBackdrop" class="side-menu-backdrop"></div>

    <!-- Modal de Perfil -->
    <div id="profileModal" class="profile-modal" style="display: none;">
        <div class="profile-content">
            <h3>Editar Perfil</h3>
            <div class="profile-pic-upload">
                <div class="avatar-preview" id="profileAvatarPreview"><i class="fa fa-user"></i></div>
                <label for="profilePicInput"><i class="fa fa-camera"></i> Cambiar foto</label>
                <input type="file" id="profilePicInput" accept="image/jpeg, image/png" style="display: none;">
            </div>
            <input type="text" id="aliasInput" class="profile-input" placeholder="Tu alias" maxlength="20">
            
            <div class="profile-stats">
                <div class="profile-stat">
                    <div class="profile-stat-value" id="totalMessages">0</div>
                    <div class="profile-stat-label">Mensajes</div>
                </div>
                <div class="profile-stat">
                    <div class="profile-stat-value" id="totalChats">0</div>
                    <div class="profile-stat-label">Chats</div>
                </div>
                <div class="profile-stat">
                    <div class="profile-stat-value" id="connectedUsers">0</div>
                    <div class="profile-stat-label">Usuarios</div>
                </div>
            </div>
            
            <div class="profile-buttons">
                <button class="profile-button save" onclick="saveProfile()">Guardar</button>
                <button class="profile-button cancel" onclick="closeProfileModal()">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Contenedor Principal -->
    <div class="main-container">
        <div id="connectedPeersList" class="connected-peers-list ios-scroll">
            <h4>Usuarios en Línea</h4>
            <ul id="peerList"></ul>
        </div>
        <div id="chat" class="ios-scroll"></div>
    </div>

    <!-- Área de Entrada -->
    <div class="input-area">
        <div class="message-input-group">
            <button id="emojiButton"><i class="far fa-laugh"></i></button>
            <textarea id="message" placeholder="Escribe un mensaje..."></textarea>
        </div>
        <button id="sendButton"><i class="fa fa-paper-plane"></i></button>
    </div>

    <!-- Selector de Emojis -->
    <div id="emojiPickerContainer">
        <emoji-picker class="light"></emoji-picker>
    </div>

    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js"></script>
    <script>
        // --- VARIABLES GLOBALES ---
        const TRACKER_ID = 'punto-p2p-network-v4';
        let peer;
        let trackerPeer;
        let myAlias = '';
        let myProfilePic = '';
        let isTracker = false;
        let trackerConnection;
        let onlineUsers = {};
        let peerConnections = {};
        let activeChatPeerId = null;
        let deviceInfo = {};
        
        // Configuración del usuario
        let userSettings = {
            notifications: true,
            sounds: true,
            showOnlineStatus: true
        };

        // Generar un ID único para el dispositivo
        function generateDeviceId() {
            let deviceId = localStorage.getItem('deviceId');
            if (!deviceId) {
                deviceId = 'dev-' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('deviceId', deviceId);
            }
            return deviceId;
        }
        
        // Obtener información del dispositivo
        function getDeviceInfo() {
            const userAgent = navigator.userAgent;
            let deviceType = 'desktop';
            let os = 'unknown';
            let browser = 'unknown';
            
            // Detectar tipo de dispositivo
            if (/Mobi|Android/i.test(userAgent)) {
                deviceType = 'smartphone';
                if (/Tablet|iPad/i.test(userAgent)) {
                    deviceType = 'tablet';
                }
            }
            
            // Detectar sistema operativo
            if (/Windows/i.test(userAgent)) {
                os = 'Windows';
            } else if (/Mac OS/i.test(userAgent)) {
                os = 'macOS';
            } else if (/Linux/i.test(userAgent)) {
                os = 'Linux';
            } else if (/Android/i.test(userAgent)) {
                os = 'Android';
            } else if (/iOS|iPhone|iPad|iPod/i.test(userAgent)) {
                os = 'iOS';
            }
            
            // Detectar navegador
            if (/Chrome/i.test(userAgent) && !/Edg/i.test(userAgent)) {
                browser = 'Chrome';
            } else if (/Firefox/i.test(userAgent)) {
                browser = 'Firefox';
            } else if (/Safari/i.test(userAgent)) {
                browser = 'Safari';
            } else if (/Edg/i.test(userAgent)) {
                browser = 'Edge';
            } else if (/Opera|OPR/i.test(userAgent)) {
                browser = 'Opera';
            }
            
            return {
                type: deviceType,
                os: os,
                browser: browser,
                deviceId: generateDeviceId()
            };
        }
        
        // Generar alias único basado en el dispositivo
        function generateUniqueAlias() {
            const device = getDeviceInfo();
            const randomSuffix = Math.random().toString(36).substr(2, 6);
            return `${device.type}-${device.os}-${device.browser}-${randomSuffix}`;
        }
        
        // Obtener alias del usuario (de localStorage o generar uno nuevo)
        function getUserAlias() {
            let alias = localStorage.getItem('chatAlias');
            if (!alias) {
                alias = generateUniqueAlias();
                localStorage.setItem('chatAlias', alias);
            }
            return alias;
        }
        
        // Obtener foto de perfil del usuario
        function getUserProfilePic() {
            return localStorage.getItem('userProfilePic') || '';
        }

        // Cargar configuración si existe
        if (localStorage.getItem('userSettings')) {
            userSettings = JSON.parse(localStorage.getItem('userSettings'));
        }

        let notificationQueue = [];
        let isDisplayingNotification = false;

        // Referencias al DOM
        const peerListContainer = document.getElementById('connectedPeersList');
        const peerListUl = document.getElementById('peerList');
        const chatDiv = document.getElementById('chat');
        const messageInput = document.getElementById('message');
        const sendButton = document.getElementById('sendButton');
        const backToPeersListButton = document.getElementById('backToPeersList');
        const activePeerNameDisplay = document.getElementById('activePeerName');
        const activePeerProfilePic = document.getElementById('activePeerProfilePic');
        const statusIndicator = document.getElementById('statusIndicator');
        const deleteChatButton = document.getElementById('deleteChatButton');
        const emojiButton = document.getElementById('emojiButton');
        const emojiPickerContainer = document.getElementById('emojiPickerContainer');

        // Elementos de perfil
        const profileModal = document.getElementById('profileModal');
        const profileAvatarPreview = document.getElementById('profileAvatarPreview');
        const profilePicInput = document.getElementById('profilePicInput');
        const aliasInput = document.getElementById('aliasInput');

        const notificationContainer = document.getElementById('notification-container');
        const menuButton = document.getElementById('menuButton');
        const sideMenu = document.getElementById('sideMenu');
        const sideMenuBackdrop = document.getElementById('sideMenuBackdrop');
        const myProfileAvatar = document.getElementById('myProfileAvatar');
        const myAliasDisplay = document.getElementById('myAliasDisplay');
        const myStatusText = document.getElementById('myStatusText');
        
        const fullscreenInstructions = document.getElementById('fullscreen-instructions');

        // --- INICIALIZACIÓN ---
        function initApp() {
            // Obtener información del dispositivo
            deviceInfo = getDeviceInfo();
            
            // Obtener alias del usuario
            myAlias = getUserAlias();
            myProfilePic = getUserProfilePic();
            
            // Actualizar UI con la foto de perfil
            updateProfileUI();
            
            // Solicitar permiso para notificaciones nativas
            if (userSettings.notifications) {
                Notification.requestPermission().then(permission => {
                    if (permission !== 'granted') {
                        showToast('Las notificaciones están desactivadas. Actívalas para recibir avisos', 'info');
                    }
                });
            }
            
            // Ocultar la barra de direcciones en navegadores móviles
            hideBrowserUI();
            
            // Inicializar conexión P2P
            initMyPeer();
            setupUIEventListeners();
            updateLayout();
            updateMessageStats();
            
            // Mostrar mensaje de bienvenida
            showToast(`Conectado como ${myAlias}`, 'success');
            addMessageToChat({ 
                type: 'system', 
                text: `¡Bienvenido a PUNTO, ${myAlias}! Buscando a otros usuarios...` 
            }, 'system-message', false);
            
            // Manejar el botón atrás del navegador
            setupBackButtonHandler();
        }
        
        // Configurar manejo del botón atrás
        function setupBackButtonHandler() {
            window.addEventListener('popstate', function(event) {
                if (activeChatPeerId) {
                    // Si estamos en un chat, volver a la lista de contactos
                    activeChatPeerId = null;
                    updateLayout();
                    renderOnlineUsers();
                } else {
                    // Si estamos en la lista de contactos, prevenir salida
                    if (confirm('¿Desea salir de la aplicación?')) {
                        window.close();
                    } else {
                        history.pushState(null, null, document.URL);
                    }
                }
            });
            
            history.pushState(null, null, document.URL);
        }
        
        // Ocultar la barra del navegador en dispositivos móviles
        function hideBrowserUI() {
            // Ocultar la barra de direcciones en navegadores móviles
            window.addEventListener('load', function() {
                setTimeout(function() {
                    window.scrollTo(0, 1);
                }, 0);
            });
            
            // Prevenir el comportamiento de desplazamiento en iOS
            document.addEventListener('touchmove', function(e) {
                e.preventDefault();
            }, { passive: false });
            
            // Mostrar instrucciones para modo pantalla completa
            if (!localStorage.getItem('fullscreenInfoShown') && 
                (deviceInfo.type === 'smartphone' || deviceInfo.type === 'tablet')) {
                fullscreenInstructions.style.display = 'flex';
                localStorage.setItem('fullscreenInfoShown', 'true');
            }
        }
        
        function updateProfileUI() {
            myAliasDisplay.textContent = myAlias;
            
            if (myProfilePic) {
                myProfileAvatar.innerHTML = `<img src="${myProfilePic}" alt="My Profile Pic">`;
                profileAvatarPreview.innerHTML = `<img src="${myProfilePic}" alt="Profile Preview">`;
            } else {
                myProfileAvatar.innerHTML = '<i class="fa fa-user"></i>';
                profileAvatarPreview.innerHTML = '<i class="fa fa-user"></i>';
            }
            
            aliasInput.value = myAlias;
        }
        
        function initMyPeer() {
            if (peer && !peer.destroyed) peer.destroy();
            peer = new Peer(myAlias, { 
                debug: 2, 
                config: { 
                    'iceServers': [
                        { 'urls': 'stun:stun.l.google.com:19302' },
                        { 'urls': 'stun:stun1.l.google.com:19302' },
                        { 'urls': 'stun:stun2.l.google.com:19302' }
                    ] 
                } 
            });

            peer.on('open', (id) => {
                console.log(`Mi Peer personal está listo con alias: ${id}`);
                connectToTracker();
            });

            peer.on('connection', (conn) => {
                console.log(`Recibí una conexión de chat directa de ${conn.peer}`);
                setupChatConnection(conn);
            });

            peer.on('error', (err) => {
                console.error("Error en PeerJS:", err);
                if (err.type === 'unavailable-id') {
                    // Generar un nuevo alias único si el actual está ocupado
                    myAlias = generateUniqueAlias();
                    localStorage.setItem('chatAlias', myAlias);
                    showToast(`Alias cambiado a ${myAlias}`, 'info');
                    initMyPeer(); // Reiniciar con nuevo alias
                } else if (err.type === 'peer-unavailable' && err.message.includes(TRACKER_ID)) {
                    console.log('El Tracker no está disponible. Me convertiré en el Tracker.');
                    becomeTracker();
                } else {
                    showToast(`Error de conexión: ${err.type}`, 'error');
                }
            });
        }

        function connectToTracker() {
            console.log('Intentando conectar con el Tracker en el ID:', TRACKER_ID);
            trackerConnection = peer.connect(TRACKER_ID, { 
                metadata: { 
                    alias: myAlias, 
                    profilePic: myProfilePic,
                    deviceInfo: deviceInfo
                }, 
                serialization: 'json' 
            });

            trackerConnection.on('open', () => {
                console.log('Conectado al Tracker exitosamente.');
                isTracker = false;
                showToast('Conectado a la red P2P', 'success');
            });
            
            trackerConnection.on('data', handleTrackerData);
            trackerConnection.on('close', () => {
                showToast('El anfitrión se desconectó. Buscando uno nuevo...', 'error');
                onlineUsers = {}; 
                renderOnlineUsers();
                setTimeout(connectToTracker, 2000 + Math.random() * 2000);
            });
            
            trackerConnection.on('error', (err) => {
                 console.error("Error de conexión del Tracker:", err);
                 showToast(`Error de conexión al anfitrión: ${err.type}`, 'error');
            });
        }

        function becomeTracker() {
            if (isTracker) return;
            isTracker = true;

            trackerPeer = new Peer(TRACKER_ID, { debug: 2 });
            trackerPeer.on('open', () => {
                console.log('¡SOY EL TRACKER! Escuchando en:', TRACKER_ID);
                showToast('Te has convertido en el anfitrión de la red.', 'success');
                onlineUsers = { 
                    [myAlias]: { 
                        profilePic: myProfilePic,
                        deviceInfo: deviceInfo,
                        isTracker: true
                    } 
                };
                renderOnlineUsers();
            });

            trackerPeer.on('connection', (conn) => {
                const newUserAlias = conn.metadata.alias;
                console.log(`Tracker: Nuevo usuario conectado: ${newUserAlias}`);

                conn.on('open', () => {
                    conn.send({ type: 'user-list', users: onlineUsers });
                    onlineUsers[newUserAlias] = { 
                        profilePic: conn.metadata.profilePic,
                        deviceInfo: conn.metadata.deviceInfo
                    };
                    
                    // Notificar a todos sobre el nuevo usuario
                    broadcastToAll({ type: 'user-joined', user: { alias: newUserAlias } });
                    renderOnlineUsers();
                });

                conn.on('close', () => {
                    console.log(`Tracker: Usuario desconectado: ${newUserAlias}`);
                    delete onlineUsers[newUserAlias];
                    broadcastToAll({ type: 'user-left', alias: newUserAlias });
                    renderOnlineUsers();
                });
                
                conn.on('error', (err) => { 
                    console.error(`Conexión del Tracker con ${newUserAlias} error:`, err); 
                });
            });
            
            trackerPeer.on('error', (err) => { 
                console.error("Error del Peer Tracker:", err); 
                showToast(`Error del anfitrión: ${err.type}`, 'error'); 
            });
        }

        function broadcastToAll(data) {
            if (trackerPeer && trackerPeer.connections) {
                Object.values(trackerPeer.connections).flat().forEach(conn => { 
                    if (conn.open) conn.send(data); 
                });
            }
        }

        function handleTrackerData(data) {
            switch(data.type) {
                case 'user-list': 
                    onlineUsers = data.users; 
                    break;
                case 'user-joined': 
                    onlineUsers[data.user.alias] = data.user; 
                    showToast(`${data.user.alias} se ha unido.`, 'info'); 
                    break;
                case 'user-left': 
                    delete onlineUsers[data.alias]; 
                    showToast(`${data.alias} se ha ido.`, 'info'); 
                    break;
                case 'profile-update':
                    if (onlineUsers[data.alias]) {
                        onlineUsers[data.alias].profilePic = data.profilePic;
                        renderOnlineUsers();
                    }
                    break;
            }
            renderOnlineUsers();
        }

        // --- RENDERIZADO DE LA UI Y MANEJO DEL CHAT ---
        function renderOnlineUsers() {
            peerListUl.innerHTML = '';
            if (Object.keys(onlineUsers).length === 0) {
                 peerListUl.innerHTML = '<li style="text-align: center; color: #777; padding: 20px;"><span class="loader"></span> Buscando usuarios...</li>';
                 statusIndicator.textContent = '0 usuarios conectados'; 
                 statusIndicator.classList.remove('active');
                 return;
            }
            
            Object.entries(onlineUsers).forEach(([alias, data]) => {
                // Obtener historial de mensajes para este usuario
                const histories = JSON.parse(localStorage.getItem('chatHistories')) || {};
                const messageCount = histories[alias] ? histories[alias].length : 0;
                
                const li = document.createElement('li');
                li.dataset.peerId = alias;
                if(data.hasUnread) li.classList.add('unread');

                const avatarContent = data.profilePic ? 
                    `<img src="${data.profilePic}" alt="${alias}">` : 
                    `<i class="fa fa-user"></i>`;
                
                let statusText = 'En línea';
                let statusClass = 'online';
                if(data.isTracker){
                    statusText = `Anfitrión ${alias === myAlias ? '(Tú)' : ''}`;
                    statusClass = 'tracker';
                }

                li.innerHTML = `
                    <div class="avatar">${avatarContent}</div>
                    <div class="peer-info">
                        <span class="peer-name">
                            ${alias === myAlias ? alias + ' (Tú)' : alias}
                        </span>
                        <span class="peer-status-text ${statusClass}">${statusText}</span>
                    </div>
                `;

                if (messageCount > 0) {
                    const countBadge = document.createElement('div');
                    countBadge.className = 'unread-count';
                    countBadge.textContent = messageCount;
                    li.appendChild(countBadge);
                }

                if (alias !== myAlias) li.onclick = () => startChatWith(alias);
                else li.style.backgroundColor = '#f1f1f1';
                if (alias === activeChatPeerId) li.classList.add('active');
                peerListUl.appendChild(li);
            });
            
            updateLayout();
            statusIndicator.textContent = `${Object.keys(onlineUsers).length} usuario(s) conectado(s)`;
            statusIndicator.classList.add('active');
            updateMessageStats();
        }

        function startChatWith(peerAlias) {
            activeChatPeerId = peerAlias;
            if (onlineUsers[peerAlias]) onlineUsers[peerAlias].hasUnread = false;

            if (!peerConnections[peerAlias] || !peerConnections[peerAlias].open) {
                console.log(`Iniciando conexión de chat con ${peerAlias}...`);
                const conn = peer.connect(peerAlias, { 
                    metadata: {
                        profilePic: myProfilePic
                    },
                    serialization: 'json' 
                });
                setupChatConnection(conn);
            }
            
            chatDiv.innerHTML = '';
            loadChatHistory(peerAlias);
            addMessageToChat({ 
                type: 'system-message', 
                text: `Has iniciado un chat con ${peerAlias}.` 
            }, 'system-message', false);
            updateLayout();
            renderOnlineUsers();
            
            // Guardar estado actual en localStorage
            localStorage.setItem('activeChatPeerId', peerAlias);
        }

        function setupChatConnection(conn) {
            peerConnections[conn.peer] = conn;
            
            conn.on('data', (data) => {
                if (activeChatPeerId === data.sender) {
                    addMessageToChat(data, 'remote');
                } else {
                    if(onlineUsers[data.sender]) onlineUsers[data.sender].hasUnread = true;
                    showSystemNotification(data.sender, data.text);
                    showToast(`Nuevo mensaje de ${data.sender}`, 'info');
                    renderOnlineUsers();
                    saveMessage(data.sender, data);
                }
            });
            
            conn.on('close', () => {
                showToast(`${conn.peer} se ha desconectado del chat.`, 'error');
                delete peerConnections[conn.peer];
                if (activeChatPeerId === conn.peer) activeChatPeerId = null;
                updateLayout();
                renderOnlineUsers();
                
                // Guardar estado actual en localStorage
                localStorage.removeItem('activeChatPeerId');
            });
            
            conn.on('error', (err) => {
                 console.error(`Error de conexión de chat con ${conn.peer}:`, err);
                 showToast(`Error de chat con ${conn.peer}: ${err.type}`, 'error');
            });
        }

        function sendMessage() {
            const text = messageInput.value.trim();
            if (!text || !activeChatPeerId) return;
            
            const messageData = { 
                type: 'text', 
                sender: myAlias, 
                text, 
                timestamp: Date.now(),
                senderProfilePic: myProfilePic
            };
            
            // Enviar mensaje
            sendDataToPeer(messageData);
            addMessageToChat(messageData, 'self');
            
            messageInput.value = '';
            emojiPickerContainer.style.display = 'none';
            
            // Guardar estado actual en localStorage
            localStorage.setItem('lastMessage', JSON.stringify({
                peer: activeChatPeerId,
                text: text,
                timestamp: Date.now()
            }));
        }

        function sendDataToPeer(data) {
             const conn = peerConnections[activeChatPeerId];
             if (conn && conn.open) {
                 conn.send(data);
             } else {
                 showToast(`No se pudo enviar. Conexión con ${activeChatPeerId} no activa.`, 'error');
             }
        }

        function addMessageToChat(data, direction = 'system-message', save = true) {
            const div = document.createElement('div');
            div.className = `message ${direction}`;

            if(direction !== 'system-message'){
                if (direction === 'remote') {
                    const senderSpan = document.createElement('span');
                    senderSpan.className = 'sender-name';
                    
                    if (data.senderProfilePic) {
                        senderSpan.innerHTML = `<img src="${data.senderProfilePic}" alt="${data.sender}"> ${data.sender}`;
                    } else {
                        senderSpan.textContent = data.sender;
                    }
                    
                    div.appendChild(senderSpan);
                }
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content';
                
                // Procesar emojis básicos
                const emojiRegex = /:\)|:\(|:D|;\)|:P|:\||:\/|:O/g;
                const emojiMap = {
                    ':)': '😊',
                    ':(': '😞',
                    ':D': '😃',
                    ';)': '😉',
                    ':P': '😛',
                    ':|': '😐',
                    ':/': '😕',
                    ':O': '😮'
                };
                
                let lastIndex = 0;
                const text = data.text;
                let match;
                
                while ((match = emojiRegex.exec(text)) !== null) {
                    // Texto antes del emoji
                    if (match.index > lastIndex) {
                        const textPart = document.createTextNode(text.substring(lastIndex, match.index));
                        contentDiv.appendChild(textPart);
                    }
                    
                    // Emoji
                    const emojiSpan = document.createElement('span');
                    emojiSpan.className = 'emoji';
                    emojiSpan.textContent = emojiMap[match[0]];
                    contentDiv.appendChild(emojiSpan);
                    
                    lastIndex = match.index + match[0].length;
                }
                
                // Texto después del último emoji
                if (lastIndex < text.length) {
                    const textPart = document.createTextNode(text.substring(lastIndex));
                    contentDiv.appendChild(textPart);
                }
                
                div.appendChild(contentDiv);
                
                const footer = document.createElement('div');
                footer.className = 'message-footer';
                const messageDate = data.timestamp ? new Date(data.timestamp) : new Date();
                footer.textContent = messageDate.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
                div.appendChild(footer);

                if(save) {
                    const peerId = direction === 'self' ? activeChatPeerId : data.sender;
                    saveMessage(peerId, data);
                }

            } else {
                 div.textContent = data.text;
            }
            
            chatDiv.appendChild(div);
            chatDiv.scrollTop = chatDiv.scrollHeight;
            
            // Guardar estado actual en localStorage
            localStorage.setItem('chatScrollPosition', chatDiv.scrollTop);
        }

        // --- LÓGICA DE GUARDADO Y BORRADO DE CHAT ---
        function saveMessage(peerId, messageData) {
            if (!peerId) return;
            const histories = JSON.parse(localStorage.getItem('chatHistories')) || {};
            if (!histories[peerId]) {
                histories[peerId] = [];
            }
            histories[peerId].push(messageData);
            localStorage.setItem('chatHistories', JSON.stringify(histories));
            updateMessageStats();
        }

        function loadChatHistory(peerId) {
            const histories = JSON.parse(localStorage.getItem('chatHistories')) || {};
            const peerHistory = histories[peerId] || [];
            peerHistory.forEach(msg => {
                const direction = msg.sender === myAlias ? 'self' : 'remote';
                addMessageToChat(msg, direction, false);
            });
            
            // Restaurar posición de scroll si existe
            const savedScrollPosition = localStorage.getItem('chatScrollPosition');
            if (savedScrollPosition) {
                setTimeout(() => {
                    chatDiv.scrollTop = parseInt(savedScrollPosition);
                }, 100);
            }
        }

        function deleteChatHistory() {
            if (!activeChatPeerId) return;

            if (confirm(`¿Estás seguro de que quieres borrar todos los mensajes de este chat? Esta acción no se puede deshacer.`)) {
                const histories = JSON.parse(localStorage.getItem('chatHistories')) || {};
                delete histories[activeChatPeerId];
                localStorage.setItem('chatHistories', JSON.stringify(histories));
                chatDiv.innerHTML = '';
                addMessageToChat({ 
                    type: 'system-message', 
                    text: `Historial de chat con ${activeChatPeerId} borrado.` 
                }, 'system-message', false);
                showToast('Historial del chat borrado', 'info');
                updateMessageStats();
                renderOnlineUsers();
            }
        }
        
        function updateMessageStats() {
            const histories = JSON.parse(localStorage.getItem('chatHistories')) || {};
            let totalMessages = 0;
            let totalChats = 0;
            
            Object.values(histories).forEach(chat => {
                totalMessages += chat.length;
                totalChats++;
            });
            
            document.getElementById('totalMessages').textContent = totalMessages;
            document.getElementById('totalChats').textContent = totalChats;
            document.getElementById('connectedUsers').textContent = Object.keys(onlineUsers).length;
            
            // Guardar estadísticas en localStorage
            localStorage.setItem('messageStats', JSON.stringify({
                totalMessages: totalMessages,
                totalChats: totalChats
            }));
        }

        // --- NOTIFICACIONES (Toast, Sonidos y Nativas) ---
        function showToast(message, type) {
            if (!userSettings.notifications) return;
            
            notificationQueue.push({ message, type });
            if (!isDisplayingNotification) {
                processNotificationQueue();
            }
        }
        
        function processNotificationQueue() {
            if (notificationQueue.length === 0) { isDisplayingNotification = false; return; }
            isDisplayingNotification = true;
            const { message, type } = notificationQueue.shift();
            const notification = document.createElement('div');
            notification.textContent = message;
            notification.className = `notification-popup notification-${type}`;
            notificationContainer.appendChild(notification);
            void notification.offsetWidth;
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
                notification.classList.add('hide');
                notification.addEventListener('transitionend', function handler() {
                    if (notification.classList.contains('hide')) {
                        notification.remove();
                        notification.removeEventListener('transitionend', handler);
                        setTimeout(processNotificationQueue, 200);
                    }
                });
            }, 3000);
        }
        
        function showSystemNotification(sender, message) {
            if (!userSettings.notifications) return;
            
            if (Notification.permission === 'granted' && (document.hidden || activeChatPeerId !== sender)) {
                const user = onlineUsers[sender] || {};
                const notification = new Notification(`Mensaje de ${sender}`, {
                    body: message,
                    icon: user.profilePic || 'https://cdn-icons-png.flaticon.com/512/1256/1256650.png',
                    vibrate: [200, 100, 200] // Patrón de vibración para dispositivos móviles
                });
                
                // Manejar clic en la notificación
                notification.onclick = function() {
                    window.focus();
                    if (onlineUsers[sender]) {
                        startChatWith(sender);
                    }
                };
            }
        }
        
        // --- GESTIÓN DE PERFIL ---
        function openProfileModal() {
            profileModal.style.display = 'flex';
            updateMessageStats();
        }
        
        function closeProfileModal() {
            profileModal.style.display = 'none';
        }
        
        function saveProfile() {
            const newAlias = aliasInput.value.trim().replace(/\s+/g, '_');
            
            if (newAlias.length < 3 || newAlias.length > 20) {
                showToast('El alias debe tener entre 3 y 20 caracteres', 'error');
                return;
            }
            
            myAlias = newAlias;
            localStorage.setItem('chatAlias', myAlias);
            
            // Actualizar en la red
            if (trackerConnection && trackerConnection.open) {
                trackerConnection.send({
                    type: 'profile-update',
                    alias: myAlias,
                    profilePic: myProfilePic
                });
            }
            
            // Reiniciar conexión con nuevo alias
            initMyPeer();
            updateProfileUI();
            renderOnlineUsers();
            
            showToast('Perfil actualizado correctamente', 'success');
            closeProfileModal();
        }
        
        function updateProfilePicture() {
            const file = profilePicInput.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (event) => {
                myProfilePic = event.target.result;
                localStorage.setItem('userProfilePic', myProfilePic);
                updateProfileUI();
                
                // Actualizar en la red
                if (trackerConnection && trackerConnection.open) {
                    trackerConnection.send({
                        type: 'profile-update',
                        alias: myAlias,
                        profilePic: myProfilePic
                    });
                }
                
                // Actualizar conexiones existentes
                Object.values(peerConnections).forEach(conn => {
                    if (conn.open) {
                        conn.send({
                            type: 'profile-update',
                            profilePic: myProfilePic
                        });
                    }
                });
                
                showToast('Foto de perfil actualizada', 'success');
            };
            reader.readAsDataURL(file);
        }

        // --- LÓGICA DE UI (EVENTOS Y DISEÑO) ---
        function setupUIEventListeners() {
            // Envío de mensajes
            sendButton.onclick = sendMessage;
            messageInput.onkeypress = (e) => { 
                if (e.key === 'Enter' && !e.shiftKey) { 
                    e.preventDefault(); 
                    sendMessage(); 
                }
            };
            
            // Borrado de chat
            deleteChatButton.onclick = deleteChatHistory;

            // Selector de Emojis
            const emojiPicker = document.querySelector('emoji-picker');
            emojiButton.onclick = (e) => {
                e.stopPropagation();
                emojiPickerContainer.style.display = emojiPickerContainer.style.display === 'none' ? 'block' : 'none';
            };
            emojiPicker.addEventListener('emoji-click', event => {
                messageInput.value += event.detail.unicode;
                messageInput.focus();
            });
            document.body.addEventListener('click', (e) => {
                if (!emojiPickerContainer.contains(e.target) && !emojiButton.contains(e.target)) {
                    emojiPickerContainer.style.display = 'none';
                }
            });

            // Menú lateral
            menuButton.onclick = () => { 
                sideMenu.classList.toggle('active'); 
                sideMenuBackdrop.classList.toggle('active'); 
            };
            sideMenuBackdrop.onclick = () => { 
                sideMenu.classList.remove('active'); 
                sideMenuBackdrop.classList.remove('active'); 
            };
            
            // Botón de volver
            backToPeersListButton.onclick = () => { 
                activeChatPeerId = null; 
                updateLayout(); 
                renderOnlineUsers(); 
                localStorage.removeItem('activeChatPeerId');
            };
            
            // Opciones del menú lateral
            document.getElementById('userInfoOption').onclick = openProfileModal;
            document.getElementById('messageStatsOption').onclick = () => {
                openProfileModal();
                updateMessageStats();
            };
            document.getElementById('settingsOption').onclick = () => {
                showToast('Configuración disponible en la próxima versión', 'info');
            };
            document.getElementById('logoutOption').onclick = () => {
                if (confirm('¿Estás seguro de que quieres cerrar sesión?')) {
                    localStorage.clear();
                    location.reload();
                }
            };
            
            // Gestión de foto de perfil
            profilePicInput.addEventListener('change', updateProfilePicture);
            
            // Guardar el estado del chat cuando se cierra la aplicación
            window.addEventListener('beforeunload', function() {
                localStorage.setItem('activeChatPeerId', activeChatPeerId || '');
            });
        }

        function updateLayout() {
            const isChatView = !!activeChatPeerId;
            peerListContainer.classList.toggle('hidden-left', isChatView);
            document.querySelector('.input-area').style.display = isChatView ? 'flex' : 'none';
            menuButton.style.display = isChatView ? 'none' : 'block';
            deleteChatButton.style.display = isChatView ? 'block' : 'none';
            backToPeersListButton.style.display = isChatView ? 'block' : 'none';

            if (isChatView) {
                const peerData = onlineUsers[activeChatPeerId] || {};
                activePeerNameDisplay.textContent = activeChatPeerId;
                
                if (peerData.profilePic) {
                    activePeerProfilePic.innerHTML = `<img src="${peerData.profilePic}" alt="${activeChatPeerId}">`;
                } else {
                    activePeerProfilePic.innerHTML = '<i class="fa fa-user"></i>';
                }
                
                statusIndicator.textContent = 'En línea';
                statusIndicator.classList.add('active');
            } else {
                activePeerNameDisplay.textContent = 'Usuarios en Línea';
                activePeerProfilePic.innerHTML = '<i class="fa fa-users"></i>';
            }
        }

        // Inicialización cuando la ventana carga
        window.addEventListener('load', function() {
            // Recuperar estado anterior del chat si existe
            const savedActiveChat = localStorage.getItem('activeChatPeerId');
            if (savedActiveChat && savedActiveChat !== '') {
                activeChatPeerId = savedActiveChat;
            }
            
            initApp();
        });
        
        window.addEventListener('resize', updateLayout);
        
        // Manejar cambios en la visibilidad de la página
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                // La página volvió a estar visible, actualizar estado
                renderOnlineUsers();
            }
        });
        
        // Ocultar la barra de direcciones al desplazar en iOS
        window.addEventListener('scroll', function() {
            setTimeout(function() {
                window.scrollTo(0, 1);
            }, 0);
        });
        
        // Guardar periodicamente los datos del chat
        setInterval(function() {
            const histories = JSON.parse(localStorage.getItem('chatHistories')) || {};
            localStorage.setItem('chatHistoriesBackup', JSON.stringify(histories));
        }, 30000); // Guardar cada 30 segundos
    </script>
</body>
</html>
