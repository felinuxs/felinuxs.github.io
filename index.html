<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <title>Gestor Empresarial Móvil v0.1</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#3498db">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Gestor">
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/3498db/ffffff?text=GE">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary: #3498db;
            --secondary: #3498db;
            --success: #27ae60;
            --danger: #e74c3c;
            --warning: #f39c12;
            --light: #f8f9fa;
            --dark: #343a40;
            --background: #f8f9fa;
            --text: #343a40;
            --card-bg: white;
            --border: #ddd;
        }

        .tema-oscuro {
            --primary: #2980b9;
            --secondary: #2980b9;
            --background: #1a1a1a;
            --text: #f8f9fa;
            --card-bg: #2d2d2d;
            --border: #444;
        }

        .tema-negro {
            --primary: #343a40;
            --secondary: #343a40;
            --background: #000000;
            --text: #f1f1f1;
            --card-bg: #1c1c1c;
            --border: #333;
        }

        .tema-verde {
            --primary: #27ae60;
            --secondary: #27ae60;
        }

        .tema-amarillo {
            --primary: #f39c12;
            --secondary: #f39c12;
        }
        
        .tema-naranja {
            --primary: #e67e22;
            --secondary: #e67e22;
        }

        .tema-rosado {
            --primary: #e84393;
            --secondary: #e84393;
        }
        
        .tema-amarillo .btn-primary, .tema-amarillo .btn-movil, .tema-amarillo table th,
        .tema-naranja .btn-primary, .tema-naranja .btn-movil, .tema-naranja table th {
            color: var(--dark) !important;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; overflow: hidden; }
        body {
            font-family: 'Segoe UI', system-ui;
            background: var(--background);
            color: var(--text);
            font-size: 16px;
            transition: background 0.3s, color 0.3s;
        }

        /* Sistema de Notificaciones Mejorado */
        .notification-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--primary);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 10000;
            transform: translateX(150%);
            transition: transform 0.3s ease;
            max-width: 300px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .notification-toast.show {
            transform: translateX(0);
        }

        .notification-toast.success { background: var(--success); }
        .notification-toast.error { background: var(--danger); }
        .notification-toast.warning { background: var(--warning); }
        .notification-toast.info { background: var(--primary); }

        .notification-sound {
            display: none;
        }

        /* Mensajería Mejorada - Estilo Google SMS */
        .message-bubble {
            max-width: 70%;
            padding: 10px 14px;
            margin: 5px 0;
            border-radius: 18px;
            position: relative;
            word-wrap: break-word;
            animation: messageSlide 0.3s ease-out;
        }

        @keyframes messageSlide {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message-bubble.sent {
            background: var(--primary);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }

        .message-bubble.received {
            background: var(--card-bg);
            color: var(--text);
            align-self: flex-start;
            border-bottom-left-radius: 5px;
            border: 1px solid var(--border);
        }

        .message-content {
            margin-bottom: 4px;
            line-height: 1.4;
        }

        .message-time {
            font-size: 0.75em;
            opacity: 0.7;
            text-align: right;
        }

        .message-bubble.received .message-time {
            text-align: left;
        }

        /* Mejoras visuales para el chat */
        #chat-box {
            display: flex;
            flex-direction: column;
            padding: 10px;
            gap: 8px;
            min-height: 300px;
            max-height: 60vh;
            overflow-y: auto;
        }

        #mensaje-texto {
            border-radius: 20px;
            padding: 12px 16px;
            resize: none;
            border: 1px solid var(--border);
            font-family: inherit;
        }

        .barra-buscadora {
            background: var(--primary);
            color: white;
            padding: 10px;
            position: fixed;
            top: 0; left: 0;
            width: 100%;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .search-container { display: flex; align-items: center; position: relative; }
        .search-container input {
            flex: 1; padding: 10px 15px;
            border: none; border-radius: 20px;
            font-size: 1em; background: white; color: #333;
            text-transform: capitalize;
        }

        .search-results {
            position: absolute; top: 100%; left: 0; right: 0;
            background: var(--card-bg); color: var(--text);
            border-radius: 0 0 5px 5px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            max-height: 300px; overflow-y: auto; display: none;
            z-index: 1001; border: 1px solid var(--border);
        }
        .search-result-item {
            padding: 10px 15px; border-bottom: 1px solid var(--border); cursor: pointer;
            display: flex; justify-content: space-between; align-items: center;
        }
        .search-result-item:hover { background-color: rgba(0,0,0,0.05); }
        .result-actions { display: flex; gap: 5px; }
        .result-btn { padding: 3px 8px; border: none; border-radius: 3px; font-size: 0.8em; cursor: pointer; }
        .btn-view { background: var(--secondary); color: white; }
        .btn-edit { background: var(--warning); color: white; }
        .btn-add { background: var(--success); color: white; }
        .btn-sell { background: var(--primary); color: white; }

        .container {
            width: 100%; padding: 10px; margin-top: 60px;
            height: calc(100% - 60px); overflow-y: auto;
        }

        .menu-movil {
            display: grid; grid-template-columns: repeat(2, 1fr);
            gap: 10px; margin-bottom: 20px;
        }
        .btn-movil {
            padding: 12px 8px; background: var(--secondary); color: white;
            border: none; border-radius: 12px; font-size: 0.95em; cursor: pointer;
            transition: transform 0.2s, background 0.2s;
            width: 100%; box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
            display: flex; align-items: center; justify-content: center; gap: 5px;
            flex-direction: column; height: 80px;
        }
        .btn-movil:hover { opacity: 0.9; }
        .btn-movil:active { transform: scale(0.98); }
        .tipo-cambio-btn { font-size: 0.85em; line-height: 1.2; text-align: center; }
        .tipo-cambio-btn .tasa { font-size: 0.75em; font-weight: bold; }
        .tipo-cambio-btn .label { font-size: 0.85em; margin-top: 3px; }

        .nueva-pagina {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--background); color: var(--text); z-index: 1000;
            overflow-y: auto; padding: 20px; padding-top: 70px;
        }
        .nueva-pagina .close-btn {
            background: none; border: none; font-size: 2em; color: var(--primary);
            padding: 10px; position: absolute; right: 15px; top: 15px;
            cursor: pointer; z-index: 1001;
        }

        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        table th, table td { padding: 10px; border: 1px solid var(--border); text-align: left; }
        table th { background-color: var(--primary); color: white; }
        table tr:nth-child(even) { background-color: rgba(0,0,0,0.03); }
        table tr:hover { background-color: rgba(0,0,0,0.05); }

        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 5px;
            font-size: 1em; background: var(--card-bg); color: var(--text);
            text-transform: capitalize;
        }
        .btn { padding: 10px 15px; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 1em; margin: 5px 0; }
        .btn-primary { background-color: var(--secondary); }
        .btn-danger { background-color: var(--danger); }
        .btn-success { background-color: var(--success); }
        .btn-warning { background-color: var(--warning); }
        .btn:hover { opacity: 0.9; }
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center;
        }
        .modal-content {
            background: var(--card-bg); color: var(--text); padding: 20px; border-radius: 10px;
            width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto; border: 1px solid var(--border);
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--border); }
        .modal-close { background: none; border: none; font-size: 1.5em; cursor: pointer; color: var(--text); }
        .producto-venta { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid var(--border); align-items: center; }
        .producto-info { flex: 1; }
        .producto-acciones { display: flex; gap: 5px; }
        .tipo-cambio-info { background: rgba(0,0,0,0.05); padding: 10px; border-radius: 5px; margin: 10px 0; text-align: center; font-size: 0.9em; }
        .card { background: var(--card-bg); border-radius: 10px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border: 1px solid var(--border); }
        .error { color: var(--danger); font-size: 0.9em; margin-top: 5px; }
        .config-option { margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid var(--border); }
        .config-option:last-child { border-bottom: none; }
        .watermark { position: fixed; bottom: 10px; left: 0; width: 100%; text-align: center; font-size: 0.8em; color: #777; z-index: 999; }
        #modal-salida .modal-content { text-align: center; }
        #modal-salida .botones-confirmacion { display: flex; justify-content: center; gap: 15px; margin-top: 20px; }
        .factura-termica { width: 80mm; padding: 10px; font-family: 'Courier New', monospace; font-size: 12px; background: white; color: black; line-height: 1.2; }
        .factura-header { text-align: center; margin-bottom: 10px; border-bottom: 1px dashed #000; padding-bottom: 10px; }
        .factura-items { width: 100%; border-collapse: collapse; margin: 10px 0; }
        .factura-items th, .factura-items td { padding: 4px 0; border-bottom: 1px dashed #ccc; }
        .factura-total { margin-top: 10px; border-top: 2px solid #000; padding-top: 10px; text-align: right; font-weight: bold; }
        .capitalize { text-transform: capitalize; }
        .gasto-item, .empleado-item, .proveedor-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid var(--border); align-items: center; }
        .reporte-item { padding: 10px; border-bottom: 1px solid var(--border); }
        .btn-tema { background-color: var(--card-bg); color: var(--text); box-shadow: 0 2px 4px rgba(0,0,0,0.2); font-weight: bold; border: 1px solid var(--border); }
        .botones-accion { display: flex; justify-content: space-between; gap: 10px; margin-top: 10px; }
        .botones-accion .btn { flex: 1; text-align: center; padding: 12px 5px; font-size: 0.9em; }
        .botones-data { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
        .botones-data .btn { flex: 1; min-width: 100px; text-align: center; }
        .acciones-tabla { display: flex; gap: 5px; flex-wrap: wrap; }
        .acciones-tabla .btn { padding: 6px 10px; font-size: 0.85em; margin: 2px; }
        .exportar-factura { display: flex; gap: 10px; margin-top: 15px; }
        .exportar-factura .btn { flex: 1; }
        .calendario-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .calendario-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; }
        .calendario-grid div { padding: 8px 4px; border-radius: 5px; }
        .calendario-dia-nombre { font-weight: bold; font-size: 0.8em; }
        .calendario-dia { cursor: pointer; border: 1px solid var(--border); }
        .calendario-dia:hover { background: var(--primary); color: white; }
        .dia-actual { background: var(--success); color: white; font-weight: bold; }
        .dia-seleccionado { background: var(--warning); color: white; }
        .modal-exportacion { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; }
        .modal-exportacion .modal-content { background: var(--card-bg); color: var(--text); padding: 20px; border-radius: 10px; width: 90%; max-width: 400px; max-height: 80vh; overflow-y: auto; border: 1px solid var(--border); }
        .opcion-exportacion { display: flex; align-items: center; padding: 15px; border-bottom: 1px solid var(--border); cursor: pointer; }
        .opcion-exportacion:last-child { border-bottom: none; }
        .opcion-exportacion:hover { background-color: rgba(0,0,0,0.05); }
        .icono-exportacion { font-size: 24px; margin-right: 15px; width: 30px; text-align: center; }
        .texto-exportacion { flex: 1; }
        .texto-exportacion h4 { margin-bottom: 5px; }
        .texto-exportacion p { font-size: 0.9em; color: #777; }
        .formulario-envio { margin-top: 15px; }
        .formulario-envio .form-group { margin-bottom: 10px; }
        .formulario-envio label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9em; }
        .formulario-envio input { width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 5px; font-size: 0.9em; }
        .botones-envio { display: flex; justify-content: space-between; margin-top: 15px; }
        /* Estilos para Mensajería P2P */
        #chat-box { scroll-behavior: smooth; }
        .chat-message { padding: 8px 12px; border-radius: 15px; margin-bottom: 10px; max-width: 80%; word-wrap: break-word; }
        .message-sent { background-color: var(--primary); color: white; align-self: flex-end; border-bottom-right-radius: 3px; }
        .message-received { background-color: #e0e0e0; color: var(--dark); align-self: flex-start; border-bottom-left-radius: 3px; }
        .message-meta { font-size: 0.75em; font-weight: bold; margin-bottom: 4px; }
        .message-content img { max-width: 100%; border-radius: 10px; cursor: pointer; }
        .message-content audio { width: 100%; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
</head>
<body>
    <div id="notification-container"></div>
    
    <div class="barra-buscadora">
        <div class="search-container">
            <input type="text" id="buscador-global" placeholder="Buscar productos, clientes, proveedores..." autocomplete="off">
            <div class="search-results" id="resultados-busqueda"></div>
        </div>
    </div>

    <div class="container">
        <div class="menu-movil">
            <button class="btn-movil" onclick="abrirPagina('ventas')">🛒 Ventas</button>
            <button class="btn-movil" onclick="abrirPagina('inventario')">📦 Inventario</button>
            <button class="btn-movil" onclick="abrirPagina('clientes')">👥 Clientes</button>
            <button class="btn-movil" onclick="abrirPagina('proveedores')">🚚 Proveedores</button>
            <button class="btn-movil" onclick="abrirPagina('gastos')">💸 Gastos</button>
            <button class="btn-movil" onclick="abrirPagina('empleados')">👨‍💼 Empleados</button>
            <button class="btn-movil tipo-cambio-btn" onclick="abrirPagina('tipo-cambio')">
                <div>💵</div>
                <div class="tasa" id="tipo-cambio-btn">1$ = 0.00 Bs</div>
                <div class="label">Dólar</div>
            </button>
            <button class="btn-movil" onclick="abrirPagina('mensajes')">📨 Mensajes</button>
            <button class="btn-movil" onclick="abrirPagina('reportes')">📊 Reportes</button>
            <button class="btn-movil" onclick="abrirPagina('config')">⚙️ Configuración</button>
        </div>
        <div class="watermark">@felinuxs</div>
    </div>

    <div id="pagina-ventas" class="nueva-pagina">
        <button class="close-btn" onclick="cerrarPagina('ventas')">&times;</button>
        <h2>🛒 Ventas</h2>
        <div class="tipo-cambio-info">Tipo de cambio: <span id="tipo-cambio-venta">1$ = 0.00 Bs</span></div>
        <div class="form-group">
            <label for="cliente-venta">Cliente:</label>
            <div class="search-container">
                <input type="text" id="buscador-cliente-venta" placeholder="Buscar cliente..." autocomplete="off">
                <div class="search-results" id="resultados-cliente-venta"></div>
            </div>
            <button class="btn btn-success" style="margin-top: 5px; width: 100%;" onclick="abrirModalCliente()">+ Nuevo Cliente</button>
        </div>
        <div class="form-group">
            <label for="producto-venta">Producto:</label>
            <div class="search-container">
                <input type="text" id="buscador-producto-venta" placeholder="Buscar producto..." autocomplete="off">
                <div class="search-results" id="resultados-producto-venta"></div>
            </div>
        </div>
        <div id="productos-seleccionados"></div>
        <div style="margin-top: 20px; padding: 10px; background: rgba(0,0,0,0.05); border-radius: 5px;">
            <h3>Resumen de Venta</h3>
            <p>Total: <span id="total-bs">0.00</span> Bs</p>
            <div class="form-group" style="margin-top: 10px;">
                <label for="metodo-pago">Método de Pago:</label>
                <select id="metodo-pago">
                    <option value="Pagomóvil">Pagomóvil</option>
                    <option value="Efectivo USD">Efectivo USD</option>
                    <option value="Efectivo Bs">Efectivo Bs</option>
                    <option value="Tarjeta">Tarjeta</option>
                    <option value="Otro">Otro</option>
                </select>
            </div>
        </div>
        <div class="botones-accion">
            <button class="btn btn-success" onclick="finalizarVenta()">Finalizar Venta</button>
            <button class="btn btn-primary" onclick="mostrarFactura()">Ver Factura</button>
        </div>
    </div>

    <div id="pagina-inventario" class="nueva-pagina">
        <button class="close-btn" onclick="cerrarPagina('inventario')">&times;</button>
        <h2>📦 Inventario</h2>
        <div class="search-container" style="margin-bottom: 15px;">
            <input type="text" id="buscador-inventario" placeholder="Buscar en inventario..." autocomplete="off">
        </div>
        <button class="btn btn-success" onclick="abrirModalProducto()">+ Agregar Producto</button>
        <table id="tabla-inventario">
            <thead><tr><th>Nombre</th><th>Precio USD</th><th>Precio Bs</th><th>Stock</th><th>Acciones</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="pagina-clientes" class="nueva-pagina">
        <button class="close-btn" onclick="cerrarPagina('clientes')">&times;</button>
        <h2>👥 Clientes</h2>
        <div class="search-container" style="margin-bottom: 15px;">
            <input type="text" id="buscador-clientes" placeholder="Buscar clientes..." autocomplete="off">
        </div>
        <button class="btn btn-success" onclick="abrirModalCliente()">+ Agregar Cliente</button>
        <table id="tabla-clientes">
            <thead><tr><th>Nombre</th><th>Teléfono</th><th>Email</th><th>Acciones</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="pagina-proveedores" class="nueva-pagina">
        <button class="close-btn" onclick="cerrarPagina('proveedores')">&times;</button>
        <h2>🚚 Proveedores</h2>
        <div class="search-container" style="margin-bottom: 15px;">
            <input type="text" id="buscador-proveedores" placeholder="Buscar proveedores..." autocomplete="off">
        </div>
        <button class="btn btn-success" onclick="abrirModalProveedor()">+ Agregar Proveedor</button>
        <div id="lista-proveedores"></div>
    </div>

    <div id="pagina-gastos" class="nueva-pagina">
        <button class="close-btn" onclick="cerrarPagina('gastos')">&times;</button>
        <h2>💸 Gastos</h2>
        <div class="form-group">
            <label for="filtro-fecha-gastos">Filtrar por fecha:</label>
            <input type="month" id="filtro-fecha-gastos" onchange="cargarGastos()">
        </div>
        <button class="btn btn-success" onclick="abrirModalGasto()">+ Registrar Gasto</button>
        <div id="resumen-gastos" class="card">
            <h3>Resumen del Mes</h3>
            <p>Total Gastos: <span id="total-gastos">0.00</span> Bs</p>
            <p>Por Categoría:</p>
            <ul id="categorias-gastos"></ul>
        </div>
        <div id="lista-gastos"></div>
    </div>

    <div id="pagina-empleados" class="nueva-pagina">
        <button class="close-btn" onclick="cerrarPagina('empleados')">&times;</button>
        <h2>👨‍💼 Empleados</h2>
        <div class="search-container" style="margin-bottom: 15px;">
            <input type="text" id="buscador-empleados" placeholder="Buscar empleados..." autocomplete="off">
        </div>
        <button class="btn btn-success" onclick="abrirModalEmpleado()">+ Agregar Empleado</button>
        <div id="lista-empleados"></div>
    </div>

    <div id="pagina-tipo-cambio" class="nueva-pagina">
        <button class="close-btn" onclick="cerrarPagina('tipo-cambio')">&times;</button>
        <h2>💵 Tipo de Cambio</h2>
        <div class="card">
            <h3>Tipo de Cambio Actual</h3>
            <p>1 USD = <span id="tipo-cambio-actual">0.00</span> Bs</p>
            <p>Última actualización: <span id="fecha-actualizacion">N/A</span></p>
        </div>
        <div class="form-group">
            <label for="nuevo-tipo-cambio">Nuevo Tipo de Cambio (Bs por USD):</label>
            <input type="number" id="nuevo-tipo-cambio" step="0.01" min="1">
        </div>
        <button class="btn btn-primary" onclick="actualizarTipoCambio()">Actualizar Manualmente</button>
        <div class="card" style="margin-top: 20px;">
            <h3>Historial de Cambios</h3>
            <div id="historial-tipo-cambio"></div>
        </div>
    </div>

    <div id="pagina-mensajes" class="nueva-pagina">
        <button class="close-btn" onclick="cerrarPagina('mensajes')">&times;</button>
        <h2>📨 Mensajería P2P</h2>
        <div id="chat-container">
            <div class="card">
                <div id="info-conexion">
                    <p><strong>Usuario:</strong> <span id="display-usuario">No configurado</span></p>
                </div>
            </div>
            <div id="chat-box" class="card" style="height: 40vh; overflow-y: auto; display: flex; flex-direction: column;"></div>
            <div id="chat-input-area" class="card">
                <div id="grabando-indicator" style="display:none; color: var(--danger); margin-bottom: 5px;">Grabando nota de voz...</div>
                <textarea id="mensaje-texto" placeholder="Escribe un mensaje..." rows="2" style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid var(--border);"></textarea>
                <div class="botones-accion" style="margin-top: 10px;">
                    <button class="btn btn-primary" onclick="enviarMensajeTexto()">Enviar ✉️</button>
                    <button class="btn btn-warning" id="btn-grabar-voz">Grabar Voz 🎤</button>
                    <label for="adjuntar-imagen" class="btn btn-success" style="margin: 5px; text-align: center; padding: 10px 15px;">Imagen 🖼️</label>
                    <input type="file" id="adjuntar-imagen" accept="image/*" style="display: none;" onchange="enviarImagen(this.files[0])">
                </div>
            </div>
        </div>
    </div>
    
    <div id="pagina-reportes" class="nueva-pagina">
        <button class="close-btn" onclick="cerrarPagina('reportes')">&times;</button>
        <h2>📊 Reportes</h2>
        <div class="card">
            <h3>Ventas Diarias</h3>
            <div id="calendario-container">
                <div class="calendario-header">
                    <button class="btn btn-primary" id="mes-anterior-btn">&lt;</button>
                    <h4 id="mes-actual-titulo"></h4>
                    <button class="btn btn-primary" id="mes-siguiente-btn">&gt;</button>
                </div>
                <div class="calendario-grid" id="calendario-grid"></div>
            </div>
            <div id="reporte-diario-container" style="margin-top: 15px;"></div>
        </div>
        <div class="card">
            <h3>Generar Reporte General</h3>
            <div class="form-group">
                <label for="tipo-reporte">Tipo de Reporte:</label>
                <select id="tipo-reporte"><option value="ventas">Ventas</option><option value="inventario">Inventario</option><option value="gastos">Gastos</option><option value="clientes">Clientes</option></select>
            </div>
            <div class="form-group"><label for="fecha-inicio">Fecha Inicio:</label><input type="date" id="fecha-inicio"></div>
            <div class="form-group"><label for="fecha-fin">Fecha Fin:</label><input type="date" id="fecha-fin"></div>
            <button class="btn btn-primary" onclick="generarReporte()">Generar Reporte</button>
        </div>
        <div id="contenedor-reporte" style="margin-top: 20px;"></div>
    </div>

    <div id="pagina-config" class="nueva-pagina">
        <button class="close-btn" onclick="cerrarPagina('config')">&times;</button>
        <h2>⚙️ Configuración</h2>
        <div class="config-option">
            <h3>Apariencia</h3>
            <div class="form-group">
                <label for="tema-select">Tema:</label>
                <select id="tema-select" onchange="cambiarTema(this.value)">
                    <option value="claro">Claro</option><option value="oscuro">Oscuro</option><option value="negro">Negro</option>
                    <option value="verde">Verde</option><option value="amarillo">Amarillo</option><option value="naranja">Naranja</option><option value="rosado">Rosado</option>
                </select>
            </div>
        </div>
        <div class="config-option" id="seccion-prevencion-cierre">
            <h3>Prevención de Cierre Accidental</h3>
            <button class="btn btn-primary" onclick="activarPrevencionCierre()">Activar</button>
            <button class="btn btn-danger" onclick="desactivarPrevencionCierre()">Desactivar</button>
            <p id="estado-prevencion" style="margin-top: 10px; font-size: 0.9em;">Estado: Inactivo</p>
        </div>
        <div class="config-option">
            <h3>Datos</h3>
            <div class="botones-data">
                <button class="btn btn-primary" onclick="respaldarDatos()">Respaldar (JSON)</button>
                <button class="btn btn-warning" onclick="restaurarDatos()">Restaurar (JSON)</button>
                <button class="btn btn-primary" onclick="exportarDatosExcel()">Respaldar (Excel)</button>
                <button class="btn btn-danger" onclick="mostrarModal('modal-salida')">Eliminar Datos</button>
            </div>
        </div>
        <div class="config-option">
            <h3>Empresa y Usuario</h3>
            <div class="form-group"><label for="nombre-empresa">Nombre de la Empresa:</label><input type="text" id="nombre-empresa"></div>
            <div class="form-group"><label for="rif-empresa">RIF:</label><input type="text" id="rif-empresa"></div>
            <div class="form-group"><label for="telefono-empresa">Teléfono:</label><input type="text" id="telefono-empresa"></div>
            <div class="form-group"><label for="direccion-empresa">Dirección:</label><textarea id="direccion-empresa"></textarea></div>
            <div class="form-group"><label for="usuario-chat">Nombre de Usuario (para chat):</label><input type="text" id="usuario-chat" placeholder="Ej: Juan Vendedor"></div>
            <button class="btn btn-success" onclick="guardarConfiguracionEmpresa()">Guardar Configuración</button>
        </div>
        <div class="config-option">
            <h3>Sincronización(Red)</h3>
            <div class="form-group">
                <label for="p2p-pin-local">Mi PIN de Sincronización (para ser visible):</label>
                <input type="text" id="p2p-pin-local" placeholder="Define un PIN (Ej: TIENDA01)">
                <button class="btn btn-primary" style="margin-top: 5px; width: 100%;" onclick="iniciarPeerLocal()">1. Conectar/Hacerme visible</button>
            </div>
            <p style="font-size: 0.9em; margin-top: 10px;">Estado Local: <strong id="p2p-device-status">Desconectado</strong></p>
            <div class="form-group" style="margin-top: 20px; border-top: 1px dashed var(--border); padding-top: 15px;">
                <label for="peer-id-input">PIN del Dispositivo Par a Conectar:</label>
                <input type="text" id="peer-id-input" placeholder="Ingresa el PIN de otro dispositivo">
            </div>
            <button class="btn btn-success" onclick="iniciarConexionP2P()">2. Conectar a este PIN e Iniciar Malla</button>
            <p style="margin-top: 10px; font-size: 0.9em; color: var(--primary);" id="p2p-estado">Pares conectados: 0</p>
        </div>
        <div class="config-option"><h3>Acerca de</h3><p>Gestor Empresarial Móvil v0.1 (Fusion)</p><p>Desarrollado por @felinuxs</p></div>
    </div>
    
    <div class="modal" id="modal-nuevo-cliente"><div class="modal-content"><div class="modal-header"><h3 id="titulo-modal-nuevo-cliente">Nuevo Cliente</h3><button class="modal-close" onclick="cerrarModal('modal-nuevo-cliente')">&times;</button></div><form id="form-nuevo-cliente"><div class="form-group"><label for="nombre-cliente-modal">Nombre:</label><input type="text" id="nombre-cliente-modal" class="capitalize" required></div><div class="form-group"><label for="telefono-cliente-modal">Teléfono:</label><input type="text" id="telefono-cliente-modal"></div><div class="form-group"><label for="email-cliente-modal">Email:</label><input type="email" id="email-cliente-modal"></div><div class="form-group"><label for="direccion-cliente-modal">Dirección:</label><textarea id="direccion-cliente-modal" class="capitalize"></textarea></div><button type="submit" class="btn btn-success">Guardar Cliente</button></form></div></div>
    <div class="modal" id="modal-agregar-producto"><div class="modal-content"><div class="modal-header"><h3 id="titulo-modal-producto">Agregar Producto</h3><button class="modal-close" onclick="cerrarModal('modal-agregar-producto')">&times;</button></div><form id="form-agregar-producto"><div class="form-group"><label for="nombre-producto">Nombre:</label><input type="text" id="nombre-producto" class="capitalize"></div><div class="form-group"><label for="precio-usd-producto">Precio USD:</label><input type="number" id="precio-usd-producto" step="0.01" min="0" oninput="calcularPrecioBs()"></div><div class="form-group"><label for="precio-bs-producto">Precio Bs:</label><input type="number" id="precio-bs-producto" step="0.01" min="0" readonly></div><div class="form-group"><label for="stock-producto">Stock:</label><input type="number" id="stock-producto" min="0"></div><button type="submit" class="btn btn-success">Guardar Producto</button></form></div></div>
    <div class="modal" id="modal-agregar-proveedor"><div class="modal-content"><div class="modal-header"><h3 id="titulo-modal-agregar-proveedor">Agregar Proveedor</h3><button class="modal-close" onclick="cerrarModal('modal-agregar-proveedor')">&times;</button></div><form id="form-agregar-proveedor"><div class="form-group"><label for="nombre-proveedor">Nombre:</label><input type="text" id="nombre-proveedor" class="capitalize" required></div><div class="form-group"><label for="contacto-proveedor">Contacto:</label><input type="text" id="contacto-proveedor" class="capitalize"></div><div class="form-group"><label for="telefono-proveedor">Teléfono:</label><input type="text" id="telefono-proveedor"></div><div class="form-group"><label for="email-proveedor">Email:</label><input type="email" id="email-proveedor"></div><div class="form-group"><label for="productos-proveedor">Suministra:</label><textarea id="productos-proveedor" class="capitalize"></textarea></div><button type="submit" class="btn btn-success">Guardar</button></form></div></div>
    <div class="modal" id="modal-agregar-gasto"><div class="modal-content"><div class="modal-header"><h3>Registrar Gasto</h3><button class="modal-close" onclick="cerrarModal('modal-agregar-gasto')">&times;</button></div><form id="form-agregar-gasto"><div class="form-group"><label for="descripcion-gasto">Descripción:</label><input type="text" id="descripcion-gasto" class="capitalize" required></div><div class="form-group"><label for="categoria-gasto">Categoría:</label><select id="categoria-gasto"><option value="oficina">Oficina</option><option value="servicios">Servicios</option><option value="impuestos">Impuestos</option><option value="nómina">Nómina</option><option value="otros">Otros</option></select></div><div class="form-group"><label for="monto-gasto">Monto (Bs):</label><input type="number" id="monto-gasto" step="0.01" min="0" required></div><div class="form-group"><label for="fecha-gasto">Fecha:</label><input type="date" id="fecha-gasto" required></div><button type="submit" class="btn btn-success">Registrar</button></form></div></div>
    <div class="modal" id="modal-agregar-empleado"><div class="modal-content"><div class="modal-header"><h3 id="titulo-modal-agregar-empleado">Agregar Empleado</h3><button class="modal-close" onclick="cerrarModal('modal-agregar-empleado')">&times;</button></div><form id="form-agregar-empleado"><div class="form-group"><label for="nombre-empleado">Nombre:</label><input type="text" id="nombre-empleado" class="capitalize" required></div><div class="form-group"><label for="cargo-empleado">Cargo:</label><input type="text" id="cargo-empleado" class="capitalize"></div><div class="form-group"><label for="salario-empleado">Salario (Bs):</label><input type="number" id="salario-empleado" step="0.01" min="0"></div><div class="form-group"><label for="telefono-empleado">Teléfono:</label><input type="text" id="telefono-empleado"></div><div class="form-group"><label for="fecha-contracto">Fecha de Contrato:</label><input type="date" id="fecha-contracto"></div><button type="submit" class="btn btn-success">Guardar</button></form></div></div>
    <div class="modal" id="modal-factura"><div class="modal-content"><div class="modal-header"><h3>Factura</h3><button class="modal-close" onclick="cerrarModal('modal-factura')">&times;</button></div><div class="factura-termica" id="area-factura"><div class="factura-header"><h3 id="nombre-empresa-factura"></h3><p>RIF: <span id="rif-empresa-factura"></span></p><p>Teléfono: <span id="telefono-empresa-factura"></span></p><p>Fecha: <span id="factura-fecha"></span></p></div><div class="factura-cliente"><p><strong>Cliente:</strong> <span id="factura-cliente-nombre"></span></p></div><table class="factura-items"><thead><tr><th>Producto</th><th>Cant</th><th>Precio</th><th>Total</th></tr></thead><tbody id="factura-items-body"></tbody></table><div class="factura-total"><p>Total: <span id="factura-total"></span></p></div><div class="factura-footer"><p>¡Gracias por su compra!</p></div></div><div class="exportar-factura"><button class="btn btn-primary" onclick="mostrarOpcionesExportacion()">Exportar/Imprimir</button></div></div></div>
    <div class="modal" id="modal-salida"><div class="modal-content"><div class="modal-header"><h3>¿Eliminar todos los datos?</h3></div><p>Esta acción no se puede deshacer.</p><div class="botones-confirmacion"><button class="btn btn-danger" onclick="eliminarTodosDatos()">Sí, eliminar</button><button class="btn btn-primary" onclick="cerrarModal('modal-salida')">Cancelar</button></div></div></div>
    <div class="modal-exportacion" id="modal-exportar"><div class="modal-content"><div class="modal-header"><h3>Exportar Factura</h3><button class="modal-close" onclick="cerrarModal('modal-exportar')">&times;</button></div><div class="opcion-exportacion" onclick="imprimirFactura()"><div class="icono-exportacion">🖨️</div><div class="texto-exportacion"><h4>Imprimir (Térmica 80mm)</h4><p>Imprimir factura directamente</p></div></div><div class="opcion-exportacion" onclick="exportarFacturaComo('PDF')"><div class="icono-exportacion">📄</div><div class="texto-exportacion"><h4>Exportar a PDF</h4><p>Guardar como documento PDF</p></div></div><div class="opcion-exportacion" onclick="exportarFacturaComo('JPEG')"><div class="icono-exportacion">🖼️</div><div class="texto-exportacion"><h4>Exportar a JPEG</h4><p>Guardar como imagen JPEG</p></div></div><div class="opcion-exportacion" onclick="exportarFacturaComo('TXT')"><div class="icono-exportacion">📝</div><div class="texto-exportacion"><h4>Exportar a TXT</h4><p>Guardar como archivo de texto</p></div></div><div class="opcion-exportacion" onclick="exportarFacturaComo('Excel')"><div class="icono-exportacion">📊</div><div class="texto-exportacion"><h4>Exportar a Excel</h4><p>Guardar datos en hoja de cálculo</p></div></div></div></div>

    <script>
        // =======================================================================
        // === SISTEMA DE NOTIFICACIONES MEJORADO ===
        // =======================================================================
        
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `notification-toast ${type}`;
            toast.innerHTML = `
                <i class="fas fa-${getNotificationIcon(type)}"></i>
                <span>${message}</span>
            `;
            
            document.getElementById('notification-container').appendChild(toast);
            
            // Mostrar notificación
            setTimeout(() => toast.classList.add('show'), 100);
            
            // Reproducir sonido
            playNotificationSound();
            
            // Ocultar después de 3 segundos
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function getNotificationIcon(type) {
            const icons = {
                success: 'check-circle',
                error: 'exclamation-circle',
                warning: 'exclamation-triangle',
                info: 'info-circle'
            };
            return icons[type] || 'info-circle';
        }

        function playNotificationSound() {
            // Crear sonido de notificación simple
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            } catch (e) {
                console.log("No se pudo reproducir sonido de notificación:", e);
            }
        }

        // =======================================================================
        // === SISTEMA DE MENSAJERÍA MEJORADO (ESTILO GOOGLE SMS) ===
        // =======================================================================
        
        function inicializarMensajeria() {
            const chatBox = document.getElementById('chat-box');
            const mensajeTexto = document.getElementById('mensaje-texto');
            
            // Cargar historial de mensajes
            cargarHistorialMensajes();
            
            // Configurar eventos de UI mejorados
            mensajeTexto.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    enviarMensajeTexto();
                }
            });
            
            mensajeTexto.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });
        }

        function enviarMensajeTexto() {
            const textoInput = document.getElementById('mensaje-texto');
            const mensaje = textoInput.value.trim();
            
            if (!mensaje) return;
            
            const mensajeData = {
                id: generarUUID(),
                remitente: configuracion.usuarioChat,
                tipo: 'texto',
                contenido: mensaje,
                timestamp: Date.now(),
                leido: false
            };
            
            // Enviar a través de P2P
            if(p2pManager) {
                p2pManager.broadcast({ 
                    type: 'CHAT_MESSAGE', 
                    payload: mensajeData 
                });
            }
            
            mostrarMensaje(mensajeData, true);
            guardarMensajeEnHistorial(mensajeData);
            textoInput.value = '';
            textoInput.style.height = 'auto';
            
            showToast('Mensaje enviado', 'success');
        }

        function mostrarMensaje(msg, esMio) {
            const chatBox = document.getElementById('chat-box');
            const divMensaje = document.createElement('div');
            
            divMensaje.className = `message-bubble ${esMio ? 'sent' : 'received'}`;
            divMensaje.innerHTML = `
                <div class="message-content">${msg.contenido}</div>
                <div class="message-time">${new Date(msg.timestamp).toLocaleTimeString('es-ES', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                })}</div>
            `;
            
            chatBox.appendChild(divMensaje);
            chatBox.scrollTop = chatBox.scrollHeight;
            
            // Notificación para mensajes recibidos
            if (!esMio) {
                showToast(`Nuevo mensaje de ${msg.remitente}`, 'info');
            }
        }

        // =======================================================================
        // === MODULO DE SINCRONIZACIÓN P2P MEJORADO ===
        // =======================================================================
        
        const dataKeys = ['inventario', 'clientes', 'proveedores', 'gastos', 'empleados', 'ventas', 'historialTipoCambio'];
        let p2pManager = null;
        const DEVICE_UUID_KEY = 'pwa_sync_device_uuid';
        const CONNECTION_PIN_KEY = 'p2p_connection_pin';
        let mediaRecorder;
        let audioChunks = [];

        function generarUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
                var r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        function getDeviceUUID() {
            let id = localStorage.getItem(DEVICE_UUID_KEY);
            if (!id) {
                id = generarUUID();
                localStorage.setItem(DEVICE_UUID_KEY, id);
            }
            return id;
        }

        function getConnectionPin() { return localStorage.getItem(CONNECTION_PIN_KEY); }

        function addMetadata(record) {
            record.id = record.id || generarUUID();
            record.timestamp = Date.now();
            record.deviceId = getDeviceUUID();
            return record;
        }

        function SincronizacionP2P(pin) {
            if (!pin || pin.length < 3) { 
                showToast('El PIN debe tener al menos 3 caracteres.', 'error');
                return null; 
            }
            
            const PEER_ID = pin.toUpperCase();
            let peer;
            
            // Configuración mejorada de PeerJS
            const peerConfig = {
                debug: 2,
                config: {
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:global.stun.twilio.com:3478' }
                    ],
                    iceTransportPolicy: 'all',
                    rtcpMuxPolicy: 'require'
                },
                reliable: true
            };

            try {
                peer = new Peer(PEER_ID, peerConfig);
            } catch (e) {
                console.error("Error al inicializar PeerJS:", e);
                document.getElementById('p2p-device-status').textContent = 'ERROR de Inicialización';
                showToast('Error al conectar P2P', 'error');
                return null;
            }
            
            let connectedPeers = {};
            let reconnectAttempts = 0;
            const maxReconnectAttempts = 5;

            peer.on('open', id => {
                localStorage.setItem(CONNECTION_PIN_KEY, id);
                document.getElementById('p2p-pin-local').value = id;
                document.getElementById('p2p-device-status').textContent = `Conectado (PIN: ${id})`;
                document.getElementById('p2p-device-status').style.color = 'var(--success)';
                reconnectAttempts = 0;
                actualizarEstadoP2P();
                showToast('Conexión P2P establecida', 'success');
            });
            
            peer.on('error', err => {
                console.error("Error en PeerJS:", err);
                document.getElementById('p2p-device-status').textContent = `Error: ${err.type}`;
                document.getElementById('p2p-device-status').style.color = 'var(--danger)';
                
                if (err.type === 'disconnected' && reconnectAttempts < maxReconnectAttempts) {
                    setTimeout(() => {
                        reconnectAttempts++;
                        peer.reconnect();
                    }, 2000 * reconnectAttempts);
                }
            });

            peer.on('disconnected', () => {
                document.getElementById('p2p-device-status').textContent = 'Reconectando...';
                document.getElementById('p2p-device-status').style.color = 'var(--warning)';
                showToast('Conexión perdida, reconectando...', 'warning');
            });
            
            peer.on('connection', conn => {
                conn.on('open', () => handleNewConnection(conn));
                conn.on('data', data => manejarDatoEntrante(data, conn.peer));
                conn.on('close', () => handleConnectionClose(conn.peer));
                conn.on('error', err => console.error('Error de conexión entrante:', err));
            });

            const handleNewConnection = (conn) => {
                if (connectedPeers[conn.peer]) return;
                connectedPeers[conn.peer] = conn;
                actualizarEstadoP2P();
                this.enviarSincronizacionCompleta(conn); 
                const knownPeers = Object.keys(connectedPeers).filter(id => id !== conn.peer);
                conn.send({ type: 'PEER_LIST', list: knownPeers, senderId: PEER_ID });
                this.broadcast({ type: 'NEW_PEER', peerId: conn.peer }, conn.peer);
            };

            const handleConnectionClose = peerId => {
                delete connectedPeers[peerId];
                actualizarEstadoP2P();
                showToast(`Dispositivo ${peerId} desconectado`, 'warning');
            };

            this.conectarA = targetPeerId => {
                targetPeerId = targetPeerId.toUpperCase();
                if (!peer || peer.disconnected) { 
                    showToast('El Peer local no está conectado. Presiona "Conectar/Hacerme visible" primero.', 'error'); 
                    return; 
                }
                if (targetPeerId === PEER_ID) { 
                    showToast('No puedes conectarte a tu propio PIN.', 'warning'); 
                    return; 
                }
                if (connectedPeers[targetPeerId]) { 
                    showToast('Ya estás conectado a este dispositivo.', 'info'); 
                    return; 
                }
                const conn = peer.connect(targetPeerId);
                conn.on('open', () => handleNewConnection(conn));
                conn.on('data', data => manejarDatoEntrante(data, conn.peer));
                conn.on('close', () => handleConnectionClose(conn.peer));
                conn.on('error', err => {
                    console.error('Error de conexión saliente:', err);
                    document.getElementById('p2p-estado').textContent = `Pares: ${Object.keys(connectedPeers).length}. Fallo al conectar con ${targetPeerId}`;
                    showToast(`Error al conectar con ${targetPeerId}`, 'error');
                });
            };

            this.broadcast = (data, excludePeerId = null) => {
                Object.values(connectedPeers).forEach(conn => {
                    if (conn.peer !== excludePeerId && conn.open) {
                        conn.send(data);
                    }
                });
            };

            this.enviarCambio = (key, record, operation) => {
                if (Object.keys(connectedPeers).length === 0) return;
                const delta = { type: 'DELTA_SYNC', key, operation, record };
                this.broadcast(delta);
            };
            
            this.enviarSincronizacionCompleta = connection => {
                const fullData = {};
                dataKeys.forEach(key => { fullData[key] = obtenerDatos(key); });
                const fullSyncMessage = { type: 'FULL_SYNC', data: fullData, senderId: PEER_ID, deviceId: getDeviceUUID() };
                if(connection.open) connection.send(fullSyncMessage);
            };

            function manejarDatoEntrante(data, senderId) {
                if (data.type === 'FULL_SYNC') {
                    document.getElementById('p2p-device-status').textContent = 'Sincronizando (Completa)...';
                    dataKeys.forEach(key => {
                        const localArray = obtenerDatos(key);
                        const remoteArray = data.data[key] || [];
                        const mergedArray = fusionarArrays(localArray, remoteArray);
                        localStorage.setItem(key, JSON.stringify(mergedArray));
                    });
                    document.getElementById('p2p-device-status').textContent = `Conectado (PIN: ${PEER_ID})`;
                    refrescarUI(); 
                    showToast('Sincronización completa recibida', 'success');
                } else if (data.type === 'DELTA_SYNC') {
                    const updated = aplicarCambioDelta(data.key, data.record, data.operation);
                    if (updated) {
                         this.broadcast(data, senderId);
                         refrescarUI(data.key); 
                         showToast(`Dato sincronizado: ${data.key}`, 'info');
                    }
                } else if (data.type === 'CHAT_MESSAGE') {
                    mostrarMensaje(data.payload, false);
                    guardarMensajeEnHistorial(data.payload);
                    this.broadcast(data, senderId);
                } else if (data.type === 'PEER_LIST' && data.list) {
                    data.list.forEach(peerId => {
                        if (peerId !== PEER_ID && !connectedPeers[peerId]) this.conectarA(peerId);
                    });
                } else if (data.type === 'NEW_PEER' && data.peerId) {
                    if (data.peerId !== PEER_ID && !connectedPeers[data.peerId]) this.conectarA(data.peerId);
                }
            }
            manejarDatoEntrante = manejarDatoEntrante.bind(this);
            
            function fusionarArrays(local, remoto) {
                const mapa = new Map(local.filter(i => i && i.id).map(i => [i.id, i]));
                remoto.filter(i => i && i.id).forEach(itemRemoto => {
                    const itemLocal = mapa.get(itemRemoto.id);
                    if (!itemLocal || itemRemoto.timestamp > itemLocal.timestamp) mapa.set(itemRemoto.id, itemRemoto);
                });
                return Array.from(mapa.values());
            }
            
            function aplicarCambioDelta(key, record, operation) {
                let localArray = obtenerDatos(key);
                const index = localArray.findIndex(item => item.id === record.id);
                let applied = false;
                if (index !== -1) {
                    const localTimestamp = localArray[index].timestamp || 0;
                    if (record.timestamp > localTimestamp) {
                        if (operation === 'DELETE') localArray.splice(index, 1);
                        else localArray[index] = record;
                        applied = true;
                    }
                } else if (operation !== 'DELETE') {
                    localArray.push(record);
                    applied = true;
                }
                if (applied) localStorage.setItem(key, JSON.stringify(localArray));
                return applied;
            }
            
            function actualizarEstadoP2P() {
                const count = Object.keys(connectedPeers).length;
                const estado = document.getElementById('p2p-estado');
                if (estado) {
                    estado.textContent = `Pares conectados: ${count}`;
                    estado.style.color = count > 0 ? 'var(--success)' : 'var(--primary)';
                }
            }
            return this; 
        }

        function iniciarPeerLocal() {
            const pin = document.getElementById('p2p-pin-local').value.trim();
            if (!pin) { 
                showToast('Por favor, define un PIN de conexión.', 'error'); 
                return; 
            }
            if (p2pManager) { 
                showToast('El sistema P2P ya está inicializado. Recarga para usar otro PIN.', 'warning'); 
                return; 
            }
            document.getElementById('p2p-pin-local').value = pin.toUpperCase();
            document.getElementById('p2p-device-status').textContent = 'Conectando...';
            document.getElementById('p2p-device-status').style.color = 'var(--warning)';
            p2pManager = new SincronizacionP2P(pin);
            if (p2pManager) localStorage.setItem(CONNECTION_PIN_KEY, pin.toUpperCase());
        }

        function iniciarConexionP2P() {
            const targetPeerId = document.getElementById('peer-id-input').value.trim();
            const pinLocal = getConnectionPin();
            if (!pinLocal) { 
                showToast('Debes definir tu PIN local y conectarte (Paso 1) primero.', 'error'); 
                return; 
            }
            if (!p2pManager) p2pManager = new SincronizacionP2P(pinLocal);
            if (!targetPeerId) { 
                showToast('Ingresa el PIN del dispositivo a conectar.', 'error'); 
                return; 
            }
            document.getElementById('p2p-estado').textContent = 'Intentando conectar...';
            p2pManager.conectarA(targetPeerId);
        }

        function refrescarUI(key = null) {
            const current_page_id = document.querySelector('.nueva-pagina[style*="display: block"]')?.id;
            if (!key || (key === 'inventario' && current_page_id === 'pagina-inventario')) cargarInventario();
            if (!key || (key === 'clientes' && current_page_id === 'pagina-clientes')) cargarClientes();
            if (!key || (key === 'proveedores' && current_page_id === 'pagina-proveedores')) cargarProveedores();
            if (!key || (key === 'gastos' && current_page_id === 'pagina-gastos')) cargarGastos();
            if (!key || (key === 'empleados' && current_page_id === 'pagina-empleados')) cargarEmpleados();
            if (!key || key === 'ventas') { /* Lógica de actualización de reportes o ventas en vivo si es necesario */ }
            if (!key || key === 'historialTipoCambio') cargarTipoCambio();
        }

        function syncLocalData(key, record, operation) {
            if (operation !== 'DELETE') record = addMetadata(record);
            
            let localArray = obtenerDatos(key);
            const index = localArray.findIndex(item => item.id === record.id);
            
            if (operation === 'DELETE') {
                if (index !== -1) {
                    record = localArray[index]; 
                    record.timestamp = Date.now(); 
                    localArray.splice(index, 1);
                }
            } else {
                if (index !== -1) { 
                    // Resolver conflictos por timestamp
                    if (record.timestamp > localArray[index].timestamp) {
                        localArray[index] = record; 
                        operation = 'UPDATE';
                    } else {
                        // El dato local es más reciente, no sobrescribir
                        return localArray[index];
                    }
                } else { 
                    localArray.push(record); 
                    operation = 'ADD'; 
                }
            }
            
            localStorage.setItem(key, JSON.stringify(localArray));
            
            // Sincronizar con otros dispositivos
            if (p2pManager && dataKeys.includes(key)) {
                p2pManager.enviarCambio(key, record, operation);
            }
            
            // Mostrar notificación de sincronización
            if (operation !== 'DELETE') {
                showToast(`Dato ${operation === 'ADD' ? 'agregado' : 'actualizado'} y sincronizado`, 'success');
            }
            
            return record;
        }
        
        // =======================================================================
        // === INICIO DEL CÓDIGO DE LA APLICACIÓN ===
        // =======================================================================

        const configKey = 'configuracion';
        const configDefault = {
            tema: "claro",
            nombreEmpresa: "MI EMPRESA",
            rifEmpresa: "J-123456789",
            telefonoEmpresa: "(123) 456-7890",
            direccionEmpresa: "Av. Principal, Local #123",
            usuarioChat: "Usuario Anónimo"
        };
        const TEMA_COLORS = { claro: '#3498db', oscuro: '#2980b9', negro: '#343a40', verde: '#27ae60', amarillo: '#f39c12', naranja: '#e67e22', rosado: '#e84393' };
        let configuracion;
        let tipoCambio = 1.0; // MODIFICADO: Valor inicial por defecto para evitar errores
        let listaVenta = [];
        let prevencionCierreActiva = false;
        let fechaCalendario = new Date();

        function obtenerDatos(key) {
            let data;
            try { data = JSON.parse(localStorage.getItem(key) || '[]'); } catch (e) { data = []; }
            if (dataKeys.includes(key)) {
                let modified = false;
                data.forEach(item => {
                    if (!item.id || !item.timestamp || !item.deviceId) {
                        item.id = item.id || generarUUID();
                        item.timestamp = item.timestamp || (item.fecha ? new Date(item.fecha).getTime() : Date.now());
                        item.deviceId = item.deviceId || 'LEGACY_IMPORT';
                        modified = true;
                    }
                });
                if (modified) localStorage.setItem(key, JSON.stringify(data));
            }
            return data;
        }

        function guardarConfiguracion() { localStorage.setItem(configKey, JSON.stringify(configuracion)); }

        function cargarConfiguracion() {
            const storedConfig = localStorage.getItem(configKey);
            configuracion = storedConfig ? { ...configDefault, ...JSON.parse(storedConfig) } : configDefault;
            aplicarTema(configuracion.tema);
            document.getElementById('nombre-empresa').value = configuracion.nombreEmpresa;
            document.getElementById('rif-empresa').value = configuracion.rifEmpresa;
            document.getElementById('telefono-empresa').value = configuracion.telefonoEmpresa;
            document.getElementById('direccion-empresa').value = configuracion.direccionEmpresa;
            document.getElementById('usuario-chat').value = configuracion.usuarioChat;
            document.getElementById('display-usuario').textContent = configuracion.usuarioChat;
            document.getElementById('tema-select').value = configuracion.tema;
            const pinGuardado = getConnectionPin();
            if (document.getElementById('p2p-pin-local')) document.getElementById('p2p-pin-local').value = pinGuardado || '';
        }
        
        function guardarConfiguracionEmpresa() {
            configuracion.nombreEmpresa = document.getElementById('nombre-empresa').value.trim();
            configuracion.rifEmpresa = document.getElementById('rif-empresa').value.trim();
            configuracion.telefonoEmpresa = document.getElementById('telefono-empresa').value.trim();
            configuracion.direccionEmpresa = document.getElementById('direccion-empresa').value.trim();
            configuracion.usuarioChat = document.getElementById('usuario-chat').value.trim();
            guardarConfiguracion();
            document.getElementById('display-usuario').textContent = configuracion.usuarioChat;
            showToast('Configuración guardada.', 'success');
        }

        function cambiarTema(nuevoTema) {
            configuracion.tema = nuevoTema;
            guardarConfiguracion();
            aplicarTema(nuevoTema);
            showToast(`Tema cambiado a ${nuevoTema}`, 'success');
        }

        function aplicarTema(tema) {
            document.body.className = '';
            if (tema && tema !== 'claro') document.body.classList.add('tema-' + tema);
            document.querySelector('meta[name="theme-color"]').setAttribute('content', TEMA_COLORS[tema] || TEMA_COLORS['claro']);
        }

        function abrirPagina(id) {
            document.querySelectorAll('.nueva-pagina').forEach(p => p.style.display = 'none');
            const pagina = document.getElementById(`pagina-${id}`);
            if (pagina) {
                pagina.style.display = 'block';
                if (id === 'inventario') cargarInventario();
                if (id === 'clientes') cargarClientes();
                if (id === 'proveedores') cargarProveedores();
                if (id === 'gastos') cargarGastos();
                if (id === 'empleados') cargarEmpleados();
                if (id === 'ventas') { cargarTipoCambio(); reiniciarVenta(); }
                if (id === 'tipo-cambio') cargarTipoCambio();
                if (id === 'reportes') generarCalendario(fechaCalendario.getFullYear(), fechaCalendario.getMonth());
                if (id === 'mensajes') { cargarHistorialChat(); inicializarMensajeria(); }
                if (id === 'config') cargarConfiguracion();
            }
        }
        function cerrarPagina(id) { document.getElementById(`pagina-${id}`).style.display = 'none'; }
        
        function formatearBs(numero) {
            if (typeof numero !== 'number') numero = parseFloat(numero) || 0;
            return new Intl.NumberFormat('es-VE', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(numero) + ' Bs';
        }

        // === LÓGICA DE TIPO DE CAMBIO ===
        // MODIFICADO: Lógica mejorada para ser más robusta
        function cargarTipoCambio() {
            const historial = obtenerDatos('historialTipoCambio');
            let tasaAplicada = 1.0; // Valor por defecto
            let fechaTasa = "N/A";

            if (historial.length > 0) {
                const ultimoRegistro = historial.reduce((prev, current) => (prev.timestamp > current.timestamp) ? prev : current);
                tasaAplicada = ultimoRegistro.tasa;
                fechaTasa = new Date(ultimoRegistro.timestamp).toLocaleDateString();
            }
            tipoCambio = tasaAplicada;

            const tasaF = formatearBs(tipoCambio);
            document.getElementById('tipo-cambio-btn').textContent = `1$ = ${tasaF}`;
            document.getElementById('tipo-cambio-venta').textContent = `1$ = ${tasaF}`;
            document.getElementById('tipo-cambio-actual').textContent = tipoCambio.toFixed(2);
            document.getElementById('fecha-actualizacion').textContent = fechaTasa;
            
            const historialDiv = document.getElementById('historial-tipo-cambio');
            if (historialDiv) {
                historialDiv.innerHTML = historial.sort((a, b) => b.timestamp - a.timestamp).map(item =>
                    `<p>${new Date(item.timestamp).toLocaleDateString()}: 1 USD = ${item.tasa.toFixed(2)} Bs</p>`
                ).join('');
            }
        }

        // MODIFICADO: Mejor manejo de errores
        async function obtenerTipoCambioReal() {
            try {
                const response = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
                if (!response.ok) throw new Error('Respuesta de red no fue OK');
                const data = await response.json();
                if (data && data.rates && data.rates.VES) {
                    const nuevoTipoCambio = parseFloat(data.rates.VES);
                    syncLocalData('historialTipoCambio', { tasa: nuevoTipoCambio, fecha: new Date().toISOString().substring(0, 10) }, 'ADD');
                    showToast('Tipo de cambio actualizado desde internet', 'success');
                }
            } catch (error) { 
                console.error("Error al obtener tipo de cambio online (se usará el último guardado):", error);
                showToast('No se pudo obtener tipo de cambio online', 'warning');
            } finally {
                // Siempre se cargan los datos, ya sean los nuevos o los viejos.
                cargarTipoCambio();
                cargarInventario();
            }
        }

        function actualizarTipoCambio() {
            const nuevoTipoCambio = parseFloat(document.getElementById('nuevo-tipo-cambio').value);
            if (isNaN(nuevoTipoCambio) || nuevoTipoCambio <= 0) { 
                showToast('Ingrese una tasa válida.', 'error'); 
                return; 
            }
            syncLocalData('historialTipoCambio', { tasa: nuevoTipoCambio, fecha: new Date().toISOString().substring(0, 10) }, 'ADD');
            cargarTipoCambio();
            cargarInventario();
            showToast(`Tipo de cambio actualizado a 1 USD = ${nuevoTipoCambio.toFixed(2)} Bs`, 'success');
        }

        // === LÓGICA DE INVENTARIO ===
        function calcularPrecioBs() {
            const precioUsd = parseFloat(document.getElementById('precio-usd-producto').value) || 0;
            document.getElementById('precio-bs-producto').value = (precioUsd * (tipoCambio || 0)).toFixed(2);
        }
        function abrirModalProducto(productoId = null) {
            const form = document.getElementById('form-agregar-producto');
            form.reset();
            form.dataset.productoId = productoId || '';
            if (productoId) {
                const producto = obtenerDatos('inventario').find(p => p.id === productoId);
                if (producto) {
                    document.getElementById('titulo-modal-producto').textContent = 'Editar Producto';
                    document.getElementById('nombre-producto').value = producto.nombre;
                    document.getElementById('precio-usd-producto').value = producto.precioUsd;
                    document.getElementById('stock-producto').value = producto.stock;
                    calcularPrecioBs();
                }
            } else {
                document.getElementById('titulo-modal-producto').textContent = 'Agregar Producto';
            }
            mostrarModal('modal-agregar-producto');
        }
        document.getElementById('form-agregar-producto').addEventListener('submit', function(e) {
            e.preventDefault();
            const productoId = this.dataset.productoId;
            let producto = { 
                nombre: document.getElementById('nombre-producto').value.trim(), 
                precioUsd: parseFloat(document.getElementById('precio-usd-producto').value), 
                stock: parseInt(document.getElementById('stock-producto').value) 
            };
            if (productoId) {
                producto.id = productoId;
                syncLocalData('inventario', producto, 'UPDATE');
            } else {
                syncLocalData('inventario', producto, 'ADD');
            }
            cargarInventario();
            cerrarModal('modal-agregar-producto');
        });
        function eliminarProducto(id) {
            if (confirm("¿Seguro que deseas eliminar este producto?")) {
                const producto = obtenerDatos('inventario').find(p => p.id === id);
                if(producto) syncLocalData('inventario', producto, 'DELETE');
                cargarInventario();
                showToast('Producto eliminado', 'success');
            }
        }
        function cargarInventario() {
            const inventario = obtenerDatos('inventario').sort((a, b) => a.nombre.localeCompare(b.nombre));
            renderizarTablaInventario(inventario);
        }
        // NUEVO: Función para renderizar la tabla de inventario (para búsqueda)
        function renderizarTablaInventario(inventario) {
             const tablaBody = document.querySelector('#tabla-inventario tbody');
            if (tablaBody) {
                tablaBody.innerHTML = inventario.map(p => `
                    <tr>
                        <td class="capitalize">${p.nombre}</td><td>$${p.precioUsd.toFixed(2)}</td>
                        <td>${formatearBs(p.precioUsd * tipoCambio)}</td><td>${p.stock}</td>
                        <td><div class="acciones-tabla">
                            <button class="btn btn-warning" onclick="abrirModalProducto('${p.id}')">Editar</button>
                            <button class="btn btn-danger" onclick="eliminarProducto('${p.id}')">Eliminar</button>
                        </div></td></tr>`).join('');
            }
        }
        
        // === LÓGICA DE CLIENTES, PROVEEDORES, GASTOS, EMPLEADOS (similar a inventario) ===
        function abrirModalCRUD(modalId, formId, titulo, datos, itemId, campos) {
            const form = document.getElementById(formId);
            form.reset();
            form.dataset.itemId = itemId || '';
            document.getElementById(`titulo-modal-${modalId}`).textContent = itemId ? `Editar ${titulo}` : `Agregar ${titulo}`;
            if (itemId) {
                const item = obtenerDatos(datos).find(i => i.id === itemId);
                if (item) {
                    campos.forEach(c => { 
                        const el = document.getElementById(`${c.id}-${modalId}`);
                        if(el) el.value = item[c.key] || ''; 
                    });
                }
            }
            mostrarModal(`modal-${modalId}`);
        }
        function guardarItemCRUD(e, modalId, datos, campos) {
            e.preventDefault();
            const itemId = e.target.dataset.itemId;
            let item = {};
            campos.forEach(c => {
                const el = document.getElementById(`${c.id}-${modalId}`);
                if(el){
                    let value = el.value;
                    if(c.type === 'number') value = parseFloat(value) || 0;
                    item[c.key] = value;
                }
            });
            if (itemId) { item.id = itemId; syncLocalData(datos, item, 'UPDATE'); }
            else { syncLocalData(datos, item, 'ADD'); }
            window[`cargar${datos.charAt(0).toUpperCase() + datos.slice(1)}`]();
            cerrarModal(`modal-${modalId}`);
            showToast(`${titulo} ${itemId ? 'actualizado' : 'agregado'}`, 'success');
        }
        function eliminarItemCRUD(id, datos, nombre) {
            if (confirm(`¿Seguro que deseas eliminar este ${nombre}?`)) {
                const item = obtenerDatos(datos).find(i => i.id === id);
                if (item) syncLocalData(datos, item, 'DELETE');
                window[`cargar${datos.charAt(0).toUpperCase() + datos.slice(1)}`]();
                showToast(`${nombre} eliminado`, 'success');
            }
        }

        // Clientes
        const camposCliente = [{id:'nombre-cliente', key:'nombre'}, {id:'telefono-cliente', key:'telefono'}, {id:'email-cliente', key:'email'}, {id:'direccion-cliente', key:'direccion'}];
        const abrirModalCliente = (id = null) => abrirModalCRUD('nuevo-cliente', 'form-nuevo-cliente', 'Cliente', 'clientes', id, camposCliente);
        document.getElementById('form-nuevo-cliente').addEventListener('submit', e => guardarItemCRUD(e, 'nuevo-cliente', 'clientes', camposCliente));
        const eliminarCliente = id => eliminarItemCRUD(id, 'clientes', 'cliente');
        function cargarClientes() {
            const clientes = obtenerDatos('clientes').sort((a,b)=>a.nombre.localeCompare(b.nombre));
            renderizarTablaClientes(clientes);
        }
         // NUEVO: Función para renderizar la tabla de clientes (para búsqueda)
        function renderizarTablaClientes(clientes){
            const tablaBody = document.querySelector('#tabla-clientes tbody');
            if (tablaBody) {
                tablaBody.innerHTML = clientes.map(c => `<tr><td class="capitalize">${c.nombre}</td><td>${c.telefono||''}</td><td>${c.email||''}</td><td><div class="acciones-tabla"><button class="btn btn-warning" onclick="abrirModalCliente('${c.id}')">Editar</button><button class="btn btn-danger" onclick="eliminarCliente('${c.id}')">Eliminar</button></div></td></tr>`).join('');
            }
        }
        // Proveedores
        const camposProveedor = [{id:'nombre', key:'nombre'}, {id:'contacto', key:'contacto'}, {id:'telefono', key:'telefono'}, {id:'email', key:'email'}, {id:'productos', key:'productos'}];
        const abrirModalProveedor = (id=null) => abrirModalCRUD('agregar-proveedor', 'form-agregar-proveedor', 'Proveedor', 'proveedores', id, camposProveedor.map(c => ({...c, id: c.key + '-proveedor'})));
        document.getElementById('form-agregar-proveedor').addEventListener('submit', e => guardarItemCRUD(e, 'agregar-proveedor', 'proveedores', camposProveedor.map(c => ({...c, id: c.key + '-proveedor'}))));
        const eliminarProveedor = id => eliminarItemCRUD(id, 'proveedores', 'proveedor');
        function cargarProveedores(){
            const proveedores = obtenerDatos('proveedores').sort((a,b)=>a.nombre.localeCompare(b.nombre));
            renderizarListaProveedores(proveedores);
        }
        // NUEVO: Función para renderizar la lista de proveedores (para búsqueda)
        function renderizarListaProveedores(proveedores){
             const lista = document.getElementById('lista-proveedores');
            if(lista){
                lista.innerHTML = proveedores.map(p => `<div class="card proveedor-item"><div class="producto-info"><h4>${p.nombre}</h4><p>Contacto: ${p.contacto||'N/A'} - Tel: ${p.telefono||'N/A'}</p><p style="font-size: 0.8em; color: #777;">Suministra: ${p.productos || 'N/A'}</p></div><div class="producto-acciones"><button class="btn btn-warning" onclick="abrirModalProveedor('${p.id}')">Editar</button><button class="btn btn-danger" onclick="eliminarProveedor('${p.id}')">Eliminar</button></div></div>`).join('');
            }
        }
        // Gastos
        const camposGasto = [{id:'descripcion', key:'descripcion'}, {id:'categoria', key:'categoria'}, {id:'monto', key:'monto', type:'number'}, {id:'fecha', key:'fecha'}];
        const abrirModalGasto = (id=null) => abrirModalCRUD('agregar-gasto', 'form-agregar-gasto', 'Gasto', 'gastos', id, camposGasto.map(c => ({...c, id: c.key + '-gasto'})));
        document.getElementById('form-agregar-gasto').addEventListener('submit', e => guardarItemCRUD(e, 'agregar-gasto', 'gastos', camposGasto.map(c => ({...c, id: c.key + '-gasto'}))));
        const eliminarGasto = id => eliminarItemCRUD(id, 'gastos', 'gasto');
        function cargarGastos() {
            const filtroFecha = document.getElementById('filtro-fecha-gastos').value;
            const gastos = obtenerDatos('gastos');
            const gastosFiltrados = filtroFecha ? gastos.filter(g => g.fecha && g.fecha.startsWith(filtroFecha)) : gastos;
            document.getElementById('total-gastos').textContent = formatearBs(gastosFiltrados.reduce((sum, g) => sum + g.monto, 0));
            const resumenCat = gastosFiltrados.reduce((acc,g) => { acc[g.categoria] = (acc[g.categoria] || 0) + g.monto; return acc; }, {});
            document.getElementById('categorias-gastos').innerHTML = Object.entries(resumenCat).map(([cat,total])=>`<li>${cat}: ${formatearBs(total)}</li>`).join('');
            document.getElementById('lista-gastos').innerHTML = gastosFiltrados.sort((a,b)=>new Date(b.fecha) - new Date(a.fecha)).map(g=>`<div class="card gasto-item"><div class="producto-info"><h4>${g.descripcion}</h4><p>Monto: <strong>${formatearBs(g.monto)}</strong></p><p style="font-size:0.8em;color:#777;">${g.categoria} | ${g.fecha}</p></div><div class="producto-acciones"><button class="btn btn-warning" onclick="abrirModalGasto('${g.id}')">Editar</button><button class="btn btn-danger" onclick="eliminarGasto('${g.id}')">Eliminar</button></div></div>`).join('');
        }
        // Empleados
        const camposEmpleado = [{id:'nombre', key:'nombre'}, {id:'cargo', key:'cargo'}, {id:'salario', key:'salario', type:'number'}, {id:'telefono', key:'telefono'}, {id:'fecha-contracto', key:'fechaContracto'}];
        const abrirModalEmpleado = (id=null) => abrirModalCRUD('agregar-empleado', 'form-agregar-empleado', 'Empleado', 'empleados', id, camposEmpleado.map(c => ({...c, id: c.key + '-empleado'})));
        document.getElementById('form-agregar-empleado').addEventListener('submit', e => guardarItemCRUD(e, 'agregar-empleado', 'empleados', camposEmpleado.map(c => ({...c, id: c.key + '-empleado'}))));
        const eliminarEmpleado = id => eliminarItemCRUD(id, 'empleados', 'empleado');
        function cargarEmpleados() {
            const empleados = obtenerDatos('empleados').sort((a,b)=>a.nombre.localeCompare(b.nombre));
            renderizarListaEmpleados(empleados);
        }
        // NUEVO: Función para renderizar la lista de empleados (para búsqueda)
        function renderizarListaEmpleados(empleados){
            const lista = document.getElementById('lista-empleados');
            if (lista) lista.innerHTML = empleados.map(e=>`<div class="card empleado-item"><div class="producto-info"><h4>${e.nombre} (${e.cargo||''})</h4><p>Salario: <strong>${formatearBs(e.salario)}</strong></p><p style="font-size:0.8em;color:#777;">Tel: ${e.telefono||''} | Contrato: ${e.fechaContracto||''}</p></div><div class="producto-acciones"><button class="btn btn-warning" onclick="abrirModalEmpleado('${e.id}')">Editar</button><button class="btn btn-danger" onclick="eliminarEmpleado('${e.id}')">Eliminar</button></div></div>`).join('');
        }

        // === LÓGICA DE VENTAS ===
        function reiniciarVenta() {
            listaVenta = [];
            localStorage.removeItem('ventaActual');
            document.getElementById('buscador-cliente-venta').value = '';
            document.getElementById('buscador-producto-venta').value = '';
            actualizarResumenVenta();
        }
        function agregarProductoVenta(productoId, cantidad = 1) {
            const producto = obtenerDatos('inventario').find(p => p.id === productoId);
            if (!producto || producto.stock < cantidad) { 
                showToast('Stock insuficiente.', 'error'); 
                return; 
            }
            const itemExistente = listaVenta.find(item => item.id === productoId);
            if (itemExistente) itemExistente.cantidad += cantidad;
            else listaVenta.push({ id: productoId, nombre: producto.nombre, precioUsd: producto.precioUsd, cantidad: cantidad, stock: producto.stock });
            localStorage.setItem('ventaActual', JSON.stringify(listaVenta));
            actualizarResumenVenta();
            document.getElementById('buscador-producto-venta').value = '';
            document.getElementById('resultados-producto-venta').style.display = 'none';
            showToast('Producto agregado a la venta', 'success');
        }
        function eliminarItemVenta(productoId) {
            listaVenta = listaVenta.filter(item => item.id !== productoId);
            localStorage.setItem('ventaActual', JSON.stringify(listaVenta));
            actualizarResumenVenta();
            showToast('Producto removido de la venta', 'info');
        }
        function actualizarResumenVenta() {
            const contenedor = document.getElementById('productos-seleccionados');
            let totalUsd = 0;
            contenedor.innerHTML = listaVenta.map(item => {
                const subtotalUsd = item.precioUsd * item.cantidad;
                totalUsd += subtotalUsd;
                return `<div class="producto-venta card"><div class="producto-info"><p><strong>${item.nombre}</strong></p><p style="font-size:0.9em;">${item.cantidad} x $${item.precioUsd.toFixed(2)} = $${subtotalUsd.toFixed(2)} (${formatearBs(subtotalUsd*tipoCambio)})</p></div><div class="producto-acciones"><button class="btn btn-danger" onclick="eliminarItemVenta('${item.id}')">Quitar</button></div></div>`;
            }).join('');
            document.getElementById('total-bs').textContent = formatearBs(totalUsd * tipoCambio);
        }
        function finalizarVenta() {
            if (listaVenta.length === 0) { 
                showToast('No hay productos en la venta.', 'error'); 
                return; 
            }
            const clienteBuscador = document.getElementById('buscador-cliente-venta').value.trim();
            const cliente = obtenerDatos('clientes').find(c => c.nombre.toLowerCase() === clienteBuscador.toLowerCase());
            const totalUsd = listaVenta.reduce((sum, item) => sum + item.precioUsd * item.cantidad, 0);
            const ventaFinal = {
                fecha: new Date().toISOString().substring(0, 10), hora: new Date().toISOString().substring(11, 19),
                clienteId: cliente ? cliente.id : null, clienteNombre: cliente ? cliente.nombre : (clienteBuscador || 'Consumidor Final'),
                productos: listaVenta, totalUsd, totalBs: totalUsd * tipoCambio,
                metodoPago: document.getElementById('metodo-pago').value, tasaCambio: tipoCambio
            };
            let inventario = obtenerDatos('inventario');
            listaVenta.forEach(itemVenta => {
                const producto = inventario.find(p => p.id === itemVenta.id);
                if (producto) {
                    producto.stock -= itemVenta.cantidad;
                    syncLocalData('inventario', { ...producto }, 'UPDATE');
                }
            });
            syncLocalData('ventas', ventaFinal, 'ADD');
            showToast('Venta finalizada con éxito.', 'success');
            reiniciarVenta();
        }
        function mostrarFactura() {
            if (listaVenta.length === 0) { 
                showToast('Debe haber una venta activa.', 'error'); 
                return; 
            }
            const totalBs = listaVenta.reduce((sum, item) => sum + item.precioUsd * item.cantidad, 0) * tipoCambio;
            document.getElementById('nombre-empresa-factura').textContent = configuracion.nombreEmpresa;
            document.getElementById('rif-empresa-factura').textContent = configuracion.rifEmpresa;
            document.getElementById('telefono-empresa-factura').textContent = configuracion.telefonoEmpresa;
            document.getElementById('factura-fecha').textContent = new Date().toLocaleDateString();
            document.getElementById('factura-cliente-nombre').textContent = document.getElementById('buscador-cliente-venta').value.trim() || 'Consumidor Final';
            document.getElementById('factura-items-body').innerHTML = listaVenta.map(item => `<tr><td>${item.nombre}</td><td>${item.cantidad}</td><td>${item.precioUsd.toFixed(2)}</td><td>${(item.precioUsd * item.cantidad * tipoCambio).toFixed(2)}</td></tr>`).join('');
            document.getElementById('factura-total').textContent = formatearBs(totalBs);
            mostrarModal('modal-factura');
        }

        // === LÓGICA DE MENSAJERÍA ===
        function enviarMensajeTexto() {
            const textoInput = document.getElementById('mensaje-texto');
            if (textoInput.value.trim() === '') return;
            const mensaje = {
                id: generarUUID(), remitente: configuracion.usuarioChat, tipo: 'texto',
                contenido: textoInput.value, timestamp: Date.now()
            };
            if(p2pManager) p2pManager.broadcast({ type: 'CHAT_MESSAGE', payload: mensaje });
            mostrarMensaje(mensaje, true);
            guardarMensajeEnHistorial(mensaje);
            textoInput.value = '';
        }
        function enviarImagen(file) {
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                const mensaje = { id: generarUUID(), remitente: configuracion.usuarioChat, tipo: 'imagen', contenido: e.target.result, timestamp: Date.now() };
                if (p2pManager) p2pManager.broadcast({ type: 'CHAT_MESSAGE', payload: mensaje });
                mostrarMensaje(mensaje, true);
                guardarMensajeEnHistorial(mensaje);
            };
            reader.readAsDataURL(file);
        }
        document.getElementById('btn-grabar-voz').addEventListener('click', () => {
             if (mediaRecorder && mediaRecorder.state === "recording") {
                mediaRecorder.stop();
                document.getElementById('btn-grabar-voz').textContent = "Grabar Voz 🎤";
                document.getElementById('grabando-indicator').style.display = 'none';
            } else {
                navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
                    mediaRecorder = new MediaRecorder(stream);
                    mediaRecorder.start();
                    audioChunks = [];
                    mediaRecorder.addEventListener("dataavailable", e => audioChunks.push(e.data));
                    mediaRecorder.addEventListener("stop", () => {
                        const reader = new FileReader();
                        reader.onload = e => {
                            const mensaje = { id: generarUUID(), remitente: configuracion.usuarioChat, tipo: 'audio', contenido: e.target.result, timestamp: Date.now() };
                            if (p2pManager) p2pManager.broadcast({ type: 'CHAT_MESSAGE', payload: mensaje });
                            mostrarMensaje(mensaje, true);
                            guardarMensajeEnHistorial(mensaje);
                        };
                        reader.readAsDataURL(new Blob(audioChunks));
                    });
                    document.getElementById('btn-grabar-voz').textContent = "Detener 🛑";
                    document.getElementById('grabando-indicator').style.display = 'block';
                });
            }
        });
        function guardarMensajeEnHistorial(msg) {
            let historial = obtenerDatos('chatHistory');
            historial.push(msg);
            if (historial.length > 100) historial = historial.slice(-100); // Limitar historial
            localStorage.setItem('chatHistory', JSON.stringify(historial));
        }
        function cargarHistorialChat() {
            const chatBox = document.getElementById('chat-box');
            chatBox.innerHTML = '';
            obtenerDatos('chatHistory').forEach(msg => mostrarMensaje(msg, msg.remitente === configuracion.usuarioChat));
        }
        
        // === BÚSQUEDA Y MODALES GENÉRICOS ===
        function mostrarModal(id) { document.getElementById(id).style.display = 'flex'; }
        function cerrarModal(id) { document.getElementById(id).style.display = 'none'; }
        
        // === REPORTES Y EXPORTACIÓN ===
        function generarCalendario(year, month) {
            fechaCalendario = new Date(year, month, 1);
            const grid = document.getElementById('calendario-grid');
            grid.innerHTML = '';
            document.getElementById('mes-actual-titulo').textContent = `${fechaCalendario.toLocaleString('es-VE', { month: 'long' })} ${year}`;
            ['Do','Lu','Ma','Mi','Ju','Vi','Sa'].forEach(d => grid.innerHTML += `<div class="calendario-dia-nombre">${d}</div>`);
            for (let i=0; i < fechaCalendario.getDay(); i++) grid.innerHTML += `<div></div>`;
            const diasMes = new Date(year, month + 1, 0).getDate();
            for (let dia=1; dia <= diasMes; dia++) {
                const fecha = `${year}-${(month+1).toString().padStart(2,'0')}-${dia.toString().padStart(2,'0')}`;
                grid.innerHTML += `<div class="calendario-dia" onclick="cargarVentasDia('${fecha}')">${dia}</div>`;
            }
            document.getElementById('mes-anterior-btn').onclick = () => generarCalendario(fechaCalendario.getFullYear(), fechaCalendario.getMonth() - 1);
            document.getElementById('mes-siguiente-btn').onclick = () => generarCalendario(fechaCalendario.getFullYear(), fechaCalendario.getMonth() + 1);
        }
        function cargarVentasDia(fecha) {
            const ventasDia = obtenerDatos('ventas').filter(v => v.fecha === fecha);
            const cont = document.getElementById('reporte-diario-container');
            cont.innerHTML = `<h4>Ventas del ${fecha}</h4><p>Total: <strong>${formatearBs(ventasDia.reduce((s,v)=>s+v.totalBs,0))}</strong></p><ul>${ventasDia.map(v=>`<li>${v.hora} - ${v.clienteNombre} - <strong>${formatearBs(v.totalBs)}</strong></li>`).join('')}</ul>`;
        }
        // MODIFICADO: Función de generar reporte ahora funciona
        function generarReporte() {
            const tipo = document.getElementById('tipo-reporte').value;
            const inicio = document.getElementById('fecha-inicio').value;
            const fin = document.getElementById('fecha-fin').value;
            const contenedor = document.getElementById('contenedor-reporte');
            
            if (!inicio || !fin) {
                showToast("Por favor seleccione un rango de fechas.", "error");
                return;
            }

            let datos = obtenerDatos(tipo);
            let cabeceras = [];
            let filas = [];

            contenedor.innerHTML = `<h4>Reporte de ${tipo} (${inicio} al ${fin})</h4>`;

            if (tipo === 'ventas' || tipo === 'gastos') {
                datos = datos.filter(d => d.fecha >= inicio && d.fecha <= fin);
            }

            switch(tipo) {
                case 'ventas':
                    cabeceras = ['Fecha', 'Cliente', 'Total Bs', 'Método Pago'];
                    filas = datos.map(d => `<tr><td>${d.fecha}</td><td>${d.clienteNombre}</td><td>${formatearBs(d.totalBs)}</td><td>${d.metodoPago}</td></tr>`);
                    break;
                case 'gastos':
                    cabeceras = ['Fecha', 'Descripción', 'Categoría', 'Monto Bs'];
                    filas = datos.map(d => `<tr><td>${d.fecha}</td><td>${d.descripcion}</td><td>${d.categoria}</td><td>${formatearBs(d.monto)}</td></tr>`);
                    break;
                case 'inventario':
                     cabeceras = ['Nombre', 'Precio USD', 'Stock'];
                     filas = datos.map(d => `<tr><td>${d.nombre}</td><td>$${d.precioUsd.toFixed(2)}</td><td>${d.stock}</td></tr>`);
                     break;
                case 'clientes':
                     cabeceras = ['Nombre', 'Teléfono', 'Email'];
                     filas = datos.map(d => `<tr><td>${d.nombre}</td><td>${d.telefono}</td><td>${d.email}</td></tr>`);
                     break;
            }
            
            if(cabeceras.length > 0) {
                contenedor.innerHTML += `<table><thead><tr>${cabeceras.map(c => `<th>${c}</th>`).join('')}</tr></thead><tbody>${filas.join('')}</tbody></table>`;
                showToast('Reporte generado exitosamente', 'success');
            } else {
                 contenedor.innerHTML += '<p>No hay datos para mostrar.</p>';
                 showToast('No hay datos para el rango seleccionado', 'warning');
            }
        }
        function mostrarOpcionesExportacion() { cerrarModal('modal-factura'); mostrarModal('modal-exportar'); }
        function exportarFacturaComo(tipo) {
            cerrarModal('modal-exportar');
            const area = document.getElementById('area-factura');
            if (tipo === 'PDF') { html2canvas(area, {scale:2}).then(c => { const d = c.toDataURL('image/jpeg'), {jsPDF} = window.jspdf, pdf = new jsPDF({orientation:'p',unit:'mm',format:[80,200]}); pdf.addImage(d,'JPEG',0,0,80,(pdf.getImageProperties(d).height*80)/pdf.getImageProperties(d).width); pdf.save('Factura.pdf'); }); }
            else if (tipo === 'Excel') { const ws = XLSX.utils.json_to_sheet(listaVenta.map(i=>({Producto:i.nombre, Cant:i.cantidad, Precio_USD:i.precioUsd, Total_Bs:(i.precioUsd*i.cantidad*tipoCambio).toFixed(2)}))); XLSX.writeFile(XLSX.utils.book_new(), `Venta.xlsx`); }
            else if (tipo === 'JPEG') { html2canvas(area, {scale:2}).then(c => { const l=document.createElement('a'); l.href=c.toDataURL('image/jpeg'); l.download='Factura.jpeg'; l.click(); }); }
            else if (tipo === 'TXT') { const b = new Blob([area.innerText], {type:'text/plain'}), u = URL.createObjectURL(b), l=document.createElement('a'); l.href=u; l.download='Factura.txt'; l.click(); URL.revokeObjectURL(u); }
            showToast(`Factura exportada como ${tipo}`, 'success');
        }
        function imprimirFactura() {
            const area = document.getElementById('area-factura').innerHTML;
            const win = window.open('','_blank');
            win.document.write(`<html><head><title>Factura</title><style>.factura-termica{width:80mm;padding:10px;font-family:"Courier New",monospace;font-size:12px;}.factura-header{text-align:center;border-bottom:1px dashed #000;padding-bottom:10px;}.factura-items{width:100%;border-collapse:collapse;}.factura-items th,.factura-items td{border-bottom:1px dashed #ccc;}.factura-total{border-top:2px solid #000;text-align:right;font-weight:bold;}</style></head><body><div class="factura-termica">${area}</div></body></html>`);
            win.document.close(); win.print();
            showToast('Imprimiendo factura...', 'info');
        }

        // === DATOS (BACKUP/RESTORE) ===
        function respaldarDatos() {
            const datos = {};
            dataKeys.forEach(key => { datos[key] = obtenerDatos(key); });
            datos.configuracion = configuracion;
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([JSON.stringify(datos, null, 2)], {type:'application/json'}));
            a.download = `gestor_respaldo_${new Date().toISOString().substring(0,10)}.json`; a.click(); URL.revokeObjectURL(a.href);
            showToast('Respaldo de datos generado', 'success');
        }
        function restaurarDatos() {
            const input = document.createElement('input');
            input.type='file'; input.accept='.json';
            input.onchange = e => {
                const reader = new FileReader();
                reader.onload = ev => {
                    try {
                        const datos = JSON.parse(ev.target.result);
                        dataKeys.forEach(key => { if (datos[key]) localStorage.setItem(key, JSON.stringify(datos[key])); });
                        if(datos.configuracion) localStorage.setItem(configKey, JSON.stringify(datos.configuracion));
                        showToast('Datos restaurados. Recargando...', 'success'); 
                        setTimeout(() => location.reload(), 1500);
                    } catch (err) { 
                        showToast('Error al procesar el archivo.', 'error'); 
                    }
                };
                reader.readAsText(e.target.files[0]);
            };
            input.click();
        }
        function exportarDatosExcel() {
            const wb = XLSX.utils.book_new();
            dataKeys.forEach(key => { XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(obtenerDatos(key)), key); });
            XLSX.writeFile(wb, `Gestor_Respaldo_${new Date().toISOString().substring(0,10)}.xlsx`);
            showToast('Datos exportados a Excel', 'success');
        }
        function eliminarTodosDatos() {
            if (confirm("¿ESTÁ SEGURO? Esta acción es irreversible.")) {
                localStorage.clear(); 
                showToast('Datos eliminados.', 'success'); 
                setTimeout(() => location.reload(), 1500);
            }
        }
        function activarPrevencionCierre() { 
            window.onbeforeunload = () => true; 
            document.getElementById('estado-prevencion').textContent = 'Estado: Activo'; 
            showToast('Prevención de cierre activada', 'success'); 
        }
        function desactivarPrevencionCierre() { 
            window.onbeforeunload = null; 
            document.getElementById('estado-prevencion').textContent = 'Estado: Inactivo'; 
            showToast('Prevención de cierre desactivada', 'info'); 
        }

        // =======================================================================
        // === NUEVO: LÓGICA DE BÚSQUEDA IMPLEMENTADA ===
        // =======================================================================
        function setupSearchListeners() {
            // Buscadores de página interna (filtran listas existentes)
            const setupSimpleFilter = (inputId, dataKey, renderer) => {
                document.getElementById(inputId).addEventListener('input', e => {
                    const query = e.target.value.toLowerCase();
                    const data = obtenerDatos(dataKey);
                    const filtered = data.filter(item => item.nombre && item.nombre.toLowerCase().includes(query));
                    renderer(filtered);
                });
            };
            setupSimpleFilter('buscador-inventario', 'inventario', renderizarTablaInventario);
            setupSimpleFilter('buscador-clientes', 'clientes', renderizarTablaClientes);
            setupSimpleFilter('buscador-proveedores', 'proveedores', renderizarListaProveedores);
            setupSimpleFilter('buscador-empleados', 'empleados', renderizarListaEmpleados);

            // Buscadores con menú desplegable (en Ventas y Global)
            const setupDropdownSearch = (inputId, resultsId, dataSources) => {
                const input = document.getElementById(inputId);
                const resultsDiv = document.getElementById(resultsId);

                input.addEventListener('input', e => {
                    const query = e.target.value.toLowerCase();
                    resultsDiv.innerHTML = '';
                    if (query.length < 2) {
                        resultsDiv.style.display = 'none';
                        return;
                    }
                    
                    let hasResults = false;
                    dataSources.forEach(source => {
                        const data = obtenerDatos(source.key);
                        const filtered = data.filter(item => item.nombre && item.nombre.toLowerCase().includes(query)).slice(0, 5);
                        
                        if (filtered.length > 0) {
                            hasResults = true;
                            filtered.forEach(item => {
                                const resultItem = document.createElement('div');
                                resultItem.className = 'search-result-item';
                                resultItem.innerHTML = source.template(item);
                                resultItem.onclick = (event) => {
                                    event.stopPropagation();
                                    source.action(item, input, resultsDiv);
                                };
                                resultsDiv.appendChild(resultItem);
                            });
                        }
                    });

                    resultsDiv.style.display = hasResults ? 'block' : 'none';
                });
            };

            // Configuración para buscador de productos en Ventas
            setupDropdownSearch('buscador-producto-venta', 'resultados-producto-venta', [{
                key: 'inventario',
                template: item => `<span>${item.nombre} ($${item.precioUsd.toFixed(2)})</span><span>Stock: ${item.stock}</span>`,
                action: item => agregarProductoVenta(item.id)
            }]);
            
            // Configuración para buscador de clientes en Ventas
            setupDropdownSearch('buscador-cliente-venta', 'resultados-cliente-venta', [{
                key: 'clientes',
                template: item => `<span>${item.nombre}</span><span>${item.telefono || ''}</span>`,
                action: (item, input, resultsDiv) => {
                    input.value = item.nombre;
                    resultsDiv.style.display = 'none';
                }
            }]);

            // Configuración para el buscador GLOBAL
            setupDropdownSearch('buscador-global', 'resultados-busqueda', [
                { // Productos
                    key: 'inventario',
                    template: item => `<div>📦 ${item.nombre} ($${item.precioUsd.toFixed(2)})</div>
                                      <div class="result-actions">
                                        <button class="result-btn btn-sell" onclick="event.stopPropagation(); abrirPagina('ventas'); agregarProductoVenta('${item.id}');">Vender</button>
                                        <button class="result-btn btn-edit" onclick="event.stopPropagation(); abrirPagina('inventario'); abrirModalProducto('${item.id}');">Editar</button>
                                      </div>`,
                    action: (item, input, resultsDiv) => {
                       abrirPagina('inventario');
                       input.value = '';
                       resultsDiv.style.display = 'none';
                    }
                },
                { // Clientes
                    key: 'clientes',
                    template: item => `<div>👥 ${item.nombre}</div>
                                      <div class="result-actions">
                                        <button class="result-btn btn-edit" onclick="event.stopPropagation(); abrirPagina('clientes'); abrirModalCliente('${item.id}');">Editar</button>
                                      </div>`,
                    action: (item, input, resultsDiv) => {
                        abrirPagina('clientes');
                        input.value = '';
                        resultsDiv.style.display = 'none';
                    }
                },
                { // Proveedores
                    key: 'proveedores',
                    template: item => `<div>🚚 ${item.nombre}</div>
                                      <div class="result-actions">
                                        <button class="result-btn btn-edit" onclick="event.stopPropagation(); abrirPagina('proveedores'); abrirModalProveedor('${item.id}');">Editar</button>
                                      </div>`,
                    action: (item, input, resultsDiv) => {
                        abrirPagina('proveedores');
                        input.value = '';
                        resultsDiv.style.display = 'none';
                    }
                }
            ]);

            // Ocultar resultados de búsqueda si se hace clic fuera
            document.addEventListener('click', () => {
                document.querySelectorAll('.search-results').forEach(div => div.style.display = 'none');
            });
        }

        // =======================================================================
        // === VERIFICACIÓN DE INTEGRIDAD DE DATOS ===
        // =======================================================================
        function verificarIntegridadDatos() {
            dataKeys.forEach(key => {
                try {
                    const datos = obtenerDatos(key);
                    if (!Array.isArray(datos)) {
                        localStorage.setItem(key, JSON.stringify([]));
                        console.warn(`Datos corruptos en ${key}, reinicializados`);
                    }
                } catch (e) {
                    localStorage.setItem(key, JSON.stringify([]));
                    console.error(`Error en ${key}, reinicializados:`, e);
                }
            });
        }

        // === INICIALIZACIÓN ===
        document.addEventListener('DOMContentLoaded', () => {
            cargarConfiguracion();
            obtenerTipoCambioReal(); // MODIFICADO: Esta función ahora maneja su propia cadena de promesas
            
            const ventaGuardada = localStorage.getItem('ventaActual');
            if (ventaGuardada) { 
                try { listaVenta = JSON.parse(ventaGuardada); actualizarResumenVenta(); } catch (e) {} 
            }
            
            const hoy = new Date().toISOString().split('T')[0];
            ['fecha-gasto', 'fecha-contracto', 'fecha-inicio', 'fecha-fin'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.value = hoy;
            });
            const filtroGastos = document.getElementById('filtro-fecha-gastos');
            if(filtroGastos) filtroGastos.value = new Date().toISOString().slice(0, 7);
            
            const pinGuardado = getConnectionPin();
            if (pinGuardado) p2pManager = new SincronizacionP2P(pinGuardado);

            // NUEVO: Activar los listeners de búsqueda
            setupSearchListeners();
            
            // NUEVO: Verificar integridad de datos
            verificarIntegridadDatos();
            
            // NUEVO: Inicializar mensajería
            inicializarMensajeria();
        });

    </script>
</body>
</html>
