<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PUNTO</title>
    <!-- Favicon: Azul círculo con fondo transparente -->
    <!-- Este SVG en Base64 crea un círculo azul (#007bff) sobre un fondo transparente -->
    <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgMTAwIDEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8Y2lyY2xlIGN4PSI1MCIgY3k9IjUwIiByPSI0NSIgZmlsbD0iIzAwN2JmZiIvPgo8L3N2Zz4=" type="image/svg+xml">
    <!-- Google Fonts - Roboto -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        /* General styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #ffffff; /* White background */
            height: 100vh;
            display: flex;
            flex-direction: column;
            touch-action: manipulation;
            font-size: 16px;
            overflow: hidden;
            color: #333; /* Dark text color for contrast */
        }

        /* Gemini style color variables (white) */
        :root {
            --gemini-light-bg: #ffffff; /* Very light background */
            --gemini-medium-bg: #f8f8f8; /* Slightly darker background for sections */
            --gemini-dark-text: #333333; /* Main dark text */
            --gemini-secondary-text: #666666; /* Secondary text */
            --gemini-accent-blue: #007bff; /* Blue for interactive elements like the send button */
            --gemini-accent-light-blue: #e0f7fa; /* Very light blue for sent message bubbles */

            /* Mapping old variables to new Gemini ones */
            --whatsapp-green: var(--gemini-light-bg); /* Header, side menu */
            --whatsapp-light-green: var(--gemini-accent-blue); /* Buttons, accents */
            --whatsapp-sent-bubble: var(--gemini-accent-light-blue); /* Sent bubble */
            --whatsapp-received-bubble: var(--gemini-light-bg); /* Received bubble */
            --whatsapp-chat-bg: var(--gemini-medium-bg); /* Chat background */
            --whatsapp-tick-blue: var(--gemini-accent-blue); /* Message ticks (if used) */
        }

        /* Notification popup styles */
        .notification-popup {
            position: fixed;
            top: 15px; /* Distance from top */
            left: 50%;
            transform: translateX(-50%); /* Horizontal centering */
            padding: 8px 16px;
            border-radius: 9999px; /* Fully rounded corners */
            font-size: 0.875rem; /* Small text */
            font-weight: 600; /* Semi-bold */
            color: white;
            opacity: 0; /* Initially transparent */
            transition: opacity 0.6s ease-out, transform 0.3s ease-out; /* Smooth transition */
            z-index: 2000; /* Ensure it's on top */
            pointer-events: none; /* Allow clicks through it */
            white-space: nowrap; /* Prevent text wrapping */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15); /* Subtle shadow */
        }

        /* Notification colors (maintained for meaning) */
        .notification-success {
            background-color: rgba(34, 197, 94, 0.85); /* Green with transparency */
        }
        .notification-error {
            background-color: rgba(239, 68, 68, 0.85); /* Red with transparency */
        }
        .notification-info {
            background-color: rgba(59, 130, 246, 0.85); /* Blue with transparency */
        }

        /* Classes for animation in and out */
        .notification-popup.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0); /* Maintain centering and position */
        }
        .notification-popup.hide {
            opacity: 0;
            transform: translateX(-50%) translateY(-10px); /* Move slightly up on hide */
        }

        /* Alias Modal */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.7); display: flex;
            justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-content {
            background: white; padding: 30px; border-radius: 15px;
            width: 90%; max-width: 380px; text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            animation: fadeInScale 0.3s ease-out forwards;
        }
        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        .modal-content h3 { color: var(--gemini-dark-text); margin-bottom: 20px; font-size: 22px; }
        .modal-input {
            width: calc(100% - 20px); padding: 14px; margin: 15px 0;
            border: 1px solid #ddd; border-radius: 8px; font-size: 17px;
            text-align: center; outline: none; transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .modal-input:focus {
            border-color: var(--gemini-accent-blue);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
        }
        .modal button {
            background: var(--gemini-accent-blue); color: white; border: none;
            padding: 12px 25px; border-radius: 30px; font-size: 17px;
            cursor: pointer; transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); font-weight: 500;
        }
        .modal button:hover { background: #0056b3; transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3); }

        .profile-pic-upload {
            margin-top: 15px; display: flex; flex-direction: column; align-items: center;
        }
        .profile-pic-upload .avatar-preview {
            width: 80px; height: 80px; border-radius: 50%; background: #eee;
            display: flex; align-items: center; justify-content: center;
            font-size: 40px; color: #ccc; overflow: hidden;
            border: 2px solid var(--gemini-accent-blue); margin-bottom: 10px;
        }
        .profile-pic-upload .avatar-preview img { width: 100%; height: 100%; object-fit: cover; }
        .profile-pic-upload label {
            background: #f0f0f0; color: var(--gemini-accent-blue); border: 1px solid #ccc;
            padding: 8px 15px; border-radius: 20px; cursor: pointer;
            font-size: 14px; transition: background 0.2s ease;
        }
        .profile-pic-upload label:hover { background: #e0e0e0; }

        /* Main Container */
        .main-container {
            display: flex; flex-direction: column; flex: 1;
            padding-top: 60px; /* Fixed header height */
            padding-bottom: 80px; /* Fixed input area height */
            overflow-y: hidden;
            -webkit-overflow-scrolling: touch;
        }

        /* Chat Header */
        .chat-header {
            background: var(--gemini-light-bg); /* White background */
            color: var(--gemini-dark-text); /* Dark text */
            padding: 10px 15px;
            position: fixed; width: 100%; top: 0; z-index: 100;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); /* More subtle shadow */
            display: flex;
            align-items: center; justify-content: flex-start; height: 60px;
        }
        .chat-header .menu-button, .chat-header .back-button {
            background: none; border: none; color: var(--gemini-dark-text); /* Dark icons */
            font-size: 24px; padding: 5px; cursor: pointer; outline: none;
            display: flex; align-items: center;
        }
        .chat-header .back-button {
            margin-right: 15px;
        }
        .chat-header .profile-pic {
            width: 40px; height: 40px; border-radius: 50%;
            background: rgba(0, 0, 0, 0.1); /* Darker background for avatar */
            margin-right: 10px;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; color: #999; /* Lighter icon color */
            overflow: hidden; flex-shrink: 0;
        }
        .chat-header .profile-pic img { width: 100%; height: 100%; object-fit: cover; }
        .chat-header .profile-info { flex-grow: 1; display: flex; flex-direction: column; align-items: flex-start; }
        .chat-header h1 { font-size: 18px; margin: 0; line-height: 1.2; font-weight: 500; }
        .online-status {
            font-size: 12px; color: var(--gemini-secondary-text); opacity: 0;
            height: 14px; transition: opacity 0.3s ease-in-out; margin-top: 2px;
        }
        .online-status.active { opacity: 1; color: #28a745; /* Green for active status */ }
        .chat-header .header-icons { display: flex; gap: 20px; margin-left: auto; align-items: center; }
        .chat-header .header-icons i { font-size: 22px; cursor: pointer; color: var(--gemini-dark-text); } /* Dark icons */

        /* Side Menu */
        .side-menu {
            position: fixed;
            top: 0;
            right: 0; /* Aligned to the right */
            width: 280px; /* Default width */
            height: 100%;
            background: var(--gemini-light-bg); /* White background */
            box-shadow: -2px 0 10px rgba(0,0,0,0.2); /* Shadow to the left */
            z-index: 150; /* Higher than header */
            transform: translateX(100%); /* Hidden by default, slides from right */
            transition: transform 0.3s ease-in-out;
            display: flex;
            flex-direction: column;
        }
        .side-menu.active {
            transform: translateX(0%); /* Show menu */
        }
        /* Media query to make side menu wider on small screens */
        @media (max-width: 480px) {
            .side-menu {
                width: 80%; /* Occupy 80% of screen width on small mobiles */
                max-width: 280px; /* But not more than 280px */
            }
        }

        .side-menu .menu-header {
            background: var(--gemini-medium-bg); /* Slightly grey background for menu header */
            padding: 20px;
            display: flex;
            align-items: center;
            color: var(--gemini-dark-text); /* Dark text */
            min-height: 120px;
        }
        .side-menu .menu-header .avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.1); /* Lighter avatar background */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            margin-right: 15px;
            overflow: hidden;
        }
        .side-menu .menu-header .avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .side-menu .menu-header .user-info h2 {
            font-size: 18px;
            font-weight: 500;
            margin: 0;
        }
        .side-menu .menu-options {
            list-style: none;
            padding: 0;
            margin: 0;
            flex-grow: 1;
            overflow-y: auto;
        }
        .side-menu .menu-options li {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            font-size: 16px;
            color: var(--gemini-dark-text); /* Dark text */
            cursor: pointer;
            transition: background 0.2s ease;
            display: flex;
            align-items: center;
        }
        .side-menu .menu-options li i {
            margin-right: 15px;
            color: var(--gemini-secondary-text); /* Secondary icons */
            font-size: 20px;
        }
        .side-menu .menu-options li:hover {
            background: #f0f0f0;
        }
        .side-menu-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 149;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .side-menu-backdrop.active {
            opacity: 1;
            pointer-events: all;
        }

        /* Connected Peers List */
        .connected-peers-list {
            background: var(--gemini-medium-bg); /* Slightly grey background */
            padding: 0; width: 100%;
            position: fixed; top: 60px; height: calc(100vh - 60px);
            overflow-y: auto; -webkit-overflow-scrolling: touch; z-index: 99;
            transition: transform 0.3s ease-in-out; transform: translateX(0%);
        }
        .connected-peers-list.hidden-left { transform: translateX(-100%); pointer-events: none; }
        .connected-peers-list h4 {
            font-size: 14px; margin: 15px 15px 10px 15px; color: var(--gemini-secondary-text);
            text-transform: uppercase; font-weight: 500;
            border-bottom: 1px solid #EAEAEA; padding-bottom: 10px;
        }
        .connected-peers-list ul { list-style: none; padding: 0; margin: 0; }
        .connected-peers-list li {
            display: flex; align-items: center; padding: 12px 15px;
            border-bottom: 1px solid #EAEAEA; cursor: pointer; font-size: 16px;
            color: var(--gemini-dark-text);
            transition: background 0.2s ease;
        }
        .connected-peers-list li:hover { background: #fdfdfd; }
        .connected-peers-list li.active { background: var(--gemini-accent-light-blue); font-weight: bold; }
        .connected-peers-list li.unread .peer-name { font-weight: bold; color: var(--gemini-accent-blue); }

        .connected-peers-list li .avatar {
            width: 50px; height: 50px; border-radius: 50%;
            background: rgba(0,0,0,0.1); margin-right: 15px; display: flex;
            align-items: center; justify-content: center; font-size: 24px;
            color: #999; flex-shrink: 0; overflow: hidden;
        }
        .connected-peers-list li .avatar img { width: 100%; height: 100%; object-fit: cover; }
        .connected-peers-list .peer-info { flex-grow: 1; display: flex; flex-direction: column; }
        .connected-peers-list .peer-name { font-weight: 500; }
        .connected-peers-list .peer-status-text { font-size: 13px; color: var(--gemini-secondary-text); margin-top: 2px; }
        .connected-peers-list .peer-status-text.online { color: #28a745; /* Green for online */ }
        .connected-peers-list .peer-status-text.tracker { color: #b08d00; font-weight: bold; }

        /* Chat Area */
        #chat {
            flex: 1; padding: 10px; overflow-y: auto; -webkit-overflow-scrolling: touch;
            display: flex; flex-direction: column;
            background-color: var(--gemini-chat-bg); /* Chat background */
            background-image: url('https://upload.wikimedia.org/wikipedia/commons/thumb/1/18/WhatsApp_Background.svg/1024px-WhatsApp_Background.svg.png');
            background-size: auto; background-repeat: repeat;
        }

        /* Message Bubbles */
        .message {
            margin: 6px 0; padding: 8px 12px 6px 12px; border-radius: 8px;
            max-width: 85%; word-wrap: break-word; position: relative;
            font-size: 15px; box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            animation: slideIn 0.2s ease-out forwards;
            display: flex; flex-direction: column; line-height: 1.4;
        }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .message.self { background: var(--whatsapp-sent-bubble); align-self: flex-end; color: var(--gemini-dark-text); } /* Light blue background, dark text */
        .message.remote { background: var(--whatsapp-received-bubble); align-self: flex-start; color: var(--gemini-dark-text); } /* White background, dark text */

        .message.system-message {
            background: #e1f2fb; color: #5a666d; text-align: center;
            max-width: 90%; margin: 10px auto; font-size: 13px; align-self: center;
            padding: 8px; border-radius: 12px; box-shadow: none;
        }
        .message .sender-name { font-weight: 500; color: var(--gemini-accent-blue); font-size: 14px; margin-bottom: 3px; }
        .message.self .sender-name { display: none; }
        .message img { max-width: 100%; border-radius: 8px; margin-top: 5px; cursor: pointer; }
        .message .file-download-link {
            display: flex; align-items: center; gap: 8px; margin-top: 5px; color: var(--gemini-accent-blue);
            text-decoration: none; font-size: 14px; font-weight: 500; background: rgba(0,0,0,0.05);
            padding: 8px 10px; border-radius: 8px; transition: background 0.2s ease;
        }
        .message .file-download-link:hover{ background: rgba(0,0,0,0.1); }
        .message .file-download-link i { font-size: 20px; }

        /* Message Footer (time) */
        .message-footer {
            align-self: flex-end; margin-top: 4px; font-size: 11px; color: rgba(0, 0, 0, 0.45);
        }

        /* Input Area */
        .input-area {
            position: fixed; bottom: 0; width: 100%; background: var(--gemini-medium-bg); /* Slightly grey background */
            padding: 8px 15px; /* Increased horizontal padding */
            box-shadow: 0 -1px 5px rgba(0,0,0,0.08); z-index: 100;
            display: flex;
            gap: 8px;
            align-items: flex-end;
        }
        .message-input-group {
            flex: 1; /* Allows it to occupy available space */
            min-width: 0; /* Allows the container to shrink correctly */
            display: flex;
            align-items: flex-end;
            background: white;
            border-radius: 25px;
            padding: 5px 10px;
        }
        .input-area textarea {
            flex: 1; /* Makes the textarea occupy remaining space within its group */
            min-height: 20px;
            max-height: 100px;
            padding: 8px 5px;
            border: none; resize: none; font-size: 16px; outline: none; background: transparent;
            color: var(--gemini-dark-text);
        }
        .input-area button, .input-area label {
            background: transparent; color: var(--gemini-secondary-text); border: none; border-radius: 50%;
            width: 48px; height: 48px; display: flex; align-items: center; justify-content: center;
            font-size: 22px; cursor: pointer; flex-shrink: 0; /* Ensures these buttons do not shrink */
        }
        #sendButton, #recordVoice {
            background: var(--gemini-accent-blue); /* Send button in blue */
            color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            width: 48px;
            height: 48px;
            flex-shrink: 0; /* Ensures the send/record button does not shrink */
        }
        #recordVoice.recording { background: #DC3545; animation: pulse 1s infinite alternate; }
        @keyframes pulse { from { transform: scale(1); } to { transform: scale(1.05); } }

        /* Attachment Menu */
        .attachment-menu {
            position: absolute; bottom: 70px; left: 10px; background: var(--gemini-light-bg);
            border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); padding: 10px;
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; z-index: 90;
            opacity: 0; pointer-events: none; transition: all 0.2s ease-out; transform: translateY(10px);
        }
        .attachment-menu.active { opacity: 1; pointer-events: all; transform: translateY(0); }
        .attachment-menu button {
            background: none; color: var(--gemini-dark-text); border-radius: 10px; width: 70px; height: 70px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-size: 12px; cursor: pointer; border: none;
        }
        .attachment-menu button .icon-wrapper {
            width: 48px; height: 48px; border-radius: 50%; display: flex;
            align-items: center; justify-content: center; margin-bottom: 5px;
            color: white; font-size: 20px;
        }
        .attachment-menu #attachImageButton .icon-wrapper { background: #ef5350; } /* Image icon */
        .attachment-menu #attachFileButton .icon-wrapper { background: #42a5f5; } /* Document icon */

        .backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.2); z-index: 89;
            opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
        }
        .backdrop.active { opacity: 1; pointer-events: all; }
    </style>
</head>
<body>
    <!-- Notification Container -->
    <div id="notification-container"></div>

    <!-- Alias Modal -->
    <div class="modal" id="aliasModal">
        <div class="modal-content">
            <h3>Bienvenido a PUNTO</h3>
            <p>Elige tu alias y una foto de perfil (opcional)</p>
            <div class="profile-pic-upload">
                <div class="avatar-preview" id="modalAvatarPreview"><i class="fa fa-user"></i></div>
                <label for="profilePicInput"><i class="fa fa-camera"></i> Elegir foto</label>
                <input type="file" id="profilePicInput" accept="image/jpeg, image/png" style="display: none;">
            </div>
            <input type="text" id="aliasInput" class="modal-input" placeholder="Ej: Juanito123" maxlength="15">
            <button onclick="setAlias()">Entrar al Chat</button>
        </div>
    </div>

    <!-- Header -->
    <div id="chatHeader" class="chat-header">
        <button class="back-button" id="backToPeersList" style="display: none;"><i class="fa fa-arrow-left"></i></button>
        <div class="profile-pic" id="activePeerProfilePic"><i class="fa fa-user"></i></div>
        <div class="profile-info">
            <h1 id="activePeerName">Usuarios en Línea</h1>
            <div id="statusIndicator" class="online-status"></div>
        </div>
        <div class="header-icons">
            <i class="fa fa-search"></i>
            <button class="menu-button" id="menuButton"><i class="fa fa-bars"></i></button>
        </div>
    </div>

    <!-- Side Menu -->
    <div id="sideMenu" class="side-menu">
        <div class="menu-header">
            <div class="avatar" id="myProfileAvatar">
                <i class="fa fa-user"></i>
            </div>
            <div class="user-info">
                <h2 id="myAliasDisplay">Mi Alias</h2>
            </div>
        </div>
        <ul class="menu-options">
            <li id="newGroupOption"><i class="fa fa-users"></i> Nuevo grupo</li>
            <li id="newBroadcastOption"><i class="fa fa-bullhorn"></i> Nueva difusión</li>
            <li id="linkedDevicesOption"><i class="fa fa-laptop"></i> Dispositivos vinculados</li>
            <li id="starredMessagesOption"><i class="fa fa-star"></i> Mensajes destacados</li>
            <li id="settingsOption"><i class="fa fa-cog"></i> Ajustes</li>
        </ul>
    </div>
    <div id="sideMenuBackdrop" class="side-menu-backdrop"></div>

    <!-- Main Container -->
    <div class="main-container">
        <div id="connectedPeersList" class="connected-peers-list">
            <h4>Usuarios en Línea</h4>
            <ul id="peerList"></ul>
        </div>
        <div id="chat"></div>
    </div>

    <!-- Input Area -->
    <div class="input-area">
        <div class="message-input-group">
            <button id="emojiButton"><i class="far fa-laugh"></i></button>
            <textarea id="message" placeholder="Mensaje"></textarea>
            <button id="attachButton"><i class="fa fa-paperclip"></i></button>
        </div>
        <button id="sendButton"><i class="fa fa-paper-plane"></i></button>
        <button id="recordVoice" style="display: none;"><i class="fa fa-microphone"></i></button>
    </div>

    <!-- Attachment Menu -->
    <div id="attachmentMenu" class="attachment-menu">
        <button id="attachImageButton">
            <span class="icon-wrapper" style="background: #ef5350;"><i class="fa fa-image"></i></span>
            <span>Imagen</span>
        </button>
        <input type="file" id="imageInput" accept="image/jpeg, image/png" style="display:none;">
        <button id="attachFileButton">
            <span class="icon-wrapper" style="background: #42a5f5;"><i class="fa fa-file-alt"></i></span>
            <span>Documento</span>
        </button>
        <input type="file" id="fileInput" style="display:none;">
    </div>
    <div id="backdrop" class="backdrop"></div>

    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script>
        // --- GLOBAL VARIABLES ---
        const TRACKER_ID = 'mi-app-chat-super-secreta-xyz-p2p-v2';
        let peer;
        let trackerPeer;
        let myAlias = localStorage.getItem('chatAlias') || '';
        let myProfilePic = localStorage.getItem('userProfilePic') || '';
        let isTracker = false;
        let trackerConnection;
        let onlineUsers = {};
        let peerConnections = {};
        let activeChatPeerId = null;
        let mediaRecorder;
        let audioChunks = [];

        let notificationQueue = [];
        let isDisplayingNotification = false;

        // DOM References
        const aliasModal = document.getElementById('aliasModal');
        const aliasInput = document.getElementById('aliasInput');
        const modalAvatarPreview = document.getElementById('modalAvatarPreview');
        const profilePicInput = document.getElementById('profilePicInput');
        const peerListContainer = document.getElementById('connectedPeersList');
        const peerListUl = document.getElementById('peerList');
        const chatDiv = document.getElementById('chat');
        const messageInput = document.getElementById('message');
        const sendButton = document.getElementById('sendButton');
        const recordVoiceButton = document.getElementById('recordVoice');
        const backToPeersListButton = document.getElementById('backToPeersList');
        const activePeerNameDisplay = document.getElementById('activePeerName');
        const activePeerProfilePic = document.getElementById('activePeerProfilePic');
        const statusIndicator = document.getElementById('statusIndicator');
        const attachButton = document.getElementById('attachButton');
        const attachmentMenu = document.getElementById('attachmentMenu');
        const backdrop = document.getElementById('backdrop');
        const attachImageButton = document.getElementById('attachImageButton');
        const imageInput = document.getElementById('imageInput');
        const attachFileButton = document.getElementById('attachFileButton');
        const fileInput = document.getElementById('fileInput');

        const notificationContainer = document.getElementById('notification-container');
        const menuButton = document.getElementById('menuButton');
        const sideMenu = document.getElementById('sideMenu');
        const sideMenuBackdrop = document.getElementById('sideMenuBackdrop');
        const myProfileAvatar = document.getElementById('myProfileAvatar');
        const myAliasDisplay = document.getElementById('myAliasDisplay');

        // --- INITIALIZATION AND ALIAS MODAL ---
        if (!myAlias) {
            aliasModal.style.display = 'flex';
        } else {
            initApp();
        }

        profilePicInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                myProfilePic = event.target.result;
                modalAvatarPreview.innerHTML = `<img src="${myProfilePic}" alt="Profile Pic">`;
            };
            reader.readAsDataURL(file);
        });

        function setAlias() {
            const alias = aliasInput.value.trim().replace(/\s+/g, '_');
            if (alias.length >= 3 && alias.length <= 15) {
                myAlias = alias;
                localStorage.setItem('chatAlias', alias);
                localStorage.setItem('userProfilePic', myProfilePic);
                aliasModal.style.display = 'none';
                initApp();
            } else {
                showNotification('El alias debe tener entre 3 y 15 caracteres.', 'error');
            }
        }

        // --- MAIN LOGIC ---
        function initApp() {
            initMyPeer();
            setupUIEventListeners();
            updateLayout();
            myAliasDisplay.textContent = myAlias; // Set alias in side menu
            if (myProfilePic) {
                myProfileAvatar.innerHTML = `<img src="${myProfilePic}" alt="My Profile Pic">`;
            }

            // History management for device/browser back button
            // Adds an initial state so the first "back" doesn't close the application.
            history.pushState({ screen: 'peerList' }, '', location.href);
            window.addEventListener('popstate', handlePopState);
        }

        function handlePopState(event) {
            console.log("Popstate event triggered:", event.state);

            if (activeChatPeerId) {
                // If we are in a chat and back is pressed, return to the online users list.
                activeChatPeerId = null;
                updateLayout();
                renderOnlineUsers();
                // We add a state again to "trap" the back button in the app.
                history.pushState({ screen: 'peerList' }, '', location.href);
            } else {
                // If we are in the peer list and back is pressed, we prevent exiting the app.
                // We simply add the current state again so the back button does nothing.
                history.pushState({ screen: 'peerList' }, '', location.href);
                // Optional: You could show a confirmation message to exit here.
                // alert('Press back again to exit.');
            }
        }

        function initMyPeer() {
            if (peer && !peer.destroyed) peer.destroy();
            peer = new Peer(myAlias, { debug: 2, config: { 'iceServers': [{ 'urls': 'stun:stun.l.google.com:19302' }] } });

            peer.on('open', (id) => {
                console.log(`My personal Peer is ready with alias: ${id}`);
                addMessageToChat({ type: 'system', text: `¡Bienvenido, ${myAlias}! Buscando a otros usuarios...` });
                showNotification(`Connected as ${myAlias}`, 'success');
                // Attempt to connect to the tracker AFTER my peer is open.
                connectToTracker();
            });

            peer.on('connection', (conn) => {
                console.log(`Received a direct chat connection from ${conn.peer}`);
                setupChatConnection(conn);
            });

            // Error handler for the main 'peer' object.
            peer.on('error', (err) => {
                console.error("Error in PeerJS:", err);
                if (err.type === 'unavailable-id') {
                    showNotification(`Alias '${myAlias}' already in use. Please, reload and choose another.`, 'error');
                    localStorage.clear();
                    aliasModal.style.display = 'flex';
                } else if (err.type === 'peer-unavailable' && err.message.includes(TRACKER_ID)) {
                     // This is the CRITICAL moment. If the Tracker is not available, I become it.
                    console.log('The Tracker is not available. I will become the Tracker.');
                    becomeTracker();
                } else {
                     showNotification(`Connection error: ${err.type}`, 'error');
                }
            });
        }

        function connectToTracker() {
            console.log('Attempting to connect to Tracker with ID:', TRACKER_ID);
            trackerConnection = peer.connect(TRACKER_ID, { metadata: { alias: myAlias, profilePic: myProfilePic }, serialization: 'json' });

            trackerConnection.on('open', () => {
                console.log('Connected to Tracker successfully.');
                isTracker = false;
                showNotification('Connected to the network server.', 'success');
            });
            trackerConnection.on('data', handleTrackerData);
            trackerConnection.on('close', () => {
                showNotification('Host disconnected. Looking for a new one...', 'error');
                onlineUsers = {}; renderOnlineUsers();
                // Introduce a random delay before reconnecting to prevent thundering herd
                setTimeout(connectToTracker, 2000 + Math.random() * 2000);
            });
            trackerConnection.on('error', (err) => {
                 console.error("Tracker connection error:", err);
                 showNotification(`Host connection error: ${err.type}`, 'error');
            });
        }

        function becomeTracker() {
            if (isTracker) return; // Already a tracker
            isTracker = true;

            trackerPeer = new Peer(TRACKER_ID, { debug: 2 });
            trackerPeer.on('open', () => {
                console.log('I AM THE TRACKER! Listening on:', TRACKER_ID);
                showNotification('You have become the network host.', 'success');
                onlineUsers = { [myAlias]: { profilePic: myProfilePic, isTracker: true } };
                renderOnlineUsers();
            });

            trackerPeer.on('connection', (conn) => {
                const newUserAlias = conn.metadata.alias;
                console.log(`Tracker: New user connected: ${newUserAlias}`);

                conn.on('open', () => {
                    // 1. Send user list to the new user
                    conn.send({ type: 'user-list', users: onlineUsers });
                    // 2. Add new user
                    onlineUsers[newUserAlias] = { profilePic: conn.metadata.profilePic };
                    // 3. Notify everyone
                    broadcastToAll({ type: 'user-joined', user: { alias: newUserAlias, data: onlineUsers[newUserAlias] } });
                    renderOnlineUsers();
                });

                conn.on('close', () => {
                    console.log(`Tracker: User disconnected: ${newUserAlias}`);
                    delete onlineUsers[newUserAlias];
                    broadcastToAll({ type: 'user-left', alias: newUserAlias });
                    renderOnlineUsers();
                });
                conn.on('error', (err) => {
                     console.error(`Tracker connection with ${newUserAlias} error:`, err);
                });
            });
            trackerPeer.on('error', (err) => {
                 console.error("Tracker Peer error:", err);
                 showNotification(`Host error: ${err.type}`, 'error');
            });
        }

        function broadcastToAll(data) {
             // Flatten the connections object and iterate through each DataConnection
             Object.values(trackerPeer.connections).flat().forEach(conn => {
                if (conn.open) conn.send(data);
            });
        }

        function handleTrackerData(data) {
            switch(data.type) {
                case 'user-list':
                    onlineUsers = data.users;
                    break;
                case 'user-joined':
                    onlineUsers[data.user.alias] = data.user.data;
                    showNotification(`${data.user.alias} has joined.`, 'info');
                    break;
                case 'user-left':
                    delete onlineUsers[data.userAlias];
                    showNotification(`${data.userAlias} has left.`, 'info');
                    break;
            }
            renderOnlineUsers();
        }

        // --- UI RENDERING AND CHAT HANDLING ---
        function renderOnlineUsers() {
            peerListUl.innerHTML = '';
            if (Object.keys(onlineUsers).length === 0) {
                 peerListUl.innerHTML = '<li style="text-align: center; color: #777; padding: 20px;">Searching for users...</li>';
                 statusIndicator.textContent = '0 users connected';
                 statusIndicator.classList.remove('active');
                 return;
            }
            Object.entries(onlineUsers).forEach(([alias, data]) => {
                const li = document.createElement('li');
                li.dataset.peerId = alias;
                if(data.hasUnread) li.classList.add('unread');

                const avatarImg = data.profilePic ? `<img src="${data.profilePic}" alt="${alias}">` : `<i class="fa fa-user"></i>`;
                let statusText = 'Online';
                let statusClass = 'online';
                if(data.isTracker){
                    statusText = `Host ${alias === myAlias ? '(You)' : ''}`;
                    statusClass = 'tracker';
                }

                li.innerHTML = `
                    <div class="avatar">${avatarImg}</div>
                    <div class="peer-info">
                        <span class="peer-name">${alias === myAlias ? alias + ' (You)' : alias}</span>
                        <span class="peer-status-text ${statusClass}">${statusText}</span>
                    </div>
                `;

                if (alias !== myAlias) li.onclick = () => startChatWith(alias);
                else li.style.backgroundColor = '#f1f1f1'; // Highlight self
                if (alias === activeChatPeerId) li.classList.add('active');
                peerListUl.appendChild(li);
            });
            updateLayout(); // Call updateLayout here to refresh the connection status based on onlineUsers count
            statusIndicator.textContent = `${Object.keys(onlineUsers).length} user(s) connected`;
            statusIndicator.classList.add('active');
        }

        function startChatWith(peerAlias) {
            activeChatPeerId = peerAlias;
            if (onlineUsers[peerAlias]) onlineUsers[peerAlias].hasUnread = false;

            if (!peerConnections[peerAlias] || !peerConnections[peerAlias].open) {
                console.log(`Starting chat connection with ${peerAlias}...`);
                const conn = peer.connect(peerAlias, { serialization: 'json' });
                setupChatConnection(conn);
            }
            chatDiv.innerHTML = ''; // Clear previous chat messages
            addMessageToChat({ type: 'system-message', text: `You have started a chat with ${peerAlias}.` });
            updateLayout(); // Update UI to show chat view
            renderOnlineUsers(); // Re-render peer list to update unread status

            // Add a history state when entering the chat
            history.pushState({ screen: 'chat', peerId: peerAlias }, '', `#chat-${peerAlias}`);
        }

        function setupChatConnection(conn) {
            peerConnections[conn.peer] = conn;
            conn.on('data', (data) => {
                if (activeChatPeerId === data.sender) {
                    addMessageToChat(data, 'remote');
                } else {
                    if(onlineUsers[data.sender]) onlineUsers[data.sender].hasUnread = true;
                    showNotification(`New message from ${data.sender}`, 'info');
                    renderOnlineUsers(); // Update peer list to show unread indicator
                }
            });
            conn.on('close', () => {
                showNotification(`${conn.peer} has disconnected from chat.`, 'error');
                delete peerConnections[conn.peer];
                if (activeChatPeerId === conn.peer) activeChatPeerId = null;
                updateLayout();
                // No need to pushState here, popstate will handle it if triggered by back button
            });
            conn.on('error', (err) => {
                 console.error(`Chat connection with ${conn.peer} error:`, err);
                 showNotification(`Chat error with ${conn.peer}: ${err.type}`, 'error');
            });
        }

        function sendMessage() {
            const text = messageInput.value.trim();
            if (!text || !activeChatPeerId) return; // No message or no active chat
            const messageData = { type: 'text', sender: myAlias, text };
            sendDataToPeer(messageData);
            addMessageToChat(messageData, 'self');
            messageInput.value = ''; // Clear the input
            checkSendRecordButtonVisibility(); // Update button visibility
        }

        function sendDataToPeer(data) {
             const conn = peerConnections[activeChatPeerId];
             if (conn && conn.open) {
                 conn.send(data);
             } else {
                 showNotification(`Could not send. Connection with ${activeChatPeerId} not active.`, 'error');
             }
        }

        function addMessageToChat(data, direction = 'system-message') {
            const div = document.createElement('div');
            div.className = `message ${direction}`;

            if(direction !== 'system-message'){
                if (direction === 'remote') {
                    const senderSpan = document.createElement('span');
                    senderSpan.className = 'sender-name';
                    senderSpan.textContent = data.sender;
                    div.appendChild(senderSpan);
                }
                if(data.type === 'text'){
                    const textSpan = document.createElement('span');
                    textSpan.textContent = data.text;
                    div.appendChild(textSpan);
                } else if(data.type === 'image'){
                     const img = document.createElement('img');
                     img.src = data.file;
                     div.appendChild(img);
                } else if(data.type === 'file'){
                     const link = document.createElement('a');
                     link.href = data.file;
                     link.download = data.name;
                     link.className = 'file-download-link';
                     link.innerHTML = `<i class="fa fa-file-alt"></i><span>${data.name}</span>`;
                     div.appendChild(link);
                }
                const footer = document.createElement('div');
                footer.className = 'message-footer';
                footer.textContent = new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
                div.appendChild(footer);
            } else {
                 div.textContent = data.text;
            }
            chatDiv.appendChild(div);
            chatDiv.scrollTop = chatDiv.scrollHeight;
        }

        /**
         * Displays a transient notification popup at the top center of the screen.
         * The notification fades out after a set time and can have different types (success, error, info).
         * @param {string} message - The message to display.
         * @param {'success' | 'error' | 'info'} type - The type of notification for styling.
         */
        function showNotification(message, type) {
            notificationQueue.push({ message, type });
            if (!isDisplayingNotification) {
                processNotificationQueue();
            }
        }

        /**
         * Processes the notification queue, displaying one notification at a time.
         */
        function processNotificationQueue() {
            if (notificationQueue.length === 0) {
                isDisplayingNotification = false;
                return;
            }

            isDisplayingNotification = true;
            const { message, type } = notificationQueue.shift();

            const notification = document.createElement('div');
            notification.textContent = message;
            notification.classList.add('notification-popup');

            if (type === 'success') {
                notification.classList.add('notification-success');
            } else if (type === 'error') {
                notification.classList.add('notification-error');
            } else if (type === 'info') {
                notification.classList.add('notification-info');
            }

            notificationContainer.appendChild(notification);

            // Force reflow for transition
            void notification.offsetWidth;
            notification.classList.add('show');

            setTimeout(() => {
                notification.classList.remove('show');
                notification.classList.add('hide');

                notification.addEventListener('transitionend', function handler() {
                    if (notification.classList.contains('hide')) {
                        notification.remove();
                        notification.removeEventListener('transitionend', handler);
                        setTimeout(processNotificationQueue, 200); // Small delay before next notification
                    }
                });
            }, 3000); // Display for 3 seconds
        }

        // --- UI LOGIC (EVENTS AND LAYOUT) ---
        function setupUIEventListeners() {
            sendButton.onclick = sendMessage;
            messageInput.onkeypress = (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }};

            // Toggle side menu
            menuButton.onclick = () => {
                sideMenu.classList.toggle('active');
                sideMenuBackdrop.classList.toggle('active');
            };
            sideMenuBackdrop.onclick = () => {
                sideMenu.classList.remove('active');
                sideMenuBackdrop.classList.remove('active');
            };

            backToPeersListButton.onclick = () => {
                // When clicking the "Back" UI button, we use history.back()
                // so the popstate event is triggered and handled correctly.
                history.back();
            };

            attachButton.onclick = (e) => { e.stopPropagation(); attachmentMenu.classList.toggle('active'); backdrop.classList.toggle('active'); };
            backdrop.onclick = () => { attachmentMenu.classList.remove('active'); backdrop.classList.remove('active'); };

            attachImageButton.onclick = () => imageInput.click();
            attachFileButton.onclick = () => fileInput.click();

            imageInput.onchange = (e) => handleFile(e.target.files[0], 'image');
            fileInput.onchange = (e) => handleFile(e.target.files[0], 'file');

            messageInput.oninput = () => checkSendRecordButtonVisibility();
            checkSendRecordButtonVisibility(); // Initial check
        }

        function handleFile(file, type){
             if(!file || !activeChatPeerId) return;
             const reader = new FileReader();
             reader.onload = (e) => {
                 const messageData = { type, sender: myAlias, file: e.target.result, name: file.name };
                 sendDataToPeer(messageData);
                 addMessageToChat(messageData, 'self');
             };
             reader.readAsDataURL(file);
             attachmentMenu.classList.remove('active');
             backdrop.classList.remove('active');
        }

        function checkSendRecordButtonVisibility() {
            const hasText = messageInput.value.trim().length > 0;
            sendButton.style.display = hasText ? 'flex' : 'none';
            recordVoiceButton.style.display = hasText ? 'none' : 'flex';
        }

        function updateLayout() {
            const isChatView = !!activeChatPeerId;
            peerListContainer.classList.toggle('hidden-left', isChatView);
            document.querySelector('.input-area').style.display = isChatView ? 'flex' : 'none';

            // Show/hide menu button vs back button
            menuButton.style.display = isChatView ? 'none' : 'block';
            backToPeersListButton.style.display = isChatView ? 'block' : 'none';

            if (isChatView) {
                const peerData = onlineUsers[activeChatPeerId] || {};
                activePeerNameDisplay.textContent = activeChatPeerId;
                activePeerProfilePic.innerHTML = peerData.profilePic ? `<img src="${peerData.profilePic}" alt="${activeChatPeerId}">` : `<i class="fa fa-user"></i>`;
                statusIndicator.textContent = 'Online';
                statusIndicator.classList.add('active');
            } else {
                activePeerNameDisplay.textContent = 'Online Users';
                activePeerProfilePic.innerHTML = `<i class="fa fa-users"></i>`;
                // Status for peer list view is handled by renderOnlineUsers
                // statusIndicator.textContent = `${Object.keys(onlineUsers).length} user(s) connected`;
                // statusIndicator.classList.add('active');
            }
        }

        window.addEventListener('load', updateLayout);
        window.addEventListener('resize', updateLayout);
    </script>
</body>
</html>
