<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WhatsApp Chat P2P v5 - Mejorado</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Se actualiza a Font Awesome 6 para mejores iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Estilos generales (Sin cambios) */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #ffffff;
            height: 100vh;
            display: flex;
            flex-direction: column;
            touch-action: manipulation;
            font-size: 16px;
            overflow: hidden;
            color: #333;
        }

        /* Variables de color de estilo Gemini (Sin cambios) */
        :root {
            --gemini-light-bg: #ffffff;
            --gemini-medium-bg: #f8f8f8;
            --gemini-dark-text: #333333;
            --gemini-secondary-text: #666666;
            --gemini-accent-blue: #007bff;
            --gemini-accent-light-blue: #e0f7fa;
            --gemini-accent-green: #25D366;
            --gemini-accent-red: #FF3B30;
            --gemini-accent-yellow: #FFCC00;

            --whatsapp-green: var(--gemini-light-bg);
            --whatsapp-light-green: var(--gemini-accent-blue);
            --whatsapp-sent-bubble: var(--gemini-accent-light-blue);
            --whatsapp-received-bubble: var(--gemini-light-bg);
            --whatsapp-chat-bg: var(--gemini-medium-bg);
            --whatsapp-tick-blue: var(--gemini-accent-blue);
        }

        /* Estilos de notificaciones emergentes (Toast) (Sin cambios) */
        .notification-popup {
            position: fixed; top: 15px; left: 50%; transform: translateX(-50%);
            padding: 8px 16px; border-radius: 9999px; font-size: 0.875rem;
            font-weight: 600; color: white; opacity: 0;
            transition: opacity 0.6s ease-out, transform 0.3s ease-out;
            z-index: 2000; pointer-events: none; white-space: nowrap;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }
        .notification-success { background-color: rgba(34, 197, 94, 0.85); }
        .notification-error { background-color: rgba(239, 68, 68, 0.85); }
        .notification-info { background-color: rgba(59, 130, 246, 0.85); }
        .notification-warning { background-color: rgba(255, 204, 0, 0.85); }
        .notification-popup.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        .notification-popup.hide { opacity: 0; transform: translateX(-50%) translateY(-10px); }

        /* Modal de Alias y otros modales (Sin cambios) */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.7); display: flex;
            justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-content {
            background: white; padding: 30px; border-radius: 15px;
            width: 90%; max-width: 380px; text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            animation: fadeInScale 0.3s ease-out forwards;
        }
        @keyframes fadeInScale { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        .modal-content h3 { color: var(--gemini-dark-text); margin-bottom: 20px; font-size: 22px; }
        .modal-input {
            width: calc(100% - 20px); padding: 14px; margin: 15px 0;
            border: 1px solid #ddd; border-radius: 8px; font-size: 17px;
            text-align: center; outline: none; transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .modal-input:focus { border-color: var(--gemini-accent-blue); box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25); }
        .modal button {
            background: var(--gemini-accent-blue); color: white; border: none;
            padding: 12px 25px; border-radius: 30px; font-size: 17px;
            cursor: pointer; transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); font-weight: 500;
            margin: 5px;
        }
        .modal button.secondary { background: var(--gemini-secondary-text); }
        .modal button.danger { background: var(--gemini-accent-red); }
        .modal button:hover { opacity: 0.9; transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3); }
        .profile-pic-upload { margin-top: 15px; display: flex; flex-direction: column; align-items: center; }
        .profile-pic-upload .avatar-preview {
            width: 80px; height: 80px; border-radius: 50%; background: #eee;
            display: flex; align-items: center; justify-content: center;
            font-size: 40px; color: #ccc; overflow: hidden;
            border: 2px solid var(--gemini-accent-blue); margin-bottom: 10px;
        }
        .profile-pic-upload .avatar-preview img { width: 100%; height: 100%; object-fit: cover; }
        .profile-pic-upload label {
            background: #f0f0f0; color: var(--gemini-accent-blue); border: 1px solid #ccc;
            padding: 8px 15px; border-radius: 20px; cursor: pointer;
            font-size: 14px; transition: background 0.2s ease;
        }
        .profile-pic-upload label:hover { background: #e0e0e0; }

        /* Contenedor Principal (Sin cambios) */
        .main-container {
            display: flex; flex-direction: column; flex: 1;
            padding-top: 60px; padding-bottom: 65px;
            overflow-y: hidden; -webkit-overflow-scrolling: touch;
        }

        /* Encabezado del Chat (Sin cambios) */
        .chat-header {
            background: var(--gemini-light-bg); color: var(--gemini-dark-text);
            padding: 10px 15px; position: fixed; width: 100%; top: 0; z-index: 100;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            display: flex; align-items: center; justify-content: flex-start; height: 60px;
        }
        .chat-header .menu-button, .chat-header .back-button {
            background: none; border: none; color: var(--gemini-dark-text);
            font-size: 24px; padding: 5px; cursor: pointer; outline: none;
            display: flex; align-items: center;
        }
        .chat-header .back-button { margin-right: 15px; }
        .chat-header .profile-pic {
            width: 40px; height: 40px; border-radius: 50%;
            background: rgba(0, 0, 0, 0.1); margin-right: 10px;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; color: #999; overflow: hidden; flex-shrink: 0;
        }
        .chat-header .profile-pic img { width: 100%; height: 100%; object-fit: cover; }
        .chat-header .profile-info { flex-grow: 1; display: flex; flex-direction: column; align-items: flex-start; }
        .chat-header h1 { font-size: 18px; margin: 0; line-height: 1.2; font-weight: 500; }
        .online-status {
            font-size: 13px; color: var(--gemini-secondary-text); 
            height: 16px; transition: opacity 0.3s ease-in-out; margin-top: 2px;
        }
        .online-status.active { color: #28a745; }
        /* NUEVO: Estilo para "escribiendo..." */
        .online-status.typing { color: var(--gemini-accent-green); font-style: italic; }
        .chat-header .header-icons { display: flex; gap: 20px; margin-left: auto; align-items: center; }
        .chat-header .header-icons i { font-size: 22px; cursor: pointer; color: var(--gemini-dark-text); }
        
        /* Men√∫ Lateral (Modificado para estado) */
        .side-menu {
            position: fixed; top: 0; right: 0; width: 280px; height: 100%;
            background: var(--gemini-light-bg); box-shadow: -2px 0 10px rgba(0,0,0,0.2);
            z-index: 150; transform: translateX(100%); transition: transform 0.3s ease-in-out;
            display: flex; flex-direction: column;
        }
        .side-menu.active { transform: translateX(0%); }
        @media (max-width: 480px) { .side-menu { width: 80%; max-width: 280px; } }
        .side-menu .menu-header {
            background: var(--gemini-medium-bg); padding: 20px; display: flex;
            align-items: center; color: var(--gemini-dark-text); min-height: 120px;
        }
        .side-menu .menu-header .avatar {
            width: 60px; height: 60px; border-radius: 50%;
            background: rgba(0, 0, 0, 0.1); display: flex;
            align-items: center; justify-content: center;
            font-size: 30px; margin-right: 15px; overflow: hidden;
        }
        .side-menu .menu-header .avatar img { width: 100%; height: 100%; object-fit: cover; }
        .side-menu .menu-header .user-info h2 { font-size: 18px; font-weight: 500; margin: 0; }
        /* MODIFICADO: El estado ahora es un 'p' clickeable */
        .side-menu .menu-header .user-info p { 
            font-size: 14px; color: var(--gemini-secondary-text); margin-top: 5px; cursor: pointer;
            border-bottom: 1px dashed var(--gemini-secondary-text);
        }
        .side-menu .menu-options { list-style: none; padding: 0; margin: 0; flex-grow: 1; overflow-y: auto; }
        .side-menu .menu-options li {
            padding: 15px 20px; border-bottom: 1px solid #eee; font-size: 16px;
            color: var(--gemini-dark-text); cursor: pointer; transition: background 0.2s ease;
            display: flex; align-items: center;
        }
        .side-menu .menu-options li i { margin-right: 15px; color: var(--gemini-secondary-text); font-size: 20px; }
        .side-menu .menu-options li:hover { background: #f0f0f0; }
        .side-menu-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 149; opacity: 0;
            pointer-events: none; transition: opacity 0.3s ease;
        }
        .side-menu-backdrop.active { opacity: 1; pointer-events: all; }

        /* Lista de Pares Conectados (Modificado para unread y status) */
        .connected-peers-list {
            background: var(--gemini-medium-bg); padding: 0; width: 100%;
            position: fixed; top: 60px; height: calc(100vh - 60px);
            overflow-y: auto; -webkit-overflow-scrolling: touch; z-index: 99;
            transition: transform 0.3s ease-in-out; transform: translateX(0%);
        }
        .connected-peers-list.hidden-left { transform: translateX(-100%); pointer-events: none; }
        .connected-peers-list h4 {
            font-size: 14px; margin: 15px 15px 10px 15px; color: var(--gemini-secondary-text);
            text-transform: uppercase; font-weight: 500;
            border-bottom: 1px solid #EAEAEA; padding-bottom: 10px;
        }
        .connected-peers-list ul { list-style: none; padding: 0; margin: 0; }
        .connected-peers-list li {
            display: flex; align-items: center; padding: 12px 15px;
            border-bottom: 1px solid #EAEAEA; cursor: pointer; font-size: 16px;
            color: var(--gemini-dark-text); transition: background 0.2s ease;
        }
        .connected-peers-list li:hover { background: #fdfdfd; }
        .connected-peers-list li.active { background: var(--gemini-accent-light-blue); }
        .connected-peers-list li .avatar {
            width: 50px; height: 50px; border-radius: 50%;
            background: rgba(0,0,0,0.1); margin-right: 15px; display: flex;
            align-items: center; justify-content: center; font-size: 24px;
            color: #999; flex-shrink: 0; overflow: hidden;
        }
        .connected-peers-list li .avatar img { width: 100%; height: 100%; object-fit: cover; }
        .connected-peers-list .peer-info { flex-grow: 1; display: flex; flex-direction: column; min-width: 0; }
        .peer-info-top { display: flex; justify-content: space-between; align-items: center; }
        .connected-peers-list .peer-name { font-weight: 500; }
        .connected-peers-list .last-message-time { font-size: 12px; color: #888; flex-shrink: 0; }
        .peer-info-bottom { display: flex; justify-content: space-between; align-items: center; margin-top: 4px; }
        .connected-peers-list .peer-status-text {
            font-size: 14px; color: var(--gemini-secondary-text);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        /* NUEVO: Badge para mensajes no le√≠dos */
        .unread-badge {
            background-color: var(--gemini-accent-green); color: white;
            border-radius: 50%; width: 22px; height: 22px;
            font-size: 12px; font-weight: bold;
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0; margin-left: 10px;
        }
        .connected-peers-list .peer-status-text.online { color: #28a745; }
        .connected-peers-list .peer-status-text.typing { color: var(--gemini-accent-green); font-style: italic; }
        .connected-peers-list .peer-status-text.tracker { color: #b08d00; font-weight: bold; }
        
        /* √Årea del Chat (Sin cambios) */
        #chat {
            flex: 1; padding: 10px; overflow-y: auto; -webkit-overflow-scrolling: touch;
            display: flex; flex-direction: column;
            background-color: var(--gemini-chat-bg);
            background-image: url('https://upload.wikimedia.org/wikipedia/commons/thumb/1/18/WhatsApp_Background.svg/1024px-WhatsApp_Background.svg.png');
            background-size: auto; background-repeat: repeat;
        }

        /* Burbujas de Mensajes (Modificado para tics y hora) */
        .message {
            margin: 6px 0; padding: 8px 12px 6px 12px; border-radius: 8px;
            max-width: 85%; word-wrap: break-word; position: relative;
            font-size: 15px; box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            animation: slideIn 0.2s ease-out forwards;
            display: flex; flex-direction: column; line-height: 1.4;
        }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .message.self { background: var(--whatsapp-sent-bubble); align-self: flex-end; color: var(--gemini-dark-text); }
        .message.remote { background: var(--whatsapp-received-bubble); align-self: flex-start; color: var(--gemini-dark-text); }
        .message-content {
             white-space: pre-wrap; /* Para que los saltos de l√≠nea se respeten */
        }
        /* NUEVO: Contenedor para la hora y los tics */
        .message-footer {
            align-self: flex-end; margin-top: 4px; font-size: 11px;
            color: rgba(0, 0, 0, 0.45); display: flex; align-items: center;
        }
        .message-footer .time { margin-right: 5px; }
        /* NUEVO: Estilo para los tics */
        .message-footer .ticks { font-size: 1rem; color: #999; }
        .message-footer .ticks.read { color: var(--whatsapp-tick-blue); }

        /* NUEVO: Separador de fecha */
        .date-separator {
            background: #e1f5ff; color: #5a666d; text-align: center;
            max-width: fit-content; margin: 15px auto; font-size: 12px;
            align-self: center; padding: 5px 12px; border-radius: 8px;
            box-shadow: 0 1px 1px rgba(0,0,0,0.05); font-weight: 500;
        }
        .message.system-message {
            background: #e1f2fb; color: #5a666d; text-align: center;
            max-width: 90%; margin: 10px auto; font-size: 13px; align-self: center;
            padding: 8px; border-radius: 12px; box-shadow: none;
        }
        .message .sender-name { font-weight: 500; color: var(--gemini-accent-blue); font-size: 14px; margin-bottom: 3px; }
        .message.self .sender-name { display: none; }

        /* √Årea de Entrada (Sin cambios) */
        .input-area {
            position: fixed; bottom: 0; width: 100%; background: var(--gemini-medium-bg);
            padding: 8px; box-shadow: 0 -1px 5px rgba(0,0,0,0.08); z-index: 100;
            display: flex; gap: 8px; align-items: flex-end;
        }
        .message-input-group {
            flex: 1; display: flex; align-items: flex-end; background: white;
            border-radius: 25px; padding: 5px 10px;
        }
        .input-area textarea {
            flex: 1; min-height: 20px; max-height: 100px; padding: 8px 5px;
            border: none; resize: none; font-size: 16px; outline: none; background: transparent;
            color: var(--gemini-dark-text);
        }
        .input-area button {
            background: transparent; color: var(--gemini-secondary-text); border: none; border-radius: 50%;
            width: 48px; height: 48px; display: flex; align-items: center; justify-content: center;
            font-size: 22px; cursor: pointer; flex-shrink: 0;
        }
        #sendButton {
            background: var(--gemini-accent-blue); color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            width: 48px; height: 48px;
        }
        
        /* Estilos de modales y otros elementos sin cambios significativos */
        #emojiPickerContainer { position: absolute; bottom: 75px; right: 10px; z-index: 110; display: none; }
        emoji-picker { box-shadow: 0 5px 15px rgba(0,0,0,0.2); border-radius: 15px; border: 1px solid #eee; }
        .settings-section { margin-bottom: 20px; }
        .settings-section h4 { margin-bottom: 10px; color: var(--gemini-dark-text); }
        .settings-option { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #eee; }
        .settings-option:last-child { border-bottom: none; }
        .settings-option label { flex-grow: 1; }
        
        /* NUEVO: Estilos para el modal de Dispositivos Vinculados */
        #linkedDevicesList { text-align: left; margin: 15px 0; max-height: 150px; overflow-y: auto; border-top: 1px solid #eee; border-bottom: 1px solid #eee;}
        .device-item { padding: 12px 5px; display: flex; align-items: center; }
        .device-item i { font-size: 24px; color: #555; margin-right: 15px; }
        .device-info p { margin: 0; font-size: 14px; font-weight: 500; }
        .device-info span { font-size: 12px; color: var(--gemini-secondary-text); }

    </style>
</head>
<body>
    <div id="notification-container"></div>

    <!-- Modal de Alias (Sin cambios funcionales) -->
    <div class="modal" id="aliasModal">
        <div class="modal-content">
            <h3>Bienvenido a Chat P2P</h3>
            <p>Elige tu alias y una foto de perfil (opcional)</p>
            <div class="profile-pic-upload">
                <div class="avatar-preview" id="modalAvatarPreview"><i class="fa fa-user"></i></div>
                <label for="profilePicInput"><i class="fa fa-camera"></i> Elegir foto</label>
                <input type="file" id="profilePicInput" accept="image/jpeg, image/png" style="display: none;">
            </div>
            <input type="text" id="aliasInput" class="modal-input" placeholder="Ej: Juanito123" maxlength="15">
            <button onclick="setAlias()">Entrar al Chat</button>
        </div>
    </div>
    
    <!-- NUEVO: Modal para cambiar el estado -->
    <div class="modal" id="statusModal" style="display: none;">
        <div class="modal-content">
            <h3>Actualiza tu estado</h3>
            <input type="text" id="statusInput" class="modal-input" placeholder="Escribe tu estado aqu√≠" maxlength="70">
            <button onclick="saveStatus()">Guardar</button>
            <button onclick="closeModal('statusModal')" class="secondary">Cancelar</button>
        </div>
    </div>


    <!-- Modal de Ajustes (Sin cambios) -->
    <div class="modal" id="settingsModal" style="display: none;">
        <div class="modal-content">
            <h3>Ajustes</h3>
            <div class="settings-section">
                <h4>Notificaciones</h4>
                <div class="settings-option">
                    <label for="notificationsEnabled">Notificaciones</label>
                    <div class="switch">
                        <input type="checkbox" id="notificationsEnabled" checked>
                        <span class="slider"></span>
                    </div>
                </div>
            </div>
            <div style="margin-top: 20px;">
                <button onclick="saveSettings()">Guardar</button>
                <button onclick="closeModal('settingsModal')" class="secondary">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Dispositivos Vinculados (Modificado) -->
    <div class="modal" id="linkedDevicesModal" style="display: none;">
        <div class="modal-content">
            <h3>Dispositivos vinculados</h3>
            <p style="font-size:14px; color: var(--gemini-secondary-text);">Usa tu cuenta en otros dispositivos.</p>
            <div id="linkedDevicesList">
                <!-- Los dispositivos vinculados aparecer√°n aqu√≠ -->
            </div>
            <button onclick="linkNewDevice()">Vincular un dispositivo</button>
            <button onclick="closeModal('linkedDevicesModal')" class="secondary" style="margin-top:10px;">Cerrar</button>
        </div>
    </div>

    <!-- Encabezado del Chat (Sin cambios) -->
    <div id="chatHeader" class="chat-header">
        <button class="back-button" id="backToPeersList" style="display: none;"><i class="fa fa-arrow-left"></i></button>
        <div class="profile-pic" id="activePeerProfilePic"><i class="fa fa-user"></i></div>
        <div class="profile-info">
            <h1 id="activePeerName">Usuarios en L√≠nea</h1>
            <div id="statusIndicator" class="online-status"></div>
        </div>
        <div class="header-icons">
            <i class="fa fa-trash" id="deleteChatButton" style="display: none;"></i>
            <button class="menu-button" id="menuButton"><i class="fa fa-bars"></i></button>
        </div>
    </div>

    <!-- Men√∫ Lateral (Modificado) -->
    <div id="sideMenu" class="side-menu">
        <div class="menu-header">
            <div class="avatar" id="myProfileAvatar"><i class="fa fa-user"></i></div>
            <div class="user-info">
                <h2 id="myAliasDisplay">Mi Alias</h2>
                <p id="myStatusText">Disponible</p>
            </div>
        </div>
        <ul class="menu-options">
            <!-- Opciones del men√∫ simplificadas para mantener el foco -->
            <li id="linkedDevicesOption"><i class="fa fa-laptop"></i> Dispositivos vinculados</li>
            <li id="settingsOption"><i class="fa fa-cog"></i> Ajustes</li>
            <li id="logoutOption"><i class="fa-solid fa-right-from-bracket"></i> Cerrar sesi√≥n</li>
        </ul>
    </div>
    <div id="sideMenuBackdrop" class="side-menu-backdrop"></div>

    <!-- Contenedor Principal (Sin cambios) -->
    <div class="main-container">
        <div id="connectedPeersList" class="connected-peers-list">
            <h4>Usuarios</h4>
            <ul id="peerList"></ul>
        </div>
        <div id="chat"></div>
    </div>

    <!-- √Årea de Entrada (Sin cambios) -->
    <div class="input-area">
        <div class="message-input-group">
            <button id="emojiButton"><i class="far fa-laugh"></i></button>
            <textarea id="message" placeholder="Mensaje"></textarea>
        </div>
        <button id="sendButton"><i class="fa fa-paper-plane"></i></button>
    </div>

    <!-- Elementos Ocultos (Sin cambios) -->
    <div id="emojiPickerContainer"><emoji-picker class="light"></emoji-picker></div>
    <audio id="messageSound" src="https://assets.mixkit.co/sfx/preview/mixkit-software-interface-start-2574.mp3" preload="auto"></audio>
    
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js"></script>
    <script>
        // --- VARIABLES GLOBALES Y CONFIGURACI√ìN ---
        const TRACKER_ID = 'mi-app-chat-super-secreta-xyz-p2p-v5'; // Mantenemos el ID original
        let peer;
        let myAlias = localStorage.getItem('chatAlias_v2') || '';
        let myProfilePic = localStorage.getItem('userProfilePic_v2') || '';
        let myStatus = localStorage.getItem('userStatus_v2') || 'Disponible';
        
        let trackerConnection;
        let isTracker = false;
        let onlineUsers = {}; // { alias: { profilePic, status, isTracker, lastSeen, isTyping } }
        let peerConnections = {}; // Conexiones activas
        let activeChatPeerId = null;
        
        let userSettings = JSON.parse(localStorage.getItem('userSettings_v2')) || { notifications: true };
        let linkedDevices = JSON.parse(localStorage.getItem('linkedDevices_v2')) || [];

        let typingTimeout;

        // Referencias al DOM (sin cambios)
        const aliasModal = document.getElementById('aliasModal');
        const peerListUl = document.getElementById('peerList');
        const chatDiv = document.getElementById('chat');
        const messageInput = document.getElementById('message');
        const backToPeersListButton = document.getElementById('backToPeersList');
        const activePeerNameDisplay = document.getElementById('activePeerName');
        const activePeerProfilePic = document.getElementById('activePeerProfilePic');
        const statusIndicator = document.getElementById('statusIndicator');

        // --- INICIALIZACI√ìN ---
        if (!myAlias) {
            aliasModal.style.display = 'flex';
        } else {
            initApp();
        }

        function setAlias() {
            const alias = document.getElementById('aliasInput').value.trim().replace(/\s+/g, '_');
            if (alias.length >= 3 && alias.length <= 15) {
                myAlias = alias;
                localStorage.setItem('chatAlias_v2', alias);
                localStorage.setItem('userProfilePic_v2', myProfilePic);
                aliasModal.style.display = 'none';
                initApp();
            } else {
                showToast('El alias debe tener entre 3 y 15 caracteres.', 'error');
            }
        }
        
        function initApp() {
            updateMyProfileUI();
            initMyPeer();
            setupUIEventListeners();
            updateLayout();
            // Guardar la hora de inicio de sesi√≥n
            localStorage.setItem('lastLogin_v2', new Date().toISOString());
        }

        // --- L√ìGICA DE PEERJS (Casi sin cambios, se mantiene la estructura original de tracker) ---
        function initMyPeer() {
            if (peer && !peer.destroyed) peer.destroy();
            peer = new Peer(myAlias, { debug: 2, config: { 'iceServers': [{ 'urls': 'stun:stun.l.google.com:19302' }] } });

            peer.on('open', (id) => {
                console.log(`Mi Peer est√° listo con alias: ${id}`);
                addSystemMessageToChat(`¬°Bienvenido, ${myAlias}! Buscando a otros usuarios...`);
                connectToTracker();
            });

            peer.on('connection', (conn) => {
                console.log(`Recib√≠ una conexi√≥n de ${conn.peer}`);
                setupChatConnection(conn);
            });

            peer.on('error', (err) => {
                console.error("Error en PeerJS:", err);
                if (err.type === 'peer-unavailable' && err.message.includes(TRACKER_ID)) {
                    console.log('El Tracker no est√° disponible. Me convertir√© en el Tracker.');
                    becomeTracker();
                }
            });
        }
        
        function connectToTracker() {
            trackerConnection = peer.connect(TRACKER_ID, { 
                metadata: { profilePic: myProfilePic, status: myStatus }, 
                serialization: 'json' 
            });
            trackerConnection.on('open', () => {
                console.log('Conectado al Tracker.');
                isTracker = false;
            });
            trackerConnection.on('data', handleTrackerData);
            trackerConnection.on('close', () => {
                onlineUsers = {}; renderOnlineUsers();
                setTimeout(connectToTracker, 3000);
            });
        }
        
        function becomeTracker() {
            if (isTracker) return;
            isTracker = true;
            const trackerPeer = new Peer(TRACKER_ID, { debug: 2 });
            trackerPeer.on('open', () => {
                console.log('¬°SOY EL TRACKER!', TRACKER_ID);
                onlineUsers = { [myAlias]: { profilePic: myProfilePic, status: myStatus, isTracker: true, lastSeen: new Date().toISOString() } };
                renderOnlineUsers();
            });
            trackerPeer.on('connection', (conn) => {
                const newUserAlias = conn.peer;
                conn.on('open', () => {
                    conn.send({ type: 'user-list', users: onlineUsers });
                    onlineUsers[newUserAlias] = { profilePic: conn.metadata.profilePic, status: conn.metadata.status, lastSeen: new Date().toISOString() };
                    broadcastToAll({ type: 'user-joined', user: { alias: newUserAlias, data: onlineUsers[newUserAlias] } });
                    renderOnlineUsers();
                });
                conn.on('close', () => {
                    delete onlineUsers[newUserAlias];
                    broadcastToAll({ type: 'user-left', alias: newUserAlias });
                    renderOnlineUsers();
                });
            });
        }

        function broadcastToAll(data) {
             Object.values(peer.connections).flat().forEach(conn => { 
                 if (conn.open && conn.peer !== TRACKER_ID) conn.send(data); 
             });
        }

        function handleTrackerData(data) {
            switch(data.type) {
                case 'user-list': onlineUsers = data.users; break;
                case 'user-joined': onlineUsers[data.user.alias] = data.user.data; break;
                case 'user-left': delete onlineUsers[data.alias]; break;
            }
            renderOnlineUsers();
        }

        // --- L√ìGICA DE MENSAJER√çA (Modificada para tics, estados, etc.) ---
        function sendMessage() {
            const text = messageInput.value.trim();
            if (!text || !activeChatPeerId) return;

            const messageData = {
                id: `msg_${Date.now()}_${Math.random()}`,
                sender: myAlias,
                text: text,
                timestamp: new Date().toISOString(),
                status: 'sent' // sent -> delivered -> read
            };
            
            // Enviar a trav√©s de la conexi√≥n directa
            if (peerConnections[activeChatPeerId] && peerConnections[activeChatPeerId].open) {
                peerConnections[activeChatPeerId].send({ type: 'text-message', payload: messageData });
            } else {
                // Guardar en cola si no hay conexi√≥n directa (mensajer√≠a offline)
                showToast(`${activeChatPeerId} no est√° en l√≠nea. Se enviar√° cuando se conecte.`, 'warning');
            }
            
            addMessageToChat(messageData, 'self');
            saveMessage(activeChatPeerId, messageData);
            messageInput.value = '';
            renderOnlineUsers(); // Para actualizar la vista previa
        }
        
        function handleReceivedData(data, senderId) {
            const { type, payload } = data;
            
            switch (type) {
                case 'text-message':
                    handleNewMessage(payload, senderId);
                    break;
                case 'message-ack':
                    updateMessageStatus(payload.messageId, payload.status, senderId);
                    break;
                case 'typing':
                    handleTypingIndicator(senderId, payload.isTyping);
                    break;
                case 'status-update':
                    if (onlineUsers[senderId]) {
                        onlineUsers[senderId].status = payload.status;
                        renderOnlineUsers();
                        if (activeChatPeerId === senderId) updateLayout();
                    }
                    break;
            }
        }
        
        function handleNewMessage(messageData, senderId) {
            if (activeChatPeerId === senderId) {
                addMessageToChat(messageData, 'remote');
                // Si el chat est√° abierto, marcar como le√≠do
                markMessagesAsRead(senderId);
            } else {
                // Si el chat no est√° abierto, incrementar contador
                const histories = JSON.parse(localStorage.getItem('chatHistories_v2')) || {};
                let history = histories[senderId] || {};
                history.unreadCount = (history.unreadCount || 0) + 1;
                histories[senderId] = history;
                localStorage.setItem('chatHistories_v2', JSON.stringify(histories));
                showToast(`Nuevo mensaje de ${senderId}`, 'info');
            }
            
            saveMessage(senderId, messageData);
            
            // Enviar ACK de 'delivered'
            const conn = peerConnections[senderId];
            if (conn && conn.open) {
                conn.send({ type: 'message-ack', payload: { messageId: messageData.id, status: 'delivered' } });
            }
            renderOnlineUsers();
        }

        // --- MANEJO DE ESTADO DE MENSAJES (TICKS) ---
        function updateMessageStatus(messageId, newStatus, targetPeerId) {
            const histories = JSON.parse(localStorage.getItem('chatHistories_v2')) || {};
            let peerHistory = histories[targetPeerId] || {};
            let messages = peerHistory.messages || [];
            
            let messageUpdated = false;
            messages = messages.map(msg => {
                if (msg.id === messageId) {
                    // No revertir 'read' a 'delivered'
                    if (msg.status === 'read' && newStatus === 'delivered') return msg;
                    msg.status = newStatus;
                    messageUpdated = true;
                }
                return msg;
            });

            if (messageUpdated) {
                peerHistory.messages = messages;
                histories[targetPeerId] = peerHistory;
                localStorage.setItem('chatHistories_v2', JSON.stringify(histories));
                
                // Actualizar UI si el chat est√° activo
                if (activeChatPeerId === targetPeerId) {
                    const tickElement = document.querySelector(`.ticks[data-message-id="${messageId}"]`);
                    if (tickElement) {
                        tickElement.innerHTML = getTicksHTML(newStatus);
                        if (newStatus === 'read') tickElement.classList.add('read');
                    }
                }
            }
        }

        function markMessagesAsRead(peerId) {
            const conn = peerConnections[peerId];
            if (!conn || !conn.open) return;
            
            const histories = JSON.parse(localStorage.getItem('chatHistories_v2')) || {};
            let peerHistory = histories[peerId] || { messages: [], unreadCount: 0 };
            
            peerHistory.messages.forEach(msg => {
                if (msg.sender === peerId && msg.status !== 'read') {
                    // Enviar ACK de lectura por cada mensaje no le√≠do
                    conn.send({ type: 'message-ack', payload: { messageId: msg.id, status: 'read' } });
                }
            });
            
            // Resetea el contador localmente
            peerHistory.unreadCount = 0;
            histories[peerId] = peerHistory;
            localStorage.setItem('chatHistories_v2', JSON.stringify(histories));
            renderOnlineUsers(); // Actualizar la lista para quitar el badge
        }
        
        // --- UI Y RENDERIZADO ---
        function renderOnlineUsers() {
            peerListUl.innerHTML = '';
            const histories = JSON.parse(localStorage.getItem('chatHistories_v2')) || {};

            Object.entries(onlineUsers).forEach(([alias, data]) => {
                if (alias === myAlias) return;
                
                const li = document.createElement('li');
                li.dataset.peerId = alias;

                const peerHistory = histories[alias] || {};
                const unreadCount = peerHistory.unreadCount || 0;
                const lastMessage = (peerHistory.messages || []).slice(-1)[0] || {};
                
                let statusHTML = '';
                if(data.isTyping) {
                    statusHTML = `<span class="peer-status-text typing">escribiendo...</span>`;
                } else if(data.isTracker) {
                    statusHTML = `<span class="peer-status-text tracker">Anfitri√≥n</span>`;
                } else {
                     statusHTML = `<span class="peer-status-text">${lastMessage.text || data.status || ''}</span>`;
                }

                li.innerHTML = `
                    <div class="avatar">${data.profilePic ? `<img src="${data.profilePic}" alt="${alias}">` : `<i class="fa fa-user"></i>`}</div>
                    <div class="peer-info">
                        <div class="peer-info-top">
                           <span class="peer-name">${alias}</span>
                           <span class="last-message-time">${formatTimestamp(lastMessage.timestamp, true)}</span>
                        </div>
                        <div class="peer-info-bottom">
                           ${statusHTML}
                           ${unreadCount > 0 ? `<div class="unread-badge">${unreadCount}</div>` : ''}
                        </div>
                    </div>
                `;
                li.onclick = () => startChatWith(alias);
                if (alias === activeChatPeerId) li.classList.add('active');
                peerListUl.appendChild(li);
            });
        }
        
        function startChatWith(peerAlias) {
            activeChatPeerId = peerAlias;
            if (!peerConnections[peerAlias] || !peerConnections[peerAlias].open) {
                const conn = peer.connect(peerAlias, { serialization: 'json' });
                setupChatConnection(conn);
            }
            chatDiv.innerHTML = '';
            loadChatHistory(peerAlias);
            updateLayout();
            markMessagesAsRead(peerAlias);
        }
        
        function setupChatConnection(conn) {
            peerConnections[conn.peer] = conn;
            conn.on('data', (data) => handleReceivedData(data, conn.peer));
            conn.on('close', () => {
                delete peerConnections[conn.peer];
                if (onlineUsers[conn.peer]) onlineUsers[conn.peer].lastSeen = new Date().toISOString();
                renderOnlineUsers();
            });
        }
        
        function addMessageToChat(data, direction) {
            let lastDate = chatDiv.dataset.lastDate;
            const messageDate = new Date(data.timestamp).toDateString();

            if (lastDate !== messageDate) {
                chatDiv.appendChild(createDateSeparator(new Date(data.timestamp)));
                chatDiv.dataset.lastDate = messageDate;
            }

            const div = document.createElement('div');
            div.className = `message ${direction}`;
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.textContent = data.text;
            div.appendChild(contentDiv);
            
            const footerDiv = document.createElement('div');
            footerDiv.className = 'message-footer';
            footerDiv.innerHTML = `
                <span class="time">${formatTimestamp(data.timestamp)}</span>
                ${direction === 'self' ? `<span class="ticks ${data.status === 'read' ? 'read' : ''}" data-message-id="${data.id}">${getTicksHTML(data.status)}</span>` : ''}
            `;
            div.appendChild(footerDiv);
            
            chatDiv.appendChild(div);
            chatDiv.scrollTop = chatDiv.scrollHeight;
            if (direction === 'remote') document.getElementById('messageSound').play().catch(()=>{});
        }
        
        // --- GUARDADO DE DATOS (HISTORIAL Y PERFILES) ---
        function saveMessage(peerId, messageData) {
            if (!peerId) return;
            const histories = JSON.parse(localStorage.getItem('chatHistories_v2')) || {};
            if (!histories[peerId]) histories[peerId] = { messages: [], unreadCount: 0 };
            
            // Evitar duplicados
            if (!histories[peerId].messages.some(m => m.id === messageData.id)) {
                histories[peerId].messages.push(messageData);
                localStorage.setItem('chatHistories_v2', JSON.stringify(histories));
            }
        }

        function loadChatHistory(peerId) {
            const histories = JSON.parse(localStorage.getItem('chatHistories_v2')) || {};
            const peerHistory = histories[peerId] || { messages: [] };
            chatDiv.dataset.lastDate = null; // Resetear fecha para el separador
            peerHistory.messages.forEach(msg => {
                const direction = msg.sender === myAlias ? 'self' : 'remote';
                addMessageToChat(msg, direction);
            });
        }

        // --- FUNCIONES DE UI Y AUXILIARES ---
        function setupUIEventListeners() {
            document.getElementById('sendButton').onclick = sendMessage;
            messageInput.onkeypress = (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }};
            document.getElementById('profilePicInput').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    myProfilePic = event.target.result;
                    document.getElementById('modalAvatarPreview').innerHTML = `<img src="${myProfilePic}" alt="Profile Pic">`;
                };
                reader.readAsDataURL(file);
            });
            backToPeersListButton.onclick = () => { activeChatPeerId = null; updateLayout(); };
            document.getElementById('menuButton').onclick = () => {
                document.getElementById('sideMenu').classList.add('active');
                document.getElementById('sideMenuBackdrop').classList.add('active');
            };
            document.getElementById('sideMenuBackdrop').onclick = () => {
                document.getElementById('sideMenu').classList.remove('active');
                document.getElementById('sideMenuBackdrop').classList.remove('active');
            };
            document.getElementById('myStatusText').onclick = () => {
                document.getElementById('statusInput').value = myStatus;
                document.getElementById('statusModal').style.display = 'flex';
            };
            document.getElementById('linkedDevicesOption').onclick = () => {
                renderLinkedDevices();
                document.getElementById('linkedDevicesModal').style.display = 'flex';
            };
            messageInput.addEventListener('input', () => {
                if (!activeChatPeerId || !peerConnections[activeChatPeerId]?.open) return;
                clearTimeout(typingTimeout);
                peerConnections[activeChatPeerId].send({ type: 'typing', payload: { isTyping: true }});
                typingTimeout = setTimeout(() => {
                    peerConnections[activeChatPeerId].send({ type: 'typing', payload: { isTyping: false }});
                }, 2000);
            });
             document.getElementById('settingsOption').onclick = () => document.getElementById('settingsModal').style.display = 'flex';
             document.getElementById('logoutOption').onclick = () => {
                if (confirm('¬øEst√°s seguro? Se borrar√° tu perfil de este navegador.')) {
                    localStorage.removeItem('chatAlias_v2');
                    localStorage.removeItem('userProfilePic_v2');
                    localStorage.removeItem('userStatus_v2');
                    localStorage.removeItem('chatHistories_v2');
                    localStorage.removeItem('linkedDevices_v2');
                    window.location.reload();
                }
            };
        }

        function handleTypingIndicator(peerId, isTyping) {
            if (onlineUsers[peerId]) {
                onlineUsers[peerId].isTyping = isTyping;
                if (activeChatPeerId === peerId) {
                    statusIndicator.classList.toggle('typing', isTyping);
                    statusIndicator.textContent = isTyping ? 'escribiendo...' : 'en l√≠nea';
                }
                renderOnlineUsers();
            }
        }
        
        function updateLayout() {
            const isChatView = !!activeChatPeerId;
            document.getElementById('connectedPeersList').classList.toggle('hidden-left', isChatView);
            document.querySelector('.input-area').style.display = isChatView ? 'flex' : 'none';
            document.getElementById('menuButton').style.display = isChatView ? 'none' : 'block';
            document.getElementById('deleteChatButton').style.display = isChatView ? 'block' : 'none';
            backToPeersListButton.style.display = isChatView ? 'block' : 'none';

            if (isChatView) {
                const peerData = onlineUsers[activeChatPeerId] || {};
                activePeerNameDisplay.textContent = activeChatPeerId;
                activePeerProfilePic.innerHTML = peerData.profilePic ? `<img src="${peerData.profilePic}">` : `<i class="fa fa-user"></i>`;
                if(peerData.isTyping) {
                     statusIndicator.textContent = 'escribiendo...';
                     statusIndicator.classList.add('typing');
                } else if (onlineUsers[activeChatPeerId]) {
                    statusIndicator.textContent = peerData.status || 'en l√≠nea';
                    statusIndicator.classList.remove('typing');
                } else {
                    const lastSeen = peerData.lastSeen || localStorage.getItem('lastLogin_v2');
                    statusIndicator.textContent = `√∫lt. vez ${formatTimestamp(lastSeen, true)}`;
                    statusIndicator.classList.remove('typing');
                }
            } else {
                activePeerNameDisplay.textContent = 'Usuarios en L√≠nea';
                activePeerProfilePic.innerHTML = `<i class="fa fa-users"></i>`;
                statusIndicator.textContent = `${Object.keys(onlineUsers).length} conectado(s)`;
            }
        }
        
        function formatTimestamp(isoString, forPreview = false) {
            if (!isoString) return '';
            const date = new Date(isoString);
            if (forPreview) {
                const today = new Date();
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                if (date.toDateString() === today.toDateString()) {
                    return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
                }
                if (date.toDateString() === yesterday.toDateString()) {
                    return 'Ayer';
                }
                return date.toLocaleDateString('es-ES');
            }
            return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
        }

        function getTicksHTML(status) {
            if (status === 'read') return '<i class="fa-solid fa-check-double"></i>';
            if (status === 'delivered') return '<i class="fa-solid fa-check-double"></i>';
            return '<i class="fa-solid fa-check"></i>';
        }

        function createDateSeparator(date) {
            const separator = document.createElement('div');
            separator.className = 'date-separator';
            const today = new Date();
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);

            if (date.toDateString() === today.toDateString()) separator.textContent = 'Hoy';
            else if (date.toDateString() === yesterday.toDateString()) separator.textContent = 'Ayer';
            else separator.textContent = date.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            return separator;
        }

        function addSystemMessageToChat(text) {
            const div = document.createElement('div');
            div.className = 'message system-message';
            div.textContent = text;
            chatDiv.appendChild(div);
            chatDiv.scrollTop = chatDiv.scrollHeight;
        }

        function updateMyProfileUI() {
            document.getElementById('myAliasDisplay').textContent = myAlias;
            document.getElementById('myStatusText').textContent = myStatus;
            if (myProfilePic) document.getElementById('myProfileAvatar').innerHTML = `<img src="${myProfilePic}">`;
        }

        function saveStatus() {
            myStatus = document.getElementById('statusInput').value.trim();
            if(myStatus) {
                localStorage.setItem('userStatus_v2', myStatus);
                updateMyProfileUI();
                broadcastToAll({ type: 'status-update', payload: { status: myStatus } });
                closeModal('statusModal');
            }
        }
        
        function linkNewDevice() {
            const deviceName = prompt("Ingresa un nombre para el nuevo dispositivo (ej: 'PC del Trabajo'):");
            if(deviceName) {
                linkedDevices.push({
                    name: deviceName,
                    lastSeen: new Date().toISOString(),
                    icon: 'fa-desktop'
                });
                localStorage.setItem('linkedDevices_v2', JSON.stringify(linkedDevices));
                renderLinkedDevices();
                showToast(`Dispositivo "${deviceName}" vinculado (simulaci√≥n).`, 'success');
            }
        }
        
        function renderLinkedDevices() {
            const list = document.getElementById('linkedDevicesList');
            list.innerHTML = ''; // Limpiar lista
            // A√±adir dispositivo actual
            const currentDevice = document.createElement('div');
            currentDevice.className = 'device-item';
            currentDevice.innerHTML = `
                <i class="fa-solid fa-mobile-screen"></i>
                <div class="device-info">
                    <p>Este Navegador</p>
                    <span>Activo ahora</span>
                </div>`;
            list.appendChild(currentDevice);
            // A√±adir otros dispositivos
            linkedDevices.forEach(device => {
                 const deviceEl = document.createElement('div');
                 deviceEl.className = 'device-item';
                 deviceEl.innerHTML = `
                    <i class="fa-solid ${device.icon}"></i>
                    <div class="device-info">
                        <p>${device.name}</p>
                        <span>√ölt. vez: ${formatTimestamp(device.lastSeen, true)}</span>
                    </div>`;
                 list.appendChild(deviceEl);
            });
        }
        
        function showToast(message, type) { /* Sin cambios */ }
        function closeModal(modalId) { document.getElementById(modalId).style.display = 'none'; }
    </script>
</body>
</html>

